# llms-full (private-aware)
> Built from GitHub files and website pages. Large files may be truncated.

--- .archived/data/part11/01-getting-started-with-github-actions.md ---
---{
  "title": "Getting started with GitHub Actions",
  "source_url": "https://fullstackopen.com/en/part11/getting_started_with_git_hub_actions",
  "crawl_timestamp": "2025-10-04T19:15:49Z",
  "checksum": "6684b630569042448f7292946f57a63553b5cdeda600f358ee34eac8d1523163"
}
---[Skip to content](../part11/01-getting-started-with-git-hub-actions-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 11](../part11/01-part11.md)
Getting started with GitHub Actions
[a Introduction to CI/CD](../part11/01-introduction-to-ci-cd.md)
b Getting started with GitHub Actions

- [Basic needs](../part11/01-getting-started-with-git-hub-actions-basic-needs.md)
- [Exercise 11.2.](../part11/01-getting-started-with-git-hub-actions-exercise-11-2.md)
- [Getting started with workflows](../part11/01-getting-started-with-git-hub-actions-getting-started-with-workflows.md)
- [Exercises 11.3-11.4.](../part11/01-getting-started-with-git-hub-actions-exercises-11-3-11-4.md)
- [Setting up lint, test and build steps](../part11/01-getting-started-with-git-hub-actions-setting-up-lint-test-and-build-steps.md)
- [Exercises 11.5.-11.9.](../part11/01-getting-started-with-git-hub-actions-exercises-11-5-11-9.md)


[c Deployment](../part11/01-deployment.md)[d Keeping green](../part11/01-keeping-green.md)[e Expanding Further](../part11/01-expanding-further.md)
b
# Getting started with GitHub Actions
Before we start playing with GitHub Actions, let's have a look at what they are and how do they work.
GitHub Actions work on a basis of
A typical execution of a workflow looks like this:

- Triggering event happens (for example, there is a push to the main branch).
- The workflow with that trigger is executed.
- Cleanup


### Basic needs
In general, to have CI operate on a repository, we need a few things:

- A repository (obviously)
- Some definition of what the CI needs to do: This can be in the form of a specific file inside the repository or it can be defined in the CI system
- The CI needs to be aware that the repository (and the configuration file within it) exist
- The CI needs to be able to access the repository
- The CI needs permissions to perform the actions it is supposed to be able to do: For example, if the CI needs to be able to deploy to a production environment, it needs _credentials_ for that environment.


That's the traditional model at least, we'll see in a minute how GitHub Actions short-circuit some of these steps or rather make it such that you don't have to worry about them!
GitHub Actions have a great advantage over self-hosted solutions: the repository is hosted with the CI provider. In other words, GitHub provides both the repository and the CI platform. This means that if we've enabled actions for a repository, GitHub is already aware of the fact that we have workflows defined and what those definitions look like.
### Exercise 11.2
In most exercises of this part, we are building a CI/CD pipeline for a small project found in
#### 11.2 The example project
The first thing you'll want to do is to fork the example repository under your name. What it essentially does is it creates a copy of the repository under your GitHub user profile for your use.
To fork the repository, you can click on the Fork button in the top-right area of the repository view next to the Star button:
![fullstack content](../assets/58ea21aff878dad5.png)
Once you've clicked on the Fork button, GitHub will start the creation of a new repository called `{github_username}/full-stack-open-pokedex`.
Once the process has been finished, you should be redirected to your brand-new repository:
![fullstack content](../assets/008659a75648497a.png)
Clone the project now to your machine. As always, when starting with a new code, the most obvious place to look first is the file `package.json`
_**NOTE** since the project is already a bit old, you need Node 16 to work with it!_
Try now the following:

- install dependencies (by running `npm install`)
- start the code in development mode
- run tests
- lint the code


You might notice that the project contains some broken tests and linting errors. **Just leave them as they are for now.** We will get around those later in the exercises.
**NOTE** the tests of the project have been made with [part 5](../part5/01-testing-react-apps.md) uses
As you might remember from [part 3](../part3/01-deploying-app-to-internet-frontend-production-build.md), the React code _should not_ be run in development mode once it is deployed in production. Try now the following

- create a production _build_ of the project
- run the production version locally


Also for these two tasks, there are ready-made npm scripts in the project!
Study the structure of the project for a while. As you notice both the frontend and the backend code are now [in the same repository](../part7/01-class-components-miscellaneous-frontend-and-backend-in-the-same-repository.md). In earlier parts of the course we had a separate repository for both, but having those in the same repository makes things much simpler when setting up a CI environment.
In contrast to most projects in this course, the frontend code _does not use_ Vite but it has a relatively simple [Webpack](../part7/01-webpack.md) configuration that takes care of creating the development environment and creating the production bundle.
### Getting started with workflows
The core component of creating CI/CD pipelines with GitHub Actions is something called a
Workflow

- Job
  - Step
  - Step
- Job
  - Step


Each workflow must specify at least one
Steps can vary from running a custom command to using pre-defined actions, thus the name GitHub Actions. You can create
For GitHub to recognize your workflows, they must be specified in `.github/workflows` folder in your repository. Each Workflow is its own separate file which needs to be configured using the `YAML` data-serialization language.
YAML is a recursive acronym for "YAML Ain't Markup Language". As the name might hint its goal is to be human-readable and it is commonly used for configuration files. You will notice below that it is indeed very easy to understand!
Notice that indentations are important in YAML. You can learn more about the syntax
A basic workflow contains three elements in a YAML document. These three elements are:

- name: Yep, you guessed it, the name of the workflow
- (on) triggers: The events that trigger the workflow to be executed
- jobs: The separate jobs that the workflow will execute (a basic workflow might contain only one job).


A simple workflow definition looks like this:

```
name: Hello World!

on:
  push:
    branches:
      - main

jobs:
  hello_world_job:
    runs-on: ubuntu-latest
    steps:
      - name: Say hello
        run: |
          echo "Hello World!"copy
```

There is one job named _hello_world_job_ , it will be run in a virtual environment with Ubuntu 20.04. The job has just one step named "Say hello", which will run the `echo "Hello World!"` command in the shell.
So you may ask, when does GitHub trigger a workflow to be started? There are plenty of

- An _event on GitHub_ occurs such as when someone pushes a commit to a repository or when an issue or pull request is created
- A _scheduled event_ , that is specified using the
- An _external event_ occurs, for example, a command is performed in an external application such as


To learn more about which events can be used to trigger workflows, please refer to GitHub Action's
### Exercises 11.3-11.4
To tie this all together, let us now get GitHub Actions up and running in the example project!
#### 11.3 Hello world
Create a new Workflow that outputs "Hello World!" to the user. For the setup, you should create the directory `.github/workflows` and a file `hello.yml` to your repository.
To see what your GitHub Action workflow has done, you can navigate to the **Actions** tab in GitHub where you should see the workflows in your repository and the steps they implement. The output of your Hello World workflow should look something like this with a properly configured workflow.
![A properly configured Hello World workflow](../assets/e065dfe5c69ffc04.png)
You should see the "Hello World!" message as an output. If that's the case then you have successfully gone through all the necessary steps. You have your first GitHub Actions workflow active!
Note that GitHub Actions also informs you on the exact environment (operating system, and its
#### 11.4 Date and directory contents
Extend the workflow with steps that print the date and current directory content in the long format.
Both of these are easy steps, and just running commands
Your workflow should now look like this
![Date and dir content in the workflow](../assets/b09fce51b5e5bf51.png)
As the output of the command `ls -l` shows, by default, the virtual environment that runs our workflow _does not_ have any code!
### Setting up lint, test and build steps
After completing the first exercises, you should have a simple but pretty useless workflow set up. Let's make our workflow do something useful.
Let's implement a GitHub Action that will lint the code. If the checks don't pass, GitHub Actions will show a red status.
At the start, the workflow that we will save to file `pipeline.yml` looks like this:

```
name: Deployment pipeline

on:
  push:
    branches:
      - main

jobs:copy
```

Before we can run a command to lint the code, we have to perform a couple of actions to set up the environment of the job.
#### Setting up the environment
Setting up the environment is an important task while configuring a pipeline. We're going to use an `ubuntu-latest` virtual environment because this is the version of Ubuntu we're going to be running in production.
It is important to replicate the same environment in CI as in production as closely as possible, to avoid situations where the same code works differently in CI and production, which would effectively defeat the purpose of using CI.
Next, we list the steps in the "build" job that the CI would need to perform. As we noticed in the last exercise, by default the virtual environment does not have any code in it, so we need to _checkout the code_ from the repository.
This is an easy step:

```
name: Deployment pipeline

on:
  push:
    branches:
      - main

jobs:
  simple_deployment_pipeline:    runs-on: ubuntu-latest    steps:      - uses: actions/checkout@v4copy
```

The _action_. An action is a reusable piece of code, like a function. Actions can be defined in your repository in a separate file or you can use the ones available in public repositories.
Here we're using a public action `@v4`) to avoid potential breaking changes if the action gets updated. The `checkout` action does what the name implies: it checkouts the project source code from Git.
Secondly, as the application is written in JavaScript, Node.js must be set up to be able to utilize the commands that are specified in `package.json`. To set up Node.js, `20` is selected because it is the version the application is using in the production environment.

```
# name and trigger not shown anymore...

jobs:
  simple_deployment_pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4        with:          node-version: '20'copy
```

As we can see, the
Lastly, the dependencies of the application must be installed. Just like on your own machine we execute `npm install`. The steps in the job should now look something like

```
jobs:
  simple_deployment_pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies        run: npm installcopy
```

Now the environment should be completely ready for the job to run actual important tasks in!
#### Lint
After the environment has been set up we can run all the scripts from `package.json` like we would on our own machine. To lint the code all you have to do is add a step to run the `npm run eslint` command.

```
jobs:
  simple_deployment_pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies 
        run: npm install  
      - name: Check style        run: npm run eslintcopy
```

Note that the _name_ of a step is optional, if you define a step as follows

```
- run: npm run eslintcopy
```

the command that is run is used as the default name.
### Exercises 11.5.-11.9
#### 11.5 Linting workflow
Implement or _copy-paste_ the "Lint" workflow and commit it to the repository. Use a new _yml_ file for this workflow, you may call it e.g. _pipeline.yml_.
Push your code and navigate to "Actions" tab and click on your newly created workflow on the left. You should see that the workflow run has failed:
![Linting to workflow](../assets/564fe7da0b2496cc.png)
#### 11.6 Fix the code
There are some issues with the code that you will need to fix. Open up the workflow logs and investigate what is wrong.
A couple of hints. One of the errors is best to be fixed by specifying proper _env_ for linting, see [here](../part3/01-validation-and-es-lint-lint.md) how it can be done . One of the complaints concerning `console.log` statement could be taken care of by simply silencing the rule for that specific line. Ask google how to do it.
Make the necessary changes to the source code so that the lint workflow passes. Once you commit new code the workflow will run again and you will see updated output where all is green again:
![Lint error fixed](../assets/0035b2f6cb4215fe.png)
#### 11.7 Building and testing
Let's expand on the previous workflow that currently does the linting of the code. Edit the workflow and similarly to the lint command add commands for build and test. After this step outcome should look like this
![tests fail...](../assets/6e2b146e5b43082f.png)
As you might have guessed, there are some problems in code...
#### 11.8 Back to green
Investigate which test fails and fix the issue in the code (do not change the tests).
Once you have fixed all the issues and the Pokedex is bug-free, the workflow run will succeed and show green!
![tests fixed](../assets/53d81741cf4323a3.png)
#### 11.9 Simple end-to-end tests
The current set of tests uses [Testing React apps](../part5/01-testing-react-apps.md) of part 5 with
Testing components in isolation is quite useful but that still does not ensure that the system as a whole works as we wish. To have more confidence about this, let us write a couple of really simple end-to-end tests similarly we did in section [part 5](../part5/01-part5.md). You could use
No matter which you choose, you should extend Jest-definition in package.json to prevent Jest from trying to run the e2e-tests. Assuming that directory _e2e-tests_ is used for e2e-tests, the definition is:

```
{
  // ...
  "jest": {
    "testEnvironment": "jsdom",
    "testPathIgnorePatterns": ["e2e-tests"]  }
}copy
```

**Playwright**
Set Playwright up (you'll find [here](../part5/01-end-to-end-testing-playwright.md) all the info you need) to your repository. Note that in contrast to part 5, you should now install Playwright to the same project with the rest of the code!
Use this test first:

```
const { test, describe, expect, beforeEach } = require('@playwright/test')

describe('Pokedex', () => {
  test('front page can be opened', async ({ page }) => {
     await page.goto('')
    await expect(page.getByText('ivysaur')).toBeVisible()
    await expect(page.getByText('Pokémon and Pokémon character names are trademarks of Nintendo.')).toBeVisible()
  })
})copy
```

**Note** is that although the page renders the Pokemon names with an initial capital letter, the names are actually written with lowercase letters in the source, so you should test for `ivysaur` instead of `Ivysaur`!
Define a npm script `test:e2e` for running the e2e tests from the command line.
Remember that the Playwright tests _assume that the application is up and running_ when you run the test! Instead of starting the app manually, you should now configure a _Playwright development server_ to start the app while tests are executed, see
Ensure that the test passes locally.
Once the end-to-end test works in your machine, include it in the GitHub Action workflow. That should be pretty easy by following
**Cypress**
Set Cypress up (you'll find [here](../part5/01-end-to-end-testing-cypress.md) all the info you need) and use this test first:

```
describe('Pokedex', function() {
  it('front page can be opened', function() {
    cy.visit('http://localhost:5000')
    cy.contains('ivysaur')
    cy.contains('Pokémon and Pokémon character names are trademarks of Nintendo.')
  })
})copy
```

Define a npm script `test:e2e` for running the e2e tests from the command line.
**Note** is that although the page renders the Pokemon names with an initial capital letter, the names are actually written with lowercase letters in the source, so you should test for `ivysaur` instead of `Ivysaur`!
Ensure that the test passes locally. Remember that the Cypress tests _assume that the application is up and running_ when you run the test! If you have forgotten the details, please see [part 5](../part5/01-end-to-end-testing.md) how to get up and running with Cypress.
Once the end-to-end test works in your machine, include it in the GitHub Action workflow. By far the easiest way to do that is to use the ready-made action

```
- name: e2e tests
  uses: cypress-io/github-action@v5
  with:
    command: npm run test:e2e
    start: npm run start-prod
    wait-on: http://localhost:5000copy
```

Three options are used:
Note that you need to build the app in GitHub Actions before it can be started in production mode!
**Once the pipeline works...**
Once you are sure that the pipeline works, _write another test_ that ensures that one can navigate from the main page to the page of a particular Pokemon, e.g. _ivysaur_. The test does not need to be a complex one, just check that when you navigate to a link, the page has some proper content, such as the string _chlorophyll_ in the case of _ivysaur_.
**Note** the Pokemon abilities are written with lowercase letters in the source code (the capitalization is done in CSS), so _do not_ test for _Chlorophyll_ but rather _chlorophyll_.
The end result should be something like this
![e2e tests](../assets/f11bd9164a94e205.png)
End-to-end tests are nice since they give us confidence that software works from the end user's perspective. The price we have to pay is the slower feedback time. Now executing the whole workflow takes quite much longer.
[Part 11a **Previous part**](../part11/01-introduction-to-ci-cd.md)[Part 11c **Next part**](../part11/01-deployment.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-getting-started-with-git-hub-actions-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 11](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-part11.md)
- [a Introduction to CI/CD](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-introduction-to-ci-cd.md)
- [Basic needs](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-getting-started-with-git-hub-actions-basic-needs.md)
- [Exercise 11.2.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-getting-started-with-git-hub-actions-exercise-11-2.md)
- [Getting started with workflows](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-getting-started-with-git-hub-actions-getting-started-with-workflows.md)
- [Exercises 11.3-11.4.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-getting-started-with-git-hub-actions-exercises-11-3-11-4.md)
- [Setting up lint, test and build steps](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-getting-started-with-git-hub-actions-setting-up-lint-test-and-build-steps.md)
- [Exercises 11.5.-11.9.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-getting-started-with-git-hub-actions-exercises-11-5-11-9.md)
- [c Deployment](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-deployment.md)
- [d Keeping green](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-keeping-green.md)
- [e Expanding Further](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-expanding-further.md)
- [fullstack content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/58ea21aff878dad5.png)
- [fullstack content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/008659a75648497a.png)
- [part 5](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part5/01-testing-react-apps.md)
- [part 3](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part3/01-deploying-app-to-internet-frontend-production-build.md)
- [in the same repository](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-frontend-and-backend-in-the-same-repository.md)
- [Webpack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-webpack.md)
- [A properly configured Hello World workflow](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/e065dfe5c69ffc04.png)
- [Date and dir content in the workflow](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/b09fce51b5e5bf51.png)
- [Linting to workflow](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/564fe7da0b2496cc.png)
- [here](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part3/01-validation-and-es-lint-lint.md)
- [Lint error fixed](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/0035b2f6cb4215fe.png)
- [tests fail...](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/6e2b146e5b43082f.png)
- [tests fixed](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/53d81741cf4323a3.png)
- [Testing React apps](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part5/01-testing-react-apps.md)
- [part 5](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part5/01-part5.md)
- [here](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part5/01-end-to-end-testing-playwright.md)
- [here](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part5/01-end-to-end-testing-cypress.md)
- [part 5](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part5/01-end-to-end-testing.md)
- [e2e tests](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/f11bd9164a94e205.png)
- [Part 11a **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-introduction-to-ci-cd.md)
- [Part 11c **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part11/01-deployment.md)

--- .taskmaster/templates/example_prd.txt ---
<context>
# Overview  
[Provide a high-level overview of your product here. Explain what problem it solves, who it's for, and why it's valuable.]

# Core Features  
[List and describe the main features of your product. For each feature, include:
- What it does
- Why it's important
- How it works at a high level]

# User Experience  
[Describe the user journey and experience. Include:
- User personas
- Key user flows
- UI/UX considerations]
</context>
<PRD>
# Technical Architecture  
[Outline the technical implementation details:
- System components
- Data models
- APIs and integrations
- Infrastructure requirements]

# Development Roadmap  
[Break down the development process into phases:
- MVP requirements
- Future enhancements
- Do not think about timelines whatsoever -- all that matters is scope and detailing exactly what needs to be build in each phase so it can later be cut up into tasks]

# Logical Dependency Chain
[Define the logical order of development:
- Which features need to be built first (foundation)
- Getting as quickly as possible to something usable/visible front end that works
- Properly pacing and scoping each feature so it is atomic but can also be built upon and improved as development approaches]

# Risks and Mitigations  
[Identify potential risks and how they'll be addressed:
- Technical challenges
- Figuring out the MVP that we can build upon
- Resource constraints]

# Appendix  
[Include any additional information:
- Research findings
- Technical specifications]
</PRD>

--- .taskmaster/templates/example_prd_rpg.txt ---
<rpg-method>
# Repository Planning Graph (RPG) Method - PRD Template

This template teaches you (AI or human) how to create structured, dependency-aware PRDs using the RPG methodology from Microsoft Research. The key insight: separate WHAT (functional) from HOW (structural), then connect them with explicit dependencies.

## Core Principles

1. **Dual-Semantics**: Think functional (capabilities) AND structural (code organization) separately, then map them
2. **Explicit Dependencies**: Never assume - always state what depends on what
3. **Topological Order**: Build foundation first, then layers on top
4. **Progressive Refinement**: Start broad, refine iteratively

## How to Use This Template

- Follow the instructions in each `<instruction>` block
- Look at `<example>` blocks to see good vs bad patterns
- Fill in the content sections with your project details
- The AI reading this will learn the RPG method by following along
- Task Master will parse the resulting PRD into dependency-aware tasks

## Recommended Tools for Creating PRDs

When using this template to **create** a PRD (not parse it), use **code-context-aware AI assistants** for best results:

**Why?** The AI needs to understand your existing codebase to make good architectural decisions about modules, dependencies, and integration points.

**Recommended tools:**
- **Claude Code** (claude-code CLI) - Best for structured reasoning and large contexts
- **Cursor/Windsurf** - IDE integration with full codebase context
- **Gemini CLI** (gemini-cli) - Massive context window for large codebases
- **Codex/Grok CLI** - Strong code generation with context awareness

**Note:** Once your PRD is created, `task-master parse-prd` works with any configured AI model - it just needs to read the PRD text itself, not your codebase.
</rpg-method>

---

<overview>
<instruction>
Start with the problem, not the solution. Be specific about:
- What pain point exists?
- Who experiences it?
- Why existing solutions don't work?
- What success looks like (measurable outcomes)?

Keep this section focused - don't jump into implementation details yet.
</instruction>

## Problem Statement
[Describe the core problem. Be concrete about user pain points.]

## Target Users
[Define personas, their workflows, and what they're trying to achieve.]

## Success Metrics
[Quantifiable outcomes. Examples: "80% task completion via autopilot", "< 5% manual intervention rate"]

</overview>

---

<functional-decomposition>
<instruction>
Now think about CAPABILITIES (what the system DOES), not code structure yet.

Step 1: Identify high-level capability domains
- Think: "What major things does this system do?"
- Examples: Data Management, Core Processing, Presentation Layer

Step 2: For each capability, enumerate specific features
- Use explore-exploit strategy:
  * Exploit: What features are REQUIRED for core value?
  * Explore: What features make this domain COMPLETE?

Step 3: For each feature, define:
- Description: What it does in one sentence
- Inputs: What data/context it needs
- Outputs: What it produces/returns
- Behavior: Key logic or transformations

<example type="good">
Capability: Data Validation
  Feature: Schema validation
    - Description: Validate JSON payloads against defined schemas
    - Inputs: JSON object, schema definition
    - Outputs: Validation result (pass/fail) + error details
    - Behavior: Iterate fields, check types, enforce constraints

  Feature: Business rule validation
    - Description: Apply domain-specific validation rules
    - Inputs: Validated data object, rule set
    - Outputs: Boolean + list of violated rules
    - Behavior: Execute rules sequentially, short-circuit on failure
</example>

<example type="bad">
Capability: validation.js
  (Problem: This is a FILE, not a CAPABILITY. Mixing structure into functional thinking.)

Capability: Validation
  Feature: Make sure data is good
  (Problem: Too vague. No inputs/outputs. Not actionable.)
</example>
</instruction>

## Capability Tree

### Capability: [Name]
[Brief description of what this capability domain covers]

#### Feature: [Name]
- **Description**: [One sentence]
- **Inputs**: [What it needs]
- **Outputs**: [What it produces]
- **Behavior**: [Key logic]

#### Feature: [Name]
- **Description**:
- **Inputs**:
- **Outputs**:
- **Behavior**:

### Capability: [Name]
...

</functional-decomposition>

---

<structural-decomposition>
<instruction>
NOW think about code organization. Map capabilities to actual file/folder structure.

Rules:
1. Each capability maps to a module (folder or file)
2. Features within a capability map to functions/classes
3. Use clear module boundaries - each module has ONE responsibility
4. Define what each module exports (public interface)

The goal: Create a clear mapping between "what it does" (functional) and "where it lives" (structural).

<example type="good">
Capability: Data Validation
  → Maps to: src/validation/
    ├── schema-validator.js      (Schema validation feature)
    ├── rule-validator.js         (Business rule validation feature)
    └── index.js                  (Public exports)

Exports:
  - validateSchema(data, schema)
  - validateRules(data, rules)
</example>

<example type="bad">
Capability: Data Validation
  → Maps to: src/utils.js
  (Problem: "utils" is not a clear module boundary. Where do I find validation logic?)

Capability: Data Validation
  → Maps to: src/validation/everything.js
  (Problem: One giant file. Features should map to separate files for maintainability.)
</example>
</instruction>

## Repository Structure

```
project-root/
├── src/
│   ├── [module-name]/       # Maps to: [Capability Name]
│   │   ├── [file].js        # Maps to: [Feature Name]
│   │   └── index.js         # Public exports
│   └── [module-name]/
├── tests/
└── docs/
```

## Module Definitions

### Module: [Name]
- **Maps to capability**: [Capability from functional decomposition]
- **Responsibility**: [Single clear purpose]
- **File structure**:
  ```
  module-name/
  ├── feature1.js
  ├── feature2.js
  └── index.js
  ```
- **Exports**:
  - `functionName()` - [what it does]
  - `ClassName` - [what it does]

</structural-decomposition>

---

<dependency-graph>
<instruction>
This is THE CRITICAL SECTION for Task Master parsing.

Define explicit dependencies between modules. This creates the topological order for task execution.

Rules:
1. List modules in dependency order (foundation first)
2. For each module, state what it depends on
3. Foundation modules should have NO dependencies
4. Every non-foundation module should depend on at least one other module
5. Think: "What must EXIST before I can build this module?"

<example type="good">
Foundation Layer (no dependencies):
  - error-handling: No dependencies
  - config-manager: No dependencies
  - base-types: No dependencies

Data Layer:
  - schema-validator: Depends on [base-types, error-handling]
  - data-ingestion: Depends on [schema-validator, config-manager]

Core Layer:
  - algorithm-engine: Depends on [base-types, error-handling]
  - pipeline-orchestrator: Depends on [algorithm-engine, data-ingestion]
</example>

<example type="bad">
- validation: Depends on API
- API: Depends on validation
(Problem: Circular dependency. This will cause build/runtime issues.)

- user-auth: Depends on everything
(Problem: Too many dependencies. Should be more focused.)
</example>
</instruction>

## Dependency Chain

### Foundation Layer (Phase 0)
No dependencies - these are built first.

- **[Module Name]**: [What it provides]
- **[Module Name]**: [What it provides]

### [Layer Name] (Phase 1)
- **[Module Name]**: Depends on [[module-from-phase-0], [module-from-phase-0]]
- **[Module Name]**: Depends on [[module-from-phase-0]]

### [Layer Name] (Phase 2)
- **[Module Name]**: Depends on [[module-from-phase-1], [module-from-foundation]]

[Continue building up layers...]

</dependency-graph>

---

<implementation-roadmap>
<instruction>
Turn the dependency graph into concrete development phases.

Each phase should:
1. Have clear entry criteria (what must exist before starting)
2. Contain tasks that can be parallelized (no inter-dependencies within phase)
3. Have clear exit criteria (how do we know phase is complete?)
4. Build toward something USABLE (not just infrastructure)

Phase ordering follows topological sort of dependency graph.

<example type="good">
Phase 0: Foundation
  Entry: Clean repository
  Tasks:
    - Implement error handling utilities
    - Create base type definitions
    - Setup configuration system
  Exit: Other modules can import foundation without errors

Phase 1: Data Layer
  Entry: Phase 0 complete
  Tasks:
    - Implement schema validator (uses: base types, error handling)
    - Build data ingestion pipeline (uses: validator, config)
  Exit: End-to-end data flow from input to validated output
</example>

<example type="bad">
Phase 1: Build Everything
  Tasks:
    - API
    - Database
    - UI
    - Tests
  (Problem: No clear focus. Too broad. Dependencies not considered.)
</example>
</instruction>

## Development Phases

### Phase 0: [Foundation Name]
**Goal**: [What foundational capability this establishes]

**Entry Criteria**: [What must be true before starting]

**Tasks**:
- [ ] [Task name] (depends on: [none or list])
  - Acceptance criteria: [How we know it's done]
  - Test strategy: [What tests prove it works]

- [ ] [Task name] (depends on: [none or list])

**Exit Criteria**: [Observable outcome that proves phase complete]

**Delivers**: [What can users/developers do after this phase?]

---

### Phase 1: [Layer Name]
**Goal**:

**Entry Criteria**: Phase 0 complete

**Tasks**:
- [ ] [Task name] (depends on: [[tasks-from-phase-0]])
- [ ] [Task name] (depends on: [[tasks-from-phase-0]])

**Exit Criteria**:

**Delivers**:

---

[Continue with more phases...]

</implementation-roadmap>

---

<test-strategy>
<instruction>
Define how testing will be integrated throughout development (TDD approach).

Specify:
1. Test pyramid ratios (unit vs integration vs e2e)
2. Coverage requirements
3. Critical test scenarios
4. Test generation guidelines for Surgical Test Generator

This section guides the AI when generating tests during the RED phase of TDD.

<example type="good">
Critical Test Scenarios for Data Validation module:
  - Happy path: Valid data passes all checks
  - Edge cases: Empty strings, null values, boundary numbers
  - Error cases: Invalid types, missing required fields
  - Integration: Validator works with ingestion pipeline
</example>
</instruction>

## Test Pyramid

```
        /\
       /E2E\       ← [X]% (End-to-end, slow, comprehensive)
      /------\
     /Integration\ ← [Y]% (Module interactions)
    /------------\
   /  Unit Tests  \ ← [Z]% (Fast, isolated, deterministic)
  /----------------\
```

## Coverage Requirements
- Line coverage: [X]% minimum
- Branch coverage: [X]% minimum
- Function coverage: [X]% minimum
- Statement coverage: [X]% minimum

## Critical Test Scenarios

### [Module/Feature Name]
**Happy path**:
- [Scenario description]
- Expected: [What should happen]

**Edge cases**:
- [Scenario description]
- Expected: [What should happen]

**Error cases**:
- [Scenario description]
- Expected: [How system handles failure]

**Integration points**:
- [What interactions to test]
- Expected: [End-to-end behavior]

## Test Generation Guidelines
[Specific instructions for Surgical Test Generator about what to focus on, what patterns to follow, project-specific test conventions]

</test-strategy>

---

<architecture>
<instruction>
Describe technical architecture, data models, and key design decisions.

Keep this section AFTER functional/structural decomposition - implementation details come after understanding structure.
</instruction>

## System Components
[Major architectural pieces and their responsibilities]

## Data Models
[Core data structures, schemas, database design]

## Technology Stack
[Languages, frameworks, key libraries]

**Decision: [Technology/Pattern]**
- **Rationale**: [Why chosen]
- **Trade-offs**: [What we're giving up]
- **Alternatives considered**: [What else we looked at]

</architecture>

---

<risks>
<instruction>
Identify risks that could derail development and how to mitigate them.

Categories:
- Technical risks (complexity, unknowns)
- Dependency risks (blocking issues)
- Scope risks (creep, underestimation)
</instruction>

## Technical Risks
**Risk**: [Description]
- **Impact**: [High/Medium/Low - effect on project]
- **Likelihood**: [High/Medium/Low]
- **Mitigation**: [How to address]
- **Fallback**: [Plan B if mitigation fails]

## Dependency Risks
[External dependencies, blocking issues]

## Scope Risks
[Scope creep, underestimation, unclear requirements]

</risks>

---

<appendix>
## References
[Papers, documentation, similar systems]

## Glossary
[Domain-specific terms]

## Open Questions
[Things to resolve during development]
</appendix>

---

<task-master-integration>
# How Task Master Uses This PRD

When you run `task-master parse-prd <file>.txt`, the parser:

1. **Extracts capabilities** → Main tasks
   - Each `### Capability:` becomes a top-level task

2. **Extracts features** → Subtasks
   - Each `#### Feature:` becomes a subtask under its capability

3. **Parses dependencies** → Task dependencies
   - `Depends on: [X, Y]` sets task.dependencies = ["X", "Y"]

4. **Orders by phases** → Task priorities
   - Phase 0 tasks = highest priority
   - Phase N tasks = lower priority, properly sequenced

5. **Uses test strategy** → Test generation context
   - Feeds test scenarios to Surgical Test Generator during implementation

**Result**: A dependency-aware task graph that can be executed in topological order.

## Why RPG Structure Matters

Traditional flat PRDs lead to:
- ❌ Unclear task dependencies
- ❌ Arbitrary task ordering
- ❌ Circular dependencies discovered late
- ❌ Poorly scoped tasks

RPG-structured PRDs provide:
- ✅ Explicit dependency chains
- ✅ Topological execution order
- ✅ Clear module boundaries
- ✅ Validated task graph before implementation

## Tips for Best Results

1. **Spend time on dependency graph** - This is the most valuable section for Task Master
2. **Keep features atomic** - Each feature should be independently testable
3. **Progressive refinement** - Start broad, use `task-master expand` to break down complex tasks
4. **Use research mode** - `task-master parse-prd --research` leverages AI for better task generation
</task-master-integration>


--- .archived/data/part7/01-class-components-miscellaneous.md ---
---{
  "title": "Class components, Miscellaneous",
  "source_url": "https://fullstackopen.com/en/part7/class_components_miscellaneous",
  "crawl_timestamp": "2025-10-04T19:16:54Z",
  "checksum": "38b3ab3fa3695e60a3409c84e115509895a53d8e91392a0e6832df1627437c45"
}
---[Skip to content](../part7/01-class-components-miscellaneous-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 7](../part7/01-part7.md)
Class components, Miscellaneous
[a React Router](../part7/01-react-router.md)[b Custom hooks](../part7/01-custom-hooks.md)[c More about styles](../part7/01-more-about-styles.md)[d Webpack](../part7/01-webpack.md)
e Class components, Miscellaneous

- [Class Components](../part7/01-class-components-miscellaneous-class-components.md)
- [Organization of code in React application](../part7/01-class-components-miscellaneous-organization-of-code-in-react-application.md)
- [Frontend and backend in the same repository](../part7/01-class-components-miscellaneous-frontend-and-backend-in-the-same-repository.md)
- [Changes on the server](../part7/01-class-components-miscellaneous-changes-on-the-server.md)
- [Virtual DOM](../part7/01-class-components-miscellaneous-virtual-dom.md)
- [On the role of React in applications](../part7/01-class-components-miscellaneous-on-the-role-of-react-in-applications.md)
- [React/node-application security](../part7/01-class-components-miscellaneous-react-node-application-security.md)
- [Current trends](../part7/01-class-components-miscellaneous-current-trends.md)
- [Useful libraries and interesting links](../part7/01-class-components-miscellaneous-useful-libraries-and-interesting-links.md)


[f Exercises: extending the bloglist](../part7/01-exercises-extending-the-bloglist.md)
e
# Class components, Miscellaneous
### Class Components
During the course, we have only used React components having been defined as Javascript functions. This was not possible without the
It is beneficial to at least be familiar with Class Components to some extent since the world contains a lot of old React code, which will probably never be completely rewritten using the updated syntax.
Let's get to know the main features of Class Components by producing yet another very familiar anecdote application. We store the anecdotes in the file _db.json_ using _json-server_. The contents of the file are lifted from
The initial version of the Class Component looks like this

```
import React from 'react'

class App extends React.Component {
  constructor(props) {
    super(props)
  }

  render() {
    return (
      <div>
        <h1>anecdote of the day</h1>
      </div>
    )
  }
}

export default Appcopy
```

The component now has a
Let's define a state for the list of anecdotes and the currently-visible anecdote. In contrast to when using the

```
class App extends React.Component {
  constructor(props) {
    super(props)

    this.state = {      anecdotes: [],      current: 0    }  }

  render() {
    if (this.state.anecdotes.length === 0) {      return <div>no anecdotes...</div>    }
    return (
      <div>
        <h1>anecdote of the day</h1>
        <div>          {this.state.anecdotes[this.state.current].content}        </div>        <button>next</button>      </div>
    )
  }
}copy
```

The component state is in the instance variable _this.state_. The state is an object having two properties. _this.state.anecdotes_ is the list of anecdotes and _this.state.current_ is the index of the currently-shown anecdote.
In Functional components, the right place for fetching data from a server is inside an
The

```
class App extends React.Component {
  constructor(props) {
    super(props)

    this.state = {
      anecdotes: [],
      current: 0
    }
  }

  componentDidMount = () => {    axios.get('http://localhost:3001/anecdotes').then(response => {      this.setState({ anecdotes: response.data })    })  }
  // ...
}copy
```

The callback function of the HTTP request updates the component state using the method _current_ remains unchanged.
Calling the method setState always triggers the rerender of the Class Component, i.e. calling the method _render_.
We'll finish off the component with the ability to change the shown anecdote. The following is the code for the entire component with the addition highlighted:

```
class App extends React.Component {
  constructor(props) {
    super(props)

    this.state = {
      anecdotes: [],
      current: 0
    }
  }

  componentDidMount = () => {
    axios.get('http://localhost:3001/anecdotes').then(response => {
      this.setState({ anecdotes: response.data })
    })
  }

  handleClick = () => {    const current = Math.floor(      Math.random() * this.state.anecdotes.length    )    this.setState({ current })  }
  render() {
    if (this.state.anecdotes.length === 0 ) {
      return <div>no anecdotes...</div>
    }

    return (
      <div>
        <h1>anecdote of the day</h1>
        <div>{this.state.anecdotes[this.state.current].content}</div>
        <button onClick={this.handleClick}>next</button>      </div>
    )
  }
}copy
```

For comparison, here is the same application as a Functional component:

```
const App = () => {
  const [anecdotes, setAnecdotes] = useState([])
  const [current, setCurrent] = useState(0)

  useEffect(() =>{
    axios.get('http://localhost:3001/anecdotes').then(response => {
      setAnecdotes(response.data)
    })
  },[])

  const handleClick = () => {
    setCurrent(Math.round(Math.random() * (anecdotes.length - 1)))
  }

  if (anecdotes.length === 0) {
    return <div>no anecdotes...</div>
  }

  return (
    <div>
      <h1>anecdote of the day</h1>
      <div>{anecdotes[current].content}</div>
      <button onClick={handleClick}>next</button>
    </div>
  )
}copy
```

In the case of our example, the differences were minor. The biggest difference between Functional components and Class components is mainly that the state of a Class component is a single object, and that the state is updated using the method _setState_ , while in Functional components the state can consist of multiple different variables, with all of them having their own update function.
In some more advanced use cases, the effect hook offers a considerably better mechanism for controlling side effects compared to the lifecycle methods of Class Components.
A notable benefit of using Functional components is not having to deal with the self-referencing _this_ reference of the Javascript class.
In my opinion, and the opinion of many others, Class Components offer little benefit over Functional components enhanced with hooks, except for the so-called
When writing fresh code,
### Organization of code in React application
In most applications, we followed the principle by which components were placed in the directory _components_ , reducers were placed in the directory _reducers_ , and the code responsible for communicating with the server was placed in the directory _services_. This way of organizing fits a smaller application just fine, but as the amount of components increases, better solutions are needed. There is no one correct way to organize a project. The article
### Frontend and backend in the same repository
During the course, we have created the frontend and backend into separate repositories. This is a very typical approach. However, we did the deployment by [copying](../part3/01-deploying-app-to-internet-serving-static-files-from-the-backend.md) the bundled frontend code into the backend repository. A possibly better approach would have been to deploy the frontend code separately.
Sometimes, there may be a situation where the entire application is to be put into a single repository. In this case, a common approach is to put the _package.json_ and _webpack.config.js_ in the root directory, as well as place the frontend and backend code into their own directories, e.g. _client_ and _server_.
### Changes on the server
If there are changes in the state on the server, e.g. when new blogs are added by other users to the bloglist service, the React frontend we implemented during this course will not notice these changes until the page reloads. A similar situation arises when the frontend triggers a time-consuming computation in the backend. How do we reflect the results of the computation to the frontend?
One way is to execute
A more sophisticated way is to use
WebSockets is an API provided by the browser, which is not yet fully supported on all browsers:
![caniuse chart showing websockets not usable by all yet](../assets/d65cc8f79a90c770.png)
Instead of directly using the WebSocket API, it is advisable to use the _fallback_ options in case the browser does not have full support for WebSockets.
In [part 8](../part8/01-part8.md), our topic is GraphQL, which provides a nice mechanism for notifying clients when there are changes in the backend data.
### Virtual DOM
The concept of the Virtual DOM often comes up when discussing React. What is it all about? As mentioned in [part 0](../part0/01-fundamentals-of-web-apps-document-object-model-or-dom.md), browsers provide a
When a software developer uses React, they rarely or never directly manipulate the DOM. The function defining the React component returns a set of

```
const element = <h1>Hello, world</h1>copy
```

they are also just JavaScript-based React elements at their core.
The React elements defining the appearance of the components of the application make up the
With the help of the

```
ReactDOM.createRoot(document.getElementById('root')).render(<App />)copy
```

When the state of the application changes, a _new virtual DOM_ gets defined by the components. React has the previous version of the virtual DOM in memory and instead of directly rendering the new virtual DOM using the DOM API, React computes the optimal way to update the DOM (remove, add or modify elements in the DOM) such that the DOM reflects the new virtual DOM.
### On the role of React in applications
In the material, we may not have put enough emphasis on the fact that React is primarily a library for managing the creation of views for an application. If we look at the traditional _View_. React has a more narrow area of application than e.g. _framework_ , but a _library_.
In small applications, data handled by the application is stored in the state of the React components, so in this scenario, the state of the components can be thought of as _models_ of an MVC architecture.
However, MVC architecture is not usually mentioned when talking about React applications. Furthermore, if we are using Redux, then the applications follow the [Redux Thunk](../part6/01-communicating-with-server-in-a-redux-application-asynchronous-actions-and-redux-thunk.md) familiar from part 6, then the business logic can be almost completely separated from the React code.
Because both React and
Part 6 [last chapter](../part6/01-react-query-use-reducer-and-the-context.md) covers the newer trends of state management in React. React's hook functions _useReducer_ and _useContext_ provide a kind of lightweight version of Redux. _React Query_ , on the other hand, is a library that solves many of the problems associated with handling state on the server, eliminating the need for a React application to store data retrieved from the server directly in frontend state.
### React/node-application security
So far during the course, we have not touched on information security much. We do not have much time for this now either, but fortunately, University of Helsinki has a MOOC course
We will, however, take a look at some things specific to this course.
The Open Web Application Security Project, otherwise known as
At the top of the list, we find _injection_ , which means that e.g. text sent using a form in an application is interpreted completely differently than the software developer had intended. The most famous type of injection is probably
For example, imagine that the following SQL query is executed in a vulnerable application:

```
let query = "SELECT * FROM Users WHERE name = '" + userName + "';"copy
```

Now let's assume that a malicious user _Arto Hellas_ would define their name as

```
Arto Hell-as'; DROP TABLE Users; --copy
```

so that the name would contain a single quote `'`, which is the beginning and end character of a SQL string. As a result of this, two SQL operations would be executed, the second of which would destroy the database table _Users_ :

```
SELECT * FROM Users WHERE name = 'Arto Hell-as'; DROP TABLE Users; --'copy
```

SQL injections are prevented using `?`):

```
execute("SELECT * FROM Users WHERE name = ?", [userName])copy
```

Injection attacks are also possible in NoSQL databases. However, mongoose prevents them by
_Cross-site scripting (XSS)_ is an attack where it is possible to inject malicious JavaScript code into a legitimate web application. The malicious code would then be executed in the browser of the victim. If we try to inject the following into e.g. the notes application:

```
<script>
  alert('Evil XSS attack')
</script>copy
```

the code is not executed, but is only rendered as 'text' on the page:
![browser showing notes with XSS attempt](../assets/fbaba65b829eecbf.png)
since React
One needs to remain vigilant when using libraries; if there are security updates to those libraries, it is advisable to update those libraries in one's applications. Security updates for Express are found in the
You can check how up-to-date your dependencies are using the command

```
npm outdated --depth 0copy
```

The one-year-old project that is used in [part 9](../part9/01-part9.md) of this course already has quite a few outdated dependencies:
![npm outdated output of patientor](../assets/51c34854bf75144e.png)
The dependencies can be brought up to date by updating the file _package.json_. The best way to do that is by using a tool called _npm-check-updates_. It can be installed globally by running the command:

```
npm install -g npm-check-updatescopy
```

Using this tool, the up-to-dateness of dependencies is checked in the following way:

```
$ npm-check-updates
Checking ...\ultimate-hooks\package.json
[====================] 9/9 100%

 @testing-library/react       ^13.0.0  →  ^13.1.1
 @testing-library/user-event  ^14.0.4  →  ^14.1.1
 react-scripts                  5.0.0  →    5.0.1

Run ncu -u to upgrade package.jsoncopy
```

The file _package.json_ is brought up to date by running the command _ncu -u_.

```
$ ncu -u
Upgrading ...\ultimate-hooks\package.json
[====================] 9/9 100%

 @testing-library/react       ^13.0.0  →  ^13.1.1
 @testing-library/user-event  ^14.0.4  →  ^14.1.1
 react-scripts                  5.0.0  →    5.0.1

Run npm install to install new versions.copy
```

Then it is time to update the dependencies by running the command _npm install_. However, old versions of the dependencies are not necessarily a security risk.
The npm
Running _npm audit_ on the same project, it prints a long list of complaints and suggested fixes. Below is a part of the report:

```
$ patientor npm audit

... many lines removed ...

url-parse  <1.5.2
Severity: moderate
Open redirect in url-parse - https://github.com/advisories/GHSA-hh27-ffr2-f2jc
fix available via `npm audit fix`
node_modules/url-parse

ws  6.0.0 - 6.2.1 || 7.0.0 - 7.4.5
Severity: moderate
ReDoS in Sec-Websocket-Protocol header - https://github.com/advisories/GHSA-6fc8-4gx4-v693
ReDoS in Sec-Websocket-Protocol header - https://github.com/advisories/GHSA-6fc8-4gx4-v693
fix available via `npm audit fix`
node_modules/webpack-dev-server/node_modules/ws
node_modules/ws

120 vulnerabilities (102 moderate, 16 high, 2 critical)

To address issues that do not require attention, run:
  npm audit fix

To address all issues (including breaking changes), run:
  npm audit fix --forcecopy
```

After only one year, the code is full of small security threats. Luckily, there are only 2 critical threats. Let's run _npm audit fix_ as the report suggests:

```
$ npm audit fix

+ mongoose@5.9.1
added 19 packages from 8 contributors, removed 8 packages and updated 15 packages in 7.325s
fixed 354 of 416 vulnerabilities in 20047 scanned packages
  1 package update for 62 vulns involved breaking changes
  (use `npm audit fix --force` to install breaking changes; or refer to `npm audit` for steps to fix these manually)copy
```

62 threats remain because, by default, _audit fix_ does not update dependencies if their _major_ version number has increased. Updating these dependencies could lead to the whole application breaking down.
The source for the critical bug is the library

```
immer  <9.0.6
Severity: critical
Prototype Pollution in immer - https://github.com/advisories/GHSA-33f9-j839-rf8h
fix available via `npm audit fix --force`
Will install react-scripts@5.0.0, which is a breaking changecopy
```

Running _npm audit fix --force_ would upgrade the library version but would also upgrade the library _react-scripts_ and that would potentially break down the development environment. So we will leave the library upgrades for later...
One of the threats mentioned in the list from OWASP is _Broken Authentication_ and the related _Broken Access Control_. The token-based authentication we have been using is fairly robust if the application is being used on the traffic-encrypting HTTPS protocol. When implementing access control, one should e.g. remember to not only check a user's identity in the browser but also on the server. Bad security would be to prevent some actions to be taken only by hiding the execution options in the code of the browser.
On Mozilla's MDN, there is a very good
![screenshot of website security from MDN](../assets/96747bbbe81bc425.png)
The documentation for Express includes a section on security:
Using the ESlint
### Current trends
Finally, let's take a look at some technology of tomorrow (or, actually, already today), and the directions in which Web development is heading.
#### Typed versions of JavaScript
Sometimes, the [PropTypes](../part5/01-props-children-and-proptypes-prop-types.md): a mechanism which enables one to enforce type-checking for props passed to React components.
Lately, there has been a notable uplift in the interest in [part 9](../part9/01-part9.md).
#### Server-side rendering, isomorphic applications and universal code
The browser is not the only domain where components defined using React can be rendered. The rendering can also be done on the _server-side rendering_.
One motivation for server-side rendering is Search Engine Optimization (SEO). Search engines have traditionally been very bad at recognizing JavaScript-rendered content. However, the tide might be turning, e.g. take a look at
Of course, server-side rendering is not anything specific to React or even JavaScript. Using the same programming language throughout the stack in theory simplifies the execution of the concept because the same code can be run on both the front- and backend.
Along with server-side rendering, there has been talk of so-called _isomorphic applications_ and _universal code_ , although there has been some debate about their definitions. According to some
React and Node provide a desirable option for implementing an isomorphic application as universal code.
Writing universal code directly using React is currently still pretty cumbersome. Lately, a library called
#### Progressive web apps
Lately, people have started using the term
In short, we are talking about web applications working as well as possible on every platform and taking advantage of the best parts of those platforms. The smaller screen of mobile devices must not hamper the usability of the application. PWAs should also work flawlessly in offline mode or with a slow internet connection. On mobile devices, they must be installable just like any other application. All the network traffic in a PWA should be encrypted.
#### Microservice architecture
During this course, we have only scratched the surface of the server end of things. In our applications, we had a _monolithic_ backend, meaning one application making up a whole and running on a single server, serving only a few API endpoints.
As the application grows, the monolithic backend approach starts turning problematic both in terms of performance and maintainability.
A
For example, the bloglist application could consist of two services: one handling the user and another taking care of the blogs. The responsibility of the user service would be user registration and user authentication, while the blog service would take care of operations related to the blogs.
The image below visualizes the difference between the structure of an application based on a microservice architecture and one based on a more traditional monolithic structure:
![microservices vs traditional approach diagram](../assets/614123fd317b5dde.png)
The role of the frontend (enclosed by a square in the picture) does not differ much between the two models. There is often a so-called
Microservice architectures emerged and evolved for the needs of large internet-scale applications. The trend was set by Amazon far before the appearance of the term microservice. The critical starting point was an email sent to all employees in 2002 by Amazon CEO Jeff Bezos:
> All teams will henceforth expose their data and functionality through service interfaces.
> Teams must communicate with each other through these interfaces.
> There will be no other form of inter-process communication allowed: no direct linking, no direct reads of another team’s data store, no shared-memory model, no back-doors whatsoever. The only communication allowed is via service interface calls over the network.
> It doesn’t matter what technology you use.
> All service interfaces, without exception, must be designed from the ground up to be externalize-able. That is to say, the team must plan and design to be able to expose the interface to developers in the outside world.
> No exceptions.
> Anyone who doesn’t do this will be fired. Thank you; have a nice day!
Nowadays, one of the biggest forerunners in the use of microservices is
The use of microservices has steadily been gaining hype to be kind of a
Unfortunately, we cannot dive deeper into this important topic during this course. Even a cursory look at the topic would require at least 5 more weeks.
#### Serverless
After the release of Amazon's
The main thing about lambda, and nowadays also Google's _the execution of individual functions_ in the cloud. Before, the smallest executable unit in the cloud was a single _process_ , e.g. a runtime environment running a Node backend.
E.g. Using Amazon's
Serverless is not about there not being a server in applications, but about how the server is defined. Software developers can shift their programming efforts to a higher level of abstraction as there is no longer a need to programmatically define the routing of HTTP requests, database relations, etc., since the cloud infrastructure provides all of this. Cloud functions also lend themselves to creating a well-scaling system, e.g. Amazon's Lambda can execute a massive amount of cloud functions per second. All of this happens automatically through the infrastructure and there is no need to initiate new servers, etc.
### Useful libraries and interesting links
The JavaScript developer community has produced a large variety of useful libraries. If you are developing anything more substantial, it is worth it to check if existing solutions are already available. Below are listed some libraries recommended by trustworthy parties.
If your application has to handle complicated data, [part 4](../part4/01-structure-of-backend-application-introduction-to-testing-exercises-4-3-4-7.md), is a good library to use. If you prefer the functional programming style, you might consider using
If you are handling times and dates,
If you have complex forms in your apps, have a look at whether
If your application displays graphs, there are multiple options to choose from. Both
The [remember](../part6/01-flux-architecture-and-redux-pure-functions-immutable.md) from part 6, reducers must be pure functions, meaning they must not modify the store's state but instead have to replace it with a new one when a change occurs.
[Redux Thunk](../part6/01-communicating-with-server-in-a-redux-application-asynchronous-actions-and-redux-thunk.md) familiar from part 6. Some embrace the hype and like it. I don't.
For single-page applications, the gathering of analytics data on the interaction between the users and the page is
You can take advantage of your React know-how when developing mobile applications using Facebook's extremely popular [part 10](../part10/01-part10.md) of the course.
When it comes to the tools used for the management and bundling of JavaScript projects, the community has been very fickle. Best practices have changed rapidly (the years are approximations, nobody remembers that far back in the past):

- 2011
- 2012
- 2013-14
- 2012-14
- 2015-2023
- 2023-


Hipsters seemed to have lost their interest in tool development after webpack started to dominate the markets. A few years ago,
The site
If you know some recommendable links or libraries, make a pull request!
[Part 7d **Previous part**](../part7/01-webpack.md)[Part 7f **Next part**](../part7/01-exercises-extending-the-bloglist.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 7](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-part7.md)
- [a React Router](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-react-router.md)
- [b Custom hooks](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-custom-hooks.md)
- [c More about styles](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-more-about-styles.md)
- [d Webpack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-webpack.md)
- [Class Components](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-class-components.md)
- [Organization of code in React application](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-organization-of-code-in-react-application.md)
- [Frontend and backend in the same repository](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-frontend-and-backend-in-the-same-repository.md)
- [Changes on the server](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-changes-on-the-server.md)
- [Virtual DOM](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-virtual-dom.md)
- [On the role of React in applications](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-on-the-role-of-react-in-applications.md)
- [React/node-application security](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-react-node-application-security.md)
- [Current trends](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-current-trends.md)
- [Useful libraries and interesting links](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-class-components-miscellaneous-useful-libraries-and-interesting-links.md)
- [f Exercises: extending the bloglist](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-exercises-extending-the-bloglist.md)
- [copying](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part3/01-deploying-app-to-internet-serving-static-files-from-the-backend.md)
- [caniuse chart showing websockets not usable by all yet](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/d65cc8f79a90c770.png)
- [part 8](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part8/01-part8.md)
- [part 0](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part0/01-fundamentals-of-web-apps-document-object-model-or-dom.md)
- [Redux Thunk](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-communicating-with-server-in-a-redux-application-asynchronous-actions-and-redux-thunk.md)
- [last chapter](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-react-query-use-reducer-and-the-context.md)
- [browser showing notes with XSS attempt](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/fbaba65b829eecbf.png)
- [part 9](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-part9.md)
- [npm outdated output of patientor](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/51c34854bf75144e.png)
- [screenshot of website security from MDN](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/96747bbbe81bc425.png)
- [PropTypes](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part5/01-props-children-and-proptypes-prop-types.md)
- [microservices vs traditional approach diagram](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/614123fd317b5dde.png)
- [part 4](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part4/01-structure-of-backend-application-introduction-to-testing-exercises-4-3-4-7.md)
- [remember](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-pure-functions-immutable.md)
- [part 10](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-part10.md)
- [Part 7d **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-webpack.md)
- [Part 7f **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part7/01-exercises-extending-the-bloglist.md)

--- .archived/data/part2/01-rendering-a-collection-modules.md ---
---{
  "title": "Rendering a collection, modules",
  "source_url": "https://fullstackopen.com/en/part2/rendering_a_collection_modules",
  "crawl_timestamp": "2025-10-04T19:16:15Z",
  "checksum": "8ad5a2c701ded5b4de5b993949e7e490d1b6d121a46a74af190d90134b1b8daf"
}
---[Skip to content](../part2/01-rendering-a-collection-modules-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 2](../part2/01-part2.md)
Rendering a collection, modules
a Rendering a collection, modules

- [console.log](../part2/01-rendering-a-collection-modules-console-log.md)
- [Protip: Visual Studio Code snippets](../part2/01-rendering-a-collection-modules-protip-visual-studio-code-snippets.md)
- [JavaScript Arrays](../part2/01-rendering-a-collection-modules-java-script-arrays.md)
- [Event Handlers Revisited](../part2/01-rendering-a-collection-modules-event-handlers-revisited.md)
- [Rendering Collections](../part2/01-rendering-a-collection-modules-rendering-collections.md)
- [Key-attribute](../part2/01-rendering-a-collection-modules-key-attribute.md)
- [Map](../part2/01-rendering-a-collection-modules-map.md)
- [Anti-pattern: Array Indexes as Keys](../part2/01-rendering-a-collection-modules-anti-pattern-array-indexes-as-keys.md)
- [Refactoring Modules](../part2/01-rendering-a-collection-modules-refactoring-modules.md)
- [When the Application Breaks](../part2/01-rendering-a-collection-modules-when-the-application-breaks.md)
- [Web developer's oath](../part2/01-rendering-a-collection-modules-web-developers-oath.md)
- [Exercises 2.1.-2.5.](../part2/01-rendering-a-collection-modules-exercises-2-1-2-5.md)


[b Forms](../part2/01-forms.md)[c Getting data from server](../part2/01-getting-data-from-server.md)[d Altering data in server](../part2/01-altering-data-in-server.md)[e Adding styles to React app](../part2/01-adding-styles-to-react-app.md)
a
# Rendering a collection, modules
Before starting a new part, let's recap some of the topics that proved difficult last year.
### console.log
**_What's the difference between an experienced JavaScript programmer and a rookie? The experienced one uses console.log 10-100 times more._**
Paradoxically, this seems to be true even though a rookie programmer would need _console.log_ (or any debugging method) more than an experienced one.
When something does not work, don't just guess what's wrong. Instead, log or use some other way of debugging.
**NB** As explained in part 1, when you use the command _console.log_ for debugging, don't concatenate things 'the Java way' with a plus. Instead of writing:

```
console.log('props value is ' + props)copy
```

separate the things to be printed with a comma:

```
console.log('props value is', props)copy
```

If you concatenate an object with a string and log it to the console (like in our first example), the result will be pretty useless:

```
props value is [object Object]copy
```

On the contrary, when you pass objects as distinct arguments separated by commas to _console.log_ , like in our second example above, the content of the object is printed to the developer console as strings that are insightful. If necessary, read more about [debugging React applications](../part1/01-a-more-complex-state-debugging-react-apps-debugging-react-applications.md).
### Protip: Visual Studio Code snippets
With Visual Studio Code it's easy to create 'snippets', i.e., shortcuts for quickly generating commonly re-used portions of code, much like how 'sout' works in Netbeans.
Instructions for creating snippets can be found
Useful, ready-made snippets can also be found as VS Code plugins, in the
The most important snippet is the one for the _console.log()_ command, for example, _clog_. This can be created like so:

```
{
  "console.log": {
    "prefix": "clog",
    "body": [
      "console.log('$1')",
    ],
    "description": "Log output to console"
  }
}copy
```

Debugging your code using _console.log()_ is so common that Visual Studio Code has that snippet built in. To use it, type _log_ and hit Tab to autocomplete. More fully featured _console.log()_ snippet extensions can be found in the
### JavaScript Arrays
From here on out, we will be using the functional programming operators of the JavaScript _find_ , _filter_ , and _map_ - all of the time.
If operating arrays with functional operators feels foreign to you, it is worth watching at least the first three parts of the YouTube video series
### Event Handlers Revisited
Based on last year's course, event handling has proved to be difficult.
It's worth reading the revision chapter at the end of the previous part - [event handlers revisited](../part1/01-a-more-complex-state-debugging-react-apps-event-handling-revisited.md) - if it feels like your own knowledge on the topic needs some brushing up.
Passing event handlers to the child components of the _App_ component has raised some questions. A small revision on the topic can be found [here](../part1/01-a-more-complex-state-debugging-react-apps-passing-event-handlers-to-child-components.md).
### Rendering Collections
Now, we will build the frontend, or the user interface (the part users see in their browser), using React, similar to the example application from [part 0](../part0/01-part0.md).
Let's start with the following (the file _App.jsx_):

```
const App = (props) => {
  const { notes } = props

  return (
    <div>
      <h1>Notes</h1>
      <ul>
        <li>{notes[0].content}</li>
        <li>{notes[1].content}</li>
        <li>{notes[2].content}</li>
      </ul>
    </div>
  )
}

export default Appcopy
```

The file _main.jsx_ looks like this:

```
import ReactDOM from 'react-dom/client'
import App from './App'

const notes = [
  {
    id: 1,
    content: 'HTML is easy',
    important: true
  },
  {
    id: 2,
    content: 'Browser can execute only JavaScript',
    important: false
  },
  {
    id: 3,
    content: 'GET and POST are the most important methods of HTTP protocol',
    important: true
  }
]

ReactDOM.createRoot(document.getElementById('root')).render(
  <App notes={notes} />
)copy
```

Every note contains its textual content, a _boolean_ value for marking whether the note has been categorized as important or not, and also a unique _id_.
The example above works due to the fact that there are exactly three notes in the array.
A single note is rendered by accessing the objects in the array by referring to a hard-coded index number:

```
<li>{notes[1].content}</li>copy
```

This is, of course, not practical. We can improve on this by generating React elements from the array objects using the

```
notes.map(note => <li>{note.content}</li>)copy
```

The result is an array of _li_ elements.

```
[
  <li>HTML is easy</li>,
  <li>Browser can execute only JavaScript</li>,
  <li>GET and POST are the most important methods of HTTP protocol</li>,
]copy
```

Which can then be placed inside _ul_ tags:

```
const App = (props) => {
  const { notes } = props

  return (
    <div>
      <h1>Notes</h1>
      <ul>        {notes.map(note => <li>{note.content}</li>)}      </ul>    </div>
  )
}copy
```

Because the code generating the _li_ tags is JavaScript, it must be wrapped in curly braces in a JSX template just like all other JavaScript code.
We will also make the code more readable by separating the arrow function's declaration across multiple lines:

```
const App = (props) => {
  const { notes } = props

  return (
    <div>
      <h1>Notes</h1>
      <ul>
        {notes.map(note => 
          <li>            {note.content}          </li>        )}
      </ul>
    </div>
  )
}copy
```

### Key-attribute
Even though the application seems to be working, there is a nasty warning in the console:
![unique key prop console error](../assets/da0e784e70c1376d.png)
As the linked _map_ method, must each have a unique key value: an attribute called _key_.
Let's add the keys:

```
const App = (props) => {
  const { notes } = props

  return (
    <div>
      <h1>Notes</h1>
      <ul>
        {notes.map(note => 
          <li key={note.id}>            {note.content}
          </li>
        )}
      </ul>
    </div>
  )
}copy
```

And the error message disappears.
React uses the key attributes of objects in an array to determine how to update the view generated by a component when the component is re-rendered. More about this is in the
### Map
Understanding how the array method
The application contains an array called _notes_ :

```
const notes = [
  {
    id: 1,
    content: 'HTML is easy',
    important: true
  },
  {
    id: 2,
    content: 'Browser can execute only JavaScript',
    important: false
  },
  {
    id: 3,
    content: 'GET and POST are the most important methods of HTTP protocol',
    important: true
  }
]copy
```

Let's pause for a moment and examine how _map_ works.
If the following code is added to, let's say, the end of the file:

```
const result = notes.map(note => note.id)
console.log(result)copy
```

_[1, 2, 3]_ will be printed to the console. _map_ always creates a new array, the elements of which have been created from the elements of the original array by _mapping_ : using the function given as a parameter to the _map_ method.
The function is

```
note => note.idcopy
```

Which is an arrow function written in compact form. The full form would be:

```
(note) => {
  return note.id
}copy
```

The function gets a note object as a parameter and _returns_ the value of its _id_ field.
Changing the command to:

```
const result = notes.map(note => note.content)copy
```

will give you an array containing the contents of the notes.
This is already pretty close to the React code we used:

```
notes.map(note =>
  <li key={note.id}>
    {note.content}
  </li>
)copy
```

which generates an _li_ tag containing the contents of the note from each note object.
Because the function parameter passed to the _map_ method -

```
note => <li key={note.id}>{note.content}</li>copy
```

- is used to create view elements, the value of the variable must be rendered inside curly braces. Try to see what happens if the braces are removed.
The use of curly braces will cause some pain in the beginning, but you will get used to them soon enough. The visual feedback from React is immediate.

### Anti-pattern: Array Indexes as Keys
We could have made the error message on our console disappear by using the array indexes as keys. The indexes can be retrieved by passing a second parameter to the callback function of the _map_ method:

```
notes.map((note, i) => ...)copy
```

When called like this, _i_ is assigned the value of the index of the position in the array where the note resides.
As such, one way to define the row generation without getting errors is:

```
<ul>
  {notes.map((note, i) => 
    <li key={i}>
      {note.content}
    </li>
  )}
</ul>copy
```

This is, however, **not recommended** and can create undesired problems even if it seems to be working just fine.
Read more about this in
### Refactoring Modules
Let's tidy the code up a bit. We are only interested in the field _notes_ of the props, so let's retrieve that directly using

```
const App = ({ notes }) => {  return (
    <div>
      <h1>Notes</h1>
      <ul>
        {notes.map(note => 
          <li key={note.id}>
            {note.content}
          </li>
        )}
      </ul>
    </div>
  )
}copy
```

If you have forgotten what destructuring means and how it works, please review the [section on destructuring](../part1/01-component-state-event-handlers-destructuring.md).
We'll separate displaying a single note into its own component _Note_ :

```
const Note = ({ note }) => {  return (    <li>{note.content}</li>  )}
const App = ({ notes }) => {
  return (
    <div>
      <h1>Notes</h1>
      <ul>
        {notes.map(note =>           <Note key={note.id} note={note} />        )}      </ul>
    </div>
  )
}copy
```

Note that the _key_ attribute must now be defined for the _Note_ components, and not for the _li_ tags like before.
A whole React application can be written in a single file. Although that is, of course, not very practical. Common practice is to declare each component in its own file as an _ES6-module_.
We have been using modules the whole time. The first few lines of the file _main.jsx_ :

```
import ReactDOM from "react-dom/client"
import App from "./App"copy
```

_react-dom/client_ is placed into the variable _ReactDOM_ , and the module that defines the main component of the app is placed into the variable _App_
Let's move our _Note_ component into its own module.
In smaller applications, components are usually placed in a directory called _components_ , which is in turn placed within the _src_ directory. The convention is to name the file after the component.
Now, we'll create a directory called _components_ for our application and place a file named _Note.jsx_ inside. The contents of the file are as follows:

```
const Note = ({ note }) => {
  return <li>{note.content}</li>
}

export default Notecopy
```

The last line of the module _Note_.
Now the file that is using the component - _App.jsx_ - can

```
import Note from './components/Note'
const App = ({ notes }) => {
  // ...
}copy
```

The component exported by the module is now available for use in the variable _Note_ , just as it was earlier.
Note that when importing our own components, their location must be given _in relation to the importing file_ :

```
'./components/Note'copy
```

The period - _._ - in the beginning refers to the current directory, so the module's location is a file called _Note.jsx_ in the _components_ sub-directory of the current directory. The filename extension _.jsx_ can be omitted.
Modules have plenty of other uses other than enabling component declarations to be separated into their own files. We will get back to them later in this course.
The current code of the application can be found on
Note that the _main_ branch of the repository contains the code for a later version of the application. The current code is in the branch
![GitHub branch screenshot](../assets/b8ae52b4a5d80e1c.png)
If you clone the project, run the command _npm install_ before starting the application with _npm run dev_.
### When the Application Breaks
Early in your programming career (and even after 30 years of coding like yours truly), what often happens is that the application just completely breaks down. This is even more so the case with dynamically typed languages, such as JavaScript, where the compiler does not check the data type. For instance, function variables or return values.
A "React explosion" can, for example, look like this:
![react sample error](../assets/e9d4a31130a8c55c.png)
In these situations, your best way out is the _console.log_ method.
The piece of code causing the explosion is this:

```
const Course = ({ course }) => (
  <div>
    <Header course={course} />
  </div>
)

const App = () => {
  const course = {
    // ...
  }

  return (
    <div>
      <Course course={course} />
    </div>
  )
}copy
```

We'll hone in on the reason for the breakdown by adding _console.log_ commands to the code. Because the first thing to be rendered is the _App_ component, it's worth putting the first _console.log_ there:

```
const App = () => {
  const course = {
    // ...
  }

  console.log('App works...')
  return (
    // ..
  )
}copy
```

To see the printing in the console, we must scroll up over the long red wall of errors.
![initial printing of the console](../assets/d48f3792871c6ea5.png)
When one thing is found to be working, it's time to log deeper. If the component has been declared as a single statement or a function without a return, it makes printing to the console harder.

```
const Course = ({ course }) => (
  <div>
    <Header course={course} />
  </div>
)copy
```

The component should be changed to its longer form for us to add the printing:

```
const Course = ({ course }) => { 
  console.log(course)  return (
    <div>
      <Header course={course} />
    </div>
  )
}copy
```

Quite often the root of the problem is that the props are expected to be of a different type, or called with a different name than they actually have, and destructuring fails as a result. The problem often begins to solve itself when destructuring is removed and we see what the _props_ contain.

```
const Course = (props) => {  console.log(props)  const { course } = props
  return (
    <div>
      <Header course={course} />
    </div>
  )
}copy
```

If the problem has still not been resolved, sadly there isn't much to do apart from continuing to bug-hunt by sprinkling more _console.log_ statements around your code.
I added this chapter to the material after the model answer for the next question exploded completely (due to props being of the wrong type), and I had to debug it using _console.log_.
### Web developer's oath
Before the exercises, let me remind what you promised at the end of the previous part.
Programming is hard, that is why I will use all the possible means to make it easier

- I will have my browser developer console open all the time
- I progress with small steps
- I will write lots of _console.log_ statements to make sure I understand how the code behaves and to help pinpoint problems
- If my code does not work, I will not write more code. Instead, I start deleting the code until it works or just return to a state when everything was still working
- When I ask for help in the course Discord channel or elsewhere I formulate my questions properly, see [here](../part0/01-general-info-how-to-get-help-in-discord.md) how to ask for help


### Exercises 2.1.-2.5
The exercises are submitted via GitHub, and by marking the exercises as done in the
You can submit all of the exercises into the same repository, or use multiple different repositories. If you submit exercises from different parts into the same repository, name your directories well.
The exercises are submitted **One part at a time**. When you have submitted the exercises for a part, you can no longer submit any missed exercises for that part.
Note that this part has more exercises than the ones before, so _do not submit_ until you have done all the exercises from this part you want to submit.
#### 2.1: Course information step 6
Let's finish the code for rendering course contents from exercises 1.1 - 1.5. You can start with the code from the model answers. The model answers for part 1 can be found by going to the _my submissions_ at the top, and in the row corresponding to part 1 under the _solutions_ column clicking on _show_. To see the solution to the _course info_ exercise, click on _App.jsx_ under _courseinfo_.
**Note that if you copy a project from one place to another, you might have to delete the _node_modules_ directory and install the dependencies again with the command _npm install_ before you can start the application.**
Generally, it's not recommended that you copy a project's whole contents and/or add the _node_modules_ directory to the version control system.
Let's change the _App_ component like so:

```
const App = () => {
  const course = {
    id: 1,
    name: 'Half Stack application development',
    parts: [
      {
        name: 'Fundamentals of React',
        exercises: 10,
        id: 1
      },
      {
        name: 'Using props to pass data',
        exercises: 7,
        id: 2
      },
      {
        name: 'State of a component',
        exercises: 14,
        id: 3
      }
    ]
  }

  return <Course course={course} />
}

export default Appcopy
```

Define a component responsible for formatting a single course called _Course_.
The component structure of the application can be, for example, the following:

```
App
  Course
    Header
    Content
      Part
      Part
      ...copy
```

Hence, the _Course_ component contains the components defined in the previous part, which are responsible for rendering the course name and its parts.
The rendered page can, for example, look as follows:
![half stack application screenshot](../assets/47ff62d4ec9c2c86.png)
You don't need the sum of the exercises yet.
The application must work _regardless of the number of parts a course has_ , so make sure the application works if you add or remove parts of a course.
Ensure that the console shows no errors!
#### 2.2: Course information step 7
Show also the sum of the exercises of the course.
![sum of exercises added feature](../assets/2503262c534490df.png)
#### 2.3*: Course information step 8
If you haven't done so already, calculate the sum of exercises with the array method
**Pro tip:** when your code looks as follows:

```
const total = 
  parts.reduce((s, p) => someMagicHere)copy
```

and does not work, it's worth it to use _console.log_ , which requires the arrow function to be written in its longer form:

```
const total = parts.reduce((s, p) => {
  console.log('what is happening', s, p)
  return someMagicHere 
})copy
```

**Not working? :** Use your search engine to look up how _reduce_ is used in an **Object Array**.
#### 2.4: Course information step 9
Let's extend our application to allow for an _arbitrary number_ of courses:

```
const App = () => {
  const courses = [
    {
      name: 'Half Stack application development',
      id: 1,
      parts: [
        {
          name: 'Fundamentals of React',
          exercises: 10,
          id: 1
        },
        {
          name: 'Using props to pass data',
          exercises: 7,
          id: 2
        },
        {
          name: 'State of a component',
          exercises: 14,
          id: 3
        },
        {
          name: 'Redux',
          exercises: 11,
          id: 4
        }
      ]
    }, 
    {
      name: 'Node.js',
      id: 2,
      parts: [
        {
          name: 'Routing',
          exercises: 3,
          id: 1
        },
        {
          name: 'Middlewares',
          exercises: 7,
          id: 2
        }
      ]
    }
  ]

  return (
    <div>
      // ...
    </div>
  )
}copy
```

The application can, for example, look like this:
![arbitrary number of courses feature add-on](../assets/d9913a59d85b0683.png)
#### 2.5: Separate module step 10
Declare the _Course_ component as a separate module, which is imported by the _App_ component. You can include all subcomponents of the course in the same module.
[Part 1 **Previous part**](../part1/01-part1.md)[Part 2b **Next part**](../part2/01-forms.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 2](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-part2.md)
- [console.log](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-console-log.md)
- [Protip: Visual Studio Code snippets](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-protip-visual-studio-code-snippets.md)
- [JavaScript Arrays](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-java-script-arrays.md)
- [Event Handlers Revisited](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-event-handlers-revisited.md)
- [Rendering Collections](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-rendering-collections.md)
- [Key-attribute](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-key-attribute.md)
- [Map](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-map.md)
- [Anti-pattern: Array Indexes as Keys](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-anti-pattern-array-indexes-as-keys.md)
- [Refactoring Modules](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-refactoring-modules.md)
- [When the Application Breaks](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-when-the-application-breaks.md)
- [Web developer's oath](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-web-developers-oath.md)
- [Exercises 2.1.-2.5.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-exercises-2-1-2-5.md)
- [b Forms](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-forms.md)
- [c Getting data from server](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-getting-data-from-server.md)
- [d Altering data in server](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server.md)
- [e Adding styles to React app](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app.md)
- [debugging React applications](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-debugging-react-applications.md)
- [event handlers revisited](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-event-handling-revisited.md)
- [here](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-passing-event-handlers-to-child-components.md)
- [part 0](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part0/01-part0.md)
- [unique key prop console error](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/da0e784e70c1376d.png)
- [section on destructuring](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-destructuring.md)
- [GitHub branch screenshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/b8ae52b4a5d80e1c.png)
- [react sample error](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/e9d4a31130a8c55c.png)
- [initial printing of the console](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/d48f3792871c6ea5.png)
- [here](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part0/01-general-info-how-to-get-help-in-discord.md)
- [half stack application screenshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/47ff62d4ec9c2c86.png)
- [sum of exercises added feature](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/2503262c534490df.png)
- [arbitrary number of courses feature add-on](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/d9913a59d85b0683.png)
- [Part 1 **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-part1.md)
- [Part 2b **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-forms.md)

--- .archived/data/part6/01-flux-architecture-and-redux.md ---
---{
  "title": "Flux-architecture and Redux",
  "source_url": "https://fullstackopen.com/en/part6/flux_architecture_and_redux",
  "crawl_timestamp": "2025-10-04T19:16:47Z",
  "checksum": "52d44386bd7fe9c2db21f80699bff58357465e15426426b288a381d52b184481"
}
---[Skip to content](../part6/01-flux-architecture-and-redux-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 6](../part6/01-part6.md)
Flux-architecture and Redux
a Flux-architecture and Redux

- [Flux-architecture](../part6/01-flux-architecture-and-redux-flux-architecture.md)
- [Redux](../part6/01-flux-architecture-and-redux-redux.md)
- [A note about the use of createStore](../part6/01-flux-architecture-and-redux-a-note-about-the-use-of-create-store.md)
- [Redux-notes](../part6/01-flux-architecture-and-redux-redux-notes.md)
- [Pure functions, immutable](../part6/01-flux-architecture-and-redux-pure-functions-immutable.md)
- [Array spread syntax](../part6/01-flux-architecture-and-redux-array-spread-syntax.md)
- [Exercises 6.1.-6.2.](../part6/01-flux-architecture-and-redux-exercises-6-1-6-2.md)
- [Uncontrolled form](../part6/01-flux-architecture-and-redux-uncontrolled-form.md)
- [Action creators](../part6/01-flux-architecture-and-redux-action-creators.md)
- [Forwarding Redux Store to various components](../part6/01-flux-architecture-and-redux-forwarding-redux-store-to-various-components.md)
- [More components](../part6/01-flux-architecture-and-redux-more-components.md)
- [Exercises 6.3.-6.8.](../part6/01-flux-architecture-and-redux-exercises-6-3-6-8.md)


[b Many reducers](../part6/01-many-reducers.md)[c Communicating with server in a Redux application](../part6/01-communicating-with-server-in-a-redux-application.md)[d React Query, useReducer and the context](../part6/01-react-query-use-reducer-and-the-context.md)
a
# Flux-architecture and Redux
So far, we have followed the state management conventions recommended by React. We have placed the state and the functions for handling it in the
### Flux-architecture
Already years ago Facebook developed the _stores_. State in the store is not changed directly, but with different _actions_.
When an action changes the state of the store, the views are rerendered:
![diagram action->dispatcher->store->view](../assets/0bb7d27aede4a659.png)
If some action on the application, for example pushing a button, causes the need to change the state, the change is made with an action. This causes re-rendering the view again:
![same diagram as above but with action looping back](../assets/b355a5bd56d17988.png)
Flux offers a standard way for how and where the application's state is kept and how it is modified.
### Redux
Facebook has an implementation for Flux, but we will be using the
We will get to know Redux by implementing a counter application yet again:
![browser counter application](../assets/e80657c8e8da427e.png)
Create a new Vite application and install redux with the command

```
npm install reduxcopy
```

As in Flux, in Redux the state is also stored in a
The whole state of the application is stored in _one_ JavaScript object in the store. Because our application only needs the value of the counter, we will save it straight to the store. If the state was more complicated, different things in the state would be saved as separate fields of the object.
The state of the store is changed with _type_ of the action. Our application needs for example the following action:

```
{
  type: 'INCREMENT'
}copy
```

If there is data involved with the action, other fields can be declared as needed. However, our counting app is so simple that the actions are fine with just the type field.
The impact of the action to the state of the application is defined using a _returns_ a new state.
Let's now define a reducer for our application at _main.jsx_. The file initially looks like this:

```
const counterReducer = (state, action) => {
  if (action.type === 'INCREMENT') {
    return state + 1
  } else if (action.type === 'DECREMENT') {
    return state - 1
  } else if (action.type === 'ZERO') {
    return 0
  }

  return state
}copy
```

The first parameter is the _state_ in the store. The reducer returns a _new state_ based on the _action_ type. So, e.g. when the type of Action is _INCREMENT_ , the state gets the old value plus one. If the type of Action is _ZERO_ the new value of state is zero.
Let's change the code a bit. We have used if-else statements to respond to an action and change the state. However, the
Let's also define a _state_. Now the reducer works even if the store state has not been primed yet.

```
const counterReducer = (state = 0, action) => {  switch (action.type) {
    case 'INCREMENT':
      return state + 1
    case 'DECREMENT':
      return state - 1
    case 'ZERO':
      return 0
    default: // if none of the above matches, code comes here
      return state
  }
}copy
```

The reducer is never supposed to be called directly from the application's code. It is only given as a parameter to the _createStore_ function which creates the store:

```
import { createStore } from 'redux'
const counterReducer = (state = 0, action) => {
  // ...
}

const store = createStore(counterReducer)copy
```

The store now uses the reducer to handle _actions_ , which are _dispatched_ or 'sent' to the store with its

```
store.dispatch({ type: 'INCREMENT' })copy
```

You can find out the state of the store using the method
For example the following code:

```
const store = createStore(counterReducer)
console.log(store.getState())
store.dispatch({ type: 'INCREMENT' })
store.dispatch({ type: 'INCREMENT' })
store.dispatch({ type: 'INCREMENT' })
console.log(store.getState())
store.dispatch({ type: 'ZERO' })
store.dispatch({ type: 'DECREMENT' })
console.log(store.getState())copy
```

would print the following to the console

```
0
3
-1copy
```

because at first, the state of the store is 0. After three _INCREMENT_ actions the state is 3. In the end, after the _ZERO_ and _DECREMENT_ actions, the state is -1.
The third important method that the store has is
If, for example, we would add the following function to subscribe, _every change in the store_ would be printed to the console.

```
store.subscribe(() => {
  const storeNow = store.getState()
  console.log(storeNow)
})copy
```

so the code

```
const store = createStore(counterReducer)

store.subscribe(() => {
  const storeNow = store.getState()
  console.log(storeNow)
})

store.dispatch({ type: 'INCREMENT' })
store.dispatch({ type: 'INCREMENT' })
store.dispatch({ type: 'INCREMENT' })
store.dispatch({ type: 'ZERO' })
store.dispatch({ type: 'DECREMENT' })copy
```

would cause the following to be printed

```
1
2
3
0
-1copy
```

The code of our counter application is the following. All of the code has been written in the same file (_main.jsx_), so _store_ is directly available for the React code. We will get to know better ways to structure React/Redux code later.

```
import React from 'react'
import ReactDOM from 'react-dom/client'

import { createStore } from 'redux'

const counterReducer = (state = 0, action) => {
  switch (action.type) {
    case 'INCREMENT':
      return state + 1
    case 'DECREMENT':
      return state - 1
    case 'ZERO':
      return 0
    default:
      return state
  }
}

const store = createStore(counterReducer)

const App = () => {
  return (
    <div>
      <div>
        {store.getState()}
      </div>
      <button 
        onClick={e => store.dispatch({ type: 'INCREMENT' })}
      >
        plus
      </button>
      <button
        onClick={e => store.dispatch({ type: 'DECREMENT' })}
      >
        minus
      </button>
      <button 
        onClick={e => store.dispatch({ type: 'ZERO' })}
      >
        zero
      </button>
    </div>
  )
}

const root = ReactDOM.createRoot(document.getElementById('root'))

const renderApp = () => {
  root.render(<App />)
}

renderApp()
store.subscribe(renderApp)copy
```

There are a few notable things in the code. _App_ renders the value of the counter by asking it from the store with the method _store.getState()_. The action handlers of the buttons _dispatch_ the right actions to the store.
When the state in the store is changed, React is not able to automatically re-render the application. Thus we have registered a function _renderApp_ , which renders the whole app, to listen for changes in the store with the _store.subscribe_ method. Note that we have to immediately call the _renderApp_ method. Without the call, the first rendering of the app would never happen.
### A note about the use of createStore
The most observant will notice that the name of the function createStore is overlined. If you move the mouse over the name, an explanation will appear
![vscode error showing createStore deprecated, use configureStore instead](../assets/84c532aba5adda47.png)
The full explanation is as follows
> _We recommend using the configureStore method of the @reduxjs/toolkit package, which replaces createStore._
> _Redux Toolkit is our recommended approach for writing Redux logic today, including store setup, reducers, data fetching, and more._
> _For more details, please read this Redux docs page:_
> _configureStore from Redux Toolkit is an improved version of createStore that simplifies setup and helps avoid common bugs._
> _You should not be using the redux core package by itself today, except for learning purposes. The createStore method from the core redux package will not be removed, but we encourage all users to migrate to using Redux Toolkit for all Redux code._
So, instead of the function _createStore_ , it is recommended to use the slightly more "advanced" function _configureStore_ , and we will also use it when we have achieved the basic functionality of Redux.
Side note: _createStore_ is defined as "deprecated", which usually means that the feature will be removed in some newer version of the library. The explanation above and this _createStore_ will not be removed, and it has been given the status _deprecated_ , perhaps with slightly incorrect reasons. So the function is not obsolete, but today there is a more preferable, new way to do almost the same thing.
### Redux-notes
We aim to modify our note application to use Redux for state management. However, let's first cover a few key concepts through a simplified note application.
The first version of our application is the following

```
const noteReducer = (state = [], action) => {
  if (action.type === 'NEW_NOTE') {
    state.push(action.payload)
    return state
  }

  return state
}

const store = createStore(noteReducer)

store.dispatch({
  type: 'NEW_NOTE',
  payload: {
    content: 'the app state is in redux store',
    important: true,
    id: 1
  }
})

store.dispatch({
  type: 'NEW_NOTE',
  payload: {
    content: 'state changes are made with actions',
    important: false,
    id: 2
  }
})

const App = () => {
  return(
    <div>
      <ul>
        {store.getState().map(note=>
          <li key={note.id}>
            {note.content} <strong>{note.important ? 'important' : ''}</strong>
          </li>
        )}
        </ul>
    </div>
  )
}
export default noteReducer;copy
```

So far the application does not have the functionality for adding new notes, although it is possible to do so by dispatching _NEW_NOTE_ actions.
Now the actions have a type and a field _payload_ , which contains the note to be added:

```
{
  type: 'NEW_NOTE',
  payload: {
    content: 'state changes are made with actions',
    important: false,
    id: 2
  }
}copy
```

The choice of the field name is not random. The general convention is that actions have exactly two fields, _type_ telling the type and _payload_ containing the data included with the Action.
### Pure functions, immutable
The initial version of the reducer is very simple:

```
const noteReducer = (state = [], action) => {
  if (action.type === 'NEW_NOTE') {
    state.push(action.payload)
    return state
  }

  return state
}copy
```

The state is now an Array. _NEW_NOTE_ -type actions cause a new note to be added to the state with the
The application seems to be working, but the reducer we have declared is bad. It breaks the
Pure functions are such, that they _do not cause any side effects_ and they must always return the same response when called with the same parameters.
We added a new note to the state with the method _state.push(action.payload)_ which _changes_ the state of the state-object. This is not allowed. The problem is easily solved by using the _new array_ , which contains all the elements of the old array and the new element:

```
const noteReducer = (state = [], action) => {
  if (action.type === 'NEW_NOTE') {
    return state.concat(action.payload)  }

  return state
}copy
```

A reducer state must be composed of _replaced with a new, changed, object_. This is exactly what we did with the new reducer: the old array is replaced with the new one.
Let's expand our reducer so that it can handle the change of a note's importance:

```
{
  type: 'TOGGLE_IMPORTANCE',
  payload: {
    id: 2
  }
}copy
```

Since we do not have any code which uses this functionality yet, we are expanding the reducer in the 'test-driven' way. Let's start by creating a test for handling the action _NEW_NOTE_.
We have to first configure the

```
npm install --save-dev jest @babel/preset-env @babel/preset-react eslint-plugin-jestcopy
```

Next we'll create the file _.babelrc_ , with the following content:

```
{
  "presets": [
    "@babel/preset-env",
    ["@babel/preset-react", { "runtime": "automatic" }]
  ]
}copy
```

Let us expand _package.json_ with a script for running the tests:

```
{
  // ...
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint . --ext js,jsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview",
    "test": "jest"  },
  // ...
}copy
```

And finally, _.eslintrc.cjs_ needs to be altered as follows:

```
module.exports = {
  root: true,
  env: { 
    browser: true,
    es2020: true,
    "jest/globals": true  },
  // ...
}copy
```

To make testing easier, we'll first move the reducer's code to its own module, to the file _src/reducers/noteReducer.js_. We'll also add the library

```
npm install --save-dev deep-freezecopy
```

The test, which we define in file _src/reducers/noteReducer.test.js_ , has the following content:

```
import noteReducer from './noteReducer'
import deepFreeze from 'deep-freeze'

describe('noteReducer', () => {
  test('returns new state with action NEW_NOTE', () => {
    const state = []
    const action = {
      type: 'NEW_NOTE',
      payload: {
        content: 'the app state is in redux store',
        important: true,
        id: 1
      }
    }

    deepFreeze(state)
    const newState = noteReducer(state, action)

    expect(newState).toHaveLength(1)
    expect(newState).toContainEqual(action.payload)
  })
})copy
```

Run the test with _npm test_. The _deepFreeze(state)_ command ensures that the reducer does not change the state of the store given to it as a parameter. If the reducer uses the _push_ command to manipulate the state, the test will not pass
![terminal showing test failure and error about not using array.push](../assets/68035f97f82a2896.png)
Now we'll create a test for the _TOGGLE_IMPORTANCE_ action:

```
test('returns new state with action TOGGLE_IMPORTANCE', () => {
  const state = [
    {
      content: 'the app state is in redux store',
      important: true,
      id: 1
    },
    {
      content: 'state changes are made with actions',
      important: false,
      id: 2
    }]

  const action = {
    type: 'TOGGLE_IMPORTANCE',
    payload: {
      id: 2
    }
  }

  deepFreeze(state)
  const newState = noteReducer(state, action)

  expect(newState).toHaveLength(2)

  expect(newState).toContainEqual(state[0])

  expect(newState).toContainEqual({
    content: 'state changes are made with actions',
    important: true,
    id: 2
  })
})copy
```

So the following action

```
{
  type: 'TOGGLE_IMPORTANCE',
  payload: {
    id: 2
  }
}copy
```

has to change the importance of the note with the id 2.
The reducer is expanded as follows

```
const noteReducer = (state = [], action) => {
  switch(action.type) {
    case 'NEW_NOTE':
      return state.concat(action.payload)
    case 'TOGGLE_IMPORTANCE': {
      const id = action.payload.id
      const noteToChange = state.find(n => n.id === id)
      const changedNote = { 
        ...noteToChange, 
        important: !noteToChange.important 
      }
      return state.map(note =>
        note.id !== id ? note : changedNote 
      )
     }
    default:
      return state
  }
}copy
```

We create a copy of the note whose importance has changed with the syntax [familiar from part 2](../part2/01-altering-data-in-server-changing-the-importance-of-notes.md), and replace the state with a new state containing all the notes which have not changed and the copy of the changed note _changedNote_.
Let's recap what goes on in the code. First, we search for a specific note object, the importance of which we want to change:

```
const noteToChange = state.find(n => n.id === id)copy
```

then we create a new object, which is a _copy_ of the original note, only the value of the _important_ field has been changed to the opposite of what it was:

```
const changedNote = { 
  ...noteToChange, 
  important: !noteToChange.important 
}copy
```

A new state is then returned. We create it by taking all of the notes from the old state except for the desired note, which we replace with its slightly altered copy:

```
state.map(note =>
  note.id !== id ? note : changedNote 
)copy
```

### Array spread syntax
Because we now have quite good tests for the reducer, we can refactor the code safely.
Adding a new note creates the state returned from the Array's _concat_ function. Let's take a look at how we can achieve the same by using the JavaScript

```
const noteReducer = (state = [], action) => {
  switch(action.type) {
    case 'NEW_NOTE':
      return [...state, action.payload]    case 'TOGGLE_IMPORTANCE':
      // ...
    default:
    return state
  }
}copy
```

The spread -syntax works as follows. If we declare

```
const numbers = [1, 2, 3]copy
```

`...numbers` breaks the array up into individual elements, which can be placed in another array.

```
[...numbers, 4, 5]copy
```

and the result is an array _[1, 2, 3, 4, 5]_.
If we would have placed the array to another array without the spread

```
[numbers, 4, 5]copy
```

the result would have been _[ [1, 2, 3], 4, 5]_.
When we take elements from an array by _gather_ the rest of the elements:

```
const numbers = [1, 2, 3, 4, 5, 6]

const [first, second, ...rest] = numbers

console.log(first)     // prints 1
console.log(second)   // prints 2
console.log(rest)     // prints [3, 4, 5, 6]copy
```

### Exercises 6.1.-6.2
Let's make a simplified version of the unicafe exercise from part 1. Let's handle the state management with Redux.
You can take the code from this repository
_Start by removing the git configuration of the cloned repository, and by installing dependencies_

```
cd unicafe-redux   // go to the directory of cloned repository
rm -rf .git
npm installcopy
```

#### 6.1: Unicafe Revisited, step 1
Before implementing the functionality of the UI, let's implement the functionality required by the store.
We have to save the number of each kind of feedback to the store, so the form of the state in the store is:

```
{
  good: 5,
  ok: 4,
  bad: 2
}copy
```

The project has the following base for a reducer:

```
const initialState = {
  good: 0,
  ok: 0,
  bad: 0
}

const counterReducer = (state = initialState, action) => {
  console.log(action)
  switch (action.type) {
    case 'GOOD':
      return state
    case 'OK':
      return state
    case 'BAD':
      return state
    case 'ZERO':
      return state
    default: return state
  }

}

export default counterReducercopy
```

and a base for its tests

```
import deepFreeze from 'deep-freeze'
import counterReducer from './reducer'

describe('unicafe reducer', () => {
  const initialState = {
    good: 0,
    ok: 0,
    bad: 0
  }

  test('should return a proper initial state when called with undefined state', () => {
    const state = {}
    const action = {
      type: 'DO_NOTHING'
    }

    const newState = counterReducer(undefined, action)
    expect(newState).toEqual(initialState)
  })

  test('good is incremented', () => {
    const action = {
      type: 'GOOD'
    }
    const state = initialState

    deepFreeze(state)
    const newState = counterReducer(state, action)
    expect(newState).toEqual({
      good: 1,
      ok: 0,
      bad: 0
    })
  })
})copy
```

**Implement the reducer and its tests.**
In the tests, make sure that the reducer is an _immutable function_ with the _deep-freeze_ library. Ensure that the provided first test passes, because Redux expects that the reducer returns the original state when it is called with a first parameter - which represents the previous _state_ - with the value _undefined_.
Start by expanding the reducer so that both tests pass. Then add the rest of the tests, and finally the functionality that they are testing.
A good model for the reducer is the [redux-notes](../part6/01-flux-architecture-and-redux-pure-functions-immutable.md) example above.
#### 6.2: Unicafe Revisited, step2
Now implement the actual functionality of the application.
Your application can have a modest appearance, nothing else is needed but buttons and the number of reviews for each type:
![browser showing good bad ok buttons](../assets/568e984dbcc82c0b.png)
### Uncontrolled form
Let's add the functionality for adding new notes and changing their importance:

```
const generateId = () =>  Number((Math.random() * 1000000).toFixed(0))
const App = () => {
  const addNote = (event) => {    event.preventDefault()    const content = event.target.note.value    event.target.note.value = ''    store.dispatch({      type: 'NEW_NOTE',      payload: {        content,        important: false,        id: generateId()      }    })  }
  const toggleImportance = (id) => {    store.dispatch({      type: 'TOGGLE_IMPORTANCE',      payload: { id }    })  }
  return (
    <div>
      <form onSubmit={addNote}>        <input name="note" />         <button type="submit">add</button>      </form>      <ul>
        {store.getState().map(note =>
          <li
            key={note.id} 
            onClick={() => toggleImportance(note.id)}          >
            {note.content} <strong>{note.important ? 'important' : ''}</strong>
          </li>
        )}
      </ul>
    </div>
  )
}copy
```

The implementation of both functionalities is straightforward. It is noteworthy that we _have not_ bound the state of the form fields to the state of the _App_ component like we have previously done. React calls this kind of form
> Uncontrolled forms have certain limitations (for example, dynamic error messages or disabling the submit button based on input are not possible). However they are suitable for our current needs.
You can read more about uncontrolled forms
The method for adding new notes is simple, it just dispatches the action for adding notes:

```
addNote = (event) => {
  event.preventDefault()
  const content = event.target.note.value  event.target.note.value = ''
  store.dispatch({
    type: 'NEW_NOTE',
    payload: {
      content,
      important: false,
      id: generateId()
    }
  })
}copy
```

We can get the content of the new note straight from the form field. Because the field has a name, we can access the content via the event object _event.target.note.value_.

```
<form onSubmit={addNote}>
  <input name="note" />  <button type="submit">add</button>
</form>copy
```

A note's importance can be changed by clicking its name. The event handler is very simple:

```
toggleImportance = (id) => {
  store.dispatch({
    type: 'TOGGLE_IMPORTANCE',
    payload: { id }
  })
}copy
```

### Action creators
We begin to notice that, even in applications as simple as ours, using Redux can simplify the frontend code. However, we can do a lot better.
React components don't need to know the Redux action types and forms. Let's separate creating actions into separate functions:

```
const createNote = (content) => {
  return {
    type: 'NEW_NOTE',
    payload: {
      content,
      important: false,
      id: generateId()
    }
  }
}

const toggleImportanceOf = (id) => {
  return {
    type: 'TOGGLE_IMPORTANCE',
    payload: { id }
  }
}copy
```

Functions that create actions are called
The _App_ component does not have to know anything about the inner representation of the actions anymore, it just gets the right action by calling the creator function:

```
const App = () => {
  const addNote = (event) => {
    event.preventDefault()
    const content = event.target.note.value
    event.target.note.value = ''
    store.dispatch(createNote(content))    
  }
  
  const toggleImportance = (id) => {
    store.dispatch(toggleImportanceOf(id))  }

  // ...
}copy
```

### Forwarding Redux Store to various components
Aside from the reducer, our application is in one file. This is of course not sensible, and we should separate _App_ into its module.
Now the question is, how can the _App_ access the store after the move? And more broadly, when a component is composed of many smaller components, there must be a way for all of the components to access the store. There are multiple ways to share the Redux store with the components. First, we will look into the newest, and possibly the easiest way, which is using the
First, we install react-redux

```
npm install react-reduxcopy
```

Next, we move the _App_ component into its own file _App.jsx_. Let's see how this affects the rest of the application files.
_main.jsx_ becomes:

```
import React from 'react'
import ReactDOM from 'react-dom/client'
import { createStore } from 'redux'
import { Provider } from 'react-redux'
import App from './App'
import noteReducer from './reducers/noteReducer'

const store = createStore(noteReducer)

ReactDOM.createRoot(document.getElementById('root')).render(
  <Provider store={store}>    <App />
  </Provider>)copy
```

Note, that the application is now defined as a child of a _store_.
Defining the action creators has been moved to the file _reducers/noteReducer.js_ where the reducer is defined. That file looks like this:

```
const noteReducer = (state = [], action) => {
  // ...
}

const generateId = () =>
  Number((Math.random() * 1000000).toFixed(0))

export const createNote = (content) => {  return {
    type: 'NEW_NOTE',
    payload: {
      content,
      important: false,
      id: generateId()
    }
  }
}

export const toggleImportanceOf = (id) => {  return {
    type: 'TOGGLE_IMPORTANCE',
    payload: { id }
  }
}

export default noteReducercopy
```

Previously, if the application had many components which needed the store, the _App_ component had to pass _store_ as props to all of those components (known as prop drilling). Now with the _store_ Provider wrapping the _App_ component, the _store_ is directly accessible to all components within the _App_ component without explicitly being passed as props.
The module now has multiple
The reducer function is still returned with the _export default_ command, so the reducer can be imported the usual way:

```
import noteReducer from './reducers/noteReducer'copy
```

A module can have only _one default export_ , but multiple "normal" exports

```
export const createNote = (content) => {
  // ...
}

export const toggleImportanceOf = (id) => { 
  // ...
}copy
```

Normally (not as defaults) exported functions can be imported with the curly brace syntax:

```
import { createNote } from '../../reducers/noteReducer'copy
```

Code for the _App_ component

```
import { createNote, toggleImportanceOf } from './reducers/noteReducer'import { useSelector, useDispatch } from 'react-redux'
const App = () => {
  const dispatch = useDispatch()  const notes = useSelector(state => state)
  const addNote = (event) => {
    event.preventDefault()
    const content = event.target.note.value
    event.target.note.value = ''
    dispatch(createNote(content))  }

  const toggleImportance = (id) => {
    dispatch(toggleImportanceOf(id))  }

  return (
    <div>
      <form onSubmit={addNote}>
        <input name="note" /> 
        <button type="submit">add</button>
      </form>
      <ul>
        {notes.map(note =>          <li
            key={note.id} 
            onClick={() => toggleImportance(note.id)}
          >
            {note.content} <strong>{note.important ? 'important' : ''}</strong>
          </li>
        )}
      </ul>
    </div>
  )
}

export default Appcopy
```

There are a few things to note in the code. Previously the code dispatched actions by calling the dispatch method of the Redux store:

```
store.dispatch({
  type: 'TOGGLE_IMPORTANCE',
  payload: { id }
})copy
```

Now it does it with the _dispatch_ function from the

```
import { useSelector, useDispatch } from 'react-redux'
const App = () => {
  const dispatch = useDispatch()  // ...

  const toggleImportance = (id) => {
    dispatch(toggleImportanceOf(id))  }

  // ...
}copy
```

The _useDispatch_ hook provides any React component access to the dispatch function of the Redux store defined in _main.jsx_. This allows all components to make changes to the state of the Redux store.
The component can access the notes stored in the store with the

```
import { useSelector, useDispatch } from 'react-redux'
const App = () => {
  // ...
  const notes = useSelector(state => state)  // ...
}copy
```

_useSelector_ receives a function as a parameter. The function either searches for or selects data from the Redux store. Here we need all of the notes, so our selector function returns the whole state:

```
state => statecopy
```

which is a shorthand for:

```
(state) => {
  return state
}copy
```

Usually, selector functions are a bit more interesting and return only selected parts of the contents of the Redux store. We could for example return only notes marked as important:

```
const importantNotes = useSelector(state => state.filter(note => note.important))  copy
```

The current version of the application can be found on _part6-0_.
### More components
Let's separate creating a new note into a component.

```
import { useDispatch } from 'react-redux'import { createNote } from '../reducers/noteReducer'
const NewNote = () => {
  const dispatch = useDispatch()
  const addNote = (event) => {
    event.preventDefault()
    const content = event.target.note.value
    event.target.note.value = ''
    dispatch(createNote(content))  }

  return (
    <form onSubmit={addNote}>
      <input name="note" />
      <button type="submit">add</button>
    </form>
  )
}

export default NewNotecopy
```

Unlike in the React code we did without Redux, the event handler for changing the state of the app (which now lives in Redux) has been moved away from the _App_ to a child component. The logic for changing the state in Redux is still neatly separated from the whole React part of the application.
We'll also separate the list of notes and displaying a single note into their own components (which will both be placed in the _Notes.jsx_ file ):

```
import { useDispatch, useSelector } from 'react-redux'import { toggleImportanceOf } from '../reducers/noteReducer'
const Note = ({ note, handleClick }) => {
  return(
    <li onClick={handleClick}>
      {note.content} 
      <strong> {note.important ? 'important' : ''}</strong>
    </li>
  )
}

const Notes = () => {
  const dispatch = useDispatch()  const notes = useSelector(state => state)
  return(
    <ul>
      {notes.map(note =>
        <Note
          key={note.id}
          note={note}
          handleClick={() => 
            dispatch(toggleImportanceOf(note.id))
          }
        />
      )}
    </ul>
  )
}

export default Notescopy
```

The logic for changing the importance of a note is now in the component managing the list of notes.
There is not much code left in _App_ :

```
const App = () => {

  return (
    <div>
      <NewNote />
      <Notes />
    </div>
  )
}copy
```

_Note_ , responsible for rendering a single note, is very simple and is not aware that the event handler it gets as props dispatches an action. These kinds of components are called
_Notes_ , on the other hand, is a _Note_ components do and coordinates the configuration of _presentational_ components, that is, the _Note_ s.
The code of the Redux application can be found on _part6-1_.
### Exercises 6.3.-6.8
Let's make a new version of the anecdote voting application from part 1. Take the project from this repository
If you clone the project into an existing git repository, _remove the git configuration of the cloned application:_

```
cd redux-anecdotes  // go to the cloned repository
rm -rf .gitcopy
```

The application can be started as usual, but you have to install the dependencies first:

```
npm install
npm run devcopy
```

After completing these exercises, your application should look like this:
![browser showing anecdotes and vote buttons](../assets/97fd505f54423cb1.png)
#### 6.3: Anecdotes, step 1
Implement the functionality for voting anecdotes. The number of votes must be saved to a Redux store.
#### 6.4: Anecdotes, step 2
Implement the functionality for adding new anecdotes.
You can keep the form uncontrolled like we did [earlier](../part6/01-flux-architecture-and-redux-uncontrolled-form.md).
#### 6.5: Anecdotes, step 3
Make sure that the anecdotes are ordered by the number of votes.
#### 6.6: Anecdotes, step 4
If you haven't done so already, separate the creation of action-objects to _src/reducers/anecdoteReducer.js_ file, so do what we have been doing since the chapter [action creators](../part6/01-flux-architecture-and-redux-action-creators.md).
#### 6.7: Anecdotes, step 5
Separate the creation of new anecdotes into a component called _AnecdoteForm_. Move all logic for creating a new anecdote into this new component.
#### 6.8: Anecdotes, step 6
Separate the rendering of the anecdote list into a component called _AnecdoteList_. Move all logic related to voting for an anecdote to this new component.
Now the _App_ component should look like this:

```
import AnecdoteForm from './components/AnecdoteForm'
import AnecdoteList from './components/AnecdoteList'

const App = () => {
  return (
    <div>
      <h2>Anecdotes</h2>
      <AnecdoteList />
      <AnecdoteForm />
    </div>
  )
}

export default Appcopy
```

[Part 5 **Previous part**](../part5/01-part5.md)[Part 6b **Next part**](../part6/01-many-reducers.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 6](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-part6.md)
- [Flux-architecture](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-flux-architecture.md)
- [Redux](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-redux.md)
- [A note about the use of createStore](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-a-note-about-the-use-of-create-store.md)
- [Redux-notes](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-redux-notes.md)
- [Pure functions, immutable](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-pure-functions-immutable.md)
- [Array spread syntax](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-array-spread-syntax.md)
- [Exercises 6.1.-6.2.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-exercises-6-1-6-2.md)
- [Uncontrolled form](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-uncontrolled-form.md)
- [Action creators](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-action-creators.md)
- [Forwarding Redux Store to various components](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-forwarding-redux-store-to-various-components.md)
- [More components](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-more-components.md)
- [Exercises 6.3.-6.8.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-exercises-6-3-6-8.md)
- [b Many reducers](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-many-reducers.md)
- [c Communicating with server in a Redux application](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-communicating-with-server-in-a-redux-application.md)
- [d React Query, useReducer and the context](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-react-query-use-reducer-and-the-context.md)
- [diagram action->dispatcher->store->view](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/0bb7d27aede4a659.png)
- [same diagram as above but with action looping back](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/b355a5bd56d17988.png)
- [browser counter application](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/e80657c8e8da427e.png)
- [vscode error showing createStore deprecated, use configureStore instead](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/84c532aba5adda47.png)
- [terminal showing test failure and error about not using array.push](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/68035f97f82a2896.png)
- [familiar from part 2](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-changing-the-importance-of-notes.md)
- [redux-notes](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-pure-functions-immutable.md)
- [browser showing good bad ok buttons](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/568e984dbcc82c0b.png)
- [browser showing anecdotes and vote buttons](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/97fd505f54423cb1.png)
- [earlier](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-uncontrolled-form.md)
- [action creators](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux-action-creators.md)
- [Part 5 **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part5/01-part5.md)
- [Part 6b **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-many-reducers.md)

--- .ruler/AGENTS.md ---
<!-- Generated by Ruler -->

<!-- Source: crawl_PRD.md -->

# generic offline-first site crawler

Repo goal: a config-first, generic, offline-friendly site crawler that turns arbitrary websites into consistent Markdown + assets trees, while preserving safety (robots, rate limits) and backward compatibility with legacy profiles.

---

# core rules

1. **Config-first sites**

   - Represent every crawlable site via `SiteConfig` (YAML/JSON or CLI-derived), not hard-coded Python, unless a legacy adapter is strictly required.
   - New sites must be onboarded **without** writing new crawler code whenever possible.

2. **Generic core, optional profiles**

   - Core crawling logic (queue, fetch, extract, markdown, assets, links, storage) must be **site-agnostic** and driven entirely by `SiteConfig`.
   - Legacy profiles (e.g. `FullstackOpenProfile`, `NextjsLearnProfile`) are thin adapters that only emit `SiteConfig` instances.

3. **Offline-first output**

   - Primary product is a deterministic Markdown + assets directory with:

     - Stable URL→path mapping per site.
     - Local image assets when enabled.
     - A global `index.json` mapping relative markdown paths to titles.
   - All postprocessing (`postprocess`, `linkcheck`) must be runnable **without re-crawling**.

4. **Robots + safety always on**

   - Respect `robots.txt` and apply rate limits by default.
   - Explicit, documented config or flags are required for any behavior that may increase traffic or change robots handling.
   - Never ship code that silently bypasses robots or ignores rate limits.

5. **Explicit scope and normalization**

   - URL normalization and in-scope decisions must derive from `SiteConfig` (domains, allow/deny rules, normalization settings).
   - No hard-coded hostnames, path prefixes, or magic allow/deny rules outside `SiteConfig` or its adapters.

6. **Layered architecture, no cycles**

   - Respect the dependency layering defined in the PRD:

     - Foundation → Config/URL → Content/Assets → Fetch/Crawl/Links → CLI.
   - Lower layers must not import higher layers (e.g. `config/model` must not import CLI modules).
   - New modules must fit into an existing layer or clearly document a new layer.

7. **Backward-compatible by default**

   - The `--site fullstackopen` and `--site nextjs-learn` flows must continue to work with no behavior regressions.
   - Any changes to normalization, scoping, or output layout for legacy sites require regression tests and explicit sign-off.

8. **Deterministic behavior**

   - Normalization, URL queue ordering, output paths, and asset naming must be deterministic for the same inputs.
   - Use stable hashing for asset filenames and consistent sorting for queues where possible.

9. **Single source of truth for config**

   - `SiteConfig` is the canonical description of how to crawl a site.
   - CLI flags are overlays on top of `SiteConfig`, not competing configuration systems.

10. **Tests first for contracts**

    - Maintain high coverage on config parsing, URL normalization, scoping, link rewriting, and index building.
    - Any change to these contracts must be accompanied by tests that lock in the new behavior.

---

# when you want to do X → do Y

- **Add a new site** → author a YAML/JSON config in `profiles/` and load it via `config/loader` (and `config/registry` if it should have a named `--site` alias).
- **Tweak what pages are crawled** → adjust `domains`, `allow`, `deny`, and depth/strip flags in `SiteConfig.scope`, not ad-hoc conditions in the orchestrator.
- **Change URL normalization** → extend `SiteConfig` normalization fields and update `url/normalize.py`. Keep behavior deterministic and covered by tests.
- **Limit or expand crawl depth** → change `default_max_depth` (config) or pass explicit depth via CLI; do not hard-code depth logic in the fetcher.
- **Change which content is extracted** → modify `content.keep`/`content.remove` selectors in `SiteConfig` and use `content/extract.py` to implement behavior.
- **Adjust frontmatter format** → add/modify modes in `content/markdown.py` and choose via config/CLI; keep a single frontmatter builder.
- **Download or skip images** → toggle `download_images` in `SiteConfig.output` / related config; implement behavior in `assets/images.py` only.
- **Rewrite internal links to local paths** → use `links/rewrite.py` with `rewrite_links(..., mode='local')`; do not manually rewrite links in the orchestrator.
- **Check for broken links** → run the `linkcheck` CLI, which uses `links/check.py` and `storage/index.py`. Fix inputs (config or crawl) instead of adding bespoke checks.
- **Run incremental recrawls** → add logic to `crawl/orchestrator.py` that checks prior checksums/timestamps and prunes the crawl queue, instead of scripting around the CLI.
- **Add a new CLI flag** → wire it through the corresponding `site_crawler/cli/*.py` module, then into `SiteConfig` or orchestration options; avoid reading `sys.argv` in library code.

---

# modules and responsibilities

Use these as the routing table for where new code belongs.

## config

**`site_crawler/config/model.py`**

- Owns `SiteConfig` and sub-configs (`ScopeConfig`, `ContentConfig`, `OutputConfig`, etc.).
- Performs validation (domains non-empty, URLs well-formed, regexes compile) and raises `ConfigError` on failure.
- No IO, no crawl logic.

**`site_crawler/config/loader.py`**

- Loads YAML/JSON configs from disk and merges CLI overrides into a `SiteConfig`.
- Enforces schema and produces actionable error messages for invalid configs.

**`site_crawler/config/registry.py`**

- Bridges legacy profiles and new configs.
- Maps `--site <name>` to a `SiteConfig`, using adapters for legacy Python profiles.

## url

**`site_crawler/url/normalize.py`**

- Canonicalizes URLs using the normalization rules from `SiteConfig`:

  - scheme/host canonicalization
  - query/fragment stripping
  - prefix stripping
  - trailing slash normalization

**`site_crawler/url/scope.py`**

- Provides `in_scope(url, cfg)` and `should_enqueue(url, cfg)`.
- Uses normalized URLs plus `domains`, `allow`, `deny` rules.

## crawl

**`site_crawler/crawl/fetcher.py`**

- Thin wrapper around `crawl4ai`/`AsyncWebCrawler`.
- Given a URL and `SiteConfig`, returns `FetchResult` with HTML, markdown (if available), title, children, and status.
- Handles timeouts and errors; logs but does not crash the process.

**`site_crawler/crawl/orchestrator.py`**

- Owns crawl orchestration:

  - Seed and scope initialization from `SiteConfig` and CLI options.
  - Queue management, depth tracking, dedup, and deterministic ordering.
  - Integration with extract/markdown/assets/link rewriting.
  - Incremental recrawl planning using existing metadata.
- Does not contain site-specific behavior.

## content & assets

**`site_crawler/content/extract.py`**

- Applies `content.keep`/`content.remove` selectors from `SiteConfig` to HTML.
- Returns a clean HTML fragment representing the main content region.
- Discovers child links from the page.

**`site_crawler/content/markdown.py`**

- Normalizes markdown and builds frontmatter.
- Computes checksums from content bodies.
- Ensures top-level headings and consistent metadata.

**`site_crawler/assets/images.py`**

- Downloads images referenced in markdown when enabled.
- Names assets using a stable hash of the remote URL + extension.
- Rewrites image links to local relative paths.

## links

**`site_crawler/links/rewrite.py`**

- Rewrites markdown links from URL-based to relative local paths when `mode='local'`.
- Uses URL normalization + scope logic to classify internal vs external links.

**`site_crawler/links/check.py`**

- Validates that all internal links in generated markdown resolve to existing files.
- Returns a list of broken links and supports a non-zero exit code for CI.

## storage & utils

**`site_crawler/storage/files.py`**

- Safe file writes (`write_text`) and directory handling (`ensure_dir`).
- No knowledge of markdown semantics.

**`site_crawler/storage/index.py`**

- Builds and writes `index.json` mapping markdown paths to titles.
- Used by both crawl and postprocess/linkcheck flows.

**`site_crawler/utils/slug.py`**

- Text slugging and path utilities.
- No external IO.

## cli

**`site_crawler/cli/crawl_cli.py`**

- Typer entrypoint for `crawl`.
- Loads `SiteConfig` via loader/registry, constructs crawl options, and invokes orchestrator.

**`site_crawler/cli/postprocess_cli.py`**

- Typer entrypoint for `postprocess`.
- Runs link rewriting and index rebuilds on existing markdown.

**`site_crawler/cli/linkcheck_cli.py`**

- Typer entrypoint for `linkcheck`.
- Uses `links/check.py` and `SiteConfig` to report broken links.

---

# layering and dependency rules

- **Foundation (Phase 0)**: `utils/slug`, `storage/files`, `storage/index`, `config/model`.
- **URL & Config (Phase 1)**: `config/loader`, `config/registry`, `url/normalize`, `url/scope`.
- **Content & Assets (Phase 2)**: `content/markdown`, `assets/images`, `content/extract`.
- **Fetch & Crawl Core (Phase 3)**: `crawl/fetcher`, `crawl/orchestrator`, `links/rewrite`, `links/check`.
- **CLI (Phase 4)**: `cli/*`.

Rules:

1. Lower layers must not import higher layers.
2. Cross-layer utilities go into the **lowest** reasonable layer.
3. New modules must declare their place in this stack and follow the same direction of dependencies.

---

# testing rules

- Aim for ≥ 85% line/function/statement coverage and ≥ 75% branch coverage for core modules.
- Prefer pure functions in config, URL, content, and link modules to simplify unit tests.
- Use local HTTP fixtures for integration tests of fetcher and orchestrator.
- Use golden-file tests for markdown output and `index.json` to catch regressions.
- Keep tests deterministic:

  - Mock timestamps where they affect checksums or output.
  - Fix user agents and any random seeds.

Critical scenarios to cover:

- Config/loader: valid + invalid configs, bad regexes, missing domains/entrypoints.
- URL/scope: mixed schemes, subdomains, trailing slashes, malformed URLs.
- Content/markdown: missing titles/headings, unparseable HTML, alternate frontmatter modes.
- Assets: HTTP errors on image download, data URIs and non-HTTP sources.
- Links: internal vs external classification, missing targets.
- Orchestrator + CLI: depth limits, dry-run, robots blocking, network failures.

---

# UX and behavior expectations

- CLI help text should prioritize config-driven usage (`--config`, `--site`) over legacy profiles.
- Errors for config and scope issues must identify the offending site, field, or URL.
- Crawl summary output should include at least:

  - planned pages
  - crawled pages
  - skipped (cache/unchanged)
  - assets downloaded
  - robots-blocked URLs

---

# non-goals (MVP)

- No attempt to perfectly handle every arbitrary SPA or authenticated site.
- No custom headless-browser automation beyond what `crawl4ai` already supports.
- No site-specific hacks in the core layers; such behavior belongs in adapters or configs only.

---

# docs map

- `crawl_PRD.md` – product requirements, capability tree, phases, and test strategy (authoritative high-level design).
- `README.md` (when present) – user-facing CLI overview and quick start.
- `profiles/*` – example `SiteConfig` definitions for common sites.
- `tests/site_crawler/*` – regression tests for config, URL normalization, scoping, and core flows.


--- .taskmaster/AGENT.md ---
# Task Master AI - Agent Integration Guide

## Essential Commands

### Core Workflow Commands

```bash
# Project Setup
task-master init                                    # Initialize Task Master in current project
task-master parse-prd .taskmaster/docs/prd.md       # Generate tasks from PRD document
task-master models --setup                        # Configure AI models interactively

# Daily Development Workflow
task-master list                                   # Show all tasks with status
task-master next                                   # Get next available task to work on
task-master show <id>                             # View detailed task information (e.g., task-master show 1.2)
task-master set-status --id=<id> --status=done    # Mark task complete

# Task Management
task-master add-task --prompt="description" --research        # Add new task with AI assistance
task-master expand --id=<id> --research --force              # Break task into subtasks
task-master update-task --id=<id> --prompt="changes"         # Update specific task
task-master update --from=<id> --prompt="changes"            # Update multiple tasks from ID onwards
task-master update-subtask --id=<id> --prompt="notes"        # Add implementation notes to subtask

# Analysis & Planning
task-master analyze-complexity --research          # Analyze task complexity
task-master complexity-report                      # View complexity analysis
task-master expand --all --research               # Expand all eligible tasks

# Dependencies & Organization
task-master add-dependency --id=<id> --depends-on=<id>       # Add task dependency
task-master move --from=<id> --to=<id>                       # Reorganize task hierarchy
task-master validate-dependencies                            # Check for dependency issues
task-master generate                                         # Update task markdown files (usually auto-called)
```

## Key Files & Project Structure

### Core Files

- `.taskmaster/tasks/tasks.json` - Main task data file (auto-managed)
- `.taskmaster/config.json` - AI model configuration (use `task-master models` to modify)
- `.taskmaster/docs/prd.md` - Product Requirements Document for parsing (`.md` extension recommended for better editor support)
- `.taskmaster/tasks/*.txt` - Individual task files (auto-generated from tasks.json)
- `.env` - API keys for CLI usage

**PRD File Format:** While both `.txt` and `.md` extensions work, **`.md` is recommended** because:
- Markdown syntax highlighting in editors improves readability
- Proper rendering when previewing in VS Code, GitHub, or other tools
- Better collaboration through formatted documentation

### Claude Code Integration Files

- `CLAUDE.md` - Auto-loaded context for Claude Code (this file)
- `.claude/settings.json` - Claude Code tool allowlist and preferences
- `.claude/commands/` - Custom slash commands for repeated workflows
- `.mcp.json` - MCP server configuration (project-specific)

### Directory Structure

```
project/
├── .taskmaster/
│   ├── tasks/              # Task files directory
│   │   ├── tasks.json      # Main task database
│   │   ├── task-1.md      # Individual task files
│   │   └── task-2.md
│   ├── docs/              # Documentation directory
│   │   ├── prd.md         # Product requirements (.md recommended)
│   ├── reports/           # Analysis reports directory
│   │   └── task-complexity-report.json
│   ├── templates/         # Template files
│   │   └── example_prd.md  # Example PRD template (.md recommended)
│   └── config.json        # AI models & settings
├── .claude/
│   ├── settings.json      # Claude Code configuration
│   └── commands/         # Custom slash commands
├── .env                  # API keys
├── .mcp.json            # MCP configuration
└── CLAUDE.md            # This file - auto-loaded by Claude Code
```

## MCP Integration

Task Master provides an MCP server that Claude Code can connect to. Configure in `.mcp.json`:

```json
{
  "mcpServers": {
    "task-master-ai": {
      "command": "npx",
      "args": ["-y", "task-master-ai"],
      "env": {
        "ANTHROPIC_API_KEY": "your_key_here",
        "PERPLEXITY_API_KEY": "your_key_here",
        "OPENAI_API_KEY": "OPENAI_API_KEY_HERE",
        "GOOGLE_API_KEY": "GOOGLE_API_KEY_HERE",
        "XAI_API_KEY": "XAI_API_KEY_HERE",
        "OPENROUTER_API_KEY": "OPENROUTER_API_KEY_HERE",
        "MISTRAL_API_KEY": "MISTRAL_API_KEY_HERE",
        "AZURE_OPENAI_API_KEY": "AZURE_OPENAI_API_KEY_HERE",
        "OLLAMA_API_KEY": "OLLAMA_API_KEY_HERE"
      }
    }
  }
}
```

### Essential MCP Tools

```javascript
help; // = shows available taskmaster commands
// Project setup
initialize_project; // = task-master init
parse_prd; // = task-master parse-prd

// Daily workflow
get_tasks; // = task-master list
next_task; // = task-master next
get_task; // = task-master show <id>
set_task_status; // = task-master set-status

// Task management
add_task; // = task-master add-task
expand_task; // = task-master expand
update_task; // = task-master update-task
update_subtask; // = task-master update-subtask
update; // = task-master update

// Analysis
analyze_project_complexity; // = task-master analyze-complexity
complexity_report; // = task-master complexity-report
```

## Claude Code Workflow Integration

### Standard Development Workflow

#### 1. Project Initialization

```bash
# Initialize Task Master
task-master init

# Create or obtain PRD, then parse it (use .md extension for better editor support)
task-master parse-prd .taskmaster/docs/prd.md

# Analyze complexity and expand tasks
task-master analyze-complexity --research
task-master expand --all --research
```

If tasks already exist, another PRD can be parsed (with new information only!) using parse-prd with --append flag. This will add the generated tasks to the existing list of tasks..

#### 2. Daily Development Loop

```bash
# Start each session
task-master next                           # Find next available task
task-master show <id>                     # Review task details

# During implementation, check in code context into the tasks and subtasks
task-master update-subtask --id=<id> --prompt="implementation notes..."

# Complete tasks
task-master set-status --id=<id> --status=done
```

#### 3. Multi-Claude Workflows

For complex projects, use multiple Claude Code sessions:

```bash
# Terminal 1: Main implementation
cd project && claude

# Terminal 2: Testing and validation
cd project-test-worktree && claude

# Terminal 3: Documentation updates
cd project-docs-worktree && claude
```

### Custom Slash Commands

Create `.claude/commands/taskmaster-next.md`:

```markdown
Find the next available Task Master task and show its details.

Steps:

1. Run `task-master next` to get the next task
2. If a task is available, run `task-master show <id>` for full details
3. Provide a summary of what needs to be implemented
4. Suggest the first implementation step
```

Create `.claude/commands/taskmaster-complete.md`:

```markdown
Complete a Task Master task: $ARGUMENTS

Steps:

1. Review the current task with `task-master show $ARGUMENTS`
2. Verify all implementation is complete
3. Run any tests related to this task
4. Mark as complete: `task-master set-status --id=$ARGUMENTS --status=done`
5. Show the next available task with `task-master next`
```

## Tool Allowlist Recommendations

Add to `.claude/settings.json`:

```json
{
  "allowedTools": [
    "Edit",
    "Bash(task-master *)",
    "Bash(git commit:*)",
    "Bash(git add:*)",
    "Bash(npm run *)",
    "mcp__task_master_ai__*"
  ]
}
```

## Configuration & Setup

### API Keys Required

At least **one** of these API keys must be configured:

- `ANTHROPIC_API_KEY` (Claude models) - **Recommended**
- `PERPLEXITY_API_KEY` (Research features) - **Highly recommended**
- `OPENAI_API_KEY` (GPT models)
- `GOOGLE_API_KEY` (Gemini models)
- `MISTRAL_API_KEY` (Mistral models)
- `OPENROUTER_API_KEY` (Multiple models)
- `XAI_API_KEY` (Grok models)

An API key is required for any provider used across any of the 3 roles defined in the `models` command.

### Model Configuration

```bash
# Interactive setup (recommended)
task-master models --setup

# Set specific models
task-master models --set-main claude-3-5-sonnet-20241022
task-master models --set-research perplexity-llama-3.1-sonar-large-128k-online
task-master models --set-fallback gpt-4o-mini
```

## Task Structure & IDs

### Task ID Format

- Main tasks: `1`, `2`, `3`, etc.
- Subtasks: `1.1`, `1.2`, `2.1`, etc.
- Sub-subtasks: `1.1.1`, `1.1.2`, etc.

### Task Status Values

- `pending` - Ready to work on
- `in-progress` - Currently being worked on
- `done` - Completed and verified
- `deferred` - Postponed
- `cancelled` - No longer needed
- `blocked` - Waiting on external factors

### Task Fields

```json
{
  "id": "1.2",
  "title": "Implement user authentication",
  "description": "Set up JWT-based auth system",
  "status": "pending",
  "priority": "high",
  "dependencies": ["1.1"],
  "details": "Use bcrypt for hashing, JWT for tokens...",
  "testStrategy": "Unit tests for auth functions, integration tests for login flow",
  "subtasks": []
}
```

## Claude Code Best Practices with Task Master

### Context Management

- Use `/clear` between different tasks to maintain focus
- This CLAUDE.md file is automatically loaded for context
- Use `task-master show <id>` to pull specific task context when needed

### Iterative Implementation

1. `task-master show <subtask-id>` - Understand requirements
2. Explore codebase and plan implementation
3. `task-master update-subtask --id=<id> --prompt="detailed plan"` - Log plan
4. `task-master set-status --id=<id> --status=in-progress` - Start work
5. Implement code following logged plan
6. `task-master update-subtask --id=<id> --prompt="what worked/didn't work"` - Log progress
7. `task-master set-status --id=<id> --status=done` - Complete task

### Complex Workflows with Checklists

For large migrations or multi-step processes:

1. Create a markdown PRD file describing the new changes: `touch task-migration-checklist.md` (prds can be .txt or .md)
2. Use Taskmaster to parse the new prd with `task-master parse-prd --append` (also available in MCP)
3. Use Taskmaster to expand the newly generated tasks into subtasks. Consdier using `analyze-complexity` with the correct --to and --from IDs (the new ids) to identify the ideal subtask amounts for each task. Then expand them.
4. Work through items systematically, checking them off as completed
5. Use `task-master update-subtask` to log progress on each task/subtask and/or updating/researching them before/during implementation if getting stuck

### Git Integration

Task Master works well with `gh` CLI:

```bash
# Create PR for completed task
gh pr create --title "Complete task 1.2: User authentication" --body "Implements JWT auth system as specified in task 1.2"

# Reference task in commits
git commit -m "feat: implement JWT auth (task 1.2)"
```

### Parallel Development with Git Worktrees

```bash
# Create worktrees for parallel task development
git worktree add ../project-auth feature/auth-system
git worktree add ../project-api feature/api-refactor

# Run Claude Code in each worktree
cd ../project-auth && claude    # Terminal 1: Auth work
cd ../project-api && claude     # Terminal 2: API work
```

## Troubleshooting

### AI Commands Failing

```bash
# Check API keys are configured
cat .env                           # For CLI usage

# Verify model configuration
task-master models

# Test with different model
task-master models --set-fallback gpt-4o-mini
```

### MCP Connection Issues

- Check `.mcp.json` configuration
- Verify Node.js installation
- Use `--mcp-debug` flag when starting Claude Code
- Use CLI as fallback if MCP unavailable

### Task File Sync Issues

```bash
# Regenerate task files from tasks.json
task-master generate

# Fix dependency issues
task-master fix-dependencies
```

DO NOT RE-INITIALIZE. That will not do anything beyond re-adding the same Taskmaster core files.

## Important Notes

### AI-Powered Operations

These commands make AI calls and may take up to a minute:

- `parse_prd` / `task-master parse-prd`
- `analyze_project_complexity` / `task-master analyze-complexity`
- `expand_task` / `task-master expand`
- `expand_all` / `task-master expand --all`
- `add_task` / `task-master add-task`
- `update` / `task-master update`
- `update_task` / `task-master update-task`
- `update_subtask` / `task-master update-subtask`

### File Management

- Never manually edit `tasks.json` - use commands instead
- Never manually edit `.taskmaster/config.json` - use `task-master models`
- Task markdown files in `tasks/` are auto-generated
- Run `task-master generate` after manual changes to tasks.json

### Claude Code Session Management

- Use `/clear` frequently to maintain focused context
- Create custom slash commands for repeated Task Master workflows
- Configure tool allowlist to streamline permissions
- Use headless mode for automation: `claude -p "task-master next"`

### Multi-Task Updates

- Use `update --from=<id>` to update multiple future tasks
- Use `update-task --id=<id>` for single task updates
- Use `update-subtask --id=<id>` for implementation logging

### Research Mode

- Add `--research` flag for research-based AI enhancement
- Requires a research model API key like Perplexity (`PERPLEXITY_API_KEY`) in environment
- Provides more informed task creation and updates
- Recommended for complex technical tasks

---

_This guide ensures Claude Code has immediate access to Task Master's essential functionality for agentic development workflows._


--- README.md ---
# Generic Crawl Tool

This repository hosts a config-first crawler built on Crawl4AI for producing offline Markdown mirrors with deterministic link structures.

## Features

- **Generic seed mode**: `uv run crawl --seed https://example.com/docs --depth-limit 3` crawls any docs-style site using runtime flags for scope and selectors.
- **Legacy compatibility shim**: `--site fullstackopen` and `--site nextjs-learn` continue to work while reusing the new generic engine.
- **Link processing pipeline**: Markdown conversion, optional image download, frontmatter metadata, index generation, rewriter, and linkcheck share the same generic configuration.
- **Safety first**: Respect robots.txt, configurable rate limits, checksum-based skip logic, and deterministic queue ordering.

## Setup

```bash
uv venv .venv
source .venv/bin/activate
uv pip install -e '.[dev]'
uv run python -m playwright install chromium  # required for Chromium-based crawling
```

## CLI

```bash
uv run crawl --seed https://nextjs.org/learn --depth-limit 5 --keep-selector main --keep-selector article
uv run crawl --site fullstackopen --rewrite-links local    # compatibility shim
uv run python -m fullstackopen_en_repo.postprocess --rewrite-links local
uv run python -m fullstackopen_en_repo.linkcheck
```

> **Note:** The crawl CLI auto-installs Playwright's Chromium build on first run if it is missing. The `uv run python -m playwright install chromium` step above keeps the initial crawl fast and deterministic.

### Smithery Skills Scraper

A specialized profile for scraping Smithery AI skills is available.

1. **Run the dedicated script**
   ```bash
   ./scrape_smithery.sh
   ```
   This script sets up the environment and runs the crawler with the `smithery` profile.

2. **Configuration**
   The profile is defined in `profiles/smithery.yml` and targets `https://smithery.ai/skills`. It handles the custom single-page application structure of Smithery to extract skill detail pages.

### Quick start

1. **Install dependencies once**
   ```bash
   uv venv .venv && source .venv/bin/activate
   uv pip install -e '.[dev]'
   uv run python -m playwright install chromium
   ```
2. **Run a legacy profile crawl**
   ```bash
   uv run crawl --site fullstackopen --rewrite-links none
   ```
   Output Markdown lands under `data/fullstackopen/` and a summary is printed.
3. **Rewrite/internalize links (optional)**
   ```bash
   uv run python -m fullstackopen_en_repo.postprocess --site fullstackopen --rewrite-links local
   ```
4. **Linkcheck**
   ```bash
   uv run python -m fullstackopen_en_repo.linkcheck --site fullstackopen
   ```
5. **Generic crawl**
   ```bash
   uv run crawl --seed https://ui.shadcn.com/docs --depth-limit 3 --scope-prefix /docs/
   ```
   Use `--keep-selector` / `--drop-selector` to fine-tune extraction, and `--include-assets` to toggle image downloads.

### Common flags

| Flag | Description |
|------|-------------|
| `--seed <url>` | Enable generic mode starting from a seed URL. Mutually exclusive with `--site`. |
| `--site <name>` | Use a legacy adapter (e.g., `fullstackopen`, `nextjs-learn`). Defaults to `fullstackopen`. |
| `--depth-limit <n>` | Override the max crawl depth. Applies to both generic and site modes. |
| `--rewrite-links [none|local]` | Leave Markdown links pointing at source URLs (`none`) or rewrite to local relative paths (`local`). |
| `--scope-prefix <path>` | When using `--seed`, limit crawling to URLs under the given path prefix (e.g., `/docs/`). |
| `--keep-selector <css>` | Additional CSS selectors to keep when extracting content. Repeatable. |
| `--drop-selector <css>` | Additional selectors to remove (nav, footer, etc.). Repeatable. |
| `--include-assets/--no-include-assets` | Toggle image downloading. Enabled by default for both site and generic crawls. |
| `--save-html` | Store raw HTML alongside Markdown for debugging. |
| `--dry-run` | Plan the crawl without fetching or writing files. |

#### Flag examples

- **`--seed`** (generic mode):
  ```bash
  uv run crawl --seed https://ui.shadcn.com/docs/directory --depth-limit 0
  ```
- **`--site`** (legacy adapter):
  ```bash
  uv run crawl --site fullstackopen --rewrite-links local
  ```
- **`--depth-limit`**: limits traversal depth.
  ```bash
  uv run crawl --seed https://example.com/docs --depth-limit 1
  ```
- **`--rewrite-links`**: rewrites Markdown hyperlinks.
  ```bash
  uv run crawl --site fullstackopen --rewrite-links local
  ```
- **`--scope-prefix`**: keeps generic crawls inside a path.
  ```bash
  uv run crawl --seed https://example.com --scope-prefix /docs/
  ```
- **`--keep-selector` / `--drop-selector`**: accept any CSS selector string. Pass the flag multiple times to add selectors. Example keeps `<main>` and `<article>` while removing nav/footer:
  ```bash
  uv run crawl --seed https://example.com/docs \
    --keep-selector main --keep-selector article \
    --drop-selector nav --drop-selector footer
  ```
- **`--include-assets/--no-include-assets`**: toggle image downloads.
  ```bash
  uv run crawl --seed https://example.com/docs --no-include-assets
  ```
- **`--save-html`**: store html next to markdown.
  ```bash
  uv run crawl --site fullstackopen --save-html
  ```
- **`--dry-run`**: plan without fetching.
  ```bash
  uv run crawl --seed https://example.com/docs --dry-run
  ```

| Command | Purpose |
|---------|---------|
| `uv run crawl` | Run crawler in generic or shimmed profile mode |
| `uv run python -m fullstackopen_en_repo.postprocess` | Rewrite internal Markdown links and rebuild index |
| `uv run python -m fullstackopen_en_repo.linkcheck` | Validate generated Markdown references |

## Testing

```bash
uv run ruff format . && uv run ruff check .
uv run mypy .
uv run bandit -r .
uv run pytest
```

## Project Layout

```
src/
├── fullstackopen_en_repo/    # shim layer + CLI wrappers
└── webcrawl/                 # new generic engine (config, crawl, content, output)
```

## Migration Notes

- `profiles/*` legacy classes are being replaced by runtime generic configuration; avoid adding new profile subclasses.
- Seed-driven mode should be the default for new sites. Legacy profile flags will be removed once documentation and tests fully cover the generic path.
- Use `uv` exclusively for environment management and command execution in this repo.

--- diagnostics.py ---
from crawl4ai import AsyncWebCrawler
import asyncio

async def run():
    async with AsyncWebCrawler() as crawler:
        res = await crawler.arun(url='https://example.com', stream=False)
        print('type', type(res))
        print('has async iter?', hasattr(res, '__aiter__'))

asyncio.run(run())


--- repro.py ---
import asyncio

async def fail():
    raise RuntimeError("foo")

def run():
    return asyncio.run(fail())

for i in range(2):
    try:
        run()
    except Exception as exc:
        print("caught", exc)


--- script.py ---
import asyncio

async def fail():
    raise RuntimeError("foo")

for i in range(2):
    try:
        asyncio.run(fail())
    except Exception as exc:
        print("caught", exc)


--- .archived/data/part5/01-404-page-not-found.md ---
---{
  "title": "404 - Page not found",
  "source_url": "https://fullstackopen.com/en/part5/end_to_end_testing",
  "crawl_timestamp": "2025-10-04T19:17:33Z",
  "checksum": "8ddd231f83f6f5da4406fd4c313e94bd7bbe85d7cba93788da9980f02624d172"
}
---[Skip to content](../part5/01-end-to-end-testing-main-content.md)
[{() => fs}](https://fullstackopen.com/)

- [About course](https://fullstackopen.com/about)
- [Course contents](https://fullstackopen.com/#course-contents)
- [FAQ](https://fullstackopen.com/faq)
- [Partners](https://fullstackopen.com/companies)
- [Challenge](https://fullstackopen.com/challenge)
[Search from the material](https://fullstackopen.com/search)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

# 404 - Page not found
Uncaught ReferenceError: unknown is not defined
[Go back home](https://fullstackopen.com/osa/)
[About course](https://fullstackopen.com/about)[Course contents](https://fullstackopen.com/#course-contents)[FAQ](https://fullstackopen.com/faq)[Partners](https://fullstackopen.com/companies)[Challenge](https://fullstackopen.com/challenge)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part5/01-end-to-end-testing-main-content.md)
- [{() => fs}](https://fullstackopen.com/)
- [About course](https://fullstackopen.com/about)
- [Course contents](https://fullstackopen.com/#course-contents)
- [FAQ](https://fullstackopen.com/faq)
- [Partners](https://fullstackopen.com/companies)
- [Challenge](https://fullstackopen.com/challenge)
- [Search from the material](https://fullstackopen.com/search)
- [Go back home](https://fullstackopen.com/osa/)

--- .archived/data/part1/01-a-more-complex-state-debugging-react-apps.md ---
---{
  "title": "A more complex state, debugging React apps",
  "source_url": "https://fullstackopen.com/en/part1/a_more_complex_state_debugging_react_apps",
  "crawl_timestamp": "2025-10-04T19:15:34Z",
  "checksum": "1ecc7ea5d7e355fccf70cc0e8c60dd7755f31a67fc14b176e39d8cd46e0e19ab"
}
---[Skip to content](../part1/01-a-more-complex-state-debugging-react-apps-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 1](../part1/01-part1.md)
A more complex state, debugging React apps
[a Introduction to React](../part1/01-introduction-to-react.md)[b JavaScript](../part1/01-java-script.md)[c Component state, event handlers](../part1/01-component-state-event-handlers.md)
d A more complex state, debugging React apps

- [Complex state](../part1/01-a-more-complex-state-debugging-react-apps-complex-state.md)
- [Handling arrays](../part1/01-a-more-complex-state-debugging-react-apps-handling-arrays.md)
- [Update of the state is asynchronous](../part1/01-a-more-complex-state-debugging-react-apps-update-of-the-state-is-asynchronous.md)
- [Conditional rendering](../part1/01-a-more-complex-state-debugging-react-apps-conditional-rendering.md)
- [Old React](../part1/01-a-more-complex-state-debugging-react-apps-old-react.md)
- [Debugging React applications](../part1/01-a-more-complex-state-debugging-react-apps-debugging-react-applications.md)
- [Rules of Hooks](../part1/01-a-more-complex-state-debugging-react-apps-rules-of-hooks.md)
- [Event Handling Revisited](../part1/01-a-more-complex-state-debugging-react-apps-event-handling-revisited.md)
- [A function that returns a function](../part1/01-a-more-complex-state-debugging-react-apps-a-function-that-returns-a-function.md)
- [Passing Event Handlers to Child Components](../part1/01-a-more-complex-state-debugging-react-apps-passing-event-handlers-to-child-components.md)
- [Do Not Define Components Within Components](../part1/01-a-more-complex-state-debugging-react-apps-do-not-define-components-within-components.md)
- [Useful Reading](../part1/01-a-more-complex-state-debugging-react-apps-useful-reading.md)
- [Web programmers oath](../part1/01-a-more-complex-state-debugging-react-apps-web-programmers-oath.md)
- [Utilization of Large language models](../part1/01-a-more-complex-state-debugging-react-apps-utilization-of-large-language-models.md)
- [Exercises 1.6.-1.14.](../part1/01-a-more-complex-state-debugging-react-apps-exercises-1-6-1-14.md)


d
# A more complex state, debugging React apps
### Complex state
In our previous example, the application state was simple as it was comprised of a single integer. What if our application requires a more complex state?
In most cases, the easiest and best way to accomplish this is by using the _useState_ function multiple times to create separate "pieces" of state.
In the following code we create two pieces of state for the application named _left_ and _right_ that both get the initial value of 0:

```
const App = () => {
  const [left, setLeft] = useState(0)
  const [right, setRight] = useState(0)

  return (
    <div>
      {left}
      <button onClick={() => setLeft(left + 1)}>
        left
      </button>
      <button onClick={() => setRight(right + 1)}>
        right
      </button>
      {right}
    </div>
  )
}copy
```

The component gets access to the functions _setLeft_ and _setRight_ that it can use to update the two pieces of state.
The component's state or a piece of its state can be of any type. We could implement the same functionality by saving the click count of both the _left_ and _right_ buttons into a single object:

```
{
  left: 0,
  right: 0
}copy
```

In this case, the application would look like this:

```
const App = () => {
  const [clicks, setClicks] = useState({
    left: 0, right: 0
  })

  const handleLeftClick = () => {
    const newClicks = { 
      left: clicks.left + 1, 
      right: clicks.right 
    }
    setClicks(newClicks)
  }

  const handleRightClick = () => {
    const newClicks = { 
      left: clicks.left, 
      right: clicks.right + 1 
    }
    setClicks(newClicks)
  }

  return (
    <div>
      {clicks.left}
      <button onClick={handleLeftClick}>left</button>
      <button onClick={handleRightClick}>right</button>
      {clicks.right}
    </div>
  )
}copy
```

Now the component only has a single piece of state and the event handlers have to take care of changing the _entire application state_.
The event handler looks a bit messy. When the left button is clicked, the following function is called:

```
const handleLeftClick = () => {
  const newClicks = { 
    left: clicks.left + 1, 
    right: clicks.right 
  }
  setClicks(newClicks)
}copy
```

The following object is set as the new state of the application:

```
{
  left: clicks.left + 1,
  right: clicks.right
}copy
```

The new value of the _left_ property is now the same as the value of _left + 1_ from the previous state, and the value of the _right_ property is the same as the value of the _right_ property from the previous state.
We can define the new state object a bit more neatly by using the

```
const handleLeftClick = () => {
  const newClicks = { 
    ...clicks, 
    left: clicks.left + 1 
  }
  setClicks(newClicks)
}

const handleRightClick = () => {
  const newClicks = { 
    ...clicks, 
    right: clicks.right + 1 
  }
  setClicks(newClicks)
}copy
```

The syntax may seem a bit strange at first. In practice _{ ...clicks }_ creates a new object that has copies of all of the properties of the _clicks_ object. When we specify a particular property - e.g. _right_ in _{ ...clicks, right: 1 }_ , the value of the _right_ property in the new object will be 1.
In the example above, this:

```
{ ...clicks, right: clicks.right + 1 }copy
```

creates a copy of the _clicks_ object where the value of the _right_ property is increased by one.
Assigning the object to a variable in the event handlers is not necessary and we can simplify the functions to the following form:

```
const handleLeftClick = () =>
  setClicks({ ...clicks, left: clicks.left + 1 })

const handleRightClick = () =>
  setClicks({ ...clicks, right: clicks.right + 1 })copy
```

Some readers might be wondering why we didn't just update the state directly, like this:

```
const handleLeftClick = () => {
  clicks.left++
  setClicks(clicks)
}copy
```

The application appears to work. However, _it is forbidden in React to mutate state directly_ , since
Storing all of the state in a single state object is a bad choice for this particular application; there's no apparent benefit and the resulting application is a lot more complex. In this case, storing the click counters into separate pieces of state is a far more suitable choice.
There are situations where it can be beneficial to store a piece of application state in a more complex data structure.
### Handling arrays
Let's add a piece of state to our application containing an array _allClicks_ that remembers every click that has occurred in the application.

```
const App = () => {
  const [left, setLeft] = useState(0)
  const [right, setRight] = useState(0)
  const [allClicks, setAll] = useState([])
  const handleLeftClick = () => {    setAll(allClicks.concat('L'))    setLeft(left + 1)  }
  const handleRightClick = () => {    setAll(allClicks.concat('R'))    setRight(right + 1)  }
  return (
    <div>
      {left}
      <button onClick={handleLeftClick}>left</button>
      <button onClick={handleRightClick}>right</button>
      {right}
      <p>{allClicks.join(' ')}</p>    </div>
  )
}copy
```

Every click is stored in a separate piece of state called _allClicks_ that is initialized as an empty array:

```
const [allClicks, setAll] = useState([])copy
```

When the _left_ button is clicked, we add the letter _L_ to the _allClicks_ array:

```
const handleLeftClick = () => {
  setAll(allClicks.concat('L'))
  setLeft(left + 1)
}copy
```

The piece of state stored in _allClicks_ is now set to be an array that contains all of the items of the previous state array plus the letter _L_. Adding the new item to the array is accomplished with the _new copy of the array_ with the item added to it.
As mentioned previously, it's also possible in JavaScript to add items to an array with the _allClicks_ array and then updating the state, the application would still appear to work:

```
const handleLeftClick = () => {
  allClicks.push('L')
  setAll(allClicks)
  setLeft(left + 1)
}copy
```

However, **don't** do this. As mentioned previously, the state of React components, like _allClicks_ , must not be mutated directly. Even if mutating state appears to work in some cases, it can lead to problems that are very hard to debug.
Let's take a closer look at how the clicking is rendered to the page:

```
const App = () => {
  // ...

  return (
    <div>
      {left}
      <button onClick={handleLeftClick}>left</button>
      <button onClick={handleRightClick}>right</button>
      {right}
      <p>{allClicks.join(' ')}</p>    </div>
  )
}copy
```

We call the _allClicks_ array, that joins all the items into a single string, separated by the string passed as the function parameter, which in our case is an empty space.
### Update of the state is asynchronous
Let's expand the application so that it keeps track of the total number of button presses in the state _total_ , whose value is always updated when the buttons are pressed:

```
const App = () => {
  const [left, setLeft] = useState(0)
  const [right, setRight] = useState(0)
  const [allClicks, setAll] = useState([])
  const [total, setTotal] = useState(0)
  const handleLeftClick = () => {
    setAll(allClicks.concat('L'))
    setLeft(left + 1)
    setTotal(left + right)  }

  const handleRightClick = () => {
    setAll(allClicks.concat('R'))
    setRight(right + 1)
    setTotal(left + right)  }

  return (
    <div>
      {left}
      <button onClick={handleLeftClick}>left</button>
      <button onClick={handleRightClick}>right</button>
      {right}
      <p>{allClicks.join(' ')}</p>
      <p>total {total}</p>    </div>
  )
}copy
```

The solution does not quite work:
![browser showing 2 left|right 1, RLL total 2](../assets/1e55856d933562eb.png)
The total number of button presses is consistently one less than the actual amount of presses, for some reason.
Let us add couple of console.log statements to the event handler:

```
const App = () => {
  // ...
  const handleLeftClick = () => {
    setAll(allClicks.concat('L'))
    console.log('left before', left)    setLeft(left + 1)
    console.log('left after', left)    setTotal(left + right) 
  }

  // ...
}copy
```

The console reveals the problem
![devtools console showing left before 4 and left after 4](../assets/6f78ad95cb590b57.png)
Even though a new value was set for _left_ by calling _setLeft(left + 1)_ , the old value persists despite the update. As a result, the attempt to count button presses produces a result that is too small:

```
setTotal(left + right) copy
```

The reason for this is that a state update in React happens
We can fix the app as follows:

```
const App = () => {
  // ...
  const handleLeftClick = () => {
    setAll(allClicks.concat('L'))
    const updatedLeft = left + 1
    setLeft(updatedLeft)
    setTotal(updatedLeft + right) 
  }

  // ...
}copy
```

So now the number of button presses is definitely based on the correct number of left button presses.
We can also handle asynchronous updates for the right button:

```
const App = () => {
  // ...
  const handleRightClick = () => {
    setAll(allClicks.concat('R'));
    const updatedRight = right + 1;
    setRight(updatedRight);
    setTotal(left + updatedRight);
  };

  // ...
}copy
```

### Conditional rendering
Let's modify our application so that the rendering of the clicking history is handled by a new _History_ component:

```
const History = (props) => {  if (props.allClicks.length === 0) {    return (      <div>        the app is used by pressing the buttons      </div>    )  }  return (    <div>      button press history: {props.allClicks.join(' ')}    </div>  )}
const App = () => {
  // ...

  return (
    <div>
      {left}
      <button onClick={handleLeftClick}>left</button>
      <button onClick={handleRightClick}>right</button>
      {right}
      <History allClicks={allClicks} />    </div>
  )
}copy
```

Now the behavior of the component depends on whether or not any buttons have been clicked. If not, meaning that the _allClicks_ array is empty, the component renders a div element with some instructions instead:

```
<div>the app is used by pressing the buttons</div>copy
```

And in all other cases, the component renders the clicking history:

```
<div>
  button press history: {props.allClicks.join(' ')}
</div>copy
```

The _History_ component renders completely different React elements depending on the state of the application. This is called _conditional rendering_.
React also offers many other ways of doing [part 2](../part2/01-part2.md).
Let's make one last modification to our application by refactoring it to use the _Button_ component that we defined earlier on:

```
const History = (props) => {
  if (props.allClicks.length === 0) {
    return (
      <div>
        the app is used by pressing the buttons
      </div>
    )
  }

  return (
    <div>
      button press history: {props.allClicks.join(' ')}
    </div>
  )
}

const Button = ({ onClick, text }) => <button onClick={onClick}>{text}</button>
const App = () => {
  const [left, setLeft] = useState(0)
  const [right, setRight] = useState(0)
  const [allClicks, setAll] = useState([])

  const handleLeftClick = () => {
    setAll(allClicks.concat('L'))
    setLeft(left + 1)
  }

  const handleRightClick = () => {
    setAll(allClicks.concat('R'))
    setRight(right + 1)
  }

  return (
    <div>
      {left}
      <Button onClick={handleLeftClick} text='left' />      <Button onClick={handleRightClick} text='right' />      {right}
      <History allClicks={allClicks} />
    </div>
  )
}copy
```

### Old React
In this course, we use the
In this course, we have made the slightly radical decision to use hooks exclusively from day one, to ensure that we are learning the current and future variations of React. Even though functional components are the future of React, it is still important to learn the class syntax, as there are billions of lines of legacy React code that you might end up maintaining someday. The same applies to documentation and examples of React that you may stumble across on the internet.
We will learn more about React class components later on in the course.
### Debugging React applications
A large part of a typical developer's time is spent on debugging and reading existing code. Every now and then we do get to write a line or two of new code, but a large part of our time is spent trying to figure out why something is broken or how something works. Good practices and tools for debugging are extremely important for this reason.
Lucky for us, React is an extremely developer-friendly library when it comes to debugging.
Before we move on, let us remind ourselves of one of the most important rules of web development.
#### The first rule of web development
> **Keep the browser's developer console open at all times.**
> The _Console_ tab in particular should always be open, unless there is a specific reason to view another tab.
Keep both your code and the web page open together **at the same time, all the time**.
If and when your code fails to compile and your browser lights up like a Christmas tree:
![screenshot of error pointing at the code line where it has been generated](../assets/89ce0b5551e8bfa7.png)
don't write more code but rather find and fix the problem **immediately**. There has yet to be a moment in the history of coding where code that fails to compile would miraculously start working after writing large amounts of additional code. I highly doubt that such an event will transpire during this course either.
Old-school, print-based debugging is always a good idea. If the component

```
const Button = ({ onClick, text }) => <button onClick={onClick}>{text}</button>copy
```

is not working as intended, it's useful to start printing its variables out to the console. In order to do this effectively, we must transform our function into the less compact form and receive the entire props object without destructuring it immediately:

```
const Button = (props) => { 
  console.log(props)  const { onClick, text } = props
  return (
    <button onClick={onClick}>
      {text}
    </button>
  )
}copy
```

This will immediately reveal if, for instance, one of the attributes has been misspelled when using the component.
**NB** When you use _console.log_ for debugging, don't combine _objects_ in a Java-like fashion by using the plus operator:

```
console.log('props value is ' + props)copy
```

If you do that, you will end up with a rather uninformative log message:

```
props value is [object Object]copy
```

Instead, separate the things you want to log to the console with a comma:

```
console.log('props value is', props)copy
```

In this way, the separated items will all be available in the browser console for further inspection.
Logging output to the console is by no means the only way of debugging our applications. You can pause the execution of your application code in the Chrome developer console's _debugger_ , by writing the command
The execution will pause once it arrives at a point where the _debugger_ command gets executed:
![debugger paused in dev tools](../assets/3d2f1fc3a66b1ec0.png)
By going to the _Console_ tab, it is easy to inspect the current state of variables:
![console inspection screenshot](../assets/098b4a01666252b1.png)
Once the cause of the bug is discovered you can remove the _debugger_ command and refresh the page.
The debugger also enables us to execute our code line by line with the controls found on the right-hand side of the _Sources_ tab.
You can also access the debugger without the _debugger_ command by adding breakpoints in the _Sources_ tab. Inspecting the values of the component's variables can be done in the _Scope_ -section:
![breakpoint example in devtools](../assets/c3136cc1d06d98b4.png)
It is highly recommended to add the _Components_ tab to the developer tools. The new developer tools tab can be used to inspect the different React elements in the application, along with their state and props:
![screenshot react developer tools extension](../assets/ed7e3c135751d833.png)
The _App_ component's state is defined like so:

```
const [left, setLeft] = useState(0)
const [right, setRight] = useState(0)
const [allClicks, setAll] = useState([])copy
```

Dev tools show the state of hooks in the order of their definition:
![state of hooks in react dev tools](../assets/541f36eae8ae7bca.png)
The first _State_ contains the value of the _left_ state, the next contains the value of the _right_ state and the last contains the value of the _allClicks_ state.
You can also learn about debugging JavaScript in Chrome, for example, with the
### Rules of Hooks
There are a few limitations and
The _useState_ function (as well as the _useEffect_ function introduced later on in the course) _must not be called_ from inside of a loop, a conditional expression, or any place that is not a function defining a component. This must be done to ensure that the hooks are always called in the same order, and if this isn't the case the application will behave erratically.
To recap, hooks may only be called from the inside of a function body that defines a React component:

```
const App = () => {
  // these are ok
  const [age, setAge] = useState(0)
  const [name, setName] = useState('Juha Tauriainen')

  if ( age > 10 ) {
    // this does not work!
    const [foobar, setFoobar] = useState(null)
  }

  for ( let i = 0; i < age; i++ ) {
    // also this is not good
    const [rightWay, setRightWay] = useState(false)
  }

  const notGood = () => {
    // and this is also illegal
    const [x, setX] = useState(-1000)
  }

  return (
    //...
  )
}copy
```

### Event Handling Revisited
Event handling has proven to be a difficult topic in previous iterations of this course.
For this reason, we will revisit the topic.
Let's assume that we're developing this simple application with the following component _App_ :

```
const App = () => {
  const [value, setValue] = useState(10)

  return (
    <div>
      {value}
      <button>reset to zero</button>
    </div>
  )
}copy
```

We want the clicking of the button to reset the state stored in the _value_ variable.
In order to make the button react to a click event, we have to add an _event handler_ to it.
Event handlers must always be a function or a reference to a function. The button will not work if the event handler is set to a variable of any other type.
If we were to define the event handler as a string:

```
<button onClick="crap...">button</button>copy
```

React would warn us about this in the console:

```
index.js:2178 Warning: Expected `onClick` listener to be a function, instead got a value of `string` type.
    in button (at index.js:20)
    in div (at index.js:18)
    in App (at index.js:27)copy
```

The following attempt would also not work:

```
<button onClick={value + 1}>button</button>copy
```

We have attempted to set the event handler to _value + 1_ which simply returns the result of the operation. React will kindly warn us about this in the console:

```
index.js:2178 Warning: Expected `onClick` listener to be a function, instead got a value of `number` type.copy
```

This attempt would not work either:

```
<button onClick={value = 0}>button</button>copy
```

The event handler is not a function but a variable assignment, and React will once again issue a warning to the console. This attempt is also flawed in the sense that we must never mutate state directly in React.
What about the following:

```
<button onClick={console.log('clicked the button')}>
  button
</button>copy
```

The message gets printed to the console once when the component is rendered but nothing happens when we click the button. Why does this not work even when our event handler contains a function _console.log_?
The issue here is that our event handler is defined as a _function call_ which means that the event handler is assigned the returned value from the function, which in the case of _console.log_ is _undefined_.
The _console.log_ function call gets executed when the component is rendered and for this reason, it gets printed once to the console.
The following attempt is flawed as well:

```
<button onClick={setValue(0)}>button</button>copy
```

We have once again tried to set a function call as the event handler. This does not work. This particular attempt also causes another problem. When the component is rendered the function _setValue(0)_ gets executed which in turn causes the component to be re-rendered. Re-rendering in turn calls _setValue(0)_ again, resulting in an infinite recursion.
Executing a particular function call when the button is clicked can be accomplished like this:

```
<button onClick={() => console.log('clicked the button')}>
  button
</button>copy
```

Now the event handler is a function defined with the arrow function syntax _() = > console.log('clicked the button')_. When the component gets rendered, no function gets called and only the reference to the arrow function is set to the event handler. Calling the function happens only once the button is clicked.
We can implement resetting the state in our application with this same technique:

```
<button onClick={() => setValue(0)}>button</button>copy
```

The event handler is now the function _() = > setValue(0)_.
Defining event handlers directly in the attribute of the button is not necessarily the best possible idea.
You will often see event handlers defined in a separate place. In the following version of our application we define a function that then gets assigned to the _handleClick_ variable in the body of the component function:

```
const App = () => {
  const [value, setValue] = useState(10)

  const handleClick = () =>
    console.log('clicked the button')

  return (
    <div>
      {value}
      <button onClick={handleClick}>button</button>
    </div>
  )
}copy
```

The _handleClick_ variable, which references the function definition, is passed to the button as the _onClick_ attribute:

```
<button onClick={handleClick}>button</button>copy
```

Naturally, our event handler function can be composed of multiple commands. In these cases we use the longer curly brace syntax for arrow functions:

```
const App = () => {
  const [value, setValue] = useState(10)

  const handleClick = () => {    console.log('clicked the button')    setValue(0)  }
  return (
    <div>
      {value}
      <button onClick={handleClick}>button</button>
    </div>
  )
}copy
```

### A function that returns a function
Another way to define an event handler is to use a _function that returns a function_.
You probably won't need to use functions that return functions in any of the exercises in this course. If the topic seems particularly confusing, you may skip over this section for now and return to it later.
Let's make the following changes to our code:

```
const App = () => {
  const [value, setValue] = useState(10)

  const hello = () => {    const handler = () => console.log('hello world')    return handler  }
  return (
    <div>
      {value}
      <button onClick={hello()}>button</button>
    </div>
  )
}copy
```

The code functions correctly even though it looks complicated.
The event handler is now set to a function call:

```
<button onClick={hello()}>button</button>copy
```

Earlier, we stated that an event handler may not be a function call; rather, it has to either be a function definition or a reference to one. Why then does a function call work in this case?
When the component is rendered, the following function gets executed:

```
const hello = () => {
  const handler = () => console.log('hello world')

  return handler
}copy
```

The _return value_ of the function is another function that is assigned to the _handler_ variable.
When React renders the line:

```
<button onClick={hello()}>button</button>copy
```

It assigns the return value of _hello()_ to the onClick attribute. Essentially the line gets transformed into:

```
<button onClick={() => console.log('hello world')}>
  button
</button>copy
```

Since the _hello_ function returns a function, the event handler is now a function.
What's the point of this concept?
Let's change the code a tiny bit:

```
const App = () => {
  const [value, setValue] = useState(10)

  const hello = (who) => {    const handler = () => {      console.log('hello', who)    }    return handler  }
  return (
    <div>
      {value}
      <button onClick={hello('world')}>button</button>      <button onClick={hello('react')}>button</button>      <button onClick={hello('function')}>button</button>    </div>
  )
}copy
```

Now the application has three buttons with event handlers defined by the _hello_ function that accepts a parameter.
The first button is defined as

```
<button onClick={hello('world')}>button</button>copy
```

The event handler is created by _executing_ the function call _hello('world')_. The function call returns the function:

```
() => {
  console.log('hello', 'world')
}copy
```

The second button is defined as:

```
<button onClick={hello('react')}>button</button>copy
```

The function call _hello('react')_ that creates the event handler returns:

```
() => {
  console.log('hello', 'react')
}copy
```

Both buttons get their individualized event handlers.
Functions returning functions can be utilized in defining generic functionality that can be customized with parameters. The _hello_ function that creates the event handlers can be thought of as a factory that produces customized event handlers meant for greeting users.
Our current definition is slightly verbose:

```
const hello = (who) => {
  const handler = () => {
    console.log('hello', who)
  }

  return handler
}copy
```

Let's eliminate the helper variables and directly return the created function:

```
const hello = (who) => {
  return () => {
    console.log('hello', who)
  }
}copy
```

Since our _hello_ function is composed of a single return command, we can omit the curly braces and use the more compact syntax for arrow functions:

```
const hello = (who) =>
  () => {
    console.log('hello', who)
  }copy
```

Lastly, let's write all of the arrows on the same line:

```
const hello = (who) => () => {
  console.log('hello', who)
}copy
```

We can use the same trick to define event handlers that set the state of the component to a given value. Let's make the following changes to our code:

```
const App = () => {
  const [value, setValue] = useState(10)
  
  const setToValue = (newValue) => () => {    console.log('value now', newValue)  // print the new value to console    setValue(newValue)  }  
  return (
    <div>
      {value}
      <button onClick={setToValue(1000)}>thousand</button>      <button onClick={setToValue(0)}>reset</button>      <button onClick={setToValue(value + 1)}>increment</button>    </div>
  )
}copy
```

When the component is rendered, the _thousand_ button is created:

```
<button onClick={setToValue(1000)}>thousand</button>copy
```

The event handler is set to the return value of _setToValue(1000)_ which is the following function:

```
() => {
  console.log('value now', 1000)
  setValue(1000)
}copy
```

The increase button is declared as follows:

```
<button onClick={setToValue(value + 1)}>increment</button>copy
```

The event handler is created by the function call _setToValue(value + 1)_ which receives as its parameter the current value of the state variable _value_ increased by one. If the value of _value_ was 10, then the created event handler would be the function:

```
() => {
  console.log('value now', 11)
  setValue(11)
}copy
```

Using functions that return functions is not required to achieve this functionality. Let's return the _setToValue_ function which is responsible for updating state into a normal function:

```
const App = () => {
  const [value, setValue] = useState(10)

  const setToValue = (newValue) => {
    console.log('value now', newValue)
    setValue(newValue)
  }

  return (
    <div>
      {value}
      <button onClick={() => setToValue(1000)}>
        thousand
      </button>
      <button onClick={() => setToValue(0)}>
        reset
      </button>
      <button onClick={() => setToValue(value + 1)}>
        increment
      </button>
    </div>
  )
}copy
```

We can now define the event handler as a function that calls the _setToValue_ function with an appropriate parameter. The event handler for resetting the application state would be:

```
<button onClick={() => setToValue(0)}>reset</button>copy
```

Choosing between the two presented ways of defining your event handlers is mostly a matter of taste.
### Passing Event Handlers to Child Components
Let's extract the button into its own component:

```
const Button = (props) => (
  <button onClick={props.onClick}>
    {props.text}
  </button>
)copy
```

The component gets the event handler function from the _onClick_ prop, and the text of the button from the _text_ prop. Lets use the new component:

```
const App = (props) => {
  // ...
  return (
    <div>
      {value}
      <Button onClick={() => setToValue(1000)} text="thousand" />      <Button onClick={() => setToValue(0)} text="reset" />      <Button onClick={() => setToValue(value + 1)} text="increment" />    </div>
  )
}copy
```

Using the _Button_ component is simple, although we have to make sure that we use the correct attribute names when passing props to the component.
![using correct attribute names code screenshot](../assets/ec9fef09df3b0cba.png)
### Do Not Define Components Within Components
Let's start displaying the value of the application in its _Display_ component.
We will change the application by defining a new component inside of the _App_ component.

```
// This is the right place to define a component
const Button = (props) => (
  <button onClick={props.onClick}>
    {props.text}
  </button>
)

const App = () => {
  const [value, setValue] = useState(10)

  const setToValue = newValue => {
    console.log('value now', newValue)
    setValue(newValue)
  }

  // Do not define components inside another component
  const Display = props => <div>{props.value}</div>
  return (
    <div>
      <Display value={value} />      <Button onClick={() => setToValue(1000)} text="thousand" />
      <Button onClick={() => setToValue(0)} text="reset" />
      <Button onClick={() => setToValue(value + 1)} text="increment" />
    </div>
  )
}copy
```

The application still appears to work, but **don't implement components like this!** Never define components inside of other components. The method provides no benefits and leads to many unpleasant problems. The biggest problems are because React treats a component defined inside of another component as a new component in every render. This makes it impossible for React to optimize the component.
Let's instead move the _Display_ component function to its correct place, which is outside of the _App_ component function:

```
const Display = props => <div>{props.value}</div>

const Button = (props) => (
  <button onClick={props.onClick}>
    {props.text}
  </button>
)

const App = () => {
  const [value, setValue] = useState(10)

  const setToValue = newValue => {
    console.log('value now', newValue)
    setValue(newValue)
  }

  return (
    <div>
      <Display value={value} />
      <Button onClick={() => setToValue(1000)} text="thousand" />
      <Button onClick={() => setToValue(0)} text="reset" />
      <Button onClick={() => setToValue(value + 1)} text="increment" />
    </div>
  )
}copy
```

### Useful Reading
The internet is full of React-related material. However, we use the new style of React for which a large majority of the material found online is outdated.
You may find the following links useful:

- The
- Some courses on **NB** The first one uses class components but the latter uses the new functional ones.


### Web programmers oath
Programming is hard, that is why I will use all the possible means to make it easier

- I will have my browser developer console open all the time
- I progress with small steps
- I will write lots of _console.log_ statements to make sure I understand how the code behaves and to help pinpointing problems
- If my code does not work, I will not write more code. Instead I will start deleting the code until it works or just return to a state when everything was still working
- When I ask for help in the course Discord channel or elsewhere I formulate my questions properly, see [here](http://fullstackopen.com/en/part0/general_info#how-to-get-help-in-discord) how to ask for help


### Utilization of Large language models
Large language models such as
Personally, I mainly use GitHub Copilot, which is now
Copilot is useful in a wide variety of scenarios. Copilot can be asked to generate code for an open file by describing the desired functionality in text:
![copilot input on vscode](../assets/6edafef4277fe0e8.png)
If the code looks good, Copilot adds it to the file:
![code added by copilot](../assets/c814f18a20604824.png)
In the case of our example, Copilot only created a button, the event handler _handleResetClick_ is undefined.
An event handler may also be generated. By writing the first line of the function, Copilot offers the functionality to be generated:
![copilot´s code suggestion](../assets/fe07a3d0ca4aedd7.png)
In Copilot's chat window, it is possible to ask for an explanation of the function of the painted code area:
![copilot explaining how the selected code works in the chat window](../assets/12d79b9411adc992.png)
Copilot is also useful in error situations, by copying the error message into Copilot's chat, you will get an explanation of the problem and a suggested fix:
![copilot explaining the error and suggesting a fix](../assets/6cfe4c2f1add399a.png)
Copilot's chat also enables the creation of larger set of functionality
![copilot creating a login component on request](../assets/b9999943a9e8fd76.png)
The degree of usefulness of the hints provided by Copilot and other language models varies. Perhaps the biggest problem with language models is
Another problem in applying language models to software development is that it is difficult for language models to "understand" larger projects, and e.g. to generate functionality that would require changes to several files. Language models are also currently unable to generalize code, i.e. if the code has, for example, existing functions or components that the language model could use with minor changes for the requested functionality, the language model will not bend to this. The result of this can be that the code base deteriorates, as the language models generate a lot of repetition in the code, see more e.g.
When using language models, the responsibility always stays with the programmer.
The rapid development of language models puts the student of programming in a challenging position: is it worth and is it even necessary to learn programming in a detailed level, when you can get almost everything ready-made from language models?
At this point, it is worth remembering the old wisdom of _The C Programming Language_ :
![Everyone knows that debugging is twice as hard as writing a program in the first place. So if you're as clever as you can be when you write it, how will you ever debug it? ― Brian Kernighan](../assets/41509a167da96ab7.png)
In other words, since debugging is twice as difficult as programming, it is not worth programming such code that you can only barely understand. How can debugging be even possible in a situation where programming is outsourced to a language model and the software developer does not understand the debugged code at all?
So far, the development of language models and artificial intelligence is still at the stage where they are not self-sufficient, and the most difficult problems are left for humans to solve. Because of this, even novice software developers must learn to program really well just in case. It may be that, despite the development of language models, even more in-depth knowledge is needed. Artificial intelligence does the easy things, but a human is needed to sort out the most complicated messes caused by AI. GitHub Copilot is a very well-named product, it's Copilot, a second pilot who helps the main pilot in an aircraft. The programmer is still the main pilot, the captain, and bears the ultimate responsibility.
It may be in your own interest that you turn off Copilot by default when you do this course and rely on it only in a real emergency.
### Exercises 1.6.-1.14
Submit your solutions to the exercises by first pushing your code to GitHub and then marking the completed exercises into the "my submissions" tab of the
Remember, submit **all** the exercises of one part **in a single submission**. Once you have submitted your solutions for one part, **you cannot submit more exercises to that part anymore**.
_Some of the exercises work on the same application. In these cases, it is sufficient to submit just the final version of the application. If you wish, you can make a commit after every finished exercise, but it is not mandatory._
In some situations you may also have to run the command below from the root of the project:

```
rm -rf node_modules/ && npm icopy
```

If and _when_ you encounter an error message
> _Objects are not valid as a React child_
keep in mind the things told [here](../part1/01-introduction-to-react-do-not-render-objects.md).
#### 1.6: unicafe step 1
Like most companies, the student restaurant of the University of Helsinki _good_ , _neutral_ , and _bad_.
The application must display the total number of collected feedback for each category. Your final application could look like this:
![screenshot of feedback options](../assets/9d63f984e6965df6.png)
Note that your application needs to work only during a single browser session. Once you refresh the page, the collected feedback is allowed to disappear.
It is advisable to use the same structure that is used in the material and previous exercise. File _main.jsx_ is as follows:

```
import ReactDOM from 'react-dom/client'

import App from './App'

ReactDOM.createRoot(document.getElementById('root')).render(<App />)copy
```

You can use the code below as a starting point for the _App.jsx_ file:

```
import { useState } from 'react'

const App = () => {
  // save clicks of each button to its own state
  const [good, setGood] = useState(0)
  const [neutral, setNeutral] = useState(0)
  const [bad, setBad] = useState(0)

  return (
    <div>
      code here
    </div>
  )
}

export default Appcopy
```

#### 1.7: unicafe step 2
Expand your application so that it shows more statistics about the gathered feedback: the total number of collected feedback, the average score (the feedback values are: good 1, neutral 0, bad -1) and the percentage of positive feedback.
![average and percentage positive screenshot feedback](../assets/97f11ed10489bf87.png)
#### 1.8: unicafe step 3
Refactor your application so that displaying the statistics is extracted into its own _Statistics_ component. The state of the application should remain in the _App_ root component.
Remember that components should not be defined inside other components:

```
// a proper place to define a component
const Statistics = (props) => {
  // ...
}

const App = () => {
  const [good, setGood] = useState(0)
  const [neutral, setNeutral] = useState(0)
  const [bad, setBad] = useState(0)

  // do not define a component within another component
  const Statistics = (props) => {
    // ...
  }

  return (
    // ...
  )
}copy
```

#### 1.9: unicafe step 4
Change your application to display statistics only once feedback has been gathered.
![no feedback given text screenshot](../assets/62546e782d1418e5.png)
#### 1.10: unicafe step 5
Let's continue refactoring the application. Extract the following two components:

- _Button_ handles the functionality of each feedback submission button.
- _StatisticLine_ for displaying a single statistic, e.g. the average score.


To be clear: the _StatisticLine_ component always displays a single statistic, meaning that the application uses multiple components for rendering all of the statistics:

```
const Statistics = (props) => {
  /// ...
  return(
    <div>
      <StatisticLine text="good" value ={...} />
      <StatisticLine text="neutral" value ={...} />
      <StatisticLine text="bad" value ={...} />
      // ...
    </div>
  )
}copy
```

The application's state should still be kept in the root _App_ component.
#### 1.11*: unicafe step 6
Display the statistics in an HTML
![screenshot of statistics table](../assets/a1e216b322d5eeb7.png)
Remember to keep your console open at all times. If you see this warning in your console:
![console warning](../assets/e6ce002777e76950.png)
Then perform the necessary actions to make the warning disappear. Try pasting the error message into a search engine if you get stuck.
_Typical source of an error _Unchecked runtime.lastError: Could not establish connection. Receiving end does not exist._ is from a Chrome extension. Try going to _chrome://extensions/_ and try disabling them one by one and refreshing React app page; the error should eventually disappear._
**Make sure that from now on you don't see any warnings in your console!**
#### 1.12*: anecdotes step 1
The world of software engineering is filled with
Expand the following application by adding a button that can be clicked to display a _random_ anecdote from the field of software engineering:

```
import { useState } from 'react'

const App = () => {
  const anecdotes = [
    'If it hurts, do it more often.',
    'Adding manpower to a late software project makes it later!',
    'The first 90 percent of the code accounts for the first 90 percent of the development time...The remaining 10 percent of the code accounts for the other 90 percent of the development time.',
    'Any fool can write code that a computer can understand. Good programmers write code that humans can understand.',
    'Premature optimization is the root of all evil.',
    'Debugging is twice as hard as writing the code in the first place. Therefore, if you write the code as cleverly as possible, you are, by definition, not smart enough to debug it.',
    'Programming without an extremely heavy use of console.log is same as if a doctor would refuse to use x-rays or blood tests when diagnosing patients.',
    'The only way to go fast, is to go well.'
  ]
   
  const [selected, setSelected] = useState(0)

  return (
    <div>
      {anecdotes[selected]}
    </div>
  )
}

export default Appcopy
```

Content of the file _main.jsx_ is the same as in previous exercises.
Find out how to generate random numbers in JavaScript, eg. via a search engine or on
Your finished application could look something like this:
![random anecdote with next button](../assets/3215d1c6dfa22d86.png)
#### 1.13*: anecdotes step 2
Expand your application so that you can vote for the displayed anecdote.
![anecdote app with votes button added](../assets/dbfe3e77c0b36adc.png)
**NB** store the votes of each anecdote into an array or object in the component's state. Remember that the correct way of updating state stored in complex data structures like objects and arrays is to make a copy of the state.
You can create a copy of an object like this:

```
const votes = { 0: 1, 1: 3, 2: 4, 3: 2 }

const copy = { ...votes }
// increment the property 2 value by one
copy[2] += 1     copy
```

OR a copy of an array like this:

```
const votes = [1, 4, 6, 3]

const copy = [...votes]
// increment the value in position 2 by one
copy[2] += 1     copy
```

Using an array might be the simpler choice in this case. Searching the Internet will provide you with lots of hints on how to
#### 1.14*: anecdotes step 3
Now implement the final version of the application that displays the anecdote with the largest number of votes:
![anecdote with largest number of votes](../assets/690bc01b439af074.png)
If multiple anecdotes are tied for first place it is sufficient to just show one of them.
This was the last exercise for this part of the course and it's time to push your code to GitHub and mark all of your finished exercises to the "my submissions" tab of the
[Part 1c **Previous part**](../part1/01-component-state-event-handlers.md)[Part 2 **Next part**](../part2/01-part2.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 1](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-part1.md)
- [a Introduction to React](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-introduction-to-react.md)
- [b JavaScript](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-java-script.md)
- [c Component state, event handlers](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers.md)
- [Complex state](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-complex-state.md)
- [Handling arrays](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-handling-arrays.md)
- [Update of the state is asynchronous](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-update-of-the-state-is-asynchronous.md)
- [Conditional rendering](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-conditional-rendering.md)
- [Old React](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-old-react.md)
- [Debugging React applications](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-debugging-react-applications.md)
- [Rules of Hooks](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-rules-of-hooks.md)
- [Event Handling Revisited](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-event-handling-revisited.md)
- [A function that returns a function](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-a-function-that-returns-a-function.md)
- [Passing Event Handlers to Child Components](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-passing-event-handlers-to-child-components.md)
- [Do Not Define Components Within Components](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-do-not-define-components-within-components.md)
- [Useful Reading](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-useful-reading.md)
- [Web programmers oath](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-web-programmers-oath.md)
- [Utilization of Large language models](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-utilization-of-large-language-models.md)
- [Exercises 1.6.-1.14.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-exercises-1-6-1-14.md)
- [browser showing 2 left|right 1, RLL total 2](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/1e55856d933562eb.png)
- [devtools console showing left before 4 and left after 4](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/6f78ad95cb590b57.png)
- [part 2](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-part2.md)
- [screenshot of error pointing at the code line where it has been generated](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/89ce0b5551e8bfa7.png)
- [debugger paused in dev tools](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/3d2f1fc3a66b1ec0.png)
- [console inspection screenshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/098b4a01666252b1.png)
- [breakpoint example in devtools](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/c3136cc1d06d98b4.png)
- [screenshot react developer tools extension](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/ed7e3c135751d833.png)
- [state of hooks in react dev tools](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/541f36eae8ae7bca.png)
- [using correct attribute names code screenshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/ec9fef09df3b0cba.png)
- [here](http://fullstackopen.com/en/part0/general_info#how-to-get-help-in-discord)
- [copilot input on vscode](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/6edafef4277fe0e8.png)
- [code added by copilot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/c814f18a20604824.png)
- [copilot´s code suggestion](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/fe07a3d0ca4aedd7.png)
- [copilot explaining how the selected code works in the chat window](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/12d79b9411adc992.png)
- [copilot explaining the error and suggesting a fix](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/6cfe4c2f1add399a.png)
- [copilot creating a login component on request](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/b9999943a9e8fd76.png)
- [Everyone knows that debugging is twice as hard as writing a program in the first place. So if you're as clever as you can be when you write it, how will you ever debug it? ― Brian Kernighan](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/41509a167da96ab7.png)
- [here](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-introduction-to-react-do-not-render-objects.md)
- [screenshot of feedback options](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/9d63f984e6965df6.png)
- [average and percentage positive screenshot feedback](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/97f11ed10489bf87.png)
- [no feedback given text screenshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/62546e782d1418e5.png)
- [screenshot of statistics table](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/a1e216b322d5eeb7.png)
- [console warning](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/e6ce002777e76950.png)
- [random anecdote with next button](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/3215d1c6dfa22d86.png)
- [anecdote app with votes button added](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/dbfe3e77c0b36adc.png)
- [anecdote with largest number of votes](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/690bc01b439af074.png)
- [Part 1c **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers.md)
- [Part 2 **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-part2.md)

--- .archived/data/part2/01-adding-styles-to-react-app.md ---
---{
  "title": "Adding styles to React app",
  "source_url": "https://fullstackopen.com/en/part2/adding_styles_to_react_app",
  "crawl_timestamp": "2025-10-04T19:16:06Z",
  "checksum": "a4357ced3c17758e9faf8a9a465cf27fbbc3e4810ab3dc5ea81a4e83dd06d811"
}
---[Skip to content](../part2/01-adding-styles-to-react-app-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 2](../part2/01-part2.md)
Adding styles to React app
[a Rendering a collection, modules](../part2/01-rendering-a-collection-modules.md)[b Forms](../part2/01-forms.md)[c Getting data from server](../part2/01-getting-data-from-server.md)[d Altering data in server](../part2/01-altering-data-in-server.md)
e Adding styles to React app

- [Improved error message](../part2/01-adding-styles-to-react-app-improved-error-message.md)
- [Inline styles](../part2/01-adding-styles-to-react-app-inline-styles.md)
- [Exercises 2.16.-2.17.](../part2/01-adding-styles-to-react-app-exercises-2-16-2-17.md)
- [Couple of important remarks](../part2/01-adding-styles-to-react-app-couple-of-important-remarks.md)
- [Exercises 2.18.-2.20.](../part2/01-adding-styles-to-react-app-exercises-2-18-2-20.md)


e
# Adding styles to React app
The appearance of our current Notes application is quite modest. In [exercise 0.2](../part0/01-fundamentals-of-web-apps-exercises-0-1-0-6.md), the assignment was to go through Mozilla's
Let's take a look at how we can add styles to a React application. There are several different ways of doing this and we will take a look at the other methods later on. First, we will add CSS to our application the old-school way; in a single file without using a
Let's add a new _index.css_ file under the _src_ directory and then add it to the application by importing it in the _main.jsx_ file:

```
import './index.css'copy
```

Let's add the following CSS rule to the _index.css_ file:

```
h1 {
  color: green;
}copy
```

CSS rules comprise of _selectors_ and _declarations_. The selector defines which elements the rule should be applied to. The selector above is _h1_ , which will match all of the _h1_ header tags in our application.
The declaration sets the _color_ property to the value _green_.
One CSS rule can contain an arbitrary number of properties. Let's modify the previous rule to make the text cursive, by defining the font style as _italic_ :

```
h1 {
  color: green;
  font-style: italic;}copy
```

There are many ways of matching elements by using
If we wanted to target, let's say, each one of the notes with our styles, we could use the selector _li_ , as all of the notes are wrapped inside _li_ tags:

```
const Note = ({ note, toggleImportance }) => {
  const label = note.important 
    ? 'make not important' 
    : 'make important'

  return (
    <li>
      {note.content} 
      <button onClick={toggleImportance}>{label}</button>
    </li>
  )
}copy
```

Let's add the following rule to our style sheet (since my knowledge of elegant web design is close to zero, the styles don't make much sense):

```
li {
  color: grey;
  padding-top: 3px;
  font-size: 15px;
}copy
```

Using element types for defining CSS rules is slightly problematic. If our application contained other _li_ tags, the same style rule would also be applied to them.
If we want to apply our style specifically to notes, then it is better to use
In regular HTML, classes are defined as the value of the _class_ attribute:

```
<li class="note">some text...</li>copy
```

In React we have to use the _Note_ component:

```
const Note = ({ note, toggleImportance }) => {
  const label = note.important 
    ? 'make not important' 
    : 'make important'

  return (
    <li className='note'>      {note.content} 
      <button onClick={toggleImportance}>{label}</button>
    </li>
  )
}copy
```

Class selectors are defined with the _.classname_ syntax:

```
.note {
  color: grey;
  padding-top: 5px;
  font-size: 15px;
}copy
```

If you now add other _li_ elements to the application, they will not be affected by the style rule above.
### Improved error message
We previously implemented the error message that was displayed when the user tried to toggle the importance of a deleted note with the _alert_ method. Let's implement the error message as its own React component.
The component is quite simple:

```
const Notification = ({ message }) => {
  if (message === null) {
    return null
  }

  return (
    <div className='error'>
      {message}
    </div>
  )
}copy
```

If the value of the _message_ prop is _null_ , then nothing is rendered to the screen, and in other cases, the message gets rendered inside of a div element.
Let's add a new piece of state called _errorMessage_ to the _App_ component. Let's initialize it with some error message so that we can immediately test our component:

```
const App = () => {
  const [notes, setNotes] = useState([]) 
  const [newNote, setNewNote] = useState('')
  const [showAll, setShowAll] = useState(true)
  const [errorMessage, setErrorMessage] = useState('some error happened...')
  // ...

  return (
    <div>
      <h1>Notes</h1>
      <Notification message={errorMessage} />      <div>
        <button onClick={() => setShowAll(!showAll)}>
          show {showAll ? 'important' : 'all' }
        </button>
      </div>      
      // ...
    </div>
  )
}copy
```

Then let's add a style rule that suits an error message:

```
.error {
  color: red;
  background: lightgrey;
  font-size: 20px;
  border-style: solid;
  border-radius: 5px;
  padding: 10px;
  margin-bottom: 10px;
}copy
```

Now we are ready to add the logic for displaying the error message. Let's change the _toggleImportanceOf_ function in the following way:

```
  const toggleImportanceOf = id => {
    const note = notes.find(n => n.id === id)
    const changedNote = { ...note, important: !note.important }

    noteService
      .update(id, changedNote).then(returnedNote => {
        setNotes(notes.map(note => note.id !== id ? note : returnedNote))
      })
      .catch(error => {
        setErrorMessage(          `Note '${note.content}' was already removed from server`        )        setTimeout(() => {          setErrorMessage(null)        }, 5000)        setNotes(notes.filter(n => n.id !== id))
      })
  }copy
```

When the error occurs we add a descriptive error message to the _errorMessage_ state. At the same time, we start a timer, that will set the _errorMessage_ state to _null_ after five seconds.
The result looks like this:
![error removed from server screenshot from app](../assets/92d6be547be25d86.png)
The code for the current state of our application can be found in the _part2-7_ branch on
### Inline styles
React also makes it possible to write styles directly in the code as so-called
The idea behind defining inline styles is extremely simple. Any React component or element can be provided with a set of CSS properties as a JavaScript object through the
CSS rules are defined slightly differently in JavaScript than in normal CSS files. Let's say that we wanted to give some element the color green and italic font. In CSS, it would look like this:

```
{
  color: green;
  font-style: italic;
}copy
```

But as a React inline-style object it would look like this:

```
{
  color: 'green',
  fontStyle: 'italic'
}copy
```

Every CSS property is defined as a separate property of the JavaScript object. Numeric values for pixels can be simply defined as integers. One of the major differences compared to regular CSS, is that hyphenated (kebab case) CSS properties are written in camelCase.
Let's add a footer component, _Footer_ , to our application and define inline styles for it. The component is defined in the file _components/Footer.jsx_ and used in the file _App.jsx_ as follows:

```
const Footer = () => {
  const footerStyle = {
    color: 'green',
    fontStyle: 'italic'
  }

  return (
    <div style={footerStyle}>
      <br />
      <p>
        Note app, Department of Computer Science, University of Helsinki 2025
      </p>
    </div>
  )
}

export default Footercopy
```

```
import { useState, useEffect } from 'react'
import Footer from './components/Footer'import Note from './components/Note'
import Notification from './components/Notification'
import noteService from './services/notes'

const App = () => {
  // ...

  return (
    <div>
      <h1>Notes</h1>

      <Notification message={errorMessage} />

      // ...  

      <Footer />    </div>
  )
}copy
```

Inline styles come with certain limitations. For instance, so-called
Inline styles and some of the other ways of adding styles to React components go completely against the grain of old conventions. Traditionally, it has been considered best practice to entirely separate CSS from the content (HTML) and functionality (JavaScript). According to this older school of thought, the goal was to write CSS, HTML, and JavaScript into their separate files.
The philosophy of React is, in fact, the polar opposite of this. Since the separation of CSS, HTML, and JavaScript into separate files did not seem to scale well in larger applications, React bases the division of the application along the lines of its logical functional entities.
The structural units that make up the application's functional entities are React components. A React component defines the HTML for structuring the content, the JavaScript functions for determining functionality, and also the component's styling; all in one place. This is to create individual components that are as independent and reusable as possible.
The code of the final version of our application can be found in the _part2-8_ branch on
### Exercises 2.16.-2.17
#### 2.16: Phonebook step 11
Use the [improved error message](../part2/01-adding-styles-to-react-app-improved-error-message.md) example from part 2 as a guide to show a notification that lasts for a few seconds after a successful operation is executed (a person is added or a number is changed):
![successful green added screenshot](../assets/675cc21824f019f6.png)
#### 2.17*: Phonebook step 12
Open your application in two browsers. **If you delete a person in browser 1** a short while before attempting to _change the person's phone number_ in browser 2, you will get the following error messages:
![error message 404 not found when changing multiple browsers](../assets/d8ad4c24e0512d64.png)
Fix the issue according to the example shown in [promise and errors](../part2/01-altering-data-in-server-promises-and-errors.md) in part 2. Modify the example so that the user is shown a message when the operation does not succeed. The messages shown for successful and unsuccessful events should look different:
![error message shown on screen instead of in console feature add-on](../assets/c26bb7aec9fc68d0.png)
**Note** that even if you handle the exception, the first "404" error message is still printed to the console. But you should not see "Uncaught (in promise) Error".
### Couple of important remarks
At the end of this part there are a few more challenging exercises. At this stage, you can skip the exercises if they are too much of a headache, we will come back to the same themes again later. The material is worth reading through in any case.
We have done one thing in our app that is masking away a very typical source of error.
We set the state _notes_ to have initial value of an empty array:

```
const App = () => {
  const [notes, setNotes] = useState([])

  // ...
}copy
```

This is a pretty natural initial value since the notes are a set, that is, there are many notes that the state will store.
If the state were only saving "one thing", a more appropriate initial value would be _null_ denoting that there is _nothing_ in the state at the start. Let's see what happens if we use this initial value:

```
const App = () => {
  const [notes, setNotes] = useState(null)
  // ...
}copy
```

The app breaks down:
![console typerror cannot read properties of null via map from App](../assets/961c00c3bfd57d6a.png)
The error message gives the reason and location for the error. The code that caused the problems is the following:

```
  // notesToShow gets the value of notes
  const notesToShow = showAll
    ? notes
    : notes.filter(note => note.important)

  // ...

  {notesToShow.map(note =>    <Note key={note.id} note={note} />
  )}copy
```

The error message is

```
Cannot read properties of null (reading 'map')copy
```

The variable _notesToShow_ is first assigned the value of the state _notes_ and then the code tries to call method _map_ to a nonexisting object, that is, to _null_.
What is the reason for that?
The effect hook uses the function _setNotes_ to set _notes_ to have the notes that the backend is returning:

```
  useEffect(() => {
    noteService
      .getAll()
      .then(initialNotes => {
        setNotes(initialNotes)      })
  }, [])copy
```

However the problem is that the effect is executed only _after the first render_. And because _notes_ has the initial value of null:

```
const App = () => {
  const [notes, setNotes] = useState(null)
  // ...copy
```

on the first render the following code gets executed:

```
notesToShow = notes

// ...

notesToShow.map(note => ...)copy
```

and this blows up the app since we can not call method _map_ of the value _null_.
When we set _notes_ to be initially an empty array, there is no error since it is allowed to call _map_ to an empty array.
So, the initialization of the state "masked" the problem that is caused by the fact that the data is not yet fetched from the backend.
Another way to circumvent the problem is to use _conditional rendering_ and return null if the component state is not properly initialized:

```
const App = () => {
  const [notes, setNotes] = useState(null)  // ... 

  useEffect(() => {
    noteService
      .getAll()
      .then(initialNotes => {
        setNotes(initialNotes)
      })
  }, [])

  // do not render anything if notes is still null
  if (!notes) {     return null   }
  // ...
} copy
```

So on the first render, nothing is rendered. When the notes arrive from the backend, the effect used function _setNotes_ to set the value of the state _notes_. This causes the component to be rendered again, and at the second render, the notes get rendered to the screen.
The method based on conditional rendering is suitable in cases where it is impossible to define the state so that the initial rendering is possible.
The other thing that we still need to have a closer look at is the second parameter of the useEffect:

```
  useEffect(() => {
    noteService
      .getAll()
      .then(initialNotes => {
        setNotes(initialNotes)  
      })
  }, [])copy
```

The second parameter of _useEffect_ is used to _and_ when the value of the second parameter changes.
If the second parameter is an empty array _[]_ , its content never changes and the effect is only run after the first render of the component. This is exactly what we want when we are initializing the app state from the server.
However, there are situations where we want to perform the effect at other times, e.g. when the state of the component changes in a particular way.
Consider the following simple application for querying currency exchange rates from the

```
import { useState, useEffect } from 'react'
import axios from 'axios'

const App = () => {
  const [value, setValue] = useState('')
  const [rates, setRates] = useState({})
  const [currency, setCurrency] = useState(null)

  useEffect(() => {
    console.log('effect run, currency is now', currency)

    // skip if currency is not defined
    if (currency) {
      console.log('fetching exchange rates...')
      axios
        .get(`https://open.er-api.com/v6/latest/${currency}`)
        .then(response => {
          setRates(response.data.rates)
        })
    }
  }, [currency])

  const handleChange = (event) => {
    setValue(event.target.value)
  }

  const onSearch = (event) => {
    event.preventDefault()
    setCurrency(value)
  }

  return (
    <div>
      <form onSubmit={onSearch}>
        currency: <input value={value} onChange={handleChange} />
        <button type="submit">exchange rate</button>
      </form>
      <pre>
        {JSON.stringify(rates, null, 2)}
      </pre>
    </div>
  )
}

export default Appcopy
```

The user interface of the application has a form, in the input field of which the name of the desired currency is written. If the currency exists, the application renders the exchange rates of the currency to other currencies:
![browser showing currency exchange rates with eur typed and console saying fetching exchange rates](../assets/cfedb7fcc4ab87ed.png)
The application sets the name of the currency entered to the form to the state _currency_ at the moment the button is pressed.
When the _currency_ gets a new value, the application fetches its exchange rates from the API in the effect function:

```
const App = () => {
  // ...
  const [currency, setCurrency] = useState(null)

  useEffect(() => {
    console.log('effect run, currency is now', currency)

    // skip if currency is not defined
    if (currency) {
      console.log('fetching exchange rates...')
      axios
        .get(`https://open.er-api.com/v6/latest/${currency}`)
        .then(response => {
          setRates(response.data.rates)
        })
    }
  }, [currency])  // ...
}copy
```

The useEffect hook now has _[currency]_ as the second parameter. The effect function is therefore executed after the first render, and _always_ after the table as its second parameter _[currency]_ changes. That is, when the state _currency_ gets a new value, the content of the table changes and the effect function is executed.
It is natural to choose _null_ as the initial value for the variable _currency_ , because _currency_ represents a single item. The initial value _null_ indicates that there is nothing in the state yet, and it is also easy to check with a simple if statement whether a value has been assigned to the variable. The effect has the following condition

```
if (currency) { 
  // exchange rates are fetched
}copy
```

which prevents requesting the exchange rates just after the first render when the variable _currency_ still has the initial value, i.e. a _null_ value.
So if the user writes e.g. _eur_ in the search field, the application uses Axios to perform an HTTP GET request to the address _rates_ state.
When the user then enters another value in the search field, e.g. _usd_ , the effect function is executed again and the exchange rates of the new currency are requested from the API.
The way presented here for making API requests might seem a bit awkward. This particular application could have been made completely without using the useEffect, by making the API requests directly in the form submit handler function:

```
  const onSearch = (event) => {
    event.preventDefault()
    axios
      .get(`https://open.er-api.com/v6/latest/${value}`)
      .then(response => {
        setRates(response.data.rates)
      })
  }copy
```

However, there are situations where that technique would not work. For example, you _might_ encounter one such a situation in the exercise 2.20 where the use of useEffect could provide a solution. Note that this depends quite much on the approach you selected, e.g. the model solution does not use this trick.
### Exercises 2.18.-2.20
#### 2.18* Data for countries, step 1
At
The user interface is very simple. The country to be shown is found by typing a search query into the search field.
If there are too many (over 10) countries that match the query, then the user is prompted to make their query more specific:
![too many matches screenshot](../assets/014dcc16758018ab.png)
If there are ten or fewer countries, but more than one, then all countries matching the query are shown:
![matching countries in a list screenshot](../assets/d48c30289df6b371.png)
When there is only one country matching the query, then the basic data of the country (eg. capital and area), its flag and the languages spoken are shown:
![flag and additional attributes screenshot](../assets/adda63f167c7903d.png)
**NB** : It is enough that your application works for most countries. Some countries, like _Sudan_ , can be hard to support since the name of the country is part of the name of another country, _South Sudan_. You don't need to worry about these edge cases.
#### 2.19*: Data for countries, step 2
**There is still a lot to do in this part, so don't get stuck on this exercise!**
Improve on the application in the previous exercise, such that when the names of multiple countries are shown on the page there is a button next to the name of the country, which when pressed shows the view for that country:
![attach show buttons for each country feature](../assets/fa0862fb551f21a0.png)
In this exercise, it is also enough that your application works for most countries. Countries whose name appears in the name of another country, like _Sudan_ , can be ignored.
#### 2.20*: Data for countries, step 3
Add to the view showing the data of a single country, the weather report for the capital of that country. There are dozens of providers for weather data. One suggested API is
![weather report added feature](../assets/796980e058df8735.png)
If you use Open weather map,
**NB:** In some browsers (such as Firefox) the chosen API might send an error response, which indicates that HTTPS encryption is not supported, although the request URL starts with _http://_. This issue can be fixed by completing the exercise using Chrome.
**NB:** You need an api-key to use almost every weather service. Do not save the api-key to source control! Nor hardcode the api-key to your source code. Instead use an
Assuming the api-key is _54l41n3n4v41m34rv0_ , when the application is started like so:

```
export VITE_SOME_KEY=54l41n3n4v41m34rv0 && npm run dev // For Linux/macOS Bash
($env:VITE_SOME_KEY="54l41n3n4v41m34rv0") -and (npm run dev) // For Windows PowerShell
set "VITE_SOME_KEY=54l41n3n4v41m34rv0" && npm run dev // For Windows cmd.execopy
```

you can access the value of the key from the _import.meta.env_ object:

```
const api_key = import.meta.env.VITE_SOME_KEY
// variable api_key now has the value set in startupcopy
```

**NB:** To prevent accidentally leaking environment variables to the client, only variables prefixed with VITE_ are exposed to Vite.
Also remember that if you make changes to environment variables, you need to restart the development server for the changes to take effect.
This was the last exercise of this part of the course. It's time to push your code to GitHub and mark all of your finished exercises to the
[Part 2d **Previous part**](../part2/01-altering-data-in-server.md)[Part 3 **Next part**](../part3/01-part3.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 2](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-part2.md)
- [a Rendering a collection, modules](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules.md)
- [b Forms](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-forms.md)
- [c Getting data from server](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-getting-data-from-server.md)
- [d Altering data in server](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server.md)
- [Improved error message](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app-improved-error-message.md)
- [Inline styles](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app-inline-styles.md)
- [Exercises 2.16.-2.17.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app-exercises-2-16-2-17.md)
- [Couple of important remarks](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app-couple-of-important-remarks.md)
- [Exercises 2.18.-2.20.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app-exercises-2-18-2-20.md)
- [exercise 0.2](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part0/01-fundamentals-of-web-apps-exercises-0-1-0-6.md)
- [error removed from server screenshot from app](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/92d6be547be25d86.png)
- [improved error message](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app-improved-error-message.md)
- [successful green added screenshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/675cc21824f019f6.png)
- [error message 404 not found when changing multiple browsers](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/d8ad4c24e0512d64.png)
- [promise and errors](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-promises-and-errors.md)
- [error message shown on screen instead of in console feature add-on](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/c26bb7aec9fc68d0.png)
- [console typerror cannot read properties of null via map from App](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/961c00c3bfd57d6a.png)
- [browser showing currency exchange rates with eur typed and console saying fetching exchange rates](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/cfedb7fcc4ab87ed.png)
- [too many matches screenshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/014dcc16758018ab.png)
- [matching countries in a list screenshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/d48c30289df6b371.png)
- [flag and additional attributes screenshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/adda63f167c7903d.png)
- [attach show buttons for each country feature](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/fa0862fb551f21a0.png)
- [weather report added feature](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/796980e058df8735.png)
- [Part 2d **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server.md)
- [Part 3 **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part3/01-part3.md)

--- .archived/data/part2/01-altering-data-in-server.md ---
---{
  "title": "Altering data in server",
  "source_url": "https://fullstackopen.com/en/part2/altering_data_in_server",
  "crawl_timestamp": "2025-10-04T19:16:08Z",
  "checksum": "b4d4d2f8d9ea6df110d7be6f919dc6f70944ff91ecf2255553204f696b37ea16"
}
---[Skip to content](../part2/01-altering-data-in-server-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 2](../part2/01-part2.md)
Altering data in server
[a Rendering a collection, modules](../part2/01-rendering-a-collection-modules.md)[b Forms](../part2/01-forms.md)[c Getting data from server](../part2/01-getting-data-from-server.md)
d Altering data in server

- [REST](../part2/01-altering-data-in-server-rest.md)
- [Sending Data to the Server](../part2/01-altering-data-in-server-sending-data-to-the-server.md)
- [Changing the Importance of Notes](../part2/01-altering-data-in-server-changing-the-importance-of-notes.md)
- [Extracting Communication with the Backend into a Separate Module](../part2/01-altering-data-in-server-extracting-communication-with-the-backend-into-a-separate-module.md)
- [Cleaner Syntax for Defining Object Literals](../part2/01-altering-data-in-server-cleaner-syntax-for-defining-object-literals.md)
- [Promises and Errors](../part2/01-altering-data-in-server-promises-and-errors.md)
- [Full stack developer's oath](../part2/01-altering-data-in-server-full-stack-developers-oath.md)
- [Exercises 2.12.-2.15.](../part2/01-altering-data-in-server-exercises-2-12-2-15.md)


[e Adding styles to React app](../part2/01-adding-styles-to-react-app.md)
d
# Altering data in server
When creating notes in our application, we would naturally want to store them in some backend server. The
> _Get a full fake REST API with zero coding in less than 30 seconds (seriously)_
The json-server does not exactly match the description provided by the textbook
We will take a closer look at REST in the [next part](../part3/01-part3.md) of the course. But it's important to familiarize ourselves at this point with some of the
### REST
In REST terminology, we refer to individual data objects, such as the notes in our application, as _resources_. Every resource has a unique address associated with it - its URL. According to a general convention used by json-server, we would be able to locate an individual note at the resource URL _notes/3_ , where 3 is the id of the resource. The _notes_ URL, on the other hand, would point to a resource collection containing all the notes.
Resources are fetched from the server with HTTP GET requests. For instance, an HTTP GET request to the URL _notes/3_ will return the note that has the id number 3. An HTTP GET request to the _notes_ URL would return a list of all notes.
Creating a new resource for storing a note is done by making an HTTP POST request to the _notes_ URL according to the REST convention that the json-server adheres to. The data for the new note resource is sent in the _body_ of the request.
json-server requires all data to be sent in JSON format. What this means in practice is that the data must be a correctly formatted string and that the request must contain the _Content-Type_ request header with the value _application/json_.
### Sending Data to the Server
Let's make the following changes to the event handler responsible for creating a new note:

```
const addNote = event => {
  event.preventDefault()
  const noteObject = {
    content: newNote,
    important: Math.random() < 0.5,
  }

  axios    .post('http://localhost:3001/notes', noteObject)    .then(response => {      console.log(response)    })}copy
```

We create a new object for the note but omit the _id_ property since it's better to let the server generate ids for our resources.
The object is sent to the server using the axios _post_ method. The registered event handler logs the response that is sent back from the server to the console.
When we try to create a new note, the following output pops up in the console:
![data json output in console](../assets/d0d628dfe547e528.png)
The newly created note resource is stored in the value of the _data_ property of the _response_ object.
Quite often it is useful to inspect HTTP requests in the _Network_ tab of Chrome developer tools, which was used heavily at the beginning of [part 0](../part0/01-fundamentals-of-web-apps-http-get.md).
We can use the inspector to check that the headers sent in the POST request are what we expected them to be:
![dev tools header shows 201 created for localhost:3001/notes](../assets/5062c160ed772225.png)
Since the data we sent in the POST request was a JavaScript object, axios automatically knew to set the appropriate _application/json_ value for the _Content-Type_ header.
The tab _payload_ can be used to check the request data:
![devtools payload tab shows content and important fields from above](../assets/f0eb234eb167eabf.png)
Also the tab _response_ is useful, it shows what was the data the server responded with:
![devtools response tab shows same content as payload but with id field too](../assets/efc8edcde75c8975.png)
The new note is not rendered to the screen yet. This is because we did not update the state of the _App_ component when we created it. Let's fix this:

```
const addNote = event => {
  event.preventDefault()
  const noteObject = {
    content: newNote,
    important: Math.random() > 0.5,
  }

  axios
    .post('http://localhost:3001/notes', noteObject)
    .then(response => {
      setNotes(notes.concat(response.data))      setNewNote('')    })
}copy
```

The new note returned by the backend server is added to the list of notes in our application's state in the customary way of using the _setNotes_ function and then resetting the note creation form. An [important detail](../part1/01-a-more-complex-state-debugging-react-apps-handling-arrays.md) to remember is that the _concat_ method does not change the component's original state, but instead creates a new copy of the list.
Once the data returned by the server starts to have an effect on the behavior of our web applications, we are immediately faced with a whole new set of challenges arising from, for instance, the asynchronicity of communication. This necessitates new debugging strategies, console logging and other means of debugging become increasingly more important. We must also develop a sufficient understanding of the principles of both the JavaScript runtime and React components. Guessing won't be enough.
It's beneficial to inspect the state of the backend server, e.g. through the browser:
![JSON data output from backend](../assets/12c4425ee33113e3.png)
This makes it possible to verify that all the data we intended to send was actually received by the server.
In the next part of the course, we will learn to implement our own logic in the backend. We will then take a closer look at tools like
The code for the current state of our application can be found in the _part2-5_ branch on
### Changing the Importance of Notes
Let's add a button to every note that can be used for toggling its importance.
We make the following changes to the _Note_ component:

```
const Note = ({ note, toggleImportance }) => {
  const label = note.important
    ? 'make not important' : 'make important'

  return (
    <li>
      {note.content} 
      <button onClick={toggleImportance}>{label}</button>
    </li>
  )
}copy
```

We add a button to the component and assign its event handler as the _toggleImportance_ function passed in the component's props.
The _App_ component defines an initial version of the _toggleImportanceOf_ event handler function and passes it to every _Note_ component:

```
const App = () => {
  const [notes, setNotes] = useState([]) 
  const [newNote, setNewNote] = useState('')
  const [showAll, setShowAll] = useState(true)

  // ...

  const toggleImportanceOf = (id) => {    console.log('importance of ' + id + ' needs to be toggled')  }
  // ...

  return (
    <div>
      <h1>Notes</h1>
      <div>
        <button onClick={() => setShowAll(!showAll)}>
          show {showAll ? 'important' : 'all' }
        </button>
      </div>      
      <ul>
        {notesToShow.map(note => 
          <Note
            key={note.id}
            note={note} 
            toggleImportance={() => toggleImportanceOf(note.id)}          />
        )}
      </ul>
      // ...
    </div>
  )
}copy
```

Notice how every note receives its own _unique_ event handler function since the _id_ of every note is unique.
E.g., if _note.id_ is 3, the event handler function returned by _toggleImportance(note.id)_ will be:

```
() => { console.log('importance of 3 needs to be toggled') }copy
```

A short reminder here. The string printed by the event handler is defined in a Java-like manner by adding the strings:

```
console.log('importance of ' + id + ' needs to be toggled')copy
```

The

```
console.log(`importance of ${id} needs to be toggled`)copy
```

We can now use the "dollar-bracket"-syntax to add parts to the string that will evaluate JavaScript expressions, e.g. the value of a variable. Note that we use backticks in template strings instead of quotation marks used in regular JavaScript strings.
Individual notes stored in the json-server backend can be modified in two different ways by making HTTP requests to the note's unique URL. We can either _replace_ the entire note with an HTTP PUT request or only change some of the note's properties with an HTTP PATCH request.
The final form of the event handler function is the following:

```
const toggleImportanceOf = id => {
  const url = `http://localhost:3001/notes/${id}`
  const note = notes.find(n => n.id === id)
  const changedNote = { ...note, important: !note.important }

  axios.put(url, changedNote).then(response => {
    setNotes(notes.map(note => note.id === id ? response.data : note))
  })
}copy
```

Almost every line of code in the function body contains important details. The first line defines the unique URL for each note resource based on its id.
The array _note_ variable.
After this, we create a _new object_ that is an exact copy of the old note, apart from the important property that has the value flipped (from true to false or from false to true).
The code for creating the new object that uses the

```
const changedNote = { ...note, important: !note.important }copy
```

In practice, _{ ...note }_ creates a new object with copies of all the properties from the _note_ object. When we add properties inside the curly braces after the spread object, e.g. _{ ...note, important: true }_ , then the value of the _important_ property of the new object will be _true_. In our example, the _important_ property gets the negation of its previous value in the original object.
There are a few things to point out. Why did we make a copy of the note object we wanted to modify when the following code also appears to work?

```
const note = notes.find(n => n.id === id)
note.important = !note.important

axios.put(url, note).then(response => {
  // ...copy
```

This is not recommended because the variable _note_ is a reference to an item in the _notes_ array in the component's state, and as we recall we must
It's also worth noting that the new object _changedNote_ is only a so-called
The new note is then sent with a PUT request to the backend where it will replace the old object.
The callback function sets the component's _notes_ state to a new array that contains all the items from the previous _notes_ array, except for the old note which is replaced by the updated version of it returned by the server:

```
axios.put(url, changedNote).then(response => {
  setNotes(notes.map(note => note.id === id ? response.data : note))
})copy
```

This is accomplished with the _map_ method:

```
notes.map(note => note.id === id ? response.data : note)copy
```

The map method creates a new array by mapping every item from the old array into an item in the new array. In our example, the new array is created conditionally so that if _note.id === id_ is true; the note object returned by the server is added to the array. If the condition is false, then we simply copy the item from the old array into the new array instead.
This _map_ trick may seem a bit strange at first, but it's worth spending some time wrapping your head around it. We will be using this method many times throughout the course.
### Extracting Communication with the Backend into a Separate Module
The _App_ component has become somewhat bloated after adding the code for communicating with the backend server. In the spirit of the [module](../part2/01-rendering-a-collection-modules-refactoring-modules.md).
Let's create a _src/services_ directory and add a file there called _notes.js_ :

```
import axios from 'axios'
const baseUrl = 'http://localhost:3001/notes'

const getAll = () => {
  return axios.get(baseUrl)
}

const create = newObject => {
  return axios.post(baseUrl, newObject)
}

const update = (id, newObject) => {
  return axios.put(`${baseUrl}/${id}`, newObject)
}

export default { 
  getAll: getAll, 
  create: create, 
  update: update 
}copy
```

The module returns an object that has three functions (_getAll_ , _create_ , and _update_) as its properties that deal with notes. The functions directly return the promises returned by the axios methods.
The _App_ component uses _import_ to get access to the module:

```
import noteService from './services/notes'
const App = () => {copy
```

The functions of the module can be used directly with the imported variable _noteService_ as follows:

```
const App = () => {
  // ...

  useEffect(() => {
    noteService      .getAll()      .then(response => {        setNotes(response.data)      })  }, [])

  const toggleImportanceOf = id => {
    const note = notes.find(n => n.id === id)
    const changedNote = { ...note, important: !note.important }

    noteService      .update(id, changedNote)      .then(response => {        setNotes(notes.map(note => note.id === id ? response.data : note))      })  }

  const addNote = (event) => {
    event.preventDefault()
    const noteObject = {
      content: newNote,
      important: Math.random() > 0.5
    }

    noteService      .create(noteObject)      .then(response => {        setNotes(notes.concat(response.data))        setNewNote('')      })  }

  // ...
}

export default Appcopy
```

We could take our implementation a step further. When the _App_ component uses the functions, it receives an object that contains the entire response for the HTTP request:

```
noteService
  .getAll()
  .then(response => {
    setNotes(response.data)
  })copy
```

The _App_ component only uses the _response.data_ property of the response object.
The module would be much nicer to use if, instead of the entire HTTP response, we would only get the response data. Using the module would then look like this:

```
noteService
  .getAll()
  .then(initialNotes => {
    setNotes(initialNotes)
  })copy
```

We can achieve this by changing the code in the module as follows (the current code contains some copy-paste, but we will tolerate that for now):

```
import axios from 'axios'
const baseUrl = 'http://localhost:3001/notes'

const getAll = () => {
  const request = axios.get(baseUrl)
  return request.then(response => response.data)
}

const create = newObject => {
  const request = axios.post(baseUrl, newObject)
  return request.then(response => response.data)
}

const update = (id, newObject) => {
  const request = axios.put(`${baseUrl}/${id}`, newObject)
  return request.then(response => response.data)
}

export default { 
  getAll: getAll, 
  create: create, 
  update: update 
}copy
```

We no longer return the promise returned by axios directly. Instead, we assign the promise to the _request_ variable and call its _then_ method:

```
const getAll = () => {
  const request = axios.get(baseUrl)
  return request.then(response => response.data)
}copy
```

The last row in our function is simply a more compact expression of the same code as shown below:

```
const getAll = () => {
  const request = axios.get(baseUrl)
  return request.then(response => {    return response.data  })}copy
```

The modified _getAll_ function still returns a promise, as the _then_ method of a promise also
After defining the parameter of the _then_ method to directly return _response.data_ , we have gotten the _getAll_ function to work like we wanted it to. When the HTTP request is successful, the promise returns the data sent back in the response from the backend.
We have to update the _App_ component to work with the changes made to our module. We have to fix the callback functions given as parameters to the _noteService_ object's methods so that they use the directly returned response data:

```
const App = () => {
  // ...

  useEffect(() => {
    noteService
      .getAll()
      .then(initialNotes => {        setNotes(initialNotes)      })
  }, [])

  const toggleImportanceOf = id => {
    const note = notes.find(n => n.id === id)
    const changedNote = { ...note, important: !note.important }

    noteService
      .update(id, changedNote)
      .then(returnedNote => {        setNotes(notes.map(note => note.id === id ? returnedNote : note))      })
  }

  const addNote = (event) => {
    event.preventDefault()
    const noteObject = {
      content: newNote,
      important: Math.random() > 0.5
    }

    noteService
      .create(noteObject)
      .then(returnedNote => {        setNotes(notes.concat(returnedNote))        setNewNote('')
      })
  }

  // ...
}copy
```

This is all quite complicated and attempting to explain it may just make it harder to understand. The internet is full of material discussing the topic, such as
The "Async and performance" book from the
Promises are central to modern JavaScript development and it is highly recommended to invest a reasonable amount of time into understanding them.
### Cleaner Syntax for Defining Object Literals
The module defining note-related services currently exports an object with the properties _getAll_ , _create_ , and _update_ that are assigned to functions for handling notes.
The module definition was:

```
import axios from 'axios'
const baseUrl = 'http://localhost:3001/notes'

const getAll = () => {
  const request = axios.get(baseUrl)
  return request.then(response => response.data)
}

const create = newObject => {
  const request = axios.post(baseUrl, newObject)
  return request.then(response => response.data)
}

const update = (id, newObject) => {
  const request = axios.put(`${baseUrl}/${id}`, newObject)
  return request.then(response => response.data)
}

export default { 
  getAll: getAll, 
  create: create, 
  update: update 
}copy
```

The module exports the following, rather peculiar looking, object:

```
{ 
  getAll: getAll, 
  create: create, 
  update: update 
}copy
```

The labels to the left of the colon in the object definition are the _keys_ of the object, whereas the ones to the right of it are _variables_ that are defined inside the module.
Since the names of the keys and the assigned variables are the same, we can write the object definition with a more compact syntax:

```
{ 
  getAll, 
  create, 
  update 
}copy
```

As a result, the module definition gets simplified into the following form:

```
import axios from 'axios'
const baseUrl = 'http://localhost:3001/notes'

const getAll = () => {
  const request = axios.get(baseUrl)
  return request.then(response => response.data)
}

const create = newObject => {
  const request = axios.post(baseUrl, newObject)
  return request.then(response => response.data)
}

const update = (id, newObject) => {
  const request = axios.put(`${baseUrl}/${id}`, newObject)
  return request.then(response => response.data)
}

export default { getAll, create, update }copy
```

In defining the object using this shorter notation, we make use of a
To demonstrate this feature, let's consider a situation where we have the following values assigned to variables:

```
const name = 'Leevi'
const age = 0copy
```

In older versions of JavaScript we had to define an object like this:

```
const person = {
  name: name,
  age: age
}copy
```

However, since both the property fields and the variable names in the object are the same, it's enough to simply write the following in ES6 JavaScript:

```
const person = { name, age }copy
```

The result is identical for both expressions. They both create an object with a _name_ property with the value _Leevi_ and an _age_ property with the value _0_.
### Promises and Errors
If our application allowed users to delete notes, we could end up in a situation where a user tries to change the importance of a note that has already been deleted from the system.
Let's simulate this situation by making the _getAll_ function of the note service return a "hardcoded" note that does not actually exist on the backend server:

```
const getAll = () => {
  const request = axios.get(baseUrl)
  const nonExisting = {
    id: 10000,
    content: 'This note is not saved to server',
    important: true,
  }
  return request.then(response => response.data.concat(nonExisting))
}copy
```

When we try to change the importance of the hardcoded note, we see the following error message in the console. The error says that the backend server responded to our HTTP PUT request with a status code 404 _not found_.
![404 not found error in dev tools](../assets/3ea8aa9a4558bd74.png)
The application should be able to handle these types of error situations gracefully. Users won't be able to tell that an error has occurred unless they happen to have their console open. The only way the error can be seen in the application is that clicking the button does not affect the note's importance.
We had [previously](../part2/01-getting-data-from-server-axios-and-promises.md) mentioned that a promise can be in one of three different states. When an axios HTTP request fails, the associated promise is _rejected_. Our current code does not handle this rejection in any way.
The rejection of a promise is _then_ method with a second callback function, which is called in the situation where the promise is rejected.
The more common way of adding a handler for rejected promises is to use the
In practice, the error handler for rejected promises is defined like this:

```
axios
  .get('http://example.com/probably_will_fail')
  .then(response => {
    console.log('success!')
  })
  .catch(error => {
    console.log('fail')
  })copy
```

If the request fails, the event handler registered with the _catch_ method gets called.
The _catch_ method is often utilized by placing it deeper within the promise chain.
When multiple _.then_ methods are chained together, we are in fact creating a

```
axios
  .get('http://...')
  .then(response => response.data)
  .then(data => {
    // ...
  })copy
```

The _catch_ method can be used to define a handler function at the end of a promise chain, which is called once any promise in the chain throws an error and the promise becomes _rejected_.

```
axios
  .get('http://...')
  .then(response => response.data)
  .then(data => {
    // ...
  })
  .catch(error => {
    console.log('fail')
  })copy
```

Let's take advantage of this feature. We will place our application's error handler in the _App_ component:

```
const toggleImportanceOf = id => {
  const note = notes.find(n => n.id === id)
  const changedNote = { ...note, important: !note.important }

  noteService
    .update(id, changedNote).then(returnedNote => {
      setNotes(notes.map(note => note.id === id ? returnedNote : note))
    })
    .catch(error => {      alert(        `the note '${note.content}' was already deleted from server`      )      setNotes(notes.filter(n => n.id !== id))    })}copy
```

The error message is displayed to the user with the trusty old
Removing an already deleted note from the application's state is done with the array

```
notes.filter(n => n.id !== id)copy
```

It's probably not a good idea to use alert in more serious React applications. We will soon learn a more advanced way of displaying messages and notifications to users. There are situations, however, where a simple, battle-tested method like _alert_ can function as a starting point. A more advanced method could always be added in later, given that there's time and energy for it.
The code for the current state of our application can be found in the _part2-6_ branch on
### Full stack developer's oath
It is again time for the exercises. The complexity of our app is now increasing since besides just taking care of the React components in the frontend, we also have a backend that is persisting the application data.
To cope with the increasing complexity we should extend the web developer's oath to a _Full stack developer's oath_ , which reminds us to make sure that the communication between frontend and backend happens as expected.
So here is the updated oath:
Full stack development is _extremely hard_ , that is why I will use all the possible means to make it easier

- I will have my browser developer console open all the time
- _I will use the network tab of the browser dev tools to ensure that frontend and backend are communicating as I expect_
- _I will constantly keep an eye on the state of the server to make sure that the data sent there by the frontend is saved there as I expect_
- I will progress with small steps
- I will write lots of _console.log_ statements to make sure I understand how the code behaves and to help pinpoint problems
- If my code does not work, I will not write more code. Instead, I start deleting the code until it works or just return to a state when everything was still working
- When I ask for help in the course Discord channel or elsewhere I formulate my questions properly, see [here](../part0/01-general-info-how-to-get-help-in-discord.md) how to ask for help


### Exercises 2.12.-2.15
#### 2.12: The Phonebook step 7
Let's return to our phonebook application.
Currently, the numbers that are added to the phonebook are not saved to a backend server. Fix this situation.
#### 2.13: The Phonebook step 8
Extract the code that handles the communication with the backend into its own module by following the example shown earlier in this part of the course material.
#### 2.14: The Phonebook step 9
Make it possible for users to delete entries from the phonebook. The deletion can be done through a dedicated button for each person in the phonebook list. You can confirm the action from the user by using the
![2.17 window confirm feature screeshot](../assets/55f986fade124d77.png)
The associated resource for a person in the backend can be deleted by making an HTTP DELETE request to the resource's URL. If we are deleting e.g. a person who has the _id_ 2, we would have to make an HTTP DELETE request to the URL _localhost:3001/persons/2_. No data is sent with the request.
You can make an HTTP DELETE request with the
**NB:** You can't use the name _delete_ for a variable because it's a reserved word in JavaScript. E.g. the following is not possible:

```
// use some other name for variable!
const delete = (id) => {
  // ...
}copy
```

#### 2.15*: The Phonebook step 10
_Why is there an asterisk in the exercise? See[here](../part0/01-general-info-taking-the-course.md) for the explanation._
Change the functionality so that if a number is added to an already existing user, the new number will replace the old number. It's recommended to use the HTTP PUT method for updating the phone number.
If the person's information is already in the phonebook, the application can ask the user to confirm the action:
![2.18 screenshot alert confirmation](../assets/4dd0224e4b3b3eb5.png)
[Part 2c **Previous part**](../part2/01-getting-data-from-server.md)[Part 2e **Next part**](../part2/01-adding-styles-to-react-app.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 2](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-part2.md)
- [a Rendering a collection, modules](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules.md)
- [b Forms](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-forms.md)
- [c Getting data from server](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-getting-data-from-server.md)
- [REST](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-rest.md)
- [Sending Data to the Server](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-sending-data-to-the-server.md)
- [Changing the Importance of Notes](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-changing-the-importance-of-notes.md)
- [Extracting Communication with the Backend into a Separate Module](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-extracting-communication-with-the-backend-into-a-separate-module.md)
- [Cleaner Syntax for Defining Object Literals](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-cleaner-syntax-for-defining-object-literals.md)
- [Promises and Errors](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-promises-and-errors.md)
- [Full stack developer's oath](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-full-stack-developers-oath.md)
- [Exercises 2.12.-2.15.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-altering-data-in-server-exercises-2-12-2-15.md)
- [e Adding styles to React app](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app.md)
- [next part](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part3/01-part3.md)
- [data json output in console](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/d0d628dfe547e528.png)
- [part 0](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part0/01-fundamentals-of-web-apps-http-get.md)
- [dev tools header shows 201 created for localhost:3001/notes](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/5062c160ed772225.png)
- [devtools payload tab shows content and important fields from above](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/f0eb234eb167eabf.png)
- [devtools response tab shows same content as payload but with id field too](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/efc8edcde75c8975.png)
- [important detail](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps-handling-arrays.md)
- [JSON data output from backend](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/12c4425ee33113e3.png)
- [module](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-rendering-a-collection-modules-refactoring-modules.md)
- [404 not found error in dev tools](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/3ea8aa9a4558bd74.png)
- [previously](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-getting-data-from-server-axios-and-promises.md)
- [here](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part0/01-general-info-how-to-get-help-in-discord.md)
- [2.17 window confirm feature screeshot](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/55f986fade124d77.png)
- [here](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part0/01-general-info-taking-the-course.md)
- [2.18 screenshot alert confirmation](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/4dd0224e4b3b3eb5.png)
- [Part 2c **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-getting-data-from-server.md)
- [Part 2e **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-adding-styles-to-react-app.md)

--- .archived/data/part9/01-background-and-introduction.md ---
---{
  "title": "Background and introduction",
  "source_url": "https://fullstackopen.com/en/part9/background_and_introduction",
  "crawl_timestamp": "2025-10-04T19:17:16Z",
  "checksum": "149ac5090a4468845e1b0f829cc261e1d29ee731017e774162dd2ec9154dccf2"
}
---[Skip to content](../part9/01-background-and-introduction-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

A new exercise has been added at the end of Part 9 "Typing an Express app" at 28th August 2024. Because of that numbering of the Exercises 9.14- has changed.
x
[Fullstack](../#course-contents/01-course-contents.md)
[Part 9](../part9/01-part9.md)
Background and introduction
a Background and introduction

- [Main principle](../part9/01-background-and-introduction-main-principle.md)
- [TypeScript key language features](../part9/01-background-and-introduction-type-script-key-language-features.md)
- [Why should one use TypeScript?](../part9/01-background-and-introduction-why-should-one-use-type-script.md)
- [What does TypeScript not fix?](../part9/01-background-and-introduction-what-does-type-script-not-fix.md)


[b First steps with TypeScript](../part9/01-first-steps-with-type-script.md)[c Typing an Express app](../part9/01-typing-an-express-app.md)[d React with types](../part9/01-react-with-types.md)[e Grande finale: Patientor](../part9/01-grande-finale-patientor.md)
a
# Background and introduction
_Azure Management Portal_ (1,2 million lines of code) and _Visual Studio Code_ (300 000 lines of code) have both been written in TypeScript. To support building large-scale JavaScript applications, TypeScript offers features such as better development-time tooling, static code analysis, compile-time type checking and code-level documentation.
### Main principle
TypeScript is a typed superset of JavaScript, and eventually, it's compiled into plain JavaScript code. The programmer is even able to decide the version of the generated code, as long as it's ECMAScript 3 or newer. TypeScript being a superset of JavaScript means that it includes all the features of JavaScript and its additional features as well. In other words, all existing JavaScript code is valid TypeScript.
TypeScript consists of three separate, but mutually fulfilling parts:

- The language
- The compiler
- The language service

![diagram of typescript components](../assets/a12e6229f1a2c2c0.png)
The _language_ consists of syntax, keywords and type annotations. The syntax is similar to but not the same as JavaScript syntax. From the three parts of TypeScript, programmers have the most direct contact with the language.
The _compiler_ is responsible for type information erasure (i.e. removing the typing information) and for code transformations. The code transformations enable TypeScript code to be transpiled into executable JavaScript. Everything related to the types is removed at compile-time, so TypeScript isn't genuine statically typed code.
Traditionally, _compiling_ means that code is transformed from a human-readable format to a machine-readable format. In TypeScript, human-readable source code is transformed into another human-readable source code, so the correct term would be _transpiling_. However, compiling has been the most commonly used term in this context, so we will continue to use it.
The compiler also performs a static code analysis. It can emit warnings or errors if it finds a reason to do so, and it can be set to perform additional tasks such as combining the generated code into a single file.
The _language service_ collects type information from the source code. Development tools can use the type information for providing intellisense, type hints and possible refactoring alternatives.
### TypeScript key language features
In this section, we will describe some of the key features of the TypeScript language. The intent is to provide you with a basic understanding of TypeScript's key features to help you understand more of what is to come during this course.
#### Type annotations
Type annotations in TypeScript are a lightweight way to record the intended _contract_ of a function or a variable. In the example below, we have defined a _birthdayGreeter_ function that accepts two arguments: one of type string and one of type number. The function will return a string.

```
const birthdayGreeter = (name: string, age: number): string => {
  return `Happy birthday ${name}, you are now ${age} years old!`;
};

const birthdayHero = "Jane User";
const age = 22;

console.log(birthdayGreeter(birthdayHero, age));copy
```

#### Keywords
Keywords in TypeScript are specially reserved words that embody designated teleological meaning within the construct of the language. They cannot be used as identifiers (variable names, function names, class names, etc.) because they are part of the syntax of the language. An attempt to use these keywords will result in syntax or semantics error. There are about 40-50 keywords in TypeScript. Some of these keywords include: type, enum, interface, void, null, instanceof etc. One thing to note is that, TypeScript inherits all the reserved keywords from JavaScript, plus it adds a few of its own type-related keywords like interface, type, enum, etc.
#### Structural typing
TypeScript is a structurally typed language. In structural typing, two elements are considered to be compatible with one another if, for each feature within the type of the first element, a corresponding and identical feature exists within the type of the second element. Two types are considered to be identical if they are compatible with each other.
#### Type inference
The TypeScript compiler can attempt to infer the type information if no type has been specified. Variables' types can be inferred based on their assigned value and their usage. The type inference takes place when initializing variables and members, setting parameter default values, and determining function return types.
For example, consider the function _add_ :

```
const add = (a: number, b: number) => {
  /* The return value is used to determine
     the return type of the function */
  return a + b;
}copy
```

The type of the function's return value is inferred by retracing the code back to the return expression. The return expression performs an addition of the parameters a and b. We can see that a and b are numbers based on their types. Thus, we can infer the return value to be of type _number_.
#### Type erasure
TypeScript removes all type system constructs during compilation.
Input:

```
let x: SomeType;copy
```

Output:

```
let x;copy
```

This means that no type information remains at runtime; nothing says that some variable x was declared as being of type _SomeType_.
The lack of runtime type information can be surprising for programmers who are used to extensively using reflection or other metadata systems.
### Why should one use TypeScript
On different forums, you may stumble upon a lot of different arguments either for or against TypeScript. The truth is probably as vague, it depends on your needs and the use of the functions that TypeScript offers. Anyway, here are some of our reasons behind why we think that the use of TypeScript may have some advantages.
First of all, TypeScript offers _type checking and static code analysis_. We can require values to be of a certain type and have the compiler warn about using them incorrectly. This can reduce runtime errors, and you might even be able to reduce the number of required unit tests in a project, at least concerning pure-type tests. The static code analysis doesn't only warn about wrongful type usage, but also other mistakes such as misspelling a variable or function name or trying to use a variable beyond its scope.
The second advantage of TypeScript is that the type annotations in the code can function as a kind of _code-level documentation_. It's easy to check from a function signature what kind of arguments the function can consume and what type of data it will return. This form of type annotation-bound documentation will always be up to date and it makes it easier for new programmers to start working on an existing project. It is also helpful when returning to work on an old project.
Types can be reused all around the code base, and a change to a type definition will automatically be reflected everywhere the type is used. One might argue that you can achieve similar code-level documentation with e.g.
The third advantage of TypeScript is that IDEs can provide more _specific and smarter IntelliSense_ when they know exactly what types of data you are processing.
All of these features are extremely helpful when you need to refactor your code. The static code analysis warns you about any errors in your code, and IntelliSense can give you hints about available properties and even possible refactoring options. The code-level documentation helps you understand the existing code. With the help of TypeScript, it is also very easy to start using the newest JavaScript language features at an early stage just by altering its configuration.
### What does TypeScript not fix
As mentioned above, TypeScript's type annotations and type checking exist only at compile time and no longer at runtime. Even if the compiler does not throw any errors, runtime errors are still possible. These runtime errors are especially common when handling external input, such as data received from a network request.
Lastly, below, we list some issues many have with TypeScript, which might be good to be aware of:
#### Incomplete, invalid or missing types in external libraries
When using external libraries, you may find that some have either missing or in some way invalid type declarations. Most often, this is due to the library not being written in TypeScript, and the person adding the type declarations manually not doing such a good job with it. In these cases, you might need to define the type declarations yourself. However, there is a good chance someone has already added typings for the package you are using. Always check the DefinitelyTyped
#### Sometimes, type inference needs assistance
The type inference in TypeScript is pretty good but not quite perfect. Sometimes, you may feel like you have declared your types perfectly, but the compiler still tells you that the property does not exist or that this kind of usage is not allowed. In these cases, you might need to help the compiler out by doing something like an "extra" type check. One should be careful with type casting (that is quite often called type assertion) or type guards: when using those, you are giving your word to the compiler that the value _is_ of the type that you declare. You might want to check out TypeScript's documentation regarding
#### Mysterious type errors
The errors given by the type system may sometimes be quite hard to understand, especially if you use complex types. As a rule of thumb, the TypeScript error messages have the most useful information at the end of the message. When running into long confusing messages, start reading them from the end.
[Part 8 **Previous part**](../part8/01-part8.md)[Part 9b **Next part**](../part9/01-first-steps-with-type-script.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-background-and-introduction-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 9](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-part9.md)
- [Main principle](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-background-and-introduction-main-principle.md)
- [TypeScript key language features](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-background-and-introduction-type-script-key-language-features.md)
- [Why should one use TypeScript?](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-background-and-introduction-why-should-one-use-type-script.md)
- [What does TypeScript not fix?](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-background-and-introduction-what-does-type-script-not-fix.md)
- [b First steps with TypeScript](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-first-steps-with-type-script.md)
- [c Typing an Express app](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-typing-an-express-app.md)
- [d React with types](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-react-with-types.md)
- [e Grande finale: Patientor](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-grande-finale-patientor.md)
- [diagram of typescript components](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/a12e6229f1a2c2c0.png)
- [Part 8 **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part8/01-part8.md)
- [Part 9b **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part9/01-first-steps-with-type-script.md)

--- .archived/data/part12/01-basics-of-orchestration.md ---
---{
  "title": "Basics of Orchestration",
  "source_url": "https://fullstackopen.com/en/part12/basics_of_orchestration",
  "crawl_timestamp": "2025-10-04T19:15:55Z",
  "checksum": "bc006858b803be176a4f3f771906338972d70d7c4be65632d5d2b244be87d797"
}
---[Skip to content](../part12/01-basics-of-orchestration-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 12](../part12/01-part12.md)
Basics of Orchestration
[a Introduction to Containers](../part12/01-introduction-to-containers.md)[b Building and configuring environments](../part12/01-building-and-configuring-environments.md)
c Basics of Orchestration

- [React in container](../part12/01-basics-of-orchestration-react-in-container.md)
- [Using multiple stages](../part12/01-basics-of-orchestration-using-multiple-stages.md)
- [Exercises 12.13 - 12.14.](../part12/01-basics-of-orchestration-exercises-12-13-12-14.md)
- [Development in containers](../part12/01-basics-of-orchestration-development-in-containers.md)
- [Exercise 12.15](../part12/01-basics-of-orchestration-exercise-12-15.md)
- [Communication between containers in a Docker network](../part12/01-basics-of-orchestration-communication-between-containers-in-a-docker-network.md)
- [Exercise 12.16](../part12/01-basics-of-orchestration-exercise-12-16.md)
- [Communications between containers in a more ambitious environment](../part12/01-basics-of-orchestration-communications-between-containers-in-a-more-ambitious-environment.md)
- [Exercises 12.17. - 12.19.](../part12/01-basics-of-orchestration-exercises-12-17-12-19.md)
- [Tools for Production](../part12/01-basics-of-orchestration-tools-for-production.md)
- [Exercises 12.20.-12.22.](../part12/01-basics-of-orchestration-exercises-12-20-12-22.md)
- [Submitting exercises and getting the credits](../part12/01-basics-of-orchestration-submitting-exercises-and-getting-the-credits.md)


c
# Basics of Orchestration
The part was updated 21th Mar 2024: Create react app was replaced with Vite in the todo-frontend.
If you started the part before the update, you can see
We have now a basic understanding of Docker and can use it to easily set up eg. a database for our app. Let us now move our focus to the frontend.
### React in container
Let's create and containerize a React application next. We start with the usual steps:

```
npm create vite@latest hello-front -- --template react
cd hello-front
npm installcopy
```

The next step is to turn the JavaScript code and CSS, into production-ready static files. Vite already has _build_ as an npm script so let's use that:

```
$ npm run build
  ...

  Creating an optimized production build...
  ...
  The build folder is ready to be deployed.
  ...copy
```

Great! The final step is figuring out a way to use a server to serve the static files. As you may know, we could use

```
FROM node:20

WORKDIR /usr/src/app

COPY . .

RUN npm ci

RUN npm run buildcopy
```

That looks about right. Let's build it and see if we are on the right track. Our goal is to have the build succeed without errors. Then we will use bash to check inside of the container to see if the files are there.

```
$ docker build . -t hello-front
 => [4/5] RUN npm ci                  
 => [5/5] RUN npm run 
 ...             
 => => naming to docker.io/library/hello-front

$ docker run -it hello-front bash

root@98fa9483ee85:/usr/src/app# ls
  Dockerfile  README.md  dist  index.html  node_modules  package-lock.json  package.json public src  vite.config.js

root@98fa9483ee85:/usr/src/app# ls dist
  assets index.html  vite.svgcopy
```

A valid option for serving static files now that we already have Node in the container is

```
root@98fa9483ee85:/usr/src/app# npm install -g serve

  added 89 packages in 2s

root@98fa9483ee85:/usr/src/app# serve dist

   ┌────────────────────────────────────────┐
   │                                        │
   │   Serving!                             │
   │                                        │
   │   - Local:    http://localhost:3000    │
   │   - Network:  http://172.17.0.2:3000   │
   │                                        │
   └────────────────────────────────────────┘copy
```

Great! Let's ctrl+c to exit out and then add those to our Dockerfile.
The installation of serve turns into a RUN in the Dockerfile. This way the dependency is installed during the build process. The command to serve the _dist_ directory will become the command to start the container:

```
FROM node:20

WORKDIR /usr/src/app

COPY . .

RUN npm ci

RUN npm run build

RUN npm install -g serve
CMD ["serve", "dist"]copy
```

Our CMD now includes square brackets and as a result, we now use the _exec form_ of CMD. There are actually **three** different forms for CMD, out of which the exec form is preferred. Read the
When we now build the image with _docker build . -t hello-front_ and run it with _docker run -p 5001:3000 hello-front_ , the app will be available in
### Using multiple stages
While serve is a _valid_ option, we can do better. A good goal is to create Docker images so that they do not contain anything irrelevant. With a minimal number of dependencies, images are less likely to break or become vulnerable over time.
With multi-stage builds, a tried and true solution like
Let's use the previous Dockerfile but change the FROM to include the name of the stage:

```
# The first FROM is now a stage called build-stage
FROM node:20 AS build-stage 
WORKDIR /usr/src/app

COPY . .

RUN npm ci

RUN npm run build

# This is a new stage, everything before this is gone, except for the files that we want to COPY
FROM nginx:1.25-alpine
# COPY the directory dist from the build-stage to /usr/share/nginx/html
# The target location here was found from the Docker hub page
COPY --from=build-stage /usr/src/app/dist /usr/share/nginx/htmlcopy
```

We have also declared _another stage_ , where only the relevant files of the first stage (the _dist_ directory, that contains the static content) are copied.
After we build it again, the image is ready to serve the static content. The default port will be 80 for Nginx, so something like _-p 8000:80_ will work, so the parameters of the RUN command need to be changed a bit.
Multi-stage builds also include some internal optimizations that may affect your builds. As an example, multi-stage builds skip stages that are not used. If we wish to use a stage to replace a part of a build pipeline, like testing or notifications, we must pass **some** data to the following stages. In some cases this is justified: copy the code from the testing stage to the build stage. This ensures that you are building the tested code.
### Exercises 12.13 - 12.14
#### Exercise 12.13: Todo application frontend
Finally, we get to the todo-frontend. View the todo-app/todo-frontend and read through the README.
Start by running the frontend outside the container and ensure that it works with the backend.
Containerize the application by creating _todo-app/todo-frontend/Dockerfile_ and use the _VITE_BACKEND_URL_ to the application and run it with the backend. The backend should still be running outside a container.
**Note** that you need to set _VITE_BACKEND_URL_ before building the frontend, otherwise, it does not get defined in the code!
#### Exercise 12.14: Testing during the build process
One interesting possibility that utilizing multi-stage builds gives us, is to use a separate build stage for _all testing_ to be done during the building of an image, but there may be _some_ containerization-related tests where it might be worth considering.
Extract a component _Todo_ that represents a single todo. Write a test for the new component and add running the tests into the build process.
You can add a new build stage for the test if you wish to do so. If you do so, remember to read the last paragraph before exercise 12.13 again!
### Development in containers
Let's move the whole todo application development to a container. There are a few reasons why you would want to do that:

- To keep the environment similar between development and production to avoid bugs that appear only in the production environment
- To avoid differences between developers and their personal environments that lead to difficulties in application development
- To help new team members hop in by having them install container runtime - and requiring nothing else.


These all are great reasons. The tradeoff is that we may encounter some unconventional behavior when we aren't running the applications like we are used to. We will need to do at least two things to move the application to a container:

- Start the application in development mode
- Access the files with VS Code


Let's start with the frontend. Since the Dockerfile will be significantly different from the production Dockerfile let's create a new one called _dev.Dockerfile_.
**Note** we shall use the name _dev.Dockerfile_ for development configurations and _Dockerfile_ otherwise.
Starting Vite in development mode should be easy. Let's start with the following:

```
FROM node:20

WORKDIR /usr/src/app

COPY . .

# Change npm ci to npm install since we are going to be in development mode
RUN npm install

# npm run dev is the command to start the application in development mode
CMD ["npm", "run", "dev", "--", "--host"]copy
```

> Note the extra parameters _-- --host_ in the _CMD_. Those are needed to expose the development server to be visible outside the Docker network. By default the development server is exposed only to localhost, and despite we access the frontend still using the localhost address, it is in reality attached to the Docker network.
During build the flag _-f_ will be used to tell which file to use, it would otherwise default to Dockerfile, so the following command will build the image:

```
docker build -f ./dev.Dockerfile -t hello-front-dev .copy
```

Vite will be served in port 5173, so you can test that it works by running a container with that port published.
The second task, accessing the files with VSCode, is not yet taken care of. There are at least two ways of doing this:

- Volumes, the same thing we used to preserve data with the database


Let's go over the latter since that will work with other editors as well. Let's do a trial run with the flag _-v_ , and if that works, then we will move the configuration to a docker-compose file. To use the _-v_ , we will need to tell it the current directory. The command _pwd_ should output the path to the current directory for us. Let's try this with _echo $(pwd)_ in the command line. We can use that as the left side for _-v_ to map the current directory to the inside of the container or we can use the full directory path.

```
$ docker run -p 5173:5173 -v "$(pwd):/usr/src/app/" hello-front-dev
> todo-vite@0.0.0 dev
> vite --host

  VITE v5.1.6  ready in 130 mscopy
```

Now we can edit the file _src/App.jsx_ , and the changes should be hot-loaded to the browser!
If you have a Mac with M1/M2 processor, the above command fails. In the error message, we notice the following:

```
Error: Cannot find module @rollup/rollup-linux-arm64-gnucopy
```

The problem is the library _node_modules_ from the host machine directory where the _@rollup/rollup-darwin-arm64_ (the version suitable Mac M1/M2) is installed, so the right version of the library for the container _@rollup/rollup-linux-arm64-gnu_ is not found.
There are several ways to fix the problem. Let's use the perhaps simplest one. Start the container with bash as the command, and run the _npm install_ inside the container:

```
$ docker run -it -v "$(pwd):/usr/src/app/" front-dev bash
root@b83e9040b91d:/usr/src/app# npm installcopy
```

Now both versions of the library rollup are installed and the container works!
Next, let's move the config to the file _docker-compose.dev.yml_. This file should be at the root of the project as well:

```
services:
  app:
    image: hello-front-dev
    build:
      context: . # The context will pick this directory as the "build context"
      dockerfile: dev.Dockerfile # This will simply tell which dockerfile to read
    volumes:
      - ./:/usr/src/app # The path can be relative, so ./ is enough to say "the same location as the docker-compose.yml"
    ports:
      - 5173:5173
    container_name: hello-front-dev # This will name the container hello-front-devcopy
```

With this configuration, _docker compose -f docker-compose.dev.yml up_ can run the application in development mode. You don't even need Node installed to develop it!
**Note** we shall use the name _docker-compose.dev.yml_ for development environment compose files, and the default name _docker-compose.yml_ otherwise.
Installing new dependencies is a headache for a development setup like this. One of the better options is to install the new dependency **inside** the container. So instead of doing e.g. _npm install axios_ , you have to do it in the running container e.g. _docker exec hello-front-dev npm install axios_ , or add it to the package.json and run _docker build_ again.
### Exercise 12.15
#### Exercise 12.15: Set up a frontend development environment
Create _todo-frontend/docker-compose.dev.yml_ and use volumes to enable the development of the todo-frontend while it is running _inside_ a container.
### Communication between containers in a Docker network
The Docker Compose tool sets up a network between the containers and includes a DNS to easily connect two containers. Let's add a new service to the Docker Compose and we shall see how the network and DNS work.
Busybox can help us to debug our configurations. So if you get lost in the later exercises of this section, you should use Busybox to find out what works and what doesn't. Let's use it to explore what was just said. That the containers are inside a network and you can easily connect between them. Busybox can be added to the mix by changing _docker-compose.dev.yml_ to:

```
services:
  app:
    image: hello-front-dev
    build:
      context: .
      dockerfile: dev.Dockerfile
    volumes:
      - ./:/usr/src/app
    ports:
      - 5173:5173
    container_name: hello-front-dev
  debug-helper:    image: busyboxcopy
```

The Busybox container won't have any process running inside so we can not _exec_ in there. Because of that, the output of _docker compose up_ will also look like this:

```
$ docker compose -f docker-compose.dev.yml up                                                                                    0.0s
Attaching to front-dev, debug-helper-1
debug-helper-1 exited with code 0
front-dev       |
front-dev       | > todo-vite@0.0.0 dev
front-dev       | > vite --host
front-dev       |
front-dev       |
front-dev       |   VITE v5.2.2  ready in 153 mscopy
```

This is expected as it's just a toolbox. Let's use it to send a request to hello-front-dev and see how the DNS works. While the hello-front-dev is running, we can do the request with
With Docker Compose we can use _docker compose run SERVICE COMMAND_ to run a service with a specific command. Command wget requires the flag _-O_ with _-_ to output the response to the stdout:

```
$ docker compose -f docker-compose.dev.yml run debug-helper wget -O - http://app:5173

Connecting to app:5173 (192.168.240.3:5173)
writing to stdout
<!doctype html>
<html lang="en">
  <head>
    <script type="module">
      ...copy
```

The URL is the interesting part here. We simply said to connect to port 5173 of the service _app_. _app_ is the name of the service specified in the _docker-compose.dev.yml_ file:

```
services:
  app:    image: hello-front-dev
    build:
      context: .
      dockerfile: dev.Dockerfile
    volumes:
      - ./:/usr/src/app
    ports:
      - 5173:5173    container_name: hello-front-devcopy
```

The port used is the port from which the application is available in that container, also specified in the _docker-compose.dev.yml_. The port does not need to be published for other services in the same network to be able to connect to it. The "ports" in the docker-compose file are only for external access.
Let's change the port configuration in the _docker-compose.dev.yml_ to emphasize this:

```
services:
  app:
    image: hello-front-dev
    build:
      context: .
      dockerfile: dev.Dockerfile
    volumes:
      - ./:/usr/src/app
    ports:
      - 3210:5173    container_name: hello-front-dev
  debug-helper:
    image: busyboxcopy
```

With _docker compose up_ the application is available in _host machine_ , but the command

```
docker compose  -f docker-compose.dev.yml run debug-helper wget -O - http://app:5173copy
```

works still since the port is still 5173 within the docker network.
The below image illustrates what happens. The command _docker compose run_ asks debug-helper to send the request within the network. While the browser in the host machine sends the request from outside of the network.
![fullstack content](../assets/d75733a78a79638f.png)
Now that you know how easy it is to find other services in the _docker-compose.yml_ and we have nothing to debug we can remove the debug-helper and revert the ports to 5173:5173 in our compose file.
### Exercise 12.16
#### Exercise 12.16: Run todo-backend in a development container
Use volumes and Nodemon to enable the development of the todo app backend while it is running _inside_ a container. Create a _todo-backend/dev.Dockerfile_ and edit the _todo-backend/docker-compose.dev.yml_.
You will also need to rethink the connections between backend and MongoDB / Redis. Thankfully Docker Compose can include environment variables that will be passed to the application:

```
services:
  server:
    image: ...
    volumes:
      - ...
    ports:
      - ...
    environment: 
      - REDIS_URL=redisurl_here
      - MONGO_URL=mongourl_herecopy
```

The URLs are purposefully wrong, you will need to set the correct values. Remember to _look all the time what happens in the console_. If and when things blow up, the error messages hint at what might be broken.
Here is a possibly helpful image illustrating the connections within the docker network:
![diagram of connection between browser, backend, mongo and redis](../assets/813fd55e4e0d5252.png)
### Communications between containers in a more ambitious environment
Next, we will configure a
> _A reverse proxy is a type of proxy server that retrieves resources on behalf of a client from one or more servers. These resources are then returned to the client, appearing as if they originated from the reverse proxy server itself._
So in our case, the reverse proxy will be the single point of entry to our application, and the final goal will be to set both the React frontend and the Express backend behind the reverse proxy.
There are multiple different options for a reverse proxy implementation, such as Traefik, Caddy, Nginx, and Apache (ordered by initial release from newer to older).
Our pick is
Let us now put the _hello-frontend_ behind the reverse proxy.
Create a file _nginx.dev.conf_ in the project root and take the following template as a starting point. We will need to do minor edits to have our application running:

```
# events is required, but defaults are ok
events { }

# A http server, listening at port 80
http {
  server {
    listen 80;

    # Requests starting with root (/) are handled
    location / {
      # The following 3 lines are required for the hot loading to work (websocket).
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      
      # Requests are directed to http://localhost:5173
      proxy_pass http://localhost:5173;
    }
  }
}copy
```

**Note** we are using the familiar naming convention also for Nginx, _nginx.dev.conf_ for development configurations, and the default name _nginx.conf_ otherwise.
Next, create an Nginx service in the _docker-compose.dev.yml_ file. Add a volume as instructed in the Docker Hub page where the right side is _:/etc/nginx/nginx.conf:ro_ , the final ro declares that the volume will be _read-only_ :

```
services:
  app:
    # ...
  nginx:
    image: nginx:1.20.1
    volumes:
      - ./nginx.dev.conf:/etc/nginx/nginx.conf:ro
    ports:
      - 8080:80
    container_name: reverse-proxy
    depends_on:
      - app # wait for the frontend container to be startedcopy
```

with that added, we can run _docker compose -f docker-compose.dev.yml up_ and see what happens.

```
$ docker container ls
CONTAINER ID   IMAGE            COMMAND  PORTS                   NAMES
a02ae58f3e8d   nginx:1.20.1     ...      0.0.0.0:8080->80/tcp    reverse-proxy
5ee0284566b4   hello-front-dev  ...      0.0.0.0:5173->5173/tcp  hello-front-devcopy
```

Connecting to
This is because directing requests to
Let's test this by going inside the Nginx container and using curl to send a request to the application itself. In our usage curl is similar to wget, but won't need any flags.

```
$ docker exec -it reverse-proxy bash  

root@374f9e62bfa8:\# curl http://localhost:80
  <html>
  <head><title>502 Bad Gateway</title></head>
  ...copy
```

To help us, Docker Compose has set up a network when we ran _docker compose up_. It has also added all of the containers mentioned in the _docker-compose.dev.yml_ to the network. A DNS makes sure we can find the other containers in the network. The containers are each given two names: the service name and the container name and both can be used to communicate with a container.
Since we are inside the container, we can also test the DNS! Let's curl the service name (app) in port 5173

```
root@374f9e62bfa8:\# curl http://app:5173
<!doctype html>
<html lang="en">
  <head>
    <script type="module" src="/@vite/client"></script>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>copy
```

That is it! Let's replace the proxy_pass address in nginx.dev.conf with that one.
One more thing: we added an option _nginx_ container is not started before the frontend container _app_ is started:

```
services:
  app:
    # ...
  nginx:
    image: nginx:1.20.1
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - 8080:80
    container_name: reverse-proxy
    depends_on:      - appcopy
```

If we do not enforce the starting order with _depends_on_ there a risk that Nginx fails on startup since it tries to resolve all DNS names that are referred in the config file:

```
http {
  server {
    listen 80;

    location / {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      
      proxy_pass http://app:5173;    }
  }
}copy
```

Note that _depends_on_ does not guarantee that the service in the depended container is ready for action, it just ensures that the container has been started (and the corresponding entry is added to DNS). If a service needs to wait another service to become ready before the startup,
### Exercises 12.17. - 12.19
#### Exercise 12.17: Set up an Nginx reverse proxy server in front of todo-frontend
We are going to put the Nginx server in front of both todo-frontend and todo-backend. Let's start by creating a new docker-compose file _todo-app/docker-compose.dev.yml_ and _todo-app/nginx.dev.conf_.

```
todo-app
├── todo-frontend
├── todo-backend
├── nginx.dev.conf└── docker-compose.dev.ymlcopy
```

Add the services Nginx and the todo-frontend built with _todo-app/todo-frontend/dev.Dockerfile_ into the _todo-app/docker-compose.dev.yml_.
![connection diagram between browser, nginx, express and frontend](../assets/f4f6852086cbbead.png)
In this and the following exercises you **do not** need to support the build option, that is, the command:

```
docker compose -f docker-compose.dev.yml up --buildcopy
```

It is enough to build the frontend and backend at their own repositories.
#### Exercise 12.18: Configure the Nginx server to be in front of todo-backend
Add the service todo-backend to the docker-compose file _todo-app/docker-compose.dev.yml_ in development mode.
Add a new location to the _nginx.dev.conf_ file, so that requests to _/api_ are proxied to the backend. Something like this should do the trick:

```
  server {
    listen 80;

    # Requests starting with root (/) are handled
    location / {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      
      proxy_pass ...
    }

    # Requests starting with /api/ are handled
    location /api/ {
      proxy_pass ...
    }
  }copy
```

The _proxy_pass_ directive has an interesting feature with a trailing slash. As we are using the path _/api_ for location but the backend application only answers in paths _/_ or _/todos_ we will want the _/api_ to be removed from the request. In other words, even though the browser will send a GET request to _/api/todos/1_ we want the Nginx to proxy the request to _/todos/1_. Do this by adding a trailing slash _/_ to the URL at the end of _proxy_pass_.
This is a
![comments about forgetting to use the trailing slash](../assets/5bc14d3edd911b8d.png)
This illustrates what we are looking for and may be helpful if you are having trouble:
![diagram of calling / and /api in action](../assets/0fc19fe93294a329.png)
#### Exercise 12.19: Connect the services, todo-frontend with todo-backend
> In this exercise, submit the entire development environment, including both Express and React applications, dev.Dockerfiles and docker-compose.dev.yml.
Finally, it is time to put all the pieces together. Before starting, it is essential to understand _where_ the React app is actually run. The above diagram might give the impression that React app is run in the container but it is totally wrong.
It is just the _React app source code_ that is in the container. When the browser hits the address
![diagram showing that the react code is sent to the browser for its execution](../assets/636c453aca339f3e.png)
Next, the browser starts executing the React app, and all the requests it makes to the backend should be done through the Nginx reverse proxy:
![diagram showing requests made from the browser to /api of nginx and the proxy in action proxying the request to /todos](../assets/3ea8741728e62b3e.png)
The frontend container is actually only accessed on the first request that gets the React app source code to the browser.
Now set up your app to work as depicted in the above figure. Make sure that the todo-frontend works with todo-backend. It will require changes to the _VITE_BACKEND_URL_ environmental variable in the frontend.
Make sure that the development environment is now fully functional, that is:

- all features of the todo app work
- you can edit the source files _and_ the changes take effect by reloading the app
- frontend should access the backend through Nginx, so the requests should be done to

![network tab of the browser developer tools showing that the url request includes 8080/api/todos](../assets/cf09003f7fbba95a.png)
Note that your app should work even if no

```
services:
  app:
    image: todo-front-dev
    volumes:
      - ./todo-frontend/:/usr/src/app
    # no ports here!

  server:
      image: todo-back-dev
      volumes:
        - ./todo-backend/:/usr/src/app
      environment: 
        - ...
      # no ports here!

  nginx:
    image: nginx:1.20.1
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - 8080:80 # this is needed
    container_name: reverse-proxy
    depends_on:
      - appcopy
```

We just need to expose the Nginx port to the host machine since the access to the backend and frontend is proxied to the right container port by Nginx. Because Nginx, frontend and backend are defined in the same Docker compose configuration, Docker puts those to the same
### Tools for Production
Containers are fun tools to use in development, but the best use case for them is in the production environment. There are many more powerful tools than Docker Compose to run containers in production.
Heavyweight container orchestration tools like
If you are interested in learning more in-depth about containers come to the
### Exercises 12.20.-12.22
#### Exercise 12.20
Create a production _todo-app/docker-compose.yml_ file with all of the services, Nginx, todo-backend, todo-frontend, MongoDB and Redis. Use Dockerfiles instead of _dev.Dockerfiles_ and make sure to start the applications in production mode.
Please use the following structure for this exercise:

```
todo-app
├── todo-frontend
├── todo-backend
├── nginx.dev.conf
├── docker-compose.dev.yml
├── nginx.conf└── docker-compose.ymlcopy
```

#### Exercise 12.21
Create a similar containerized development environment of one of _your own_ full stack apps that you have created during the course or in your free time. You should structure the app in your submission repository as follows:

```
└── my-app
    ├── frontend
    |    └── dev.Dockerfile
    ├── backend
    |    └── dev.Dockerfile
    ├── nginx.dev.conf
    └── docker-compose.dev.ymlcopy
```

#### Exercise 12.22
Finish this part by creating a containerized _production setup_ of your own full stack app. Structure the app in your submission repository as follows:

```
└── my-app
    ├── frontend
    |    ├── dev.Dockerfile
    |    └── Dockerfile
    ├── backend
    |    └── dev.Dockerfile
    |    └── Dockerfile
    ├── nginx.dev.conf
    ├── nginx.conf
    ├── docker-compose.dev.yml
    └── docker-compose.ymlcopy
```

### Submitting exercises and getting the credits
This was the last exercise in this section. It's time to push your code to GitHub and mark all of your finished exercises to the
Exercises of this part are submitted just like in the previous parts, but unlike parts 0 to 7, the submission goes to an own _all the exercises_ to pass this part!
Once you have completed the exercises and want to get the credits, let us know through the exercise submission system that you have completed the course:
![Submissions](../assets/770a7d941952a2f6.png)
**Note** that you need a registration to the corresponding course part for getting the credits registered, see [here](../part0/01-general-info-parts-and-completion.md) for more information.
You can download the certificate for completing this part by clicking one of the flag icons. The flag icon corresponds to the certificate's language.
[Part 12b **Previous part**](../part12/01-building-and-configuring-environments.md)[Part 13 **Next part**](../part13/01-part13.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 12](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-part12.md)
- [a Introduction to Containers](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-introduction-to-containers.md)
- [b Building and configuring environments](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments.md)
- [React in container](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-react-in-container.md)
- [Using multiple stages](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-using-multiple-stages.md)
- [Exercises 12.13 - 12.14.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-exercises-12-13-12-14.md)
- [Development in containers](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-development-in-containers.md)
- [Exercise 12.15](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-exercise-12-15.md)
- [Communication between containers in a Docker network](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-communication-between-containers-in-a-docker-network.md)
- [Exercise 12.16](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-exercise-12-16.md)
- [Communications between containers in a more ambitious environment](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-communications-between-containers-in-a-more-ambitious-environment.md)
- [Exercises 12.17. - 12.19.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-exercises-12-17-12-19.md)
- [Tools for Production](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-tools-for-production.md)
- [Exercises 12.20.-12.22.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-exercises-12-20-12-22.md)
- [Submitting exercises and getting the credits](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration-submitting-exercises-and-getting-the-credits.md)
- [fullstack content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/d75733a78a79638f.png)
- [diagram of connection between browser, backend, mongo and redis](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/813fd55e4e0d5252.png)
- [connection diagram between browser, nginx, express and frontend](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/f4f6852086cbbead.png)
- [comments about forgetting to use the trailing slash](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/5bc14d3edd911b8d.png)
- [diagram of calling / and /api in action](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/0fc19fe93294a329.png)
- [diagram showing that the react code is sent to the browser for its execution](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/636c453aca339f3e.png)
- [diagram showing requests made from the browser to /api of nginx and the proxy in action proxying the request to /todos](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/3ea8741728e62b3e.png)
- [network tab of the browser developer tools showing that the url request includes 8080/api/todos](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/cf09003f7fbba95a.png)
- [Submissions](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/770a7d941952a2f6.png)
- [here](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part0/01-general-info-parts-and-completion.md)
- [Part 12b **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments.md)
- [Part 13 **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part13/01-part13.md)

--- .archived/data/part12/01-building-and-configuring-environments.md ---
---{
  "title": "Building and configuring environments",
  "source_url": "https://fullstackopen.com/en/part12/building_and_configuring_environments",
  "crawl_timestamp": "2025-10-04T19:15:57Z",
  "checksum": "644090ef8940c83644d436152125bfe4824e98e776d3879e3968e6d1919e8eb1"
}
---[Skip to content](../part12/01-building-and-configuring-environments-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 12](../part12/01-part12.md)
Building and configuring environments
[a Introduction to Containers](../part12/01-introduction-to-containers.md)
b Building and configuring environments

- [Dockerfile](../part12/01-building-and-configuring-environments-dockerfile.md)
- [More meaningful image](../part12/01-building-and-configuring-environments-more-meaningful-image.md)
- [Exercise 12.5.](../part12/01-building-and-configuring-environments-exercise-12-5.md)
- [Using Docker compose](../part12/01-building-and-configuring-environments-using-docker-compose.md)
- [Exercise 12.6.](../part12/01-building-and-configuring-environments-exercise-12-6.md)
- [Utilizing containers in development](../part12/01-building-and-configuring-environments-utilizing-containers-in-development.md)
- [Bind mount and initializing the database](../part12/01-building-and-configuring-environments-bind-mount-and-initializing-the-database.md)
- [Still problems?](../part12/01-building-and-configuring-environments-still-problems.md)
- [Persisting data with volumes](../part12/01-building-and-configuring-environments-persisting-data-with-volumes.md)
- [Exercise 12.7.](../part12/01-building-and-configuring-environments-exercise-12-7.md)
- [Debugging issues in containers](../part12/01-building-and-configuring-environments-debugging-issues-in-containers.md)
- [Exercise 12.8.](../part12/01-building-and-configuring-environments-exercise-12-8.md)
- [Redis](../part12/01-building-and-configuring-environments-redis.md)
- [Exercises 12.9. - 12.11.](../part12/01-building-and-configuring-environments-exercises-12-9-12-11.md)
- [Persisting data with Redis](../part12/01-building-and-configuring-environments-persisting-data-with-redis.md)
- [Exercise 12.12.](../part12/01-building-and-configuring-environments-exercise-12-12.md)


[c Basics of Orchestration](../part12/01-basics-of-orchestration.md)
b
# Building and configuring environments
The part was updated 21th Mar 2024: Create react app was replaced with Vite in the todo-frontend.
If you started the part before the update, you can see
In the previous section, we used two different base images: ubuntu and node, and did some manual work to get a simple "Hello, World!" running. The tools and commands we learned during that process will be helpful. In this section, we will learn how to build images and configure environments for our applications. We will start with a regular Express/Node.js backend and build on top of that with other services, including a MongoDB database.
### Dockerfile
Instead of modifying a container by copying files inside, we can create a new image that contains the "Hello, World!" application. The tool for this is the Dockerfile. Dockerfile is a simple text file that contains all of the instructions for creating an image. Let's create an example Dockerfile from the "Hello, World!" application.
If you did not already, create a directory on your machine and create a file called _Dockerfile_ inside that directory. Let's also put an _index.js_ containing _console.log('Hello, World!')_ next to the Dockerfile. Your directory structure should look like this:

```
├── index.js
└── Dockerfilecopy
```

inside that Dockerfile we will tell the image three things:

- Use the
- Include the index.js file inside the image, so we don't need to manually copy it into the container
- When we run a container from the image, use Node to execute the index.js file.


The wishes above will translate into a basic Dockerfile. The best location to place this file is usually at the root of the project.
The resulting _Dockerfile_ looks like this:

```
FROM node:20

WORKDIR /usr/src/app

COPY ./index.js ./index.js

CMD node index.jscopy
```

FROM instruction will tell Docker that the base for the image should be node:20. COPY instruction will copy the file _index.js_ from the host machine to the file with the same name in the image. CMD instruction tells what happens when _docker run_ is used. CMD is the default command that can then be overwritten with the argument given after the image name. See _docker run --help_ if you forgot.
The WORKDIR instruction was slipped in to ensure we don't interfere with the contents of the image. It will guarantee all of the following commands will have _/usr/src/app_ set as the working directory. If the directory doesn't exist in the base image, it will be automatically created.
If we do not specify a WORKDIR, we risk overwriting important files by accident. If you check the root (_/_) of the node:20 image with _docker run node:20 ls_ , you can notice all of the directories and files that are already included in the image.
Now we can use the command _docker build_ to build an image based on the Dockerfile. Let's spice up the command with one additional flag: _-t_ , this will help us name the image:

```
$ docker build -t fs-hello-world . 
[+] Building 3.9s (8/8) FINISHED
...copy
```

So the result is "Docker please build with tag (you may think of the tag as the name of the resulting image.) _fs-hello-world_ the Dockerfile in this directory". You can point to any Dockerfile, but in our case, a simple dot will mean the Dockerfile is in _this_ directory. That is why the command ends with a period. After the build is finished, you can run it with _docker run fs-hello-world_ :

```
$ docker run fs-hello-world
Hello, Worldcopy
```

As images are just files, they can be moved around, downloaded and deleted. You can list the images you have locally with _docker image ls_ , delete them with _docker image rm_. See what other command you have available with _docker image --help_.
One more thing: before it was mentioned that the default command, defined by the CMD in the Dockerfile, can be overwritten if needed. We could e.g. open a bash session to the container and observe it's content:

```
$ docker run -it fs-hello-world bash
root@2932e32dbc09:/usr/src/app# ls
index.js
root@2932e32dbc09:/usr/src/app#copy
```

### More meaningful image
Moving an Express server to a container should be as simple as moving the "Hello, World!" application inside a container. The only difference is that there are more files. Thankfully _COPY_ instruction can handle all that. Let's delete the index.js and create a new Express server. Lets use

```
$ npx express-generator
  ...
  
  install dependencies:
    $ npm install

  run the app:
    $ DEBUG=playground:* npm startcopy
```

First, let's run the application to get an idea of what we just created. Note that the command to run the application may be different from you, my directory was called playground.

```
$ npm install
$ DEBUG=playground:* npm start
  playground:server Listening on port 3000 +0mscopy
```

Great, so now we can navigate to
Containerizing that should be relatively easy based on the previous example.

- Use node as base
- Set working directory so we don't interfere with the contents of the base image
- Copy ALL of the files in this directory to the image
- Start with DEBUG=playground:* npm start


Let's place the following Dockerfile at the root of the project:

```
FROM node:20

WORKDIR /usr/src/app

COPY . .

CMD DEBUG=playground:* npm startcopy
```

Let's build the image from the Dockerfile and then run it:

```
docker build -t express-server .
docker run -p 3123:3000 express-servercopy
```

The _-p_ flag in the run command will inform Docker that a port from the host machine should be opened and directed to a port in the container. The format is _-p host-port:application-port_.
The application is now running! Let's test it by sending a GET request to
> If yours doesn't work, skip to the next section. There is an explanation why it may not work even if you followed the steps correctly.
Shutting the app down is a headache at the moment. Use another terminal and _docker kill_ command to kill the application. The _docker kill_ will send a kill signal (SIGKILL) to the application to force it to shut down. It needs the name or the id of the container as an argument.
By the way, when using the id as the argument, the beginning of the ID is enough for Docker to know which container we mean.

```
$ docker container ls
  CONTAINER ID   IMAGE            COMMAND                  CREATED         STATUS         PORTS                                       NAMES
  48096ca3ffec   express-server   "docker-entrypoint.s…"   9 seconds ago   Up 6 seconds   0.0.0.0:3123->3000/tcp, :::3123->3000/tcp   infallible_booth

$ docker kill 48
  48copy
```

In the future, let's use the same port on both sides of _-p_. Just so we don't have to remember which one we happened to choose.
#### Fixing potential issues we created by copy-pasting
There are a few steps we need to change to create a more comprehensive Dockerfile. It may even be that the above example doesn't work in all cases because we skipped an important step.
When we ran npm install on our machine, in some cases the **Node package manager** may install operating system specific dependencies during the install step. We may accidentally move non-functional parts to the image with the COPY instruction. This can easily happen if we copy the _node_modules_ directory into the image.
This is a critical thing to keep in mind when we build our images. It's best to do most things, such as to run _npm install_ during the build process _inside the container_ rather than doing those prior to building. The easy rule of thumb is to only copy files that you would push to GitHub. Build artifacts or dependencies should not be copied since those can be installed during the build process.
We can use _.dockerignore_ to solve the problem. The file .dockerignore is very similar to .gitignore, you can use that to prevent unwanted files from being copied to your image. The file should be placed next to the Dockerfile. Here is a possible content of a _.dockerignore_

```
.dockerignore
.gitignore
node_modules
Dockerfilecopy
```

However, in our case, the .dockerignore isn't the only thing required. We will need to install the dependencies during the build step. The _Dockerfile_ changes to:

```
FROM node:20

WORKDIR /usr/src/app

COPY . .

RUN npm install
CMD DEBUG=playground:* npm startcopy
```

The npm install can be risky. Instead of using npm install, npm offers a much better tool for installing dependencies, the _ci_ command.
Differences between ci and install:

- install may update the package-lock.json
- install may install a different version of a dependency if you have ^ or ~ in the version of the dependency.
- ci will delete the node_modules folder before installing anything
- ci will follow the package-lock.json and does not alter any files


So in short: _ci_ creates reliable builds, while _install_ is the one to use when you want to install new dependencies.
As we are not installing anything new during the build step, and we don't want the versions to suddenly change, we will use _ci_ :

```
FROM node:20

WORKDIR /usr/src/app

COPY . .

RUN npm ci
CMD DEBUG=playground:* npm startcopy
```

Even better, we can use _npm ci --omit=dev_ to not waste time installing development dependencies.
> As you noticed in the comparison list; npm ci will delete the node_modules folder so creating the .dockerignore did not matter. However, .dockerignore is an amazing tool when you want to optimize your build process. We will talk briefly about these optimizations later.
Now the Dockerfile should work again, try it with _docker build -t express-server . && docker run -p 3123:3000 express-server_
> Note that we are here chaining two bash commands with &&. We could get (nearly) the same effect by running both commands separately. When chaining commands with && if one command fails, the next ones in the chain will not be executed.
We set an environment variable _DEBUG=playground:*_ during CMD for the npm start. However, with Dockerfiles we could also use the instruction ENV to set environment variables. Let's do that:

```
FROM node:20

WORKDIR /usr/src/app

COPY . .

RUN npm ci 

ENV DEBUG=playground:*
CMD npm startcopy
```

> _If you're wondering what the DEBUG environment variable does, read_
#### Dockerfile best practices
There are 2 rules of thumb you should follow when creating images:

- Try to create as **secure** of an image as possible
- Try to create as **small** of an image as possible


Smaller images are more secure by having less attack surface area, and also move faster in deployment pipelines.
Snyk has a great list of the 10 best practices for Node/Express containerization. Read those
One big carelessness we have left is running the application as root instead of using a user with lower privileges. Let's do a final fix to the Dockerfile:

```
FROM node:20
  
WORKDIR /usr/src/app

COPY --chown=node:node . .
RUN npm ci 

ENV DEBUG=playground:*
  
USER node
CMD npm startcopy
```

### Exercise 12.5
#### Exercise 12.5: Containerizing a Node application
The repository that you cloned or copied in the [first exercise](../part12/01-introduction-to-containers-exercise-12-1.md) contains a todo-app. See the todo-app/todo-backend and read through the README. We will not touch the todo-frontend yet.

- Step 1. Containerize the todo-backend by creating a _todo-app/todo-backend/Dockerfile_ and building an image.
- Step 2. Run the todo-backend image with the correct ports open. Make sure the visit counter increases when used through a browser in


Tip: Run the application outside of a container to examine it before starting to containerize.
### Using Docker compose
In the previous section, we created an Express server, knowing that it will run in port 3123, and used the commands _docker build -t express-server . && docker run -p 3123:3000 express-server_ to run it. This already looks like something you would need to put into a script to remember. Fortunately, Docker offers us a better solution.
Now we can turn the previous spell into a yaml file. The best part about yaml files is that you can save these to a Git repository!
Create the file **docker-compose.yml** and place it at the root of the project, next to the Dockerfile. This time we will use the same port for host and container. The file content is:

```
services:
  app:                    # The name of the service, can be anything
    image: express-server # Declares which image to use
    build: .              # Declares where to build if image is not found
    ports:                # Declares the ports to publish
      - 3000:3000copy
```

The meaning of each line is explained as a comment. If you want to see the full specification see the
Now we can use _docker compose up_ to build and run the application. If we want to rebuild the images we can use _docker compose up --build_.
You can also run the application in the background with _docker compose up -d_ (_-d_ for detached) and close it with _docker compose down_.
> _Note that some older Docker versions (especially in Windows) do not support the command _docker compose_. One way to circumvent this problem is to _docker-compose_ that works mostly similarly to _docker compose_. However, the preferable fix is to update the Docker to a more recent version._
Creating files like _docker-compose.yml_ that _declare_ what you want instead of script files that you need to run in a specific order / a specific number of times is often a great practice.
### Exercise 12.6
#### Exercise 12.6: Docker compose
Create a _todo-app/todo-backend/docker-compose.yml_ file that works with the Node application from the previous exercise.
The visit counter is the only feature that is required to be working.
### Utilizing containers in development
When you are developing software, containerization can be used in various ways to improve your quality of life. One of the most useful cases is by bypassing the need to install and configure tools twice.
It may not be the best option to move your entire development environment into a container, but if that's what you want it's certainly possible. We will revisit this idea at the end of this part. But until then, _run the Node application itself outside of containers_.
The application we met in the previous exercises uses MongoDB. Let's explore
Create a new yaml called _todo-app/todo-backend/docker-compose.dev.yml_ that looks like following:

```
services:
  mongo:
    image: mongo
    ports:
      - 3456:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
      MONGO_INITDB_DATABASE: the_databasecopy
```

The meaning of the two first environment variables defined above is explained on the Docker Hub page:
> _These variables, used in conjunction, create a new user and set that user's password. This user is created in the admin authentication database and given the role of root, which is a "superuser" role._
The last environment variable _MONGO_INITDB_DATABASE_ will tell MongoDB to create a database with that name.
You can use _-f_ flag to specify a _file_ to run the Docker Compose command with e.g.

```
docker compose -f docker-compose.dev.yml upcopy
```

Now that we may have multiple compose files, it's useful.
Next, start the MongoDB with _docker compose -f docker-compose.dev.yml up -d_. With _-d_ it will run it in the background. You can view the output logs with _docker compose -f docker-compose.dev.yml logs -f_. There the _-f_ will ensure we _follow_ the logs.
As said previously, currently we **do not** want to run the Node application inside a container. Developing while the application itself is inside a container is a challenge. We will explore that option later in this part.
Run the good old _npm install_ first on your machine to set up the Node application. Then start the application with the relevant environment variable. You can modify the code to set them as the defaults or use the .env file. There is no hurt in putting these keys to GitHub since they are only used in your local development environment. I'll just throw them in with the _npm run dev_ to help you copy-paste.

```
MONGO_URL=mongodb://localhost:3456/the_database npm run devcopy
```

This won't be enough; we need to create a user to be authorized inside of the container. The url

```
[nodemon] 2.0.12
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,json
[nodemon] starting `node ./bin/www`
/Users/mluukkai/dev/fs-ci-lokakuu/repo/todo-app/todo-backend/node_modules/mongodb/lib/cmap/connection.js:272
          callback(new MongoError(document));
                   ^
MongoError: command find requires authentication
    at MessageStream.messageHandler (/Users/mluukkai/dev/fs-ci-lokakuu/repo/todo-app/todo-backend/node_modules/mongodb/lib/cmap/connection.js:272:20)copy
```

### Bind mount and initializing the database
In the
The exercise project has a file _todo-app/todo-backend/mongo/mongo-init.js_ with contents:

```
db.createUser({
  user: 'the_username',
  pwd: 'the_password',
  roles: [
    {
      role: 'dbOwner',
      db: 'the_database',
    },
  ],
});

db.createCollection('todos');

db.todos.insert({ text: 'Write code', done: true });
db.todos.insert({ text: 'Learn about containers', done: false });copy
```

This file will initialize the database with a user and a few todos. Next, we need to get it inside the container at startup.
We could create a new image FROM mongo and COPY the file inside, or we can use a _mongo-init.js_ to the container. Let's do the latter.
Bind mount is the act of binding a file (or directory) on the host machine to a file (or directory) in the container. A bind mount is done by adding a _-v_ flag with _container run_. The syntax is _-v FILE-IN-HOST:FILE-IN-CONTAINER_. Since we already learned about Docker Compose let's skip that. The bind mount is declared under key _volumes_ in _docker-compose.dev.yml_. Otherwise the format is the same, first host and then container:

```
  mongo:
    image: mongo
    ports:
     - 3456:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
      MONGO_INITDB_DATABASE: the_database
    volumes:       - ./mongo/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.jscopy
```

The result of the bind mount is that the file _mongo-init.js_ in the mongo folder of the host machine is the same as the _mongo-init.js_ file in the container's /docker-entrypoint-initdb.d directory. Changes to either file will be available in the other. We don't need to make any changes during runtime. But this will be the key to software development in containers.
Run _docker compose -f docker-compose.dev.yml down --volumes_ to ensure that nothing is left and start from a clean slate with _docker compose -f docker-compose.dev.yml up_ to initialize the database.
If you see an error like this:

```
mongo_database | failed to load: /docker-entrypoint-initdb.d/mongo-init.js
mongo_database | exiting with code -3copy
```

you may have a read permission problem. They are not uncommon when dealing with volumes. In the above case, you can use _chmod a+r mongo-init.js_ , which will give everyone read access to that file. Be careful when using _chmod_ since granting more privileges can be a security issue. Use the _chmod_ only on the mongo-init.js on your computer.
Now starting the Express application with the correct environment variable should work:

```
MONGO_URL=mongodb://the_username:the_password@localhost:3456/the_database npm run devcopy
```

Let's check that the _should_ use Postman to test the basic functionality of the app, such as adding or deleting a todo.
### Still problems
For some reason, the initialization of Mongo has caused problems for many.
If the app does not work and you still end up with the following error:

```
/Users/mluukkai/dev/fs-ci-lokakuu/repo/todo-app/todo-backend/node_modules/mongodb/lib/cmap/connection.js:272
          callback(new MongoError(document));
                   ^
MongoError: command find requires authentication
    at MessageStream.messageHandler (/Users/mluukkai/dev/fs-ci-lokakuu/repo/todo-app/todo-backend/node_modules/mongodb/lib/cmap/connection.js:272:20)copy
```

run these commands:

```
docker compose -f docker-compose.dev.yml down --volumes
docker image rm mongocopy
```

After these, try to start Mongo again.
If the problem persists, let us drop the idea of a volume altogether and copy the initialization script to a custom image. Create the following _Dockerfile_ to the directory _todo-app/todo-backend/mongo_ :

```
FROM mongo

COPY ./mongo-init.js /docker-entrypoint-initdb.d/copy
```

Build it to an image with the command:

```
docker build -t initialized-mongo .copy
```

Now change the _docker-compose.dev.yml_ file to use the new image:

```
  mongo:
    image: initialized-mongo    ports:
     - 3456:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
      MONGO_INITDB_DATABASE: the_databasecopy
```

Now the app should finally work.
### Persisting data with volumes
By default, database containers are not going to preserve our data. When you close the database container you _may or may not_ be able to get the data back.
> Mongo is actually a rare case in which the container indeed does preserve the data. This happens, since the developers who made the Docker image for Mongo have defined a volume to be used.
There are two distinct methods to store the data:

- Declaring a location in your filesystem (called
- Letting Docker decide where to store the data (


The first choice is preferable in most cases whenever one _really_ needs to avoid the data being deleted.
Let's see both in action with Docker compose. Let us start with _bind mount:_

```
services:
  mongo:
    image: mongo
    ports:
     - 3456:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
      MONGO_INITDB_DATABASE: the_database
    volumes:
      - ./mongo/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js
      - ./mongo_data:/data/dbcopy
```

The above will create a directory called _mongo_data_ to your local filesystem and map it into the container as _/data/db_. This means the data in _/data/db_ is stored outside of the container but still accessible by the container! Just remember to add the directory to .gitignore.
A similar outcome can be achieved with a _named volume:_

```
services:
  mongo:
    image: mongo
    ports:
     - 3456:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
      MONGO_INITDB_DATABASE: the_database
    volumes:
      - ./mongo/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js
      - mongo_data:/data/db
volumes:  mongo_data:copy
```

Now the volume is created and managed by Docker. After starting the application (_docker compose -f docker-compose.dev.yml up_) you can list the volumes with _docker volume ls_ , inspect one of them with _docker volume inspect_ and even delete them with _docker volume rm_ :

```
$ docker volume ls
DRIVER    VOLUME NAME
local     todo-backend_mongo_data
$ docker volume inspect todo-backend_mongo_data
[
    {
        "CreatedAt": "2024-19-03T12:52:11Z",
        "Driver": "local",
        "Labels": {
            "com.docker.compose.project": "todo-backend",
            "com.docker.compose.version": "1.29.2",
            "com.docker.compose.volume": "mongo_data"
        },
        "Mountpoint": "/var/lib/docker/volumes/todo-backend_mongo_data/_data",
        "Name": "todo-backend_mongo_data",
        "Options": null,
        "Scope": "local"
    }
]copy
```

The named volume is still stored in your local filesystem but figuring out _where_ may not be as trivial as with the previous option.
### Exercise 12.7
#### Exercise 12.7: Little bit of MongoDB coding
Note that this exercise assumes that you have done all the configurations made in the material after exercise 12.5. You should still run the todo-app backend _outside a container_ ; just the MongoDB is containerized for now.
The todo application has no proper implementation of routes for getting one todo (GET _/todos/:id_) and updating one todo (PUT _/todos/:id_). Fix the code.
### Debugging issues in containers
> _When coding, you most likely end up in a situation where everything is broken._
>
> - Matti Luukkainen
When developing with containers, we need to learn new tools for debugging, since we can not just "console.log" everything. When code has a bug, you may often be in a state where at least something works, so you can work forward from that. Configuration most often is in either of two states: 1. working or 2. broken. We will go over a few tools that can help when your application is in the latter state.
When developing software, you can safely progress step by step, all the time verifying that what you have coded behaves as expected. Often, this is not the case when doing configurations. The configuration you may be writing can be broken until the moment it is finished. So when you write a long docker-compose.yml or Dockerfile and it does not work, you need to take a moment and think about the various ways you could confirm something is working.
_Question Everything_ is still applicable here. As said in [part 3](../part3/01-saving-data-to-mongo-db.md): The key is to be systematic. Since the problem can exist anywhere, _you must question everything_ , and eliminate all possible sources of error one by one.
For myself, the most valuable method of debugging is stopping and thinking about what I'm trying to accomplish instead of just bashing my head at the problem. Often there is a simple, alternate, solution or quick google search that will get me moving forward.

#### exec
The Docker command
Let's start a web server in the background and do a little bit of debugging to get it running and displaying the message "Hello, exec!" in our browser. Let's choose

```
docker container run -d nginxcopy
```

Ok, now the questions are:

- Where should we go with our browser?
- Is it even running?


We know how to answer the latter: by listing the running containers.

```
$ docker container ls
CONTAINER ID   IMAGE   COMMAND  CREATED     STATUS    PORTS     NAMES
3f831a57b7cc   nginx   ...      3 sec ago   Up 2 sec  80/tcp    keen_darwincopy
```

Yes! We got the first question answered as well. It seems to listen on port 80, as seen on the output above.
Let's shut it down and restart with the _-p_ flag to have our browser access it.

```
docker container stop keen_darwin
docker container rm keen_darwin

docker container run -d -p 8080:80 nginxcopy
```

> _**Editor's note_** when doing development, it is **essential** to constantly follow the container logs. I'm usually not running containers in a detached mode (that is with -d) since it requires a bit of an extra effort to open the logs. _
> _When I'm 100% sure that everything works... no, when I'm 200% sure, then I might relax a bit and start the containers in detached mode. Until everything again falls apart and it is time to open the logs again._
Let's look at the app by going to _-it_ will ensure that we can interact with the container:

```
$ docker container ls
CONTAINER ID   IMAGE     COMMAND  PORTS                  NAMES
7edcb36aff08   nginx     ...      0.0.0.0:8080->80/tcp   wonderful_ramanujan

$ docker exec -it wonderful_ramanujan bash
root@7edcb36aff08:/#copy
```

Now that we are in, we need to find the faulty file and replace it. Quick Google tells us that file itself is _/usr/share/nginx/html/index.html_.
Let's move to the directory and delete the file

```
root@7edcb36aff08:/# cd /usr/share/nginx/html/
root@7edcb36aff08:/# rm index.htmlcopy
```

Now, if we go to

```
root@7edcb36aff08:/# echo "Hello, exec!" > index.htmlcopy
```

Refresh the page, and our message is displayed! Now we know how exec can be used to interact with the containers. Remember that all of the changes are lost when the container is deleted. To preserve the changes, you must use _commit_ just as we did in [previous section](../part12/01-introduction-to-containers-other-docker-commands.md).
### Exercise 12.8
#### Exercise 12.8: Mongo command-line interface
> Use _script_ to record what you do, save the file as script-answers/exercise12_8.txt
While the MongoDB from the previous exercise is running, access the database with the Mongo command-line interface (CLI). You can do that using docker exec. Then add a new todo using the CLI.
The command to open CLI when inside the container is _mongosh_
The Mongo CLI will require the username and password flags to authenticate correctly. Flags _-u root -p example_ should work, the values are from the _docker-compose.dev.yml_.

- Step 1: Run MongoDB
- Step 2: Use _docker exec_ to get inside the container
- Step 3: Open Mongo CLI


When you have connected to the Mongo CLI you can ask it to show the DBs inside:

```
> show dbs
admin         0.000GB
config         0.000GB
local         0.000GB
the_database  0.000GBcopy
```

To access the correct database:

```
> use the_databasecopy
```

And finally to find out the collections:

```
> show collections
todoscopy
```

We can now access the data in those collections:

```
> db.todos.find({})
[
  {
    _id: ObjectId("633c270ba211aa5f7931f078"),
    text: 'Write code',
    done: false
  },
  {
    _id: ObjectId("633c270ba211aa5f7931f079"),
    text: 'Learn about containers',
    done: false
  }
]copy
```

Insert one new todo with the text: "Increase the number of tools in my tool belt" with the status done as _false_. Consult the
Ensure that you see the new todo both in the Express app and when querying from Mongo CLI.
### Redis
_key_ that was attached to the data (the _value_).
By default, Redis works _in-memory_ , which means that it does not store data persistently.
An excellent use case for Redis is to use it as a cache. Caches are often used to store data that is otherwise slow to fetch and save until it's no longer valid. After the cache becomes invalid, you would then fetch the data again and store it in the cache.
Redis has nothing to do with containers. But since we are already able to add _any_ 3rd party service to your applications, why not learn about a new one?
### Exercises 12.9. - 12.11
#### Exercise 12.9: Set up Redis for the project
The Express server has already been configured to use Redis, and it is only missing the _REDIS_URL_ environment variable. The application will use that environment variable to connect to the Redis. Read through the _todo-app/todo-backend/docker-compose.dev.yml_ by defining another service after mongo:

```
services:
  mongo:
    ...
  redis:
    ???copy
```

Since the Docker Hub page doesn't have all the info, we can use Google to aid us. The default port for Redis is found by doing so:
![google search result for "default port for redis" is 6379](../assets/2a9ddc7879ac306c.png)
We won't have any idea if the configuration works unless we try it. The application will not start using Redis by itself, that shall happen in the next exercise.
Once Redis is configured and started, restart the backend and give it the _REDIS_URL_ , which has the form _redis://host:port_

```
REDIS_URL=insert-redis-url-here MONGO_URL=mongodb://the_username:the_password@localhost:3456/the_database npm run devcopy
```

You can now test the configuration by adding the line

```
const redis = require('../redis')copy
```

to the Express server e.g. in the file _routes/index.js_. If nothing happens, the configuration is done right. If not, the server crashes:

```
events.js:291
      throw er; // Unhandled 'error' event
      ^

Error: Redis connection to localhost:637 failed - connect ECONNREFUSED 127.0.0.1:6379
    at TCPConnectWrap.afterConnect [as oncomplete] (net.js:1144:16)
Emitted 'error' event on RedisClient instance at:
    at RedisClient.on_error (/Users/mluukkai/opetus/docker-fs/container-app/express-app/node_modules/redis/index.js:342:14)
    at Socket.<anonymous> (/Users/mluukkai/opetus/docker-fs/container-app/express-app/node_modules/redis/index.js:223:14)
    at Socket.emit (events.js:314:20)
    at emitErrorNT (internal/streams/destroy.js:100:8)
    at emitErrorCloseNT (internal/streams/destroy.js:68:3)
    at processTicksAndRejections (internal/process/task_queues.js:80:21) {
  errno: -61,
  code: 'ECONNREFUSED',
  syscall: 'connect',
  address: '127.0.0.1',
  port: 6379
}
[nodemon] app crashed - waiting for file changes before starting...copy
```

#### Exercise 12.10
The project already has

- setAsync function takes in key and value, using the key to store the value.
- getAsync function takes in a key and returns the value in a promise.


Implement a todo counter that saves the number of created todos to Redis:

- Step 1: Whenever a request is sent to add a todo, increment the counter by one.
- Step 2: Create a GET /statistics endpoint where you can ask for the usage metadata. The format should be the following JSON:


```
{
  "added_todos": 0
}copy
```

#### Exercise 12.11
> Use _script_ to record what you do, save the file as script-answers/exercise12_11.txt
If the application does not behave as expected, direct access to the database may be beneficial in pinpointing problems. Let us try out how

- Go to the Redis container with _docker exec_ and open the redis-cli.
- Find the key you used with
- Check the value of the key with the command
- Set the value of the counter to 9001, find the right command from
- Make sure that the new value works by refreshing the page
- Create a new todo with Postman and ensure from redis-cli that the counter has increased accordingly
- Delete the key from the cli and ensure that the counter works when new todos are added


### Persisting data with Redis
In the previous section, it was mentioned that _by default_ Redis does not persist the data. However, the persistence is easy to toggle on. We only need to start the Redis with a different command, as instructed by the

```
services:
  redis:
    # Everything else
    command: ['redis-server', '--appendonly', 'yes'] # Overwrite the CMD
    volumes: # Declare the volume
      - ./redis_data:/datacopy
```

The data will now be persisted to the directory _redis_data_ of the host machine. Remember to add the directory to .gitignore!
#### Other functionality of Redis
In addition to the GET, SET and DEL operations on keys and values, Redis can do also quite a lot more. It can for example automatically expire keys, which is a very useful feature when Redis is used as a cache.
Redis can also be used to implement the so-called _message broker_ between two or more services. Some of the services are _publishing_ messages by sending those to Redis, which on arrival of a message, informs the parties that have _subscribed_ to those messages.
### Exercise 12.12
#### Exercise 12.12: Persisting data in Redis
Check that the data is not persisted by default, after running:

```
docker compose -f docker-compose.dev.yml down
docker compose -f docker-compose.dev.yml upcopy
```

the counter value is reset to 0.
Then create a volume for Redis data (by modifying _todo-app/todo-backend/docker-compose.dev.yml_) and make sure that the data survives after running:

```
docker compose -f docker-compose.dev.yml down
docker compose -f docker-compose.dev.yml upcopy
```

[Part 12a **Previous part**](../part12/01-introduction-to-containers.md)[Part 12c **Next part**](../part12/01-basics-of-orchestration.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 12](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-part12.md)
- [a Introduction to Containers](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-introduction-to-containers.md)
- [Dockerfile](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-dockerfile.md)
- [More meaningful image](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-more-meaningful-image.md)
- [Exercise 12.5.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-exercise-12-5.md)
- [Using Docker compose](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-using-docker-compose.md)
- [Exercise 12.6.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-exercise-12-6.md)
- [Utilizing containers in development](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-utilizing-containers-in-development.md)
- [Bind mount and initializing the database](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-bind-mount-and-initializing-the-database.md)
- [Still problems?](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-still-problems.md)
- [Persisting data with volumes](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-persisting-data-with-volumes.md)
- [Exercise 12.7.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-exercise-12-7.md)
- [Debugging issues in containers](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-debugging-issues-in-containers.md)
- [Exercise 12.8.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-exercise-12-8.md)
- [Redis](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-redis.md)
- [Exercises 12.9. - 12.11.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-exercises-12-9-12-11.md)
- [Persisting data with Redis](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-persisting-data-with-redis.md)
- [Exercise 12.12.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-building-and-configuring-environments-exercise-12-12.md)
- [c Basics of Orchestration](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration.md)
- [first exercise](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-introduction-to-containers-exercise-12-1.md)
- [part 3](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part3/01-saving-data-to-mongo-db.md)
- [previous section](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-introduction-to-containers-other-docker-commands.md)
- [google search result for "default port for redis" is 6379](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/2a9ddc7879ac306c.png)
- [Part 12a **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-introduction-to-containers.md)
- [Part 12c **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part12/01-basics-of-orchestration.md)

--- .archived/data/part10/01-communicating-with-server.md ---
---{
  "title": "Communicating with server",
  "source_url": "https://fullstackopen.com/en/part10/communicating_with_server",
  "crawl_timestamp": "2025-10-04T19:15:42Z",
  "checksum": "68ce575258c9e8f42c9009d7f14ba20daf7a8752d3186b075c64a22f083c60e1"
}
---[Skip to content](../part10/01-communicating-with-server-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 10](../part10/01-part10.md)
Communicating with server
[a Introduction to React Native](../part10/01-introduction-to-react-native.md)[b React Native basics](../part10/01-react-native-basics.md)
c Communicating with server

- [HTTP requests](../part10/01-communicating-with-server-http-requests.md)
- [GraphQL and Apollo client](../part10/01-communicating-with-server-graph-ql-and-apollo-client.md)
- [Organizing GraphQL related code](../part10/01-communicating-with-server-organizing-graph-ql-related-code.md)
- [Evolving the structure](../part10/01-communicating-with-server-evolving-the-structure.md)
- [Exercise 10.11](../part10/01-communicating-with-server-exercise-10-11.md)
- [Environment variables](../part10/01-communicating-with-server-environment-variables.md)
- [Exercise 10.12](../part10/01-communicating-with-server-exercise-10-12.md)
- [Storing data in the user's device](../part10/01-communicating-with-server-storing-data-in-the-users-device.md)
- [Exercises 10.13. - 10.14](../part10/01-communicating-with-server-exercises-10-13-10-14.md)
- [Enhancing Apollo Client's requests](../part10/01-communicating-with-server-enhancing-apollo-clients-requests.md)
- [Using React Context for dependency injection](../part10/01-communicating-with-server-using-react-context-for-dependency-injection.md)
- [Exercises 10.15. - 10.16](../part10/01-communicating-with-server-exercises-10-15-10-16.md)


[d Testing and extending our application](../part10/01-testing-and-extending-our-application.md)
c
# Communicating with server
So far we have implemented features to our application without any actual server communication. For example, the reviewed repositories list we have implemented uses mock data and the sign in form doesn't send the user's credentials to any authentication endpoint. In this section, we will learn how to communicate with a server using HTTP requests, how to use Apollo Client in a React Native application, and how to store data in the user's device.
Soon we will learn how to communicate with a server in our application. Before we get to that, we need a server to communicate with. For this purpose, we have a completed server implementation in the
Before heading further into the material, set up the rate-repository-api server by following the setup instructions in the repository's _on the same computer_. This eases network requests considerably.
### HTTP requests
React Native provides
People who have used both Fetch API and XMLHttpRequest API most likely agree that the Fetch API is easier to use and more modern. However, this doesn't mean that XMLHttpRequest API doesn't have its uses. For the sake of simplicity, we will be only using the Fetch API in our examples.
Sending HTTP requests using the Fetch API can be done using the _fetch_ function. The first argument of the function is the URL of the resource:

```
fetch('https://my-api.com/get-end-point');copy
```

The default request method is _GET_. The second argument of the _fetch_ function is an options object, which you can use to for example to specify a different request method, request headers, or request body:

```
fetch('https://my-api.com/post-end-point', {
  method: 'POST',
  headers: {
    Accept: 'application/json',
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    firstParam: 'firstValue',
    secondParam: 'secondValue',
  }),
});copy
```

Note that these URLs are made up and won't (most likely) send a response to your requests. In comparison to Axios, the Fetch API operates on a bit lower level. For example, there isn't any request or response body serialization and parsing. This means that you have to for example set the _Content-Type_ header by yourself and use _JSON.stringify_ method to serialize the request body.
The _fetch_ function returns a promise which resolves a _are not rejected_ like for example in Axios. In case of a JSON formatted response we can parse the response body using the _Response.json_ method:

```
const fetchMovies = async () => {
  const response = await fetch('https://reactnative.dev/movies.json');
  const json = await response.json();

  return json;
};copy
```

For a more detailed introduction to the Fetch API, read the
Next, let's try the Fetch API in practice. The rate-repository-api server provides an endpoint for returning a paginated list of reviewed repositories. Once the server is running, you should be able to access the endpoint at _node_ key in the _edges_ array.
Unfortunately, if we´re using external device, we can't access the server directly in our application by using the _npm start_. In the console you should be able to see an URL starting with _exp://_ below the QR code, after the "Metro waiting on" text:
![metro console output with highlight over exp://<ip> url](../assets/01ec3c013259ce0e.png)
Copy the IP address between the _exp://_ and _:_ , which is in this example _192.168.1.33_. Construct an URL in format _<http://><IP_ADDRESS>:5000/api/repositories_ and open it in the browser. You should see the same response as you did with the _localhost_ URL.
Now that we know the end point's URL let's use the actual server-provided data in our reviewed repositories list. We are currently using mock data stored in the _repositories_ variable. Remove the _repositories_ variable and replace the usage of the mock data with this piece of code in the _RepositoryList.jsx_ file in the _components_ directory:

```
import { useState, useEffect } from 'react';
// ...

const RepositoryList = () => {
  const [repositories, setRepositories] = useState();

  const fetchRepositories = async () => {
    // Replace the IP address part with your own IP address!
    const response = await fetch('http://192.168.1.33:5000/api/repositories');
    const json = await response.json();

    console.log(json);

    setRepositories(json);
  };

  useEffect(() => {
    fetchRepositories();
  }, []);

  // Get the nodes from the edges array
  const repositoryNodes = repositories
    ? repositories.edges.map(edge => edge.node)
    : [];

  return (
    <FlatList
      data={repositoryNodes}
      // Other props
    />
  );
};

export default RepositoryList;copy
```

We are using the React's _useState_ hook to maintain the repository list state and the _useEffect_ hook to call the _fetchRepositories_ function when the _RepositoryList_ component is mounted. We extract the actual repositories into the _repositoryNodes_ variable and replace the previously used _repositories_ variable in the _FlatList_ component's _data_ prop with it. Now you should be able to see actual server-provided data in the reviewed repositories list.
It is usually a good idea to log the server's response to be able to inspect it as we did in the _fetchRepositories_ function. You should be able to see this log message in the Expo development tools if you navigate to your device's logs as we learned in the [Debugging](../part10/01-introduction-to-react-native-debugging.md) section. If you are using the Expo's mobile app for development and the network request is failing, make sure that the computer you are using to run the server and your phone are _connected to the same Wi-Fi network_. If that's not possible either use an emulator in the same computer as the server is running in or set up a tunnel to the localhost, for example, using
The current data fetching code in the RepositoryList component could do with some refactoring. For instance, the component is aware of the network request's details such as the end point's URL. In addition, the data fetching code has lots of reuse potential. Let's refactor the component's code by extract the data fetching code into its own hook. Create a directory _hooks_ in the _src_ directory and in that _hooks_ directory create a file _useRepositories.js_ with the following content:

```
import { useState, useEffect } from 'react';

const useRepositories = () => {
  const [repositories, setRepositories] = useState();
  const [loading, setLoading] = useState(false);

  const fetchRepositories = async () => {
    setLoading(true);

    // Replace the IP address part with your own IP address!
    const response = await fetch('http://192.168.1.33:5000/api/repositories');
    const json = await response.json();

    setLoading(false);
    setRepositories(json);
  };

  useEffect(() => {
    fetchRepositories();
  }, []);

  return { repositories, loading, refetch: fetchRepositories };
};

export default useRepositories;copy
```

Now that we have a clean abstraction for fetching the reviewed repositories, let's use the _useRepositories_ hook in the _RepositoryList_ component:

```
// ...
import useRepositories from '../hooks/useRepositories';
const RepositoryList = () => {
  const { repositories } = useRepositories();
  const repositoryNodes = repositories
    ? repositories.edges.map(edge => edge.node)
    : [];

  return (
    <FlatList
      data={repositoryNodes}
      // Other props
    />
  );
};

export default RepositoryList;copy
```

That's it, now the _RepositoryList_ component is no longer aware of the way the repositories are acquired. Maybe in the future, we will acquire them through a GraphQL API instead of a REST API. We will see what happens.
### GraphQL and Apollo client
In [part 8](../part8/01-part8.md) we learned about GraphQL and how to send GraphQL queries to an Apollo Server using the
As mentioned earlier, the rate-repository-api server provides a GraphQL API which is implemented with Apollo Server. Once the server is running, you can access the _always_ test it with the Apollo Sandbox first before implementing it in the code. It is much easier to debug possible problems in the query in the Apollo Sandbox than in the application. If you are uncertain what the available queries are or how to use them, you can see the documentation next to the operations editor:
![Apollo Sandbox](../assets/e34c16527441267a.png)
In our React Native application, we will be using the same

```
npm install @apollo/client graphqlcopy
```

Before we can start using Apollo Client, we will need to slightly configure the Metro bundler so that it handles the _.cjs_ file extensions used by the Apollo Client. First, let's install the _@expo/metro-config_ package which has the default Metro configuration:

```
npm install @expo/metro-config@0.17.4copy
```

Then, we can add the following configuration to a _metro.config.js_ in the root directory of our project:

```
const { getDefaultConfig } = require('@expo/metro-config');

const defaultConfig = getDefaultConfig(__dirname);

defaultConfig.resolver.sourceExts.push('cjs');

module.exports = defaultConfig;copy
```

Restart the Expo development tools so that changes in the configuration are applied.
Now that the Metro configuration is in order, let's create a utility function for creating the Apollo Client with the required configuration. Create a _utils_ directory in the _src_ directory and in that _utils_ directory create a file _apolloClient.js_. In that file configure the Apollo Client to connect to the Apollo Server:

```
import { ApolloClient, InMemoryCache } from '@apollo/client';


const createApolloClient = () => {
  return new ApolloClient({
    uri: 'http://192.168.1.100:4000/graphql',
    cache: new InMemoryCache(),
  });
};

export default createApolloClient;copy
```

The URL used to connect to the Apollo Server is otherwise the same as the one you used with the Fetch API except the port is _4000_ and the path is _/graphql_. Lastly, we need to provide the Apollo Client using the _App_ component in the _App.js_ file:

```
import { NativeRouter } from 'react-router-native';
import { ApolloProvider } from '@apollo/client';
import Main from './src/components/Main';
import createApolloClient from './src/utils/apolloClient';
const apolloClient = createApolloClient();
const App = () => {
  return (
    <NativeRouter>
      <ApolloProvider client={apolloClient}>        <Main />
      </ApolloProvider>    </NativeRouter>
  );
};

export default App;copy
```

### Organizing GraphQL related code
It is up to you how to organize the GraphQL related code in your application. However, for the sake of a reference structure, let's have a look at one quite simple and efficient way to organize the GraphQL related code. In this structure, we define queries, mutations, fragments, and possibly other entities in their own files. These files are located in the same directory. Here is an example of the structure you can use to get started:
![GraphQL structure](../assets/3fe54e3166fbbbf4.png)
You can import the _gql_ template literal tag used to define GraphQL queries from _@apollo/client_ library. If we follow the structure suggested above, we could have a _queries.js_ file in the _graphql_ directory for our application's GraphQL queries. Each of the queries can be stored in a variable and exported like this:

```
import { gql } from '@apollo/client';

export const GET_REPOSITORIES = gql`
  query {
    repositories {
      ${/* ... */}
    }
  }
`;

// other queries...copy
```

We can import these variables and use them with the _useQuery_ hook like this:

```
import { useQuery } from '@apollo/client';

import { GET_REPOSITORIES } from '../graphql/queries';

const Component = () => {
  const { data, error, loading } = useQuery(GET_REPOSITORIES);
  // ...
};copy
```

The same goes for organizing mutations. The only difference is that we define them in a different file, _mutations.js_. It is recommended to use
### Evolving the structure
Once our application grows larger there might be times when certain files grow too large to manage. For example, we have component _A_ which renders the components _B_ and _C_. All these components are defined in a file _A.jsx_ in a _components_ directory. We would like to extract components _B_ and _C_ into their own files _B.jsx_ and _C.jsx_ without major refactors. We have two options:

- Create files _B.jsx_ and _C.jsx_ in the _components_ directory. This results in the following structure:


```
components/
  A.jsx
  B.jsx
  C.jsx
  ...copy
```

- Create a directory _A_ in the _components_ directory and create files _B.jsx_ and _C.jsx_ there. To avoid breaking components that import the _A.jsx_ file, move the _A.jsx_ file to the _A_ directory and rename it to _index.jsx_. This results in the following structure:


```
components/
  A/
    B.jsx
    C.jsx
    index.jsx
  ...copy
```

The first option is fairly decent, however, if components _B_ and _C_ are not reusable outside the component _A_ , it is useless to bloat the _components_ directory by adding them as separate files. The second option is quite modular and doesn't break any imports because importing a path such as _./A_ will match both _A.jsx_ and _A/index.jsx_.
### Exercise 10.11
#### Exercise 10.11: fetching repositories with Apollo Client
We want to replace the Fetch API implementation in the _useRepositories_ hook with a GraphQL query. Open the Apollo Sandbox at _repositories_ query. The query has some arguments, however, all of these are optional so you don't need to specify them. In the Apollo Sandbox form a query for fetching the repositories with the fields you are currently displaying in the application. The result will be paginated and it contains the up to first 30 results by default. For now, you can ignore the pagination entirely.
Once the query is working in the Apollo Sandbox, use it to replace the Fetch API implementation in the _useRepositories_ hook. This can be achieved using the _gql_ template literal tag can be imported from the _@apollo/client_ library as instructed earlier. Consider using the structure recommended earlier for the GraphQL related code. To avoid future caching issues, use the _cache-and-network_ _useQuery_ hook like this:

```
useQuery(MY_QUERY, {
  fetchPolicy: 'cache-and-network',
  // Other options
});copy
```

The changes in the _useRepositories_ hook should not affect the _RepositoryList_ component in any way.
### Environment variables
Every application will most likely run in more than one environment. Two obvious candidates for these environments are the development environment and the production environment. Out of these two, the development environment is the one we are running the application right now. Different environments usually have different dependencies, for example, the server we are developing locally might use a local database whereas the server that is deployed to the production environment uses the production database. To make the code environment independent we need to parametrize these dependencies. At the moment we are using one very environment dependant hardcoded value in our application: the URL of the server.
We have previously learned that we can provide running programs with environment variables. These variables can be defined in the command line or using environment configuration files such as _.env_ files and third-party libraries such as _Dotenv_. Unfortunately, React Native doesn't have direct support for environment variables. However, we can access the Expo configuration defined in the _app.json_ file at runtime from our JavaScript code. This configuration can be used to define and access environment dependant variables.
The configuration can be accessed by importing the _Constants_ constant from the _expo-constants_ module as we have done a few times before. Once imported, the _Constants.expoConfig_ property will contain the configuration. Let's try this by logging _Constants.expoConfig_ in the _App_ component:

```
import { NativeRouter } from 'react-router-native';
import { ApolloProvider } from '@apollo/client';
import Constants from 'expo-constants';
import Main from './src/components/Main';
import createApolloClient from './src/utils/apolloClient';

const apolloClient = createApolloClient();

const App = () => {
  console.log(Constants.expoConfig);
  return (
    <NativeRouter>
      <ApolloProvider client={apolloClient}>
        <Main />
      </ApolloProvider>
    </NativeRouter>
  );
};

export default App;copy
```

You should now see the configuration in the logs.
The next step is to use the configuration to define environment dependant variables in our application. Let's get started by renaming the _app.json_ file to _app.config.js_. Once the file is renamed, we can use JavaScript inside the configuration file. Change the file contents so that the previous object:

```
{
  "expo": {
    "name": "rate-repository-app",
    // rest of the configuration...
  }
}copy
```

Is turned into an export, which contains the contents of the _expo_ property:

```
export default {
   name: 'rate-repository-app',
   // rest of the configuration...
};copy
```

Expo has reserved an _env_ variable into our application's configuration. Note, that the older versions used (now deprecated) manifest instead of expoConfig.

```
export default {
   name: 'rate-repository-app',
   // rest of the configuration...
   extra: {     env: 'development'   },};copy
```

If you make changes in configuration, the restart may not be enough. You may need to start the application with cache cleared by command:

```
npx expo start --clearcopy
```

Now, restart Expo development tools to apply the changes and you should see that the value of _Constants.expoConfig_ property has changed and now includes the _extra_ property containing our application-specific configuration. Now the value of the _env_ variable is accessible through the _Constants.expoConfig.extra.env_ property.
Because using hard coded configuration is a bit silly, let's use an environment variable instead:

```
export default {
   name: 'rate-repository-app',
   // rest of the configuration...
   extra: {     env: process.env.ENV,   },};copy
```

As we have learned, we can set the value of an environment variable through the command line by defining the variable's name and value before the actual command. As an example, start Expo development tools and set the environment variable _ENV_ as _test_ like this:

```
ENV=test npm startcopy
```

If you take a look at the logs, you should see that the _Constants.expoConfig.extra.env_ property has changed.
We can also load environment variables from an _.env_ file as we have learned in the previous parts. First, we need to install the

```
npm install dotenvcopy
```

Next, add a _.env_ file in the root directory of our project with the following content:

```
ENV=developmentcopy
```

Finally, import the library in the _app.config.js_ file:

```
import 'dotenv/config';
export default {
   name: 'rate-repository-app',
   // rest of the configuration...
   extra: {
     env: process.env.ENV,
   },
};copy
```

You need to restart Expo development tools to apply the changes you have made to the _.env_ file.
Note that it is _never_ a good idea to put sensitive data into the application's configuration. The reason for this is that once a user has downloaded your application, they can, at least in theory, reverse engineer your application and figure out the sensitive data you have stored into the code.
### Exercise 10.12
#### Exercise 10.12: environment variables
Instead of the hardcoded Apollo Server's URL, use an environment variable defined in the _.env_ file when initializing the Apollo Client. You can name the environment variable for example _APOLLO_URI_.
_Do not_ try to access environment variables like _process.env.APOLLO_URI_ outside the _app.config.js_ file. Instead use the _Constants.expoConfig.extra_ object like in the previous example. In addition, do not import the dotenv library outside the _app.config.js_ file or you will most likely face errors.
### Storing data in the user's device
There are times when we need to store some persisted pieces of data in the user's device. One such common scenario is storing the user's authentication token so that we can retrieve it even if the user closes and reopens our application. In web development, we have used the browser's _localStorage_ object to achieve such functionality. React Native provides similar persistent storage, the
We can use the _npx expo install_ command to install the version of the _@react-native-async-storage/async-storage_ package that is suitable for our Expo SDK version:

```
npx expo install @react-native-async-storage/async-storagecopy
```

The API of the _AsyncStorage_ is in many ways same as the _localStorage_ API. They are both key-value storages with similar methods. The biggest difference between the two is that, as the name implies, the operations of _AsyncStorage_ are _asynchronous_.
Because _AsyncStorage_ operates with string keys in a global namespace it is a good idea to create a simple abstraction for its operations. This abstraction can be implemented for example using a

```
import AsyncStorage from '@react-native-async-storage/async-storage';

class ShoppingCartStorage {
  constructor(namespace = 'shoppingCart') {
    this.namespace = namespace;
  }

  async getProducts() {
    const rawProducts = await AsyncStorage.getItem(
      `${this.namespace}:products`,
    );

    return rawProducts ? JSON.parse(rawProducts) : [];
  }

  async addProduct(productId) {
    const currentProducts = await this.getProducts();
    const newProducts = [...currentProducts, productId];

    await AsyncStorage.setItem(
      `${this.namespace}:products`,
      JSON.stringify(newProducts),
    );
  }

  async clearProducts() {
    await AsyncStorage.removeItem(`${this.namespace}:products`);
  }
}

const doShopping = async () => {
  const shoppingCartA = new ShoppingCartStorage('shoppingCartA');
  const shoppingCartB = new ShoppingCartStorage('shoppingCartB');

  await shoppingCartA.addProduct('chips');
  await shoppingCartA.addProduct('soda');

  await shoppingCartB.addProduct('milk');

  const productsA = await shoppingCartA.getProducts();
  const productsB = await shoppingCartB.getProducts();

  console.log(productsA, productsB);

  await shoppingCartA.clearProducts();
  await shoppingCartB.clearProducts();
};

doShopping();copy
```

Because _AsyncStorage_ keys are global, it is usually a good idea to add a _namespace_ for the keys. In this context, the namespace is just a prefix we provide for the storage abstraction's keys. Using the namespace prevents the storage's keys from colliding with other _AsyncStorage_ keys. In this example, the namespace is defined as the constructor's argument and we are using the _namespace:key_ format for the keys.
We can add an item to the storage using the _must be a string_ , so we need to serialize non-string values as we did with the _JSON.stringify_ method. The
**NB:** _AsyncStorage_ but it encrypts the stored data. This makes it more suitable for storing more sensitive data such as the user's credit card number.
### Exercises 10.13. - 10.14
#### Exercise 10.13: the sign in form mutation
The current implementation of the sign in form doesn't do much with the submitted user's credentials. Let's do something about that in this exercise. First, read the rate-repository-api server's
Once you have figured out how the authentication works, create a file _useSignIn.js_ file in the _hooks_ directory. In that file implement a _useSignIn_ hook that sends the _authenticate_ mutation using the _authenticate_ mutation has a _single_ argument called _credentials_ , which is of type _AuthenticateInput_. This _username_ and _password_ fields.
The return value of the hook should be a tuple _[signIn, result]_ where _result_ is the mutations result as it is returned by the _useMutation_ hook and _signIn_ a function that runs the mutation with a _{ username, password }_ object argument. Hint: don't pass the mutation function to the return value directly. Instead, return a function that calls the mutation function like this:

```
const useSignIn = () => {
  const [mutate, result] = useMutation(/* mutation arguments */);

  const signIn = async ({ username, password }) => {
    // call the mutate function here with the right arguments
  };

  return [signIn, result];
};copy
```

Once the hook is implemented, use it in the _SignIn_ component's _onSubmit_ callback for example like this:

```
const SignIn = () => {
  const [signIn] = useSignIn();

  const onSubmit = async (values) => {
    const { username, password } = values;

    try {
      const { data } = await signIn({ username, password });
      console.log(data);
    } catch (e) {
      console.log(e);
    }
  };

  // ...
};copy
```

This exercise is completed once you can log the user's _authenticate_ mutations result after the sign in form has been submitted. The mutation result should contain the user's access token.
#### Exercise 10.14: storing the access token step1
Now that we can obtain the access token we need to store it. Create a file _authStorage.js_ in the _utils_ directory with the following content:

```
import AsyncStorage from '@react-native-async-storage/async-storage';

class AuthStorage {
  constructor(namespace = 'auth') {
    this.namespace = namespace;
  }

  getAccessToken() {
    // Get the access token for the storage
  }

  setAccessToken(accessToken) {
    // Add the access token to the storage
  }

  removeAccessToken() {
    // Remove the access token from the storage
  }
}

export default AuthStorage;copy
```

Next, implement the methods _AuthStorage.getAccessToken_ , _AuthStorage.setAccessToken_ and _AuthStorage.removeAccessToken_. Use the _namespace_ variable to give your keys a namespace like we did in the previous example.
### Enhancing Apollo Client's requests
Now that we have implemented storage for storing the user's access token, it is time to start using it. Initialize the storage in the _App_ component:

```
import { NativeRouter } from 'react-router-native';
import { ApolloProvider } from '@apollo/client';

import Main from './src/components/Main';
import createApolloClient from './src/utils/apolloClient';
import AuthStorage from './src/utils/authStorage';
const authStorage = new AuthStorage();const apolloClient = createApolloClient(authStorage);
const App = () => {
  return (
    <NativeRouter>
      <ApolloProvider client={apolloClient}>
        <Main />
      </ApolloProvider>
    </NativeRouter>
  );
};

export default App;copy
```

We also provided the storage instance for the _createApolloClient_ function as an argument. This is because next, we will send the access token to Apollo Server in each request. The Apollo Server will expect that the access token is present in the _Authorization_ header in the format _Bearer <ACCESS_TOKEN>_. We can enhance the Apollo Client's request by using the _createApolloClient_ function in the _apolloClient.js_ file:

```
import { ApolloClient, InMemoryCache, createHttpLink } from '@apollo/client';
import Constants from 'expo-constants';
import { setContext } from '@apollo/client/link/context';
// You might need to change this depending on how you have configured the Apollo Server's URI
const { apolloUri } = Constants.expoConfig.extra;

const httpLink = createHttpLink({
  uri: apolloUri,
});

const createApolloClient = (authStorage) => {  const authLink = setContext(async (_, { headers }) => {    try {      const accessToken = await authStorage.getAccessToken();      return {        headers: {          ...headers,          authorization: accessToken ? `Bearer ${accessToken}` : '',        },      };    } catch (e) {      console.log(e);      return {        headers,      };    }  });  return new ApolloClient({    link: authLink.concat(httpLink),    cache: new InMemoryCache(),  });};
export default createApolloClient;copy
```

### Using React Context for dependency injection
The last piece of the sign-in puzzle is to integrate the storage to the _useSignIn_ hook. To achieve this the hook must be able to access token storage instance we have initialized in the _App_ component. React _contexts_ in the _src_ directory. In that directory create a file _AuthStorageContext.js_ with the following content:

```
import { createContext } from 'react';

const AuthStorageContext = createContext();

export default AuthStorageContext;copy
```

Now we can use the _AuthStorageContext.Provider_ to provide the storage instance to the descendants of the context. Let's add it to the _App_ component:

```
import { NativeRouter } from 'react-router-native';
import { ApolloProvider } from '@apollo/client';

import Main from './src/components/Main';
import createApolloClient from './src/utils/apolloClient';
import AuthStorage from './src/utils/authStorage';
import AuthStorageContext from './src/contexts/AuthStorageContext';
const authStorage = new AuthStorage();
const apolloClient = createApolloClient(authStorage);

const App = () => {
  return (
    <NativeRouter>
      <ApolloProvider client={apolloClient}>
        <AuthStorageContext.Provider value={authStorage}>          <Main />
        </AuthStorageContext.Provider>      </ApolloProvider>
    </NativeRouter>
  );
};

export default App;copy
```

Accessing the storage instance in the _useSignIn_ hook is now possible using the React's

```
// ...
import { useContext } from 'react';
import AuthStorageContext from '../contexts/AuthStorageContext';
const useSignIn = () => {
  const authStorage = useContext(AuthStorageContext);  // ...
};copy
```

Note that accessing a context's value using the _useContext_ hook only works if the _useContext_ hook is used in a component that is a _descendant_ of the
Accessing the _AuthStorage_ instance with _useContext(AuthStorageContext)_ is quite verbose and reveals the details of the implementation. Let's improve this by implementing a _useAuthStorage_ hook in a _useAuthStorage.js_ file in the _hooks_ directory:

```
import { useContext } from 'react';
import AuthStorageContext from '../contexts/AuthStorageContext';

const useAuthStorage = () => {
  return useContext(AuthStorageContext);
};

export default useAuthStorage;copy
```

The hook's implementation is quite simple but it improves the readability and maintainability of the hooks and components using it. We can use the hook to refactor the _useSignIn_ hook like this:

```
// ...
import useAuthStorage from '../hooks/useAuthStorage';
const useSignIn = () => {
  const authStorage = useAuthStorage();  // ...
};copy
```

The ability to provide data to component's descendants opens tons of use cases for React Context, as we already saw in the [last chapter](../part6/01-react-query-use-reducer-and-the-context.md) of part 6.
To learn more about these use cases, read Kent C. Dodds' enlightening article
### Exercises 10.15. - 10.16
#### Exercise 10.15: storing the access token step2
Improve the _useSignIn_ hook so that it stores the user's access token retrieved from the _authenticate_ mutation. The return value of the hook should not change. The only change you should make to the _SignIn_ component is that you should redirect the user to the reviewed repositories list view after a successful sign in. You can achieve this by using the
After the _authenticate_ mutation has been executed and you have stored the user's access token to the storage, you should reset the Apollo Client's store. This will clear the Apollo Client's cache and re-execute all active queries. You can do this by using the Apollo Client's _useSignIn_ hook using the

```
const { data } = await mutate(/* options */);
await authStorage.setAccessToken(/* access token from the data */);
apolloClient.resetStore();copy
```

#### Exercise 10.16: sign out
The final step in completing the sign in feature is to implement a sign out feature. The _me_ query can be used to check the authenticated user's information. If the query's result is _null_ , that means that the user is not authenticated. Open the Apollo Sandbox and run the following query:

```
{
  me {
    id
    username
  }
}copy
```

You will probably end up with the _null_ result. This is because the Apollo Sandbox is not authenticated, meaning that it doesn't send a valid access token with the request. Revise the _authenticate_ mutation. Use this access token in the _Authorization_ header as instructed in the documentation. Now, run the _me_ query again and you should be able to see the authenticated user's information.
Open the _AppBar_ component in the _AppBar.jsx_ file where you currently have the tabs "Repositories" and "Sign in". Change the tabs so that if the user is signed in the tab "Sign out" is displayed, otherwise show the "Sign in" tab. You can achieve this by using the _me_ query with the
Pressing the "Sign out" tab should remove the user's access token from the storage and reset the Apollo Client's store with the _resetStore_ method should automatically re-execute all active queries which means that the _me_ query should be re-executed. Note that the order of execution is crucial: access token must be removed from the storage _before_ the Apollo Client's store is reset.
This was the last exercise in this section. It's time to push your code to GitHub and mark all of your finished exercises to the
[Part 10b **Previous part**](../part10/01-react-native-basics.md)[Part 10d **Next part**](../part10/01-testing-and-extending-our-application.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 10](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-part10.md)
- [a Introduction to React Native](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-introduction-to-react-native.md)
- [b React Native basics](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-react-native-basics.md)
- [HTTP requests](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-http-requests.md)
- [GraphQL and Apollo client](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-graph-ql-and-apollo-client.md)
- [Organizing GraphQL related code](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-organizing-graph-ql-related-code.md)
- [Evolving the structure](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-evolving-the-structure.md)
- [Exercise 10.11](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-exercise-10-11.md)
- [Environment variables](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-environment-variables.md)
- [Exercise 10.12](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-exercise-10-12.md)
- [Storing data in the user's device](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-storing-data-in-the-users-device.md)
- [Exercises 10.13. - 10.14](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-exercises-10-13-10-14.md)
- [Enhancing Apollo Client's requests](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-enhancing-apollo-clients-requests.md)
- [Using React Context for dependency injection](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-using-react-context-for-dependency-injection.md)
- [Exercises 10.15. - 10.16](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-communicating-with-server-exercises-10-15-10-16.md)
- [d Testing and extending our application](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-testing-and-extending-our-application.md)
- [metro console output with highlight over exp://<ip> url](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/01ec3c013259ce0e.png)
- [Debugging](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-introduction-to-react-native-debugging.md)
- [part 8](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part8/01-part8.md)
- [Apollo Sandbox](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/e34c16527441267a.png)
- [GraphQL structure](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/3fe54e3166fbbbf4.png)
- [last chapter](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-react-query-use-reducer-and-the-context.md)
- [Part 10b **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-react-native-basics.md)
- [Part 10d **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part10/01-testing-and-extending-our-application.md)

--- .archived/data/part6/01-communicating-with-server-in-a-redux-application.md ---
---{
  "title": "Communicating with server in a Redux application",
  "source_url": "https://fullstackopen.com/en/part6/communicating_with_server_in_a_redux_application",
  "crawl_timestamp": "2025-10-04T19:16:45Z",
  "checksum": "b0da0c467e79b636a241366a54905ae0f44476f79780f82b8b00098772e503ea"
}
---[Skip to content](../part6/01-communicating-with-server-in-a-redux-application-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 6](../part6/01-part6.md)
Communicating with server in a Redux application
[a Flux-architecture and Redux](../part6/01-flux-architecture-and-redux.md)[b Many reducers](../part6/01-many-reducers.md)
c Communicating with server in a Redux application

- [Getting data from the backend](../part6/01-communicating-with-server-in-a-redux-application-getting-data-from-the-backend.md)
- [Sending data to the backend](../part6/01-communicating-with-server-in-a-redux-application-sending-data-to-the-backend.md)
- [Exercises 6.14.-6.15.](../part6/01-communicating-with-server-in-a-redux-application-exercises-6-14-6-15.md)
- [Asynchronous actions and Redux Thunk](../part6/01-communicating-with-server-in-a-redux-application-asynchronous-actions-and-redux-thunk.md)
- [Exercises 6.16.-6.19.](../part6/01-communicating-with-server-in-a-redux-application-exercises-6-16-6-19.md)


[d React Query, useReducer and the context](../part6/01-react-query-use-reducer-and-the-context.md)
c
# Communicating with server in a Redux application
Let's expand the application so that the notes are stored in the backend. We'll use [json-server](../part2/01-getting-data-from-server.md), familiar from part 2.
The initial state of the database is stored in the file _db.json_ , which is placed in the root of the project:

```
{
  "notes": [
    {
      "content": "the app state is in redux store",
      "important": true,
      "id": 1
    },
    {
      "content": "state changes are made with actions",
      "important": false,
      "id": 2
    }
  ]
}copy
```

We'll install json-server for the project:

```
npm install json-server --save-devcopy
```

and add the following line to the _scripts_ part of the file _package.json_

```
"scripts": {
  "server": "json-server -p3001 --watch db.json",
  // ...
}copy
```

Now let's launch json-server with the command _npm run server_.
### Getting data from the backend
Next, we'll create a method into the file _services/notes.js_ , which uses _axios_ to fetch data from the backend

```
import axios from 'axios'

const baseUrl = 'http://localhost:3001/notes'

const getAll = async () => {
  const response = await axios.get(baseUrl)
  return response.data
}

export default { getAll }copy
```

We'll add axios to the project

```
npm install axioscopy
```

We'll change the initialization of the state in _noteReducer_ , so that by default there are no notes:

```
const noteSlice = createSlice({
  name: 'notes',
  initialState: [],  // ...
})copy
```

Let's also add a new action _appendNote_ for adding a note object:

```
const noteSlice = createSlice({
  name: 'notes',
  initialState: [],
  reducers: {
    createNote(state, action) {
      const content = action.payload

      state.push({
        content,
        important: false,
        id: generateId(),
      })
    },
    toggleImportanceOf(state, action) {
      const id = action.payload

      const noteToChange = state.find(n => n.id === id)

      const changedNote = { 
        ...noteToChange, 
        important: !noteToChange.important 
      }

      return state.map(note =>
        note.id !== id ? note : changedNote 
      )     
    },
    appendNote(state, action) {      state.push(action.payload)    }  },
})

export const { createNote, toggleImportanceOf, appendNote } = noteSlice.actions
export default noteSlice.reducercopy
```

A quick way to initialize the notes state based on the data received from the server is to fetch the notes in the _main.jsx_ file and dispatch an action using the _appendNote_ action creator for each individual note object:

```
// ...
import noteService from './services/notes'import noteReducer, { appendNote } from './reducers/noteReducer'
const store = configureStore({
  reducer: {
    notes: noteReducer,
    filter: filterReducer,
  }
})

noteService.getAll().then(notes =>  notes.forEach(note => {    store.dispatch(appendNote(note))  }))
// ...copy
```

Dispatching multiple actions seems a bit impractical. Let's add an action creator _setNotes_ which can be used to directly replace the notes array. We'll get the action creator from the _createSlice_ function by implementing the _setNotes_ action:

```
// ...

const noteSlice = createSlice({
  name: 'notes',
  initialState: [],
  reducers: {
    createNote(state, action) {
      const content = action.payload

      state.push({
        content,
        important: false,
        id: generateId(),
      })
    },
    toggleImportanceOf(state, action) {
      const id = action.payload

      const noteToChange = state.find(n => n.id === id)

      const changedNote = { 
        ...noteToChange, 
        important: !noteToChange.important 
      }

      return state.map(note =>
        note.id !== id ? note : changedNote 
      )     
    },
    appendNote(state, action) {
      state.push(action.payload)
    },
    setNotes(state, action) {      return action.payload    }  },
})

export const { createNote, toggleImportanceOf, appendNote, setNotes } = noteSlice.actions
export default noteSlice.reducercopy
```

Now, the code in the _main.jsx_ file looks a lot better:

```
// ...
import noteService from './services/notes'
import noteReducer, { setNotes } from './reducers/noteReducer'
const store = configureStore({
  reducer: {
    notes: noteReducer,
    filter: filterReducer,
  }
})

noteService.getAll().then(notes =>
  store.dispatch(setNotes(notes)))copy
```

> **NB:** Why didn't we use await in place of promises and event handlers (registered to _then_ -methods)?
> Await only works inside _async_ functions, and the code in _main.jsx_ is not inside a function, so due to the simple nature of the operation, we'll abstain from using _async_ this time.
We do, however, decide to move the initialization of the notes into the _App_ component, and, as usual, when fetching data from a server, we'll use the _effect hook_.

```
import { useEffect } from 'react'import NewNote from './components/NewNote'
import Notes from './components/Notes'
import VisibilityFilter from './components/VisibilityFilter'
import noteService from './services/notes'import { setNotes } from './reducers/noteReducer'import { useDispatch } from 'react-redux'
const App = () => {
  const dispatch = useDispatch()  useEffect(() => {    noteService      .getAll().then(notes => dispatch(setNotes(notes)))  }, [])
  return (
    <div>
      <NewNote />
      <VisibilityFilter />
      <Notes />
    </div>
  )
}

export default Appcopy
```

### Sending data to the backend
We can do the same thing when it comes to creating a new note. Let's expand the code communicating with the server as follows:

```
const baseUrl = 'http://localhost:3001/notes'

const getAll = async () => {
  const response = await axios.get(baseUrl)
  return response.data
}

const createNew = async (content) => {  const object = { content, important: false }  const response = await axios.post(baseUrl, object)  return response.data}
export default {
  getAll,
  createNew,}copy
```

The method _addNote_ of the component _NewNote_ changes slightly:

```
import { useDispatch } from 'react-redux'
import { createNote } from '../reducers/noteReducer'
import noteService from '../services/notes'
const NewNote = (props) => {
  const dispatch = useDispatch()
  
  const addNote = async (event) => {    event.preventDefault()
    const content = event.target.note.value
    event.target.note.value = ''
    const newNote = await noteService.createNew(content)    dispatch(createNote(newNote))  }

  return (
    <form onSubmit={addNote}>
      <input name="note" />
      <button type="submit">add</button>
    </form>
  )
}

export default NewNotecopy
```

Because the backend generates ids for the notes, we'll change the action creator _createNote_ in the file _noteReducer.js_ accordingly:

```
const noteSlice = createSlice({
  name: 'notes',
  initialState: [],
  reducers: {
    createNote(state, action) {
      state.push(action.payload)    },
    // ..
  },
})copy
```

Changing the importance of notes could be implemented using the same principle, by making an asynchronous method call to the server and then dispatching an appropriate action.
The current state of the code for the application can be found on _part6-3_.
### Exercises 6.14.-6.15
#### 6.14 Anecdotes and the Backend, step 1
When the application launches, fetch the anecdotes from the backend implemented using json-server.
As the initial backend data, you can use, e.g.
#### 6.15 Anecdotes and the Backend, step 2
Modify the creation of new anecdotes, so that the anecdotes are stored in the backend.
### Asynchronous actions and Redux Thunk
Our approach is quite good, but it is not great that the communication with the server happens inside the functions of the components. It would be better if the communication could be abstracted away from the components so that they don't have to do anything else but call the appropriate _action creator_. As an example, _App_ would initialize the state of the application as follows:

```
const App = () => {
  const dispatch = useDispatch()

  useEffect(() => {
    dispatch(initializeNotes())  
  }, []) 

  // ...
}copy
```

and _NewNote_ would create a new note as follows:

```
const NewNote = () => {
  const dispatch = useDispatch()
  
  const addNote = async (event) => {
    event.preventDefault()
    const content = event.target.note.value
    event.target.note.value = ''
    dispatch(createNote(content))
  }

  // ...
}copy
```

In this implementation, both components would dispatch an action without the need to know about the communication with the server that happens behind the scenes. These kinds of _async actions_ can be implemented using the _configureStore_ function.
With Redux Thunk it is possible to implement _action creators_ which return a function instead of an object. The function receives Redux store's _dispatch_ and _getState_ methods as parameters. This allows for example implementations of asynchronous action creators, which first wait for the completion of a certain asynchronous operation and after that dispatch some action, which changes the store's state.
We can define an action creator _initializeNotes_ which initializes the notes based on the data received from the server:

```
// ...
import noteService from '../services/notes'
const noteSlice = createSlice(/* ... */)

export const { createNote, toggleImportanceOf, setNotes, appendNote } = noteSlice.actions

export const initializeNotes = () => {  return async dispatch => {    const notes = await noteService.getAll()    dispatch(setNotes(notes))  }}
export default noteSlice.reducercopy
```

In the inner function, meaning the _asynchronous action_ , the operation first fetches all the notes from the server and then _dispatches_ the _setNotes_ action, which adds them to the store.
The component _App_ can now be defined as follows:

```
// ...
import { initializeNotes } from './reducers/noteReducer'
const App = () => {
  const dispatch = useDispatch()

  useEffect(() => {    dispatch(initializeNotes())   }, []) 
  return (
    <div>
      <NewNote />
      <VisibilityFilter />
      <Notes />
    </div>
  )
}copy
```

The solution is elegant. The initialization logic for the notes has been completely separated from the React component.
Next, let's replace the _createNote_ action creator created by the _createSlice_ function with an asynchronous action creator:

```
// ...
import noteService from '../services/notes'

const noteSlice = createSlice({
  name: 'notes',
  initialState: [],
  reducers: {
    toggleImportanceOf(state, action) {
      const id = action.payload

      const noteToChange = state.find(n => n.id === id)

      const changedNote = { 
        ...noteToChange, 
        important: !noteToChange.important 
      }

      return state.map(note =>
        note.id !== id ? note : changedNote 
      )     
    },
    appendNote(state, action) {
      state.push(action.payload)
    },
    setNotes(state, action) {
      return action.payload
    }
    // createNote definition removed from here!
  },
})

export const { toggleImportanceOf, appendNote, setNotes } = noteSlice.actions
export const initializeNotes = () => {
  return async dispatch => {
    const notes = await noteService.getAll()
    dispatch(setNotes(notes))
  }
}

export const createNote = content => {  return async dispatch => {    const newNote = await noteService.createNew(content)    dispatch(appendNote(newNote))  }}
export default noteSlice.reducercopy
```

The principle here is the same: first, an asynchronous operation is executed, after which the action changing the state of the store is _dispatched_.
The component _NewNote_ changes as follows:

```
// ...
import { createNote } from '../reducers/noteReducer'
const NewNote = () => {
  const dispatch = useDispatch()
  
  const addNote = async (event) => {
    event.preventDefault()
    const content = event.target.note.value
    event.target.note.value = ''
    dispatch(createNote(content))  }

  return (
    <form onSubmit={addNote}>
      <input name="note" />
      <button type="submit">add</button>
    </form>
  )
}copy
```

Finally, let's clean up the _main.jsx_ file a bit by moving the code related to the creation of the Redux store into its own, _store.js_ file:

```
import { configureStore } from '@reduxjs/toolkit'

import noteReducer from './reducers/noteReducer'
import filterReducer from './reducers/filterReducer'

const store = configureStore({
  reducer: {
    notes: noteReducer,
    filter: filterReducer
  }
})

export default storecopy
```

After the changes, the content of the _main.jsx_ is the following:

```
import React from 'react'
import ReactDOM from 'react-dom/client'
import { Provider } from 'react-redux' 
import store from './store'import App from './App'

ReactDOM.createRoot(document.getElementById('root')).render(
  <Provider store={store}>
    <App />
  </Provider>
)copy
```

The current state of the code for the application can be found on _part6-5_.
Redux Toolkit offers a multitude of tools to simplify asynchronous state management. Suitable tools for this use case are for example the
### Exercises 6.16.-6.19
#### 6.16 Anecdotes and the Backend, step 3
Modify the initialization of the Redux store to happen using asynchronous action creators, which are made possible by the Redux Thunk library.
#### 6.17 Anecdotes and the Backend, step 4
Also modify the creation of a new anecdote to happen using asynchronous action creators, made possible by the Redux Thunk library.
#### 6.18 Anecdotes and the Backend, step 5
Voting does not yet save changes to the backend. Fix the situation with the help of the Redux Thunk library.
#### 6.19 Anecdotes and the Backend, step 6
The creation of notifications is still a bit tedious since one has to do two actions and use the _setTimeout_ function:

```
dispatch(setNotification(`new anecdote '${content}'`))
setTimeout(() => {
  dispatch(clearNotification())
}, 5000)copy
```

Make an action creator, which enables one to provide the notification as follows:

```
dispatch(setNotification(`you voted '${anecdote.content}'`, 10))copy
```

The first parameter is the text to be rendered and the second parameter is the time to display the notification given in seconds.
Implement the use of this improved notification in your application.
[Part 6b **Previous part**](../part6/01-many-reducers.md)[Part 6d **Next part**](../part6/01-react-query-use-reducer-and-the-context.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-communicating-with-server-in-a-redux-application-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 6](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-part6.md)
- [a Flux-architecture and Redux](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-flux-architecture-and-redux.md)
- [b Many reducers](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-many-reducers.md)
- [Getting data from the backend](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-communicating-with-server-in-a-redux-application-getting-data-from-the-backend.md)
- [Sending data to the backend](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-communicating-with-server-in-a-redux-application-sending-data-to-the-backend.md)
- [Exercises 6.14.-6.15.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-communicating-with-server-in-a-redux-application-exercises-6-14-6-15.md)
- [Asynchronous actions and Redux Thunk](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-communicating-with-server-in-a-redux-application-asynchronous-actions-and-redux-thunk.md)
- [Exercises 6.16.-6.19.](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-communicating-with-server-in-a-redux-application-exercises-6-16-6-19.md)
- [d React Query, useReducer and the context](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-react-query-use-reducer-and-the-context.md)
- [json-server](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part2/01-getting-data-from-server.md)
- [Part 6b **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-many-reducers.md)
- [Part 6d **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part6/01-react-query-use-reducer-and-the-context.md)

--- .archived/data/part1/01-component-state-event-handlers.md ---
---{
  "title": "Component state, event handlers",
  "source_url": "https://fullstackopen.com/en/part1/component_state_event_handlers",
  "crawl_timestamp": "2025-10-04T19:15:36Z",
  "checksum": "46bfb9860994d17db781b2314c6998e00ee3d3e67af10a69fa57b59e47ee81ec"
}
---[Skip to content](../part1/01-component-state-event-handlers-course-main-content.md)
[{() => fs}](https://fullstackopen.com/en/)

- [About course](../about/01-about.md)
- [Course contents](../#course-contents/01-course-contents.md)
- [FAQ](../faq/01-faq.md)
- [Partners](../companies/01-companies.md)
- [Challenge](../challenge/01-challenge.md)
[Search from the material](../search/01-search.md)Toggle dark theme
Select languageSuomi English 中文 Español Français Português(BR)

[Fullstack](../#course-contents/01-course-contents.md)
[Part 1](../part1/01-part1.md)
Component state, event handlers
[a Introduction to React](../part1/01-introduction-to-react.md)[b JavaScript](../part1/01-java-script.md)
c Component state, event handlers

- [Component helper functions](../part1/01-component-state-event-handlers-component-helper-functions.md)
- [Destructuring](../part1/01-component-state-event-handlers-destructuring.md)
- [Page re-rendering](../part1/01-component-state-event-handlers-page-re-rendering.md)
- [Stateful component](../part1/01-component-state-event-handlers-stateful-component.md)
- [Event handling](../part1/01-component-state-event-handlers-event-handling.md)
- [An event handler is a function](../part1/01-component-state-event-handlers-an-event-handler-is-a-function.md)
- [Passing state - to child components](../part1/01-component-state-event-handlers-passing-state-to-child-components.md)
- [Changes in state cause re-rendering](../part1/01-component-state-event-handlers-changes-in-state-cause-re-rendering.md)
- [Refactoring the components](../part1/01-component-state-event-handlers-refactoring-the-components.md)


[d A more complex state, debugging React apps](../part1/01-a-more-complex-state-debugging-react-apps.md)
c
# Component state, event handlers
Let's go back to working with React.
We start with a new example:

```
const Hello = (props) => {
  return (
    <div>
      <p>
        Hello {props.name}, you are {props.age} years old
      </p>
    </div>
  )
}

const App = () => {
  const name = 'Peter'
  const age = 10

  return (
    <div>
      <h1>Greetings</h1>
      <Hello name="Maya" age={26 + 10} />
      <Hello name={name} age={age} />
    </div>
  )
}copy
```

### Component helper functions
Let's expand our _Hello_ component so that it guesses the year of birth of the person being greeted:

```
const Hello = (props) => {
  const bornYear = () => {    const yearNow = new Date().getFullYear()    return yearNow - props.age  }
  return (
    <div>
      <p>
        Hello {props.name}, you are {props.age} years old
      </p>
      <p>So you were probably born in {bornYear()}</p>    </div>
  )
}copy
```

The logic for guessing the year of birth is encapsulated within a function of its own, which is invoked when the component is rendered.
The person's age does not need to be explicitly passed as a parameter to this function because the function can directly access all the props provided to the component.
If we examine the current code, we notice that the helper function is defined within another function that determines the component's behavior. In Java programming, defining a function within another function can be complex and is uncommon. However, in JavaScript, defining functions within functions is a common and efficient practice.
### Destructuring
Before we move forward, we will take a look at a small but useful feature of the JavaScript language that was added in the ES6 specification, that allows us to
In our previous code, we had to reference the data passed to our component as _props.name_ and _props.age_. Of these two expressions, we had to repeat _props.age_ twice in our code.
Since _props_ is an object

```
props = {
  name: 'Arto Hellas',
  age: 35,
}copy
```

we can streamline our component by assigning the values of the properties directly into two variables _name_ and _age_ which we can then use in our code:

```
const Hello = (props) => {
  const name = props.name  const age = props.age
  const bornYear = () => new Date().getFullYear() - age
  return (
    <div>
      <p>Hello {name}, you are {age} years old</p>      <p>So you were probably born in {bornYear()}</p>
    </div>
  )
}copy
```

Note that we've also utilized the more compact syntax for arrow functions when defining the _bornYear_ function. As mentioned earlier, if an arrow function consists of a single expression, then the function body does not need to be written inside of curly braces. In this more compact form, the function simply returns the result of the single expression.
To recap, the two function definitions shown below are equivalent:

```
const bornYear = () => new Date().getFullYear() - age

const bornYear = () => {
  return new Date().getFullYear() - age
}copy
```

Destructuring makes the assignment of variables even easier since we can use it to extract and gather the values of an object's properties into separate variables:

```
const Hello = (props) => {
  const { name, age } = props  const bornYear = () => new Date().getFullYear() - age

  return (
    <div>
      <p>Hello {name}, you are {age} years old</p>
      <p>So you were probably born in {bornYear()}</p>
    </div>
  )
}copy
```

When the object that we are destructuring has the values

```
props = {
  name: 'Arto Hellas',
  age: 35,
}copy
```

the expression _const { name, age } = props_ assigns the values 'Arto Hellas' to _name_ and 35 to _age_.
We can take destructuring a step further:

```
const Hello = ({ name, age }) => {  const bornYear = () => new Date().getFullYear() - age

  return (
    <div>
      <p>
        Hello {name}, you are {age} years old
      </p>
      <p>So you were probably born in {bornYear()}</p>
    </div>
  )
}copy
```

The props that are passed to the component are now directly destructured into the variables, _name_ and _age_.
This means that instead of assigning the entire props object into a variable called _props_ and then assigning its properties to the variables _name_ and _age_

```
const Hello = (props) => {
  const { name, age } = propscopy
```

we assign the values of the properties directly to variables by destructuring the props object that is passed to the component function as a parameter:

```
const Hello = ({ name, age }) => {copy
```

### Page re-rendering
Up to this point, our applications have been static — their appearance remains unchanged after the initial rendering. But what if we wanted to create a counter that increases in value, either over time or when a button is clicked?
Let's start with the following. File _App.jsx_ becomes:

```
const App = (props) => {
  const {counter} = props
  return (
    <div>{counter}</div>
  )
}

export default Appcopy
```

And file _main.jsx_ becomes:

```
import ReactDOM from 'react-dom/client'

import App from './App'

let counter = 1

ReactDOM.createRoot(document.getElementById('root')).render(
  <App counter={counter} />
)copy
```

The App component is given the value of the counter via the _counter_ prop. This component renders the value to the screen. What happens when the value of _counter_ changes? Even if we were to add the following

```
counter += 1copy
```

the component won't re-render. We can get the component to re-render by calling the _render_ method a second time, e.g. in the following way:

```
let counter = 1

const root = ReactDOM.createRoot(document.getElementById('root'))

const refresh = () => {
  root.render(
    <App counter={counter} />
  )
}

refresh()
counter += 1
refresh()
counter += 1
refresh()copy
```

The re-rendering command has been wrapped inside of the _refresh_ function to cut down on the amount of copy-pasted code.
Now the component _renders three times_ , first with the value 1, then 2, and finally 3. However, values 1 and 2 are displayed on the screen for such a short amount of time that they can't be noticed.
We can implement slightly more interesting functionality by re-rendering and incrementing the counter every second by using

```
setInterval(() => {
  refresh()
  counter += 1
}, 1000)copy
```

Making repeated calls to the _render_ method is not the recommended way to re-render components. Next, we'll introduce a better way of accomplishing this effect.
### Stateful component
All of our components up till now have been simple in the sense that they have not contained any state that could change during the lifecycle of the component.
Next, let's add state to our application's _App_ component with the help of React's
We will change the application as follows. _main.jsx_ goes back to:

```
import ReactDOM from 'react-dom/client'

import App from './App'

ReactDOM.createRoot(document.getElementById('root')).render(<App />)copy
```

and _App.jsx_ changes to the following:

```
import { useState } from 'react'
const App = () => {
  const [ counter, setCounter ] = useState(0)
  setTimeout(    () => setCounter(counter + 1),    1000  )
  return (
    <div>{counter}</div>
  )
}

export default Appcopy
```

In the first row, the file imports the _useState_ function:

```
import { useState } from 'react'copy
```

The function body that defines the component begins with the function call:

```
const [ counter, setCounter ] = useState(0)copy
```

The function call adds _state_ to the component and renders it initialized with the value zero. The function returns an array that contains two items. We assign the items to the variables _counter_ and _setCounter_ by using the destructuring assignment syntax shown earlier.
The _counter_ variable is assigned the initial value of _state_ , which is zero. The variable _setCounter_ is assigned a function that will be used to _modify the state_.
The application calls the

```
setTimeout(
  () => setCounter(counter + 1),
  1000
)copy
```

The function passed as the first parameter to the _setTimeout_ function is invoked one second after calling the _setTimeout_ function

```
() => setCounter(counter + 1)copy
```

When the state modifying function _setCounter_ is called, _React re-renders the component_ which means that the function body of the component function gets re-executed:

```
() => {
  const [ counter, setCounter ] = useState(0)

  setTimeout(
    () => setCounter(counter + 1),
    1000
  )

  return (
    <div>{counter}</div>
  )
}copy
```

The second time the component function is executed it calls the _useState_ function and returns the new value of the state: 1. Executing the function body again also makes a new function call to _setTimeout_ , which executes the one-second timeout and increments the _counter_ state again. Because the value of the _counter_ variable is 1, incrementing the value by 1 is essentially the same as an expression setting the value of _counter_ to 2.

```
() => setCounter(2)copy
```

Meanwhile, the old value of _counter_ - "1" - is rendered to the screen.
Every time the _setCounter_ modifies the state it causes the component to re-render. The value of the state will be incremented again after one second, and this will continue to repeat for as long as the application is running.
If the component doesn't render when you think it should, or if it renders at the "wrong time", you can debug the application by logging the values of the component's variables to the console. If we make the following additions to our code:

```
const App = () => {
  const [ counter, setCounter ] = useState(0)

  setTimeout(
    () => setCounter(counter + 1),
    1000
  )

  console.log('rendering...', counter)
  return (
    <div>{counter}</div>
  )
}copy
```

It's easy to follow and track the calls made to the _App_ component's render function:
![screenshot of rendering log on dev tools](../assets/ccffd337b4a9a3bf.png)
Was your browser console open? If it wasn't, then promise that this was the last time you need to be reminded about it.
### Event handling
We have already mentioned the _event handlers_ that are registered to be called when specific events occur a few times in [part 0](../part0/01-part0.md). A user's interaction with the different elements of a web page can cause a collection of various kinds of events to be triggered.
Let's change the application so that increasing the counter happens when a user clicks a button, which is implemented with the
Button elements support so-called _mouse event_.
In React, _click_ event happens like this:

```
const App = () => {
  const [ counter, setCounter ] = useState(0)

  const handleClick = () => {    console.log('clicked')  }
  return (
    <div>
      <div>{counter}</div>
      <button onClick={handleClick}>        plus      </button>    </div>
  )
}copy
```

We set the value of the button's _onClick_ attribute to be a reference to the _handleClick_ function defined in the code.
Now every click of the _plus_ button causes the _handleClick_ function to be called, meaning that every click event will log a _clicked_ message to the browser console.
The event handler function can also be defined directly in the value assignment of the onClick-attribute:

```
const App = () => {
  const [ counter, setCounter ] = useState(0)

  return (
    <div>
      <div>{counter}</div>
      <button onClick={() => console.log('clicked')}>        plus
      </button>
    </div>
  )
}copy
```

By changing the event handler to the following form

```
<button onClick={() => setCounter(counter + 1)}>
  plus
</button>copy
```

we achieve the desired behavior, meaning that the value of _counter_ is increased by one _and_ the component gets re-rendered.
Let's also add a button for resetting the counter:

```
const App = () => {
  const [ counter, setCounter ] = useState(0)

  return (
    <div>
      <div>{counter}</div>
      <button onClick={() => setCounter(counter + 1)}>
        plus
      </button>
      <button onClick={() => setCounter(0)}>         zero      </button>    </div>
  )
}copy
```

Our application is now ready!
### An event handler is a function
We define the event handlers for our buttons where we declare their _onClick_ attributes:

```
<button onClick={() => setCounter(counter + 1)}> 
  plus
</button>copy
```

What if we tried to define the event handlers in a simpler form?

```
<button onClick={setCounter(counter + 1)}> 
  plus
</button>copy
```

This would completely break our application:
![screenshot of re-renders error](../assets/73f3c922859ef532.png)
What's going on? An event handler is supposed to be either a _function_ or a _function reference_ , and when we write:

```
<button onClick={setCounter(counter + 1)}>copy
```

the event handler is actually a _function call_. In many situations this is ok, but not in this particular situation. In the beginning, the value of the _counter_ variable is 0. When React renders the component for the first time, it executes the function call _setCounter(0+1)_ , and changes the value of the component's state to 1. This will cause the component to be re-rendered, React will execute the setCounter function call again, and the state will change leading to another re-render...
Let's define the event handlers like we did before:

```
<button onClick={() => setCounter(counter + 1)}> 
  plus
</button>copy
```

Now the button's attribute which defines what happens when the button is clicked - _onClick_ - has the value _() = > setCounter(counter + 1)_. The setCounter function is called only when a user clicks the button.
Usually defining event handlers within JSX-templates is not a good idea. Here it's ok, because our event handlers are so simple.
Let's separate the event handlers into separate functions anyway:

```
const App = () => {
  const [ counter, setCounter ] = useState(0)

  const increaseByOne = () => setCounter(counter + 1)  const setToZero = () => setCounter(0)
  return (
    <div>
      <div>{counter}</div>
      <button onClick={increaseByOne}>        plus
      </button>
      <button onClick={setToZero}>        zero
      </button>
    </div>
  )
}copy
```

Here, the event handlers have been defined correctly. The value of the _onClick_ attribute is a variable containing a reference to a function:

```
<button onClick={increaseByOne}> 
  plus
</button>copy
```

### Passing state - to child components
It's recommended to write React components that are small and reusable across the application and even across projects. Let's refactor our application so that it's composed of three smaller components, one component for displaying the counter and two components for buttons.
Let's first implement a _Display_ component that's responsible for displaying the value of the counter.
One best practice in React is to
> _Often, several components need to reflect the same changing data. We recommend lifting the shared state up to their closest common ancestor._
So let's place the application's state in the _App_ component and pass it down to the _Display_ component through _props_ :

```
const Display = (props) => {
  return (
    <div>{props.counter}</div>
  )
}copy
```

Using the component is straightforward, as we only need to pass the state of the _counter_ to it:

```
const App = () => {
  const [ counter, setCounter ] = useState(0)

  const increaseByOne = () => setCounter(counter + 1)
  const setToZero = () => setCounter(0)

  return (
    <div>
      <Display counter={counter}/>      <button onClick={increaseByOne}>
        plus
      </button>
      <button onClick={setToZero}> 
        zero
      </button>
    </div>
  )
}copy
```

Everything still works. When the buttons are clicked and the _App_ gets re-rendered, all of its children including the _Display_ component are also re-rendered.
Next, let's make a _Button_ component for the buttons of our application. We have to pass the event handler as well as the title of the button through the component's props:

```
const Button = (props) => {
  return (
    <button onClick={props.onClick}>
      {props.text}
    </button>
  )
}copy
```

Our _App_ component now looks like this:

```
const App = () => {
  const [ counter, setCounter ] = useState(0)

  const increaseByOne = () => setCounter(counter + 1)
  const decreaseByOne = () => setCounter(counter - 1)  const setToZero = () => setCounter(0)

  return (
    <div>
      <Display counter={counter}/>
      <Button        onClick={increaseByOne}        text='plus'      />      <Button        onClick={setToZero}        text='zero'      />           <Button        onClick={decreaseByOne}        text='minus'      />               </div>
  )
}copy
```

Since we now have an easily reusable _Button_ component, we've also implemented new functionality into our application by adding a button that can be used to decrement the counter.
The event handler is passed to the _Button_ component through the _onClick_ prop. When creating your own components, you can theoretically choose the prop name freely. However, our naming choice for the event handler was not entirely arbitrary.
React's own official _onSomething_ names for props which take functions which handle events and _handleSomething_ for the actual function definitions which handle those events."
### Changes in state cause re-rendering
Let's go over the main principles of how an application works once more.
When the application starts, the code in _App_ is executed. This code uses a _counter_. This component contains the _Display_ component - which displays the counter's value, 0 - and three _Button_ components. The buttons all have event handlers, which are used to change the state of the counter.
When one of the buttons is clicked, the event handler is executed. The event handler changes the state of the _App_ component with the _setCounter_ function. **Calling a function that changes the state causes the component to re-render.**
So, if a user clicks the _plus_ button, the button's event handler changes the value of _counter_ to 1, and the _App_ component is re-rendered. This causes its subcomponents _Display_ and _Button_ to also be re-rendered. _Display_ receives the new value of the counter, 1, as props. The _Button_ components receive event handlers which can be used to change the state of the counter.
To be sure to understand how the program works, let us add some _console.log_ statements to it

```
const App = () => {
  const [counter, setCounter] = useState(0)
  console.log('rendering with counter value', counter)
  const increaseByOne = () => {
    console.log('increasing, value before', counter)    setCounter(counter + 1)
  }

  const decreaseByOne = () => { 
    console.log('decreasing, value before', counter)    setCounter(counter - 1)
  }

  const setToZero = () => {
    console.log('resetting to zero, value before', counter)    setCounter(0)
  }

  return (
    <div>
      <Display counter={counter} />
      <Button onClick={increaseByOne} text="plus" />
      <Button onClick={setToZero} text="zero" />
      <Button onClick={decreaseByOne} text="minus" />
    </div>
  )
} copy
```

Let us now see what gets rendered to the console when the buttons plus, zero and minus are pressed:
![browser showing console with rendering values highlighted](../assets/24352e26096626cc.png)
Do not ever try to guess what your code does. It is just better to use _console.log_ and _see with your own eyes_ what it does.
### Refactoring the components
The component displaying the value of the counter is as follows:

```
const Display = (props) => {
  return (
    <div>{props.counter}</div>
  )
}copy
```

The component only uses the _counter_ field of its _props_. This means we can simplify the component by using [destructuring](../part1/01-component-state-event-handlers-destructuring.md), like so:

```
const Display = ({ counter }) => {
  return (
    <div>{counter}</div>
  )
}copy
```

The function defining the component contains only the return statement, so we can define the function using the more compact form of arrow functions:

```
const Display = ({ counter }) => <div>{counter}</div>copy
```

We can simplify the Button component as well.

```
const Button = (props) => {
  return (
    <button onClick={props.onClick}>
      {props.text}
    </button>
  )
}copy
```

We can use destructuring to get only the required fields from _props_ , and use the more compact form of arrow functions:

```
const Button = ({ onClick, text }) => <button onClick={onClick}>{text}</button>copy
```

This approach works because the component contains only a single return statement, making it possible to use the concise arrow function syntax.
[Part 1b **Previous part**](../part1/01-java-script.md)[Part 1d **Next part**](../part1/01-a-more-complex-state-debugging-react-apps.md)
[About course](../about/01-about.md)[Course contents](../#course-contents/01-course-contents.md)[FAQ](../faq/01-faq.md)[Partners](../companies/01-companies.md)[Challenge](../challenge/01-challenge.md)


## Links discovered
- [Skip to content](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-course-main-content.md)
- [{() => fs}](https://fullstackopen.com/en/)
- [About course](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/about/01-about.md)
- [Course contents](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [FAQ](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/faq/01-faq.md)
- [Partners](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/companies/01-companies.md)
- [Challenge](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/challenge/01-challenge.md)
- [Search from the material](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/search/01-search.md)
- [Fullstack](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/#course-contents/01-course-contents.md)
- [Part 1](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-part1.md)
- [a Introduction to React](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-introduction-to-react.md)
- [b JavaScript](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-java-script.md)
- [Component helper functions](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-component-helper-functions.md)
- [Destructuring](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-destructuring.md)
- [Page re-rendering](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-page-re-rendering.md)
- [Stateful component](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-stateful-component.md)
- [Event handling](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-event-handling.md)
- [An event handler is a function](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-an-event-handler-is-a-function.md)
- [Passing state - to child components](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-passing-state-to-child-components.md)
- [Changes in state cause re-rendering](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-changes-in-state-cause-re-rendering.md)
- [Refactoring the components](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-refactoring-the-components.md)
- [d A more complex state, debugging React apps](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps.md)
- [screenshot of rendering log on dev tools](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/ccffd337b4a9a3bf.png)
- [part 0](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part0/01-part0.md)
- [screenshot of re-renders error](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/73f3c922859ef532.png)
- [browser showing console with rendering values highlighted](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/assets/24352e26096626cc.png)
- [destructuring](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-component-state-event-handlers-destructuring.md)
- [Part 1b **Previous part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-java-script.md)
- [Part 1d **Next part**](https://github.com/AcidicSoil/crawlFullStack/blob/main/.archived/data/part1/01-a-more-complex-state-debugging-react-apps.md)

--- src/seeds.txt ---
https://ui.shadcn.com/docs/directory 

--- src/fullstackopen_en_repo/crawl_fullstackopen.py ---
from __future__ import annotations

import asyncio
import hashlib
import json
import os
import re
import subprocess
import time
from dataclasses import dataclass
from pathlib import Path
from typing import Any, Dict, Literal, Tuple

import requests
import typer
import yaml
from bs4 import BeautifulSoup, Tag
from crawl4ai import AsyncWebCrawler  # type: ignore[import-untyped]
from crawl4ai.async_configs import (  # type: ignore[import-untyped]
    BrowserConfig,
    CrawlerRunConfig,
)
from crawl4ai.markdown_generation_strategy import (  # type: ignore[import-untyped]
    DefaultMarkdownGenerator,
)
from rich import print

from .indexing import write_index
from .link_rewriter import rewrite_markdown_links
from .markdown_utils import split_frontmatter
from .profiles import GenericSiteProfile, SiteProfile, load_profile

APP = typer.Typer(add_completion=False)
ROOT = Path(__file__).resolve().parents[2]
DATA_DIR = ROOT / "data"
LOG_DIR = ROOT / "logs"
CONFIG_PATH = ROOT / "crawl.config.yml"

# Crawl4AI writes robots cache into ~/.crawl4ai by default. That location can be
# read-only in sandboxed environments, so redirect into the project tree unless
# the caller already set a base directory.
os.environ.setdefault("CRAWL4_AI_BASE_DIRECTORY", str(ROOT))

UA_DEFAULT = "Mozilla/5.0 (compatible; FullstackOpenMirror/1.0; +https://example.invalid/personal-use)"
LinkRewriteMode = Literal["none", "local"]
FrontmatterMode = Literal["metadata", "simple"]
BrowserMode = Literal["headless", "managed", "builtin"]

# Shared global to avoid repeating downloads; tests can patch installer.
PLAYWRIGHT_INSTALL_CMD = ["playwright", "install", "chromium"]


@dataclass
class CrawlItem:
    url: str
    depth: int


def load_yaml(path: Path) -> dict:
    with open(path, "r", encoding="utf-8") as f:
        return yaml.safe_load(f) or {}


def load_config() -> dict:
    if not CONFIG_PATH.exists():
        return {}
    return load_yaml(CONFIG_PATH)


def _extract_href(value: Any) -> str | None:
    if isinstance(value, str):
        return value
    return None


def discover_children(html: str, base_url: str, profile: SiteProfile) -> list[str]:
    soup = BeautifulSoup(html, "lxml")
    children: set[str] = set()
    for a in soup.select("a[href]"):
        raw = _extract_href(a.get("href"))
        if not raw:
            continue
        href = raw.strip()
        if not href or href.startswith("#"):
            continue
        absolute = profile.to_absolute(href, base_url)
        normalized = profile.normalize_url(absolute)
        if profile.should_enqueue(normalized):
            children.add(normalized)
    
    # Custom extraction for Smithery skills
    if profile.id == "smithery":
        for div in soup.select("div.cursor-pointer"):
            handle_div = div.select_one(".text-muted-foreground.text-sm.truncate")
            if handle_div and handle_div.text and "/" in handle_div.text:
                handle = handle_div.text.strip()
                skill_url = f"https://smithery.ai/skills/{handle}"
                normalized = profile.normalize_url(skill_url)
                if profile.should_enqueue(normalized):
                    children.add(normalized)

    return sorted(children)

def extract_github_source(html: str) -> str | None:
    if not html:
        return None
    soup = BeautifulSoup(html, "lxml")
    link = soup.select_one("a[href^='https://github.com/']")
    href = link.get("href") if link else None
    return href.strip() if href else None


def write_text(path: Path, text: str) -> None:
    path.parent.mkdir(parents=True, exist_ok=True)
    path.write_text(text, encoding="utf-8")


def append_text(path: Path, text: str) -> None:
    path.parent.mkdir(parents=True, exist_ok=True)
    with open(path, "a", encoding="utf-8") as handle:
        handle.write(text)


def write_json(path: Path, payload: dict) -> None:
    path.parent.mkdir(parents=True, exist_ok=True)
    path.write_text(json.dumps(payload, ensure_ascii=False, indent=2), encoding="utf-8")


def sha256(s: str) -> str:
    return hashlib.sha256(s.encode("utf-8")).hexdigest()


def load_existing_metadata(profile: SiteProfile) -> Dict[str, Tuple[Path, str | None]]:
    mapping: Dict[str, Tuple[Path, str | None]] = {}
    root = profile.output_root
    if not root.exists():
        return mapping
    for path in root.rglob("*.md"):
        try:
            text = path.read_text(encoding="utf-8")
        except OSError:
            continue
        meta, _, _ = split_frontmatter(text)
        source = meta.get("source_url")
        if not source:
            continue
        canonical = profile.normalize_url(str(source))
        if not profile.in_scope(canonical):
            continue
        mapping[canonical] = (path, meta.get("checksum"))
    return mapping


async def crawl_once(
    url: str,
    browser_cfg: BrowserConfig,
    run_cfg: CrawlerRunConfig,
    profile: SiteProfile,
) -> dict[str, Any]:
    async with AsyncWebCrawler(config=browser_cfg, base_directory=str(ROOT)) as crawler:
        result = await crawler.arun(url=url, config=run_cfg)

    if not getattr(result, "success", True):
        raise RuntimeError(
            f"crawl failed {url}: {getattr(result, 'error_message', 'unknown error')}"
        )

    md_obj = getattr(result, "markdown", None)
    raw_candidate = getattr(md_obj, "raw_markdown", None) if md_obj else None
    fit_candidate = getattr(md_obj, "fit_markdown", None) if md_obj else None
    base_md = raw_candidate or fit_candidate or (md_obj if isinstance(md_obj, str) else "")
    html = getattr(result, "html", "") or ""

    title = None
    for line in base_md.splitlines() if isinstance(base_md, str) else []:
        if line.startswith("# "):
            title = line[2:].strip()
            break
    if not title:
        dom = BeautifulSoup(html, "lxml") if html else None
        title = (
            getattr(result, "title", None)
            or (dom.title.string if dom and dom.title else "")
            or "untitled"
        ).strip()

    children: set[str] = set()

    def consider(href: str | None) -> None:
        if not href:
            return
        absolute = profile.to_absolute(href, url)
        normalized = profile.normalize_url(absolute)
        if profile.should_enqueue(normalized):
            children.add(normalized)

    links = getattr(result, "links", None)
    if links and isinstance(links, dict):
        for link in links.get("internal") or []:
            consider(_extract_href(link.get("href")))

    if not children and html:
        soup = BeautifulSoup(html, "lxml")
        for a in soup.select("a[href]"):
            consider(_extract_href(a.get("href")))
            
        if profile.id == "smithery":
            for div in soup.select("div.cursor-pointer"):
                handle_div = div.select_one(".text-muted-foreground.text-sm.truncate")
                if handle_div and handle_div.text and "/" in handle_div.text:
                    handle = handle_div.text.strip()
                    skill_url = f"https://smithery.ai/skill/{handle}"
                    normalized = profile.normalize_url(skill_url)
                    if profile.should_enqueue(normalized):
                        children.add(normalized)

    return {
        "raw_markdown": raw_candidate or (base_md if isinstance(base_md, str) else ""),
        "fit_markdown": fit_candidate or "",
        "html": html,
        "title": title,
        "children": sorted(children),
        "links": links or {},
        "media": sanitize_media_list(getattr(result, "media", []) or []),
    }


def build_run_config(
    cfg: dict,
    profile: SiteProfile,
    *, browser_mode: BrowserMode
) -> tuple[BrowserConfig, CrawlerRunConfig]:
    ua = cfg.get("user_agent", UA_DEFAULT)
    browser_kwargs: dict[str, Any] = {
        "user_agent": ua,
        "verbose": False,
    }
    if browser_mode == "managed":
        browser_kwargs.update({"browser_mode": "managed"})
    elif browser_mode == "builtin":
        browser_kwargs.update(
            {
                "browser_mode": "builtin",
                "use_managed_browser": True,
            }
        )
    else:
        browser_kwargs.setdefault("headless", True)
    browser = BrowserConfig(**browser_kwargs)
    mdgen = DefaultMarkdownGenerator(
        options={"preserve_links": True, "code_fences": True}
    )

    def _normalize_selectors(value: Any) -> str | None:
        if not value:
            return None
        if isinstance(value, str):
            return value
        if isinstance(value, (list, tuple)):
            joined = ",".join(str(v) for v in value if v)
            return joined or None
        return None

    keep_sel = _normalize_selectors(
        profile.content_selectors or cfg.get("content", {}).get("keep_selectors")
    )
    drop_sel = _normalize_selectors(
        profile.remove_selectors or cfg.get("content", {}).get("drop_selectors", [])
    )
    wait_for = None
    wait_for_timeout = None
    delay_before_return_html = cfg.get("timeouts", {}).get("post_render_delay_s", 0.1)
    if profile.id == "smithery":
        # Smithery skill detail pages are client-rendered; wait for GitHub link or allow list page.
        wait_for = (
            "js:() => window.location.pathname === '/skills' || "
            "!!document.querySelector(\"a[href^='https://github.com/']\")"
        )
        wait_for_timeout = 20000
        delay_before_return_html = max(delay_before_return_html, 1.5)

    run = CrawlerRunConfig(
        markdown_generator=mdgen,
        css_selector=keep_sel,
        excluded_selector=drop_sel,
        wait_until="domcontentloaded",
        page_timeout=cfg.get("timeouts", {}).get("page_ms", 60000),
        wait_for=wait_for,
        wait_for_timeout=wait_for_timeout,
        delay_before_return_html=delay_before_return_html,
        mean_delay=cfg.get("rate_limits", {}).get("mean_delay", 0.25),
        max_range=cfg.get("rate_limits", {}).get("jitter_seconds", [0.3, 1.0])[1],
        semaphore_count=min(int(cfg.get("max_concurrency", 3)), 4),
        check_robots_txt=True,
        exclude_external_links=True,
        
    )
    return browser, run


def needs_playwright_install(exc: Exception) -> bool:
    message = str(exc).lower()
    triggers = [
        "executable doesn't exist",
        "playwright install",
        "looks like playwright was just installed",
        "browsertype.launch",
        "chromium"
    ]
    return any(trigger in message for trigger in triggers)

def install_playwright_browsers() -> None:
    print("[yellow]Installing Playwright Chromium (first run may take a minute)...[/yellow]")
    subprocess.run(PLAYWRIGHT_INSTALL_CMD, check=True)

def run_crawl_with_retry(
    url: str,
    browser_cfg: BrowserConfig,
    run_cfg: CrawlerRunConfig,
    profile: SiteProfile,
    installer: Any | None = None,
    crawler: Any | None = None,
) -> tuple[str, str, str, list[str]]:
    attempted_install = False
    crawler_fn = crawler or crawl_once
    installer_fn = installer or install_playwright_browsers
    while True:
        try:
            result = crawler_fn(url, browser_cfg, run_cfg, profile)
            if asyncio.iscoroutine(result):  # pragma: no cover - actual crawler is async
                return asyncio.run(result)
            return result
        except Exception as exc:  # pragma: no cover - retries handled in tests
            if not attempted_install and needs_playwright_install(exc):
                attempted_install = True
                installer_fn()
                continue
            raise

def frontmatter(
    title: str,
    source_url: str,
    content_md: str,
    checksum: str | None = None,
    *,
    doc_id: str = "",
    mode: FrontmatterMode = "metadata",
) -> str:
    ts = time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime())
    checksum_value = checksum or sha256(content_md)
    if mode == "simple":
        lines = [
            "---",
            f"id: {doc_id}",
            f"title: {title or ''}",
            f"source_url: {source_url}",
            f"crawl_timestamp: {ts}",
            f"checksum: {checksum_value}",
            "---",
            "",
        ]
        return "\n".join(lines)

    fm = {
        "title": title,
        "source_url": source_url,
        "crawl_timestamp": ts,
        "checksum": checksum_value,
    }
    return "---" + json.dumps(fm, ensure_ascii=False, indent=2) + "---"

def relative_asset_href(out_path: Path, asset_path: Path) -> str:
    rel = os.path.relpath(asset_path, out_path.parent)
    return Path(rel).as_posix()

def resolve_asset_dir(profile: SiteProfile) -> Path:
    subdir = Path(profile.asset_subdir)
    if not subdir.is_absolute():
        return ROOT / subdir
    return subdir

def download_images(md: str, out_path: Path, asset_dir: Path) -> tuple[str, list[str]]:
    written: list[str] = []
    asset_dir.mkdir(parents=True, exist_ok=True)

    def repl(match: re.Match[str]) -> str:
        alt, src = match.group(1), match.group(2)
        if not src.lower().startswith("http"):
            return match.group(0)
        ext = os.path.splitext(src.split("?")[0])[1] or ".png"
        fname = sha256(src)[:16] + ext
        out = asset_dir / fname
        try:
            resp = requests.get(src, timeout=20)
            if resp.ok:
                out.write_bytes(resp.content)
                written.append(str(out))
                href = relative_asset_href(out_path, out)
                return f"![{alt}]({href})"
        except Exception:
            pass
        return match.group(0)

    # Fixed regex for image markdown
    new_md = re.sub(r'!\[([^\]]*)\]\(([^)]+)\)', repl, md)
    return new_md, written

def _to_serializable(value: Any) -> Any:
    if isinstance(value, dict):
        return {str(k): _to_serializable(v) for k, v in value.items()}
    if isinstance(value, (list, tuple, set)):
        return [_to_serializable(v) for v in value]
    if isinstance(value, (str, int, float, bool)) or value is None:
        return value
    return str(value)

def _sort_entries(entries: list[dict[str, Any]], key_candidates: tuple[str, ...]) -> list[dict[str, Any]]:
    def sort_key(item: dict[str, Any]) -> str:
        for candidate in key_candidates:
            val = item.get(candidate)
            if isinstance(val, str):
                return val
        return json.dumps(item, sort_keys=True)

    return sorted(entries, key=sort_key)

def sanitize_links_map(data: Any) -> dict[str, list[dict[str, Any]]]:
    if not isinstance(data, dict):
        return {}
    sanitized: dict[str, list[dict[str, Any]]] = {}
    for key in sorted(data.keys()):
        entries = data[key]
        normalized: list[dict[str, Any]] = []
        if isinstance(entries, list):
            for item in entries:
                if isinstance(item, dict):
                    normalized.append(_to_serializable(item))
                else:
                    normalized.append({"value": _to_serializable(item)})
        sanitized[key] = _sort_entries(normalized, ("href", "url", "value"))
    return sanitized

def sanitize_media_list(data: Any) -> list[dict[str, Any]]:
    if not isinstance(data, list):
        return []
    normalized: list[dict[str, Any]] = []
    for item in data:
        if isinstance(item, dict):
            normalized.append(_to_serializable(item))
        else:
            normalized.append({"value": _to_serializable(item)})
    return _sort_entries(normalized, ("src", "url", "value"))

def extract_main_html(html: str, profile: SiteProfile) -> str:
    if not html:
        return ""
    soup = BeautifulSoup(html, "lxml")
    for selector in profile.remove_selectors:
        for node in soup.select(selector):
            node.decompose()
    keepers: list[Tag] = []
    for selector in profile.content_selectors:
        keepers.extend(soup.select(selector))
    if keepers:
        return "\n".join(str(node) for node in keepers)
    return html


@APP.command()
def main(
    fresh: bool = typer.Option(
        False, "--fresh", help="Ignore cache and rewrite outputs"
    ),
    since: str | None = typer.Option(
        None, "--since", help="Only re-crawl pages updated since date (YYYY-MM-DD)"
    ),
    dry_run: bool = typer.Option(
        False, "--dry-run", help="Plan only; do not fetch or write"
    ),
    save_html: bool = typer.Option(
        False, "--save-html", help="Store raw HTML next to Markdown"
    ),
    site: str = typer.Option(
        "fullstackopen", "--site", help="Site profile id to crawl"
    ),
    rewrite_links: LinkRewriteMode = typer.Option(
        "none",
        "--rewrite-links",
        case_sensitive=False,
        help="Rewrite internal links: 'local' rewrites to relative paths",
    ),
    depth_limit: int | None = typer.Option(
        None,
        "--depth-limit",
        help="Override crawl depth limit (defaults to profile setting)",
    ),
    seed: str | None = typer.Option(
        None,
        "--seed",
        help="Seed URL to enable generic crawl mode",
    ),
    allow_external: bool = typer.Option(
        False,
        "--allow-external",
        help="Permit crawling outside the seed domain when in generic mode",
    ),
    scope_prefix: str | None = typer.Option(
        None,
        "--scope-prefix",
        help="Restrict generic mode to URLs under this path prefix",
    ),
    keep_selector: list[str] = typer.Option(
        None,
        "--keep-selector",
        help="CSS selector to keep (repeatable)",
    ),
    drop_selector: list[str] = typer.Option(
        None,
        "--drop-selector",
        help="CSS selector to drop (repeatable)",
    ),
    include_assets: bool = typer.Option(
        True,
        "--include-assets/--no-include-assets",
        help="Download remote images when scraping",
    ),
    browser_mode: BrowserMode = typer.Option(
        "headless",
        "--browser-mode",
        case_sensitive=False,
        help="Browser strategy: headless (default), managed, or builtin (persistent)",
    ),
    fit_markdown: bool = typer.Option(
        False,
        "--fit-markdown",
        help="Store Crawl4AI fit_markdown alongside raw markdown",
    ),
    emit_linkmap: bool = typer.Option(
        False,
        "--emit-linkmap",
        help="Write per-document link/media metadata JSON",
    ),
    frontmatter_template: FrontmatterMode = typer.Option(
        "metadata",
        "--frontmatter-template",
        case_sensitive=False,
        help="Frontmatter format: 'metadata' JSON (default) or 'simple' YAML id/title style",
    ),
):
    cfg = load_config()
    if fresh:
        print(
            "[yellow]--fresh flag is not implemented; continuing with existing outputs[/yellow]"
        )
    if since:
        print("[yellow]--since filter is not implemented; crawling all pages[/yellow]")
    DATA_DIR.mkdir(parents=True, exist_ok=True)
    LOG_DIR.mkdir(parents=True, exist_ok=True)

    profile: SiteProfile
    if seed:
        profile = GenericSiteProfile(
            seed_url=seed,
            output_root=DATA_DIR,
            output_subdir=site if site and site != "generic" else "generic",
            profile_id=site or "generic",
            max_depth=depth_limit or 3,
            include_assets=include_assets,
            asset_subdir=f"assets/{site or 'generic'}",
            allow_external=allow_external,
            scope_prefix=scope_prefix,
            keep_selectors=keep_selector,
            drop_selectors=drop_selector,
        )
    else:
        profile = load_profile(site, output_root=DATA_DIR)
    asset_dir = resolve_asset_dir(profile)
    asset_dir.mkdir(parents=True, exist_ok=True)
    existing_meta = load_existing_metadata(profile) if not fresh else {}
    depth_limit = depth_limit or profile.default_max_depth
    cfg_for_browser = dict(cfg)
    cfg_for_browser["browser_mode"] = browser_mode
    browser_cfg, run_cfg = build_run_config(cfg_for_browser, profile, browser_mode=browser_mode)

    queue: list[CrawlItem] = []
    seen: set[str] = set()
    for seed in profile.start_urls:
        normalized = profile.normalize_url(seed)
        if profile.in_scope(normalized):
            queue.append(CrawlItem(normalized, 0))

    planned: list[str] = []
    skipped_existing = 0

    while queue:
        item = queue.pop(0)
        normalized = profile.normalize_url(item.url)
        if normalized in seen or not profile.in_scope(normalized):
            continue
        seen.add(normalized)
        planned.append(normalized)

        if dry_run:
            continue

        try:
            crawl_payload = run_crawl_with_retry(
                normalized, browser_cfg, run_cfg, profile
            )
        except Exception as exc:
            append_text(LOG_DIR / "errors.log", f"{normalized}\t{exc}\n")
            continue

        raw_md = crawl_payload.get("raw_markdown") or ""
        fit_md_payload = crawl_payload.get("fit_markdown") or ""
        html = crawl_payload.get("html") or ""
        title = crawl_payload.get("title") or ""
        children = crawl_payload.get("children") or []
        links_payload = sanitize_links_map(crawl_payload.get("links"))
        media_payload = sanitize_media_list(crawl_payload.get("media"))

        content_md = raw_md.strip() if isinstance(raw_md, str) else ""
        html_main = extract_main_html(html, profile)
        out_path = profile.derive_output_path(normalized, title=title)

        if profile.id == "smithery" and html_main:
            github_url = extract_github_source(html_main)
            if github_url and "github.com" not in content_md:
                if "Source:" in content_md:
                    content_md = content_md.rstrip() + f"\n{github_url}\n"
                else:
                    content_md = content_md.rstrip() + f"\n\nSource: {github_url}\n"

        if profile.download_images and content_md:
            content_md, _ = download_images(content_md, out_path, asset_dir)

        rewritten = rewrite_markdown_links(
            content_md,
            mode=rewrite_links,
            profile=profile,
            from_url=normalized,
        )

        new_checksum = sha256(rewritten)
        if not fresh:
            existing_info = existing_meta.get(normalized)
            if existing_info and existing_info[1] == new_checksum:
                skipped_existing += 1
                continue

        rel_doc_id = ""
        try:
            rel_doc_id = out_path.relative_to(profile.output_root).as_posix()
        except ValueError:
            rel_doc_id = out_path.as_posix()

        body = (
            frontmatter(
                title,
                normalized,
                rewritten,
                checksum=new_checksum,
                doc_id=rel_doc_id,
                mode=frontmatter_template,
            )
            + rewritten
        )
        if save_html:
            write_text(out_path.with_suffix(".html"), html_main)
        write_text(out_path, body)
        existing_meta[normalized] = (out_path, new_checksum)

        if fit_markdown and isinstance(fit_md_payload, str) and fit_md_payload.strip():
            fit_content = fit_md_payload.strip()
            fit_rewritten = rewrite_markdown_links(
                fit_content,
                mode=rewrite_links,
                profile=profile,
                from_url=normalized,
            )
            fit_checksum = sha256(fit_rewritten)
            fit_doc_id = f"{rel_doc_id}.fit" if rel_doc_id else ""
            fit_body = (
                frontmatter(
                    title,
                    normalized,
                    fit_rewritten,
                    checksum=fit_checksum,
                    doc_id=fit_doc_id,
                    mode=frontmatter_template,
                )
                + fit_rewritten
            )
            fit_path = out_path.parent / f"{out_path.stem}.fit.md"
            write_text(fit_path, fit_body)

        if emit_linkmap and (links_payload or media_payload):
            metadata_payload = {
                "source_url": normalized,
                "links": links_payload,
                "media": media_payload,
            }
            meta_path = out_path.with_suffix(out_path.suffix + ".links.json")
            write_json(meta_path, metadata_payload)

        if item.depth < depth_limit:
            kids = set(children or [])
            kids.update(discover_children(html, normalized, profile))
            for child in sorted(kids):
                if child not in seen and profile.should_enqueue(child):
                    queue.append(CrawlItem(child, item.depth + 1))

    write_index(DATA_DIR, ROOT / "index.json")

    print(
        {
            "planned": len(planned),
            "written_md": len(list(DATA_DIR.rglob("*.md"))),
            "assets": len(list(asset_dir.glob("*"))),
            "skipped_existing": skipped_existing,
        }
    )


if __name__ == "__main__":
    APP()


## Links discovered
- [{alt}](https://github.com/AcidicSoil/crawlFullStack/blob/main/src/fullstackopen_en_repo/{href}.md)

--- src/fullstackopen_en_repo/indexing.py ---
from __future__ import annotations

import json
from pathlib import Path
from typing import Dict

from .markdown_utils import split_frontmatter


def build_index_map(data_dir: Path) -> Dict[str, dict[str, str]]:
    index: Dict[str, dict[str, str]] = {}
    for path in data_dir.rglob("*.md"):
        rel = path.relative_to(data_dir).as_posix()
        meta, _, _ = split_frontmatter(path.read_text(encoding="utf-8"))
        index[rel] = {"title": meta.get("title", path.stem), "path": rel}
    return index


def write_index(data_dir: Path, output_path: Path) -> None:
    index = build_index_map(data_dir)
    output_path.write_text(
        json.dumps(index, ensure_ascii=False, indent=2), encoding="utf-8"
    )


__all__ = ["build_index_map", "write_index"]


--- src/fullstackopen_en_repo/__init__.py ---


--- src/webcrawl/__init__.py ---
"""Public API for the generic crawl engine."""

from .crawl.engine import crawl_once, run_crawl
from .crawl.run_config import build_run_config
from .config.runtime import GenericCrawlerConfig

__all__ = [
    "crawl_once",
    "run_crawl",
    "build_run_config",
    "GenericCrawlerConfig",
]


--- src/fullstackopen_en_repo/link_rewriter.py ---
from __future__ import annotations

import re
from typing import Literal

from .profiles import SiteProfile

LINK_RE = re.compile(r"\[([^\]]+)\]\(([^)]+)\)")


def rewrite_markdown_links(
    markdown: str,
    *,
    mode: Literal["none", "local"],
    profile: SiteProfile,
    from_url: str,
) -> str:
    """Rewrite markdown links according to the chosen mode."""

    if mode == "none":
        return markdown

    def repl(match: re.Match[str]) -> str:
        text, href = match.group(1), match.group(2)
        absolute = profile.to_absolute(href, from_url)
        if not profile.is_internal_link(absolute):
            return match.group(0)
        rel = profile.map_url_to_relpath(from_url, absolute)
        return f"[{text}]({rel})"

    return LINK_RE.sub(repl, markdown)


__all__ = ["rewrite_markdown_links"]


## Links discovered
- [{text}](https://github.com/AcidicSoil/crawlFullStack/blob/main/src/fullstackopen_en_repo/{rel}.md)

--- src/fullstackopen_en_repo/linkcheck.py ---
from __future__ import annotations

from pathlib import Path

import typer
from rich import print

from .link_rewriter import LINK_RE
from .markdown_utils import split_frontmatter
from .profiles import load_profile

APP = typer.Typer(add_completion=False)
ROOT = Path(__file__).resolve().parents[1]
DATA_DIR = ROOT / "data"


@APP.command()
def main(
    site: str = typer.Option(
        "fullstackopen", "--site", help="Site profile id to check"
    ),
):
    profile = load_profile(site, output_root=DATA_DIR)
    broken = 0

    for path in profile.output_root.rglob("*.md"):
        text = path.read_text(encoding="utf-8", errors="ignore")
        meta, body, _ = split_frontmatter(text)
        source_url = meta.get("source_url")
        if not source_url:
            continue
        base_url = profile.normalize_url(source_url)
        if not profile.in_scope(base_url):
            continue

        for match in LINK_RE.finditer(body):
            href = match.group(2)
            if href.startswith("mailto:") or href.startswith("tel:"):
                continue
            target_path: Path | None
            if href.startswith("http") or href.startswith("/"):
                absolute = profile.normalize_url(profile.to_absolute(href, base_url))
                if not profile.is_internal_link(absolute):
                    continue
                target_path = profile.derive_output_path(absolute)
            else:
                target_path = (path.parent / href).resolve()
            if not target_path.exists():
                print(f"[red]BROKEN[/red] {path.relative_to(ROOT)} -> {href}")
                broken += 1

    if broken:
        print(f"[red]broken links: {broken}[/red]")
        raise typer.Exit(code=1)
    print("[green]linkcheck ok[/green]")


if __name__ == "__main__":
    APP()


--- src/fullstackopen_en_repo/markdown_utils.py ---
from __future__ import annotations

import json
from typing import Any, Tuple

import yaml


def split_frontmatter(text: str) -> Tuple[dict[str, Any], str, str | None]:
    if not text.startswith("---"):
        return {}, text, None
    parts = text.split("---", 2)
    if len(parts) < 3:
        return {}, text, None
    raw_meta = parts[1]
    body = parts[2]
    try:
        meta = json.loads(raw_meta.strip())
    except Exception:
        try:
            loaded = yaml.safe_load(raw_meta)
        except Exception:
            loaded = None
        meta = loaded if isinstance(loaded, dict) else {}
    front_block = f"---{raw_meta}---"
    return meta, body, front_block


__all__ = ["split_frontmatter"]


--- src/fullstackopen_en_repo/postprocess.py ---
from __future__ import annotations

from pathlib import Path
from typing import Literal

import typer
from rich import print

from .indexing import write_index
from .link_rewriter import rewrite_markdown_links
from .markdown_utils import split_frontmatter
from .profiles import load_profile

APP = typer.Typer(add_completion=False)
ROOT = Path(__file__).resolve().parents[1]
DATA_DIR = ROOT / "data"
LinkRewriteMode = Literal["none", "local"]


@APP.command()
def main(
    site: str = typer.Option(
        "fullstackopen", "--site", help="Site profile id to postprocess"
    ),
    rewrite_links: LinkRewriteMode = typer.Option(
        "none",
        "--rewrite-links",
        case_sensitive=False,
        help="Rewrite internal links after crawl",
    ),
):
    profile = load_profile(site, output_root=DATA_DIR)
    rewritten = 0

    for path in profile.output_root.rglob("*.md"):
        text = path.read_text(encoding="utf-8")
        meta, body, front = split_frontmatter(text)
        source_url = meta.get("source_url")
        if not source_url:
            continue
        canonical_source = profile.normalize_url(source_url)
        if not profile.in_scope(canonical_source):
            continue
        new_body = body
        if rewrite_links == "local":
            new_body = rewrite_markdown_links(
                body,
                mode=rewrite_links,
                profile=profile,
                from_url=canonical_source,
            )
        if new_body != body:
            prefix = front or ""
            path.write_text(f"{prefix}{new_body}", encoding="utf-8")
            rewritten += 1

    write_index(profile.output_root, ROOT / "index.json")
    print({"rewritten": rewritten, "site": profile.id})


if __name__ == "__main__":
    APP()


--- src/webcrawl/profiles.py ---
"""Generic profile abstraction replacing bespoke per-site implementations."""

from __future__ import annotations

import os
from dataclasses import dataclass
from pathlib import Path
from typing import Iterable
from urllib.parse import urljoin, urlparse, urlunparse

from .config.runtime import GenericCrawlerConfig


def _sanitize_segment(segment: str) -> str:
    value = segment.strip().strip("/")
    if not value:
        return "index"
    return "".join(ch if ch.isalnum() or ch in "-_" else "-" for ch in value)


def _relative_path(from_path: Path, to_path: Path) -> str:
    rel = os.path.relpath(to_path, from_path.parent)
    return Path(rel).as_posix()


@dataclass
class GenericProfile:
    """Runtime profile derived from a GenericCrawlerConfig."""

    config: GenericCrawlerConfig
    output_root: Path

    @property
    def id(self) -> str:
        return self.config.id or "generic"

    @property
    def start_urls(self) -> list[str]:
        return [self.normalize_url(self.config.seed_url)]

    @property
    def default_max_depth(self) -> int:
        return self.config.max_depth

    @property
    def content_selectors(self) -> list[str]:
        return list(self.config.keep_selectors)

    @property
    def remove_selectors(self) -> list[str]:
        return list(self.config.drop_selectors)

    @property
    def asset_subdir(self) -> str:
        return self.config.asset_subdir

    @property
    def download_images(self) -> bool:
        return self.config.include_assets

    def normalize_url(self, url: str) -> str:
        parsed = urlparse(url)
        scheme = parsed.scheme or "https"
        host = parsed.hostname or ""
        path = parsed.path or "/"
        query = parsed.query if not self.config.strip_query else ""
        fragment = parsed.fragment if not self.config.strip_fragment else ""
        return urlunparse((scheme, host, path, "", query, fragment))

    def in_scope(self, url: str) -> bool:
        normalized = self.normalize_url(url)
        parsed = urlparse(normalized)
        if (
            not self.config.allow_external
            and parsed.hostname != urlparse(self.config.seed_url).hostname
        ):
            return False
        prefix = self._scope_prefix()
        if prefix:
            return (parsed.path or "/").startswith(prefix)
        return True

    def _scope_prefix(self) -> str:
        prefix = self.config.scope_prefix
        if prefix:
            value = prefix.strip()
            if not value.startswith("/"):
                value = "/" + value
            return value
        seed_path = urlparse(self.config.seed_url).path or "/"
        if seed_path.endswith("/"):
            return seed_path
        parent = seed_path.rsplit("/", 1)[0]
        if not parent:
            return ""
        if not parent.startswith("/"):
            parent = "/" + parent
        return parent

    def should_enqueue(self, url: str) -> bool:
        return self.in_scope(url)

    def derive_output_path(self, url: str) -> Path:
        normalized = self.normalize_url(url)
        parsed = urlparse(normalized)
        path = parsed.path or "/"
        segments = [_sanitize_segment(seg) for seg in path.split("/") if seg]
        base = self.output_root / self.config.output_subdir
        if not segments:
            return base / "index.md"
        if path.endswith("/"):
            return base.joinpath(*segments, "index.md")
        if len(segments) == 1:
            return base / f"{segments[0]}.md"
        return base.joinpath(*segments[:-1], f"{segments[-1]}.md")

    def to_absolute(self, href: str, from_url: str) -> str:
        if href.startswith("mailto:") or href.startswith("tel:"):
            return href
        if href.startswith("//"):
            parsed_from = urlparse(from_url)
            return f"{parsed_from.scheme}:{href}"
        return urljoin(from_url, href)

    def map_url_to_relpath(self, from_url: str, target_url: str) -> str:
        src = self.derive_output_path(from_url)
        dst = self.derive_output_path(target_url)
        return _relative_path(src, dst)


__all__ = ["GenericProfile"]


--- tests/test_config_site_profile.py ---
from pathlib import Path

from fullstackopen_en_repo.profiles.config_profile import ConfigSiteProfile

SAMPLE_CONFIG = {
    "id": "sample",
    "domains": ["example.com"],
    "entrypoints": ["https://example.com/root"],
    "default_max_depth": 2,
    "scope": {
        "allow": [r"^/root(/.*)?$"],
        "strip_prefix": "/root",
        "canonical_host": "example.com",
        "canonical_scheme": "https",
    },
    "output": {
        "site_dir": "example",
        "root_index": "index.md",
        "section_index": "index.md",
        "leaf_extension": ".md",
    },
}


def test_config_profile_output(tmp_path: Path) -> None:
    profile = ConfigSiteProfile(SAMPLE_CONFIG, tmp_path)
    normalized = profile.normalize_url("https://www.example.com/root/guide/?foo=bar")
    assert normalized == "https://example.com/root/guide"
    assert profile.in_scope("https://example.com/root/guide")
    assert not profile.in_scope("https://example.com/other")

    root = profile.derive_output_path("https://example.com/root")
    assert root == tmp_path / "example" / "index.md"

    child = profile.derive_output_path("https://example.com/root/getting-started")
    assert child == tmp_path / "example" / "getting-started" / "index.md"


--- tests/test_crawl_cli.py ---
from __future__ import annotations

from pathlib import Path
from typing import Any

import pytest

from fullstackopen_en_repo import crawl_fullstackopen as cli


class DummyProfile(cli.SiteProfile):  # type: ignore[misc]
    def __init__(self) -> None:
        super().__init__(Path("/tmp"))

    @property
    def id(self) -> str:  # pragma: no cover - not used
        return "dummy"

    @property
    def domains(self) -> list[str]:
        return ["example.com"]

    @property
    def entrypoints(self) -> list[str]:
        return ["https://example.com"]

    @property
    def default_max_depth(self) -> int:
        return 1

    def in_scope(self, url: str) -> bool:  # pragma: no cover - not used
        return True

    def derive_output_path(self, url: str, *, title: str | None = None) -> Path:
        return self.output_root / "dummy.md"


def test_needs_playwright_install_detection() -> None:
    exc = RuntimeError("BrowserType.launch: Executable doesn't exist")
    assert cli.needs_playwright_install(exc)
    assert not cli.needs_playwright_install(RuntimeError("some other error"))


def test_run_crawl_with_retry_triggers_install(monkeypatch: pytest.MonkeyPatch) -> None:
    calls: list[str] = []

    def fake_crawl_once(*args: Any, **kwargs: Any) -> tuple[str, str, str, list[str]]:
        if not calls:
            calls.append("fail")
            raise RuntimeError("Executable doesn't exist at /fake")
        return ("# title", "<html></html>", "title", [])

    def fake_install() -> None:
        calls.append("install")

    profile = DummyProfile()
    md, html, title, children = cli.run_crawl_with_retry(
        "https://example.com",
        browser_cfg=None,  # type: ignore[arg-type]
        run_cfg=None,  # type: ignore[arg-type]
        profile=profile,
        installer=fake_install,
        crawler=fake_crawl_once,
    )
    assert md.startswith("#")
    assert html.startswith("<")
    assert title == "title"
    assert children == []
    assert calls == ["fail", "install"]


--- tests/test_link_rewriter.py ---
from pathlib import Path

from fullstackopen_en_repo.link_rewriter import rewrite_markdown_links
from fullstackopen_en_repo.profiles.nextjs_learn import NextjsLearnProfile


def test_rewrite_links_none(tmp_path: Path) -> None:
    profile = NextjsLearnProfile(tmp_path)
    markdown = "[Intro](https://nextjs.org/learn)"
    assert (
        rewrite_markdown_links(
            markdown,
            mode="none",
            profile=profile,
            from_url="https://nextjs.org/learn",
        )
        == markdown
    )


def test_rewrite_links_local(tmp_path: Path) -> None:
    profile = NextjsLearnProfile(tmp_path)
    markdown = (
        "[Overview](https://nextjs.org/learn/dashboard-app) "
        "[Chapter](/learn/dashboard-app/css-styling) "
        "[External](https://example.com)"
    )
    rewritten = rewrite_markdown_links(
        markdown,
        mode="local",
        profile=profile,
        from_url="https://nextjs.org/learn/dashboard-app/getting-started",
    )
    assert "[Overview](index.md)" in rewritten
    assert "[Chapter](css-styling.md)" in rewritten
    assert "[External](https://example.com)" in rewritten


## Links discovered
- [Intro](https://nextjs.org/learn)
- [Overview](https://nextjs.org/learn/dashboard-app)
- [Chapter](https://github.com/AcidicSoil/crawlFullStack/blob/main/learn/dashboard-app/css-styling.md)
- [External](https://example.com)
- [Overview](https://github.com/AcidicSoil/crawlFullStack/blob/main/tests/index.md)
- [Chapter](https://github.com/AcidicSoil/crawlFullStack/blob/main/tests/css-styling.md)

--- tests/test_markdown_utils.py ---
from fullstackopen_en_repo.markdown_utils import split_frontmatter


def test_split_frontmatter_json():
    text = '---\n{"key": "value"}\n---\nBody'
    meta, body, block = split_frontmatter(text)
    assert meta["key"] == "value"
    assert body.strip() == "Body"
    assert block.startswith("---")


def test_split_frontmatter_yaml():
    text = "---\nid: abc\ntitle: Hello\nchecksum: '123'\n---\nContent"
    meta, body, _ = split_frontmatter(text)
    assert meta["id"] == "abc"
    assert meta["checksum"] == "123"
    assert body.strip() == "Content"


--- tests/test_nextjs_profile.py ---
from pathlib import Path

from fullstackopen_en_repo.profiles.nextjs_learn import NextjsLearnProfile


def test_nextjs_path_mapping(tmp_path: Path) -> None:
    profile = NextjsLearnProfile(tmp_path)
    assert (
        profile.normalize_url("https://nextjs.org/learn/") == "https://nextjs.org/learn"
    )
    assert (
        profile.normalize_url("https://www.nextjs.org/learn/dashboard-app/")
        == "https://nextjs.org/learn/dashboard-app"
    )

    root = profile.derive_output_path("https://nextjs.org/learn")
    assert root == tmp_path / "nextjs-learn" / "index.md"

    overview = profile.derive_output_path("https://nextjs.org/learn/dashboard-app")
    assert overview == tmp_path / "nextjs-learn" / "dashboard-app" / "index.md"

    chapter = profile.derive_output_path(
        "https://nextjs.org/learn/dashboard-app/getting-started"
    )
    assert chapter == tmp_path / "nextjs-learn" / "dashboard-app" / "getting-started.md"

    rel = profile.map_url_to_relpath(
        "https://nextjs.org/learn/dashboard-app/getting-started",
        "https://nextjs.org/learn/dashboard-app",
    )
    assert rel == "index.md"


def test_nextjs_scope_and_enqueue(tmp_path: Path) -> None:
    profile = NextjsLearnProfile(tmp_path)
    assert profile.in_scope("https://nextjs.org/learn/dashboard-app")
    assert profile.should_enqueue("https://nextjs.org/learn/dashboard-app/css-styling")
    assert not profile.in_scope("https://nextjs.org/docs")
