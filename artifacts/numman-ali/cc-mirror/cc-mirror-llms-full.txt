# llms-full (private-aware)
> Built from GitHub files and website pages. Large files may be truncated.

--- docs/README.md ---
# CC-MIRROR Documentation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚   â•­â”€â”€â”€â”€â”€â•®â•­â”€â”€â”€â”€â”€â•®    â•­â”€â”€â”€â•®â•­â”€â”€â”€â•®â•­â”€â”€â”€â•®â•­â”€â”€â”€â”€â”€â”€â”€â•®â•­â”€â”€â”€â”€â”€â”€â”€â•®â•­â”€â”€â”€â”€â”€â”€â”€â•®â•­â”€â”€â”€â”€â”€â”€â”€â•®     â”‚
â”‚   â”‚ â•­â”€â”€â”€â•¯â”‚ â•­â”€â”€â”€â•¯    â”‚ â•­â•®â•¯â”‚ â•­â”€â•¯â•°â”€â•® â”‚â”‚ â•­â”€â•® â•­â”€â•¯â”‚ â•­â”€â•® â•­â”€â•¯â”‚ â•­â”€â”€â”€â•® â”‚â”‚ â•­â”€â•® â•­â”€â•¯     â”‚
â”‚   â”‚ â”‚    â”‚ â”‚   â•­â”€â”€â”€â”€â”‚ â”‚â”‚ â”‚ â”‚  â•­â”€â•¯ â”‚â”‚ â•°â”€â•¯ â”‚  â”‚ â•°â”€â•¯ â”‚  â”‚ â”‚   â”‚ â”‚â”‚ â•°â”€â•¯ â”‚       â”‚
â”‚   â”‚ â•°â”€â”€â”€â•®â”‚ â•°â”€â”€â”€â•¯    â”‚ â•°â•¯â•­â•¯ â•°â”€â”€â•¯ â•­â”€â•¯â”‚ â•­â”€â•® â”‚  â”‚ â•­â”€â•® â”‚  â”‚ â•°â”€â”€â”€â•¯ â”‚â”‚ â•­â”€â•® â”‚       â”‚
â”‚   â•°â”€â”€â”€â”€â”€â•¯â•°â”€â”€â”€â”€â”€â•¯    â•°â”€â”€â”€â•¯â•°â”€â”€â”€â”€â”€â”€â•¯  â•°â”€â•¯ â•°â”€â•¯  â•°â”€â•¯ â•°â”€â•¯  â•°â”€â”€â”€â”€â”€â”€â”€â•¯â•°â”€â•¯ â•°â”€â•¯       â”‚
â”‚                                                                              â”‚
â”‚   Create multiple isolated Claude Code variants with custom providers        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“š Documentation Index

### âš¡ Getting Started

| Document                                | Description                           |
| --------------------------------------- | ------------------------------------- |
| [Quick Start](../README.md#quick-start) | Install and create your first variant |
| [CLI Options](../README.md#cli-options) | Commands, flags, and options          |

### ğŸ¤– Features

| Document                                   | Description                          |
| ------------------------------------------ | ------------------------------------ |
| [Mirror Claude](features/mirror-claude.md) | Pure Claude Code with clean defaults |

### ğŸ—ï¸ Architecture

| Document                             | Description                        |
| ------------------------------------ | ---------------------------------- |
| [Overview](architecture/overview.md) | How cc-mirror works under the hood |

### ğŸ”§ Reference

| Document                          | Description         |
| --------------------------------- | ------------------- |
| [Tweakcc Guide](TWEAKCC-GUIDE.md) | Theme customization |

---

## ğŸ—ºï¸ Quick Navigation

```
docs/
â”œâ”€â”€ README.md                 â† You are here
â”œâ”€â”€ TWEAKCC-GUIDE.md           # ğŸ”§ tweakcc integration notes
â”œâ”€â”€ features/
â”‚   â””â”€â”€ mirror-claude.md       # ğŸª Pure Claude Code variant
â””â”€â”€ architecture/
    â””â”€â”€ overview.md            # ğŸ—ï¸ System architecture
```

---

## ğŸ’¡ Quick Links

- **New to cc-mirror?** Start with the [Quick Start](../README.md#quick-start)
- **Pure Claude experience?** Try [Mirror Claude](features/mirror-claude.md)
- **Adding a provider?** See [Provider System](architecture/provider-system.md)

---

## ğŸ“Š Provider Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Provider   â”‚       Model        â”‚  Auth Mode   â”‚ Prompt Packâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ kimi         â”‚ kimi-for-coding    â”‚ API Key      â”‚ âœ—          â”‚
â”‚ minimax      â”‚ MiniMax-M2.5       â”‚ API Key      â”‚ âœ“ Full     â”‚
â”‚ zai          â”‚ GLM-5/4.7/4.5-Air  â”‚ API Key      â”‚ âœ“ Full     â”‚
â”‚ openrouter   â”‚ You choose         â”‚ Auth Token   â”‚ âœ—          â”‚
â”‚ vercel       â”‚ Vercel gateway     â”‚ Auth Token   â”‚ âœ—          â”‚
â”‚ ollama       â”‚ Local + cloud      â”‚ Auth Token   â”‚ âœ—          â”‚
â”‚ nanogpt      â”‚ Anthropic compat   â”‚ Auth Token   â”‚ âœ—          â”‚
â”‚ ccrouter     â”‚ Local LLMs         â”‚ Optional     â”‚ âœ—          â”‚
â”‚ mirror       â”‚ Claude (native)    â”‚ OAuth/Key    â”‚ âœ— Pure     â”‚
â”‚ gatewayz     â”‚ GatewayZ gateway   â”‚ Auth Token   â”‚ âœ—          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— Provider Setup Links

| Provider     | Subscribe                                                     | Get Key/Token                                                    | Docs                                                             |
| ------------ | ------------------------------------------------------------- | ---------------------------------------------------------------- | ---------------------------------------------------------------- |
| `kimi`       | https://www.kimi.com/code                                     | https://www.kimi.com/code/console                                | https://www.kimi.com/code/docs/en/more/third-party-agents.html   |
| `minimax`    | https://platform.minimax.io/subscribe/coding-plan             | https://platform.minimax.io/user-center/payment/coding-plan      | https://platform.minimax.io/docs                                 |
| `zai`        | https://z.ai/subscribe                                        | https://z.ai/manage-apikey/apikey-list                           | https://z.ai/docs                                                |
| `openrouter` | https://openrouter.ai/account                                 | https://openrouter.ai/keys                                       | https://openrouter.ai/docs                                       |
| `vercel`     | https://vercel.com/ai                                         | https://vercel.com/account/tokens                                | https://vercel.com/docs/ai-gateway                               |
| `ollama`     | https://ollama.com                                            | https://ollama.com                                               | https://docs.ollama.com/api/anthropic-compatibility              |
| `nanogpt`    | https://nano-gpt.com                                          | https://nano-gpt.com                                             | https://docs.nano-gpt.com/docs/anthropic-compatibility           |
| `ccrouter`   | https://github.com/musistudio/claude-code-router#installation | https://github.com/musistudio/claude-code-router#2-configuration | https://github.com/musistudio/claude-code-router#2-configuration |
| `gatewayz`   | https://gatewayz.ai                                           | https://gatewayz.ai                                              | https://docs.gatewayz.ai/docs/anthropic-compatibility            |

---

<p align="center">
  <strong>Created by <a href="https://github.com/numman-ali">Numman Ali</a></strong>
</p>


## Links discovered
- [Quick Start](https://github.com/numman-ali/cc-mirror/blob/main/README.md#quick-start)
- [CLI Options](https://github.com/numman-ali/cc-mirror/blob/main/README.md#cli-options)
- [Mirror Claude](https://github.com/numman-ali/cc-mirror/blob/main/docs/features/mirror-claude.md)
- [Overview](https://github.com/numman-ali/cc-mirror/blob/main/docs/architecture/overview.md)
- [Tweakcc Guide](https://github.com/numman-ali/cc-mirror/blob/main/docs/TWEAKCC-GUIDE.md)
- [Provider System](https://github.com/numman-ali/cc-mirror/blob/main/docs/architecture/provider-system.md)
- [Numman Ali](https://github.com/numman-ali)

--- src/core/install.ts ---
import fs from 'node:fs';
import path from 'node:path';
import { spawnSync } from 'node:child_process';
import crypto from 'node:crypto';
import { once } from 'node:events';
import { Readable } from 'node:stream';
import type { ReadableStream as NodeReadableStream } from 'node:stream/web';
import { finished } from 'node:stream/promises';
import { commandExists } from './paths.js';

const CLAUDE_VERSION_PATTERN = /^(stable|latest|[0-9]+\.[0-9]+\.[0-9]+(?:-[^[:space:]]+)?)$/;

const CLAUDE_NATIVE_RELEASES_URL =
  process.env.CC_MIRROR_CLAUDE_RELEASES_URL ??
  'https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases';

const assertValidClaudeVersion = (value: string) => {
  const trimmed = (value ?? '').trim();
  if (!trimmed || !CLAUDE_VERSION_PATTERN.test(trimmed)) {
    throw new Error(`Invalid Claude Code version "${value}". Use "stable", "latest", or a version like "2.1.37".`);
  }
};

const resolveNativePlatformKey = (): string => {
  const os = process.platform;
  const arch = process.arch;

  const normArch = arch === 'x64' ? 'x64' : arch === 'arm64' ? 'arm64' : null;
  if (!normArch) {
    throw new Error(`Unsupported architecture: ${arch}`);
  }

  if (os === 'darwin') {
    return `darwin-${normArch}`;
  }
  if (os === 'win32') {
    if (normArch !== 'x64') {
      throw new Error(`Unsupported Windows architecture: ${arch}`);
    }
    return 'win32-x64';
  }
  if (os !== 'linux') {
    throw new Error(`Unsupported platform: ${os}`);
  }

  // Detect musl on Linux (best-effort, no hard dependency on ldd).
  const muslLibs =
    (normArch === 'x64' && fs.existsSync('/lib/libc.musl-x86_64.so.1')) ||
    (normArch === 'arm64' && fs.existsSync('/lib/libc.musl-aarch64.so.1'));
  let isMusl = Boolean(muslLibs);
  if (!isMusl && commandExists('ldd')) {
    try {
      const out = spawnSync('ldd', ['/bin/ls'], { encoding: 'utf8' });
      isMusl = out.status === 0 && /musl/i.test(out.stdout + out.stderr);
    } catch {
      // ignore
    }
  }

  return isMusl ? `linux-${normArch}-musl` : `linux-${normArch}`;
};

export const resolveNativeClaudePath = (nativeDir: string): string => {
  const filename = process.platform === 'win32' ? 'claude.exe' : 'claude';
  return path.join(nativeDir, filename);
};

const fetchText = async (url: string): Promise<string> => {
  if (typeof fetch !== 'function') {
    throw new Error('Native installs require Node.js 18+ (global fetch).');
  }
  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`Failed to fetch ${url} (${res.status})`);
  }
  return await res.text();
};

const fetchJson = async <T>(url: string): Promise<T> => {
  const text = await fetchText(url);
  try {
    return JSON.parse(text) as T;
  } catch {
    throw new Error(`Failed to parse JSON from ${url}`);
  }
};

const downloadToFileWithSha256 = async (url: string, outPath: string): Promise<string> => {
  if (typeof fetch !== 'function') {
    throw new Error('Native installs require Node.js 18+ (global fetch).');
  }
  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`Download failed for ${url} (${res.status})`);
  }
  if (!res.body) {
    throw new Error(`Download failed for ${url} (empty response body)`);
  }

  const tmpPath = `${outPath}.tmp-${Date.now()}`;
  const file = fs.createWriteStream(tmpPath);
  const hash = crypto.createHash('sha256');

  try {
    // TS: DOM ReadableStream (fetch) vs Node stream/web ReadableStream type mismatch.
    // Runtime is fine on Node 18+; we just coerce for compilation.
    const nodeStream = Readable.fromWeb(res.body as unknown as NodeReadableStream);
    for await (const chunk of nodeStream) {
      const buf = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk as Uint8Array);
      hash.update(buf);
      if (!file.write(buf)) {
        await once(file, 'drain');
      }
    }
    file.end();
    await finished(file);

    // Ensure atomic-ish replace (Windows can't overwrite existing targets).
    try {
      fs.rmSync(outPath, { force: true });
    } catch {
      // ignore
    }
    fs.renameSync(tmpPath, outPath);
    return hash.digest('hex');
  } catch (error) {
    try {
      file.destroy();
    } catch {
      // ignore
    }
    try {
      fs.rmSync(tmpPath, { force: true });
    } catch {
      // ignore
    }
    throw error;
  }
};

const sha256File = async (filePath: string): Promise<string> => {
  const hash = crypto.createHash('sha256');
  const stream = fs.createReadStream(filePath);
  stream.on('data', (chunk) => hash.update(chunk));
  await finished(stream);
  return hash.digest('hex');
};

type ClaudeNativeManifest = {
  version: string;
  buildDate?: string;
  platforms: Record<string, { binary?: string; checksum: string }>;
};

const resolveClaudeNativeVersion = async (versionSpec: string): Promise<string> => {
  const trimmed = (versionSpec ?? '').trim();
  assertValidClaudeVersion(trimmed);
  if (trimmed === 'stable' || trimmed === 'latest') {
    return (await fetchText(`${CLAUDE_NATIVE_RELEASES_URL}/${trimmed}`)).trim();
  }
  return trimmed;
};

export const installNativeClaudeAsync = async (params: {
  nativeDir: string;
  version: string;
  cacheDir?: string;
  stdio?: 'inherit' | 'pipe';
}): Promise<{ binaryPath: string; resolvedVersion: string; platform: string }> => {
  const versionSpec = (params.version ?? '').trim();
  assertValidClaudeVersion(versionSpec);

  const platform = resolveNativePlatformKey();
  const resolvedVersion = await resolveClaudeNativeVersion(versionSpec);
  const manifestUrl = `${CLAUDE_NATIVE_RELEASES_URL}/${resolvedVersion}/manifest.json`;
  const manifest = await fetchJson<ClaudeNativeManifest>(manifestUrl);
  const platformInfo = manifest.platforms?.[platform];
  if (!platformInfo?.checksum) {
    throw new Error(`Platform ${platform} not found in Claude Code manifest for ${resolvedVersion}`);
  }

  // Older manifests omit the binary filename; the installer scripts assume these defaults.
  const defaultBinary = platform.startsWith('win32-') ? 'claude.exe' : 'claude';
  const binaryName = platformInfo.binary?.trim() || defaultBinary;

  const expected = platformInfo.checksum;
  if (!/^[a-f0-9]{64}$/i.test(expected)) {
    throw new Error(`Invalid checksum for ${platform} in manifest for ${resolvedVersion}`);
  }

  const binaryUrl = `${CLAUDE_NATIVE_RELEASES_URL}/${resolvedVersion}/${platform}/${binaryName}`;
  const binaryPath = resolveNativeClaudePath(params.nativeDir);
  const cacheRoot = params.cacheDir?.trim();
  const cachePath = cacheRoot ? resolveNativeClaudePath(path.join(cacheRoot, resolvedVersion, platform)) : null;

  if (cachePath && fs.existsSync(cachePath)) {
    const cached = await sha256File(cachePath);
    if (cached.toLowerCase() === expected.toLowerCase()) {
      try {
        fs.rmSync(binaryPath, { force: true });
      } catch {
        // ignore
      }
      fs.copyFileSync(cachePath, binaryPath);
      if (process.platform !== 'win32') {
        try {
          fs.chmodSync(binaryPath, 0o755);
        } catch {
          // ignore
        }
      }
      return { binaryPath, resolvedVersion, platform };
    }
    try {
      fs.rmSync(cachePath, { force: true });
    } catch {
      // ignore
    }
  }

  if (cachePath) {
    fs.mkdirSync(path.dirname(cachePath), { recursive: true });
  }

  const downloadTarget = cachePath ?? binaryPath;
  const actual = await downloadToFileWithSha256(binaryUrl, downloadTarget);
  if (actual.toLowerCase() !== expected.toLowerCase()) {
    try {
      fs.rmSync(downloadTarget, { force: true });
    } catch {
      // ignore
    }
    throw new Error(`Checksum verification failed for ${binaryUrl}`);
  }

  if (cachePath) {
    try {
      fs.rmSync(binaryPath, { force: true });
    } catch {
      // ignore
    }
    fs.copyFileSync(cachePath, binaryPath);
  }

  if (process.platform !== 'win32') {
    try {
      fs.chmodSync(binaryPath, 0o755);
    } catch {
      // ignore
    }
  }

  return { binaryPath, resolvedVersion, platform };
};


--- test/core/install-validation.test.ts ---
import test from 'node:test';
import assert from 'node:assert/strict';
import { installNativeClaudeAsync } from '../../src/core/install.js';
import { makeTempDir, cleanup } from '../helpers/index.js';

test('installNativeClaudeAsync rejects invalid version spec', async () => {
  const nativeDir = makeTempDir();
  try {
    await assert.rejects(
      installNativeClaudeAsync({
        nativeDir,
        version: '2.1.25 && rm -rf /',
        stdio: 'pipe',
      }),
      /Invalid Claude Code version/
    );
  } finally {
    cleanup(nativeDir);
  }
});

test('installNativeClaudeAsync rejects empty version spec', async () => {
  const nativeDir = makeTempDir();
  try {
    await assert.rejects(
      installNativeClaudeAsync({
        nativeDir,
        version: '',
        stdio: 'pipe',
      }),
      /Invalid Claude Code version/
    );
  } finally {
    cleanup(nativeDir);
  }
});


--- docs/architecture/overview.md ---
# ğŸ—ï¸ Architecture Overview

This document explains how cc-mirror works under the hood.

---

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CC-MIRROR                                        â”‚
â”‚                                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                 â”‚    â”‚                  â”‚    â”‚                         â”‚ â”‚
â”‚   â”‚   CLI / TUI     â”‚â”€â”€â”€â–¶â”‚   Core Engine    â”‚â”€â”€â”€â–¶â”‚   Variant Directory     â”‚ â”‚
â”‚   â”‚                 â”‚    â”‚                  â”‚    â”‚   ~/.cc-mirror/<name>/  â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                       â”‚                         â”‚                  â”‚
â”‚          â”‚                       â”‚                         â–¼                  â”‚
â”‚          â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚          â”‚               â”‚               â”‚         â”‚                   â”‚     â”‚
â”‚          â”‚         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”‚   Shell Wrapper   â”‚     â”‚
â”‚          â”‚         â”‚ Providers â”‚   â”‚  Brands   â”‚   â”‚  <bin-dir>/       â”‚     â”‚
â”‚          â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                   â”‚     â”‚
â”‚          â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚          â”‚                                                   â”‚               â”‚
â”‚          â”‚                                                   â–¼               â”‚
â”‚          â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚          â”‚                                         â”‚                   â”‚     â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Claude Code     â”‚     â”‚
â”‚                                                    â”‚  (native binary)  â”‚     â”‚
â”‚                                                    â”‚                   â”‚     â”‚
â”‚                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Default `<bin-dir>` is `~/.local/bin` on macOS/Linux and `~/.cc-mirror/bin` on Windows.

---

## Directory Structure

```
src/
â”œâ”€â”€ cli/                    # Command-line interface
â”‚   â”œâ”€â”€ index.ts           # Entry point
â”‚   â”œâ”€â”€ args.ts            # Argument parsing
â”‚   â””â”€â”€ commands/          # create, update, remove, doctor, etc.
â”‚
â”œâ”€â”€ tui/                    # Terminal User Interface (Ink/React)
â”‚   â”œâ”€â”€ App.tsx            # Main TUI app
â”‚   â”œâ”€â”€ screens/           # Home, Create, Update screens
â”‚   â”œâ”€â”€ components/        # UI components
â”‚   â””â”€â”€ content/           # Provider education content
â”‚
â”œâ”€â”€ core/                   # Core variant management
â”‚   â”œâ”€â”€ index.ts           # Public API
â”‚   â”œâ”€â”€ types.ts           # Type definitions
â”‚   â”œâ”€â”€ constants.ts       # Default paths, versions
â”‚   â”œâ”€â”€ variant-builder/   # Build steps
â”‚   â”‚   â”œâ”€â”€ VariantBuilder.ts
â”‚   â”‚   â”œâ”€â”€ VariantUpdater.ts
â”‚   â”‚   â””â”€â”€ steps/         # Individual build steps
â”‚   â”œâ”€â”€ wrapper.ts         # Shell wrapper generation
â”‚   â””â”€â”€ prompt-pack/       # System prompt overlays
â”‚
â”œâ”€â”€ providers/              # Provider templates
â”‚   â””â”€â”€ index.ts           # mirror, zai, minimax, kimi, openrouter, ccrouter, ollama, gatewayz, vercel, nanogpt
â”‚
â””â”€â”€ brands/                 # Theme presets
    â”œâ”€â”€ index.ts           # Brand registry
    â”œâ”€â”€ zai.ts             # Gold theme
    â”œâ”€â”€ minimax.ts         # Coral theme
    â”œâ”€â”€ kimi.ts            # Teal theme
    â”œâ”€â”€ openrouter.ts      # Chrome theme
    â”œâ”€â”€ ccrouter.ts        # Sky theme
    â”œâ”€â”€ ollama.ts          # Ember theme
    â”œâ”€â”€ gatewayz.ts        # Violet theme
    â”œâ”€â”€ vercel.ts          # Monochrome theme
    â”œâ”€â”€ nanogpt.ts         # Aurora theme
    â””â”€â”€ mirror.ts          # Silver/chrome theme
```

---

## Variant Lifecycle

### Create Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚   npx cc-mirror create                                                      â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚   â”‚ Parse Args    â”‚  --provider, --name, --api-key                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚   â”‚ Resolve       â”‚  Get provider template from providers/index.ts          â”‚
â”‚   â”‚ Provider      â”‚                                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                        BUILD STEPS                                    â”‚ â”‚
â”‚   â”‚                                                                       â”‚ â”‚
â”‚   â”‚   1. PrepareDirectoriesStep Create ~/.cc-mirror/<name>/               â”‚ â”‚
â”‚   â”‚                             â”‚                                         â”‚ â”‚
â”‚   â”‚   2. InstallNativeStep      Download + verify native Claude Code      â”‚ â”‚
â”‚   â”‚                             â”‚                                         â”‚ â”‚
â”‚   â”‚   3. WriteConfigStep        Write settings.json, .claude.json         â”‚ â”‚
â”‚   â”‚                             â”‚                                         â”‚ â”‚
â”‚   â”‚   4. BrandThemeStep         Write tweakcc/config.json                 â”‚ â”‚
â”‚   â”‚                             â”‚                                         â”‚ â”‚
â”‚   â”‚   5. TweakccStep            Apply customization via tweakcc           â”‚ â”‚
â”‚   â”‚                             â”‚                                         â”‚ â”‚
â”‚   â”‚   6. WrapperStep            Create <bin-dir>/<name>                   â”‚ â”‚
â”‚   â”‚                             â”‚                                         â”‚ â”‚
â”‚   â”‚   7. ShellEnvStep           Optional shell profile env                â”‚ â”‚
â”‚   â”‚                             â”‚                                         â”‚ â”‚
â”‚   â”‚   8. SkillInstallStep       Optional dev-browser skill                â”‚ â”‚
â”‚   â”‚                             â”‚                                         â”‚ â”‚
â”‚   â”‚   9. FinalizeStep           Write variant.json metadata               â”‚ â”‚
â”‚   â”‚                                                                       â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Update Flow

```
npx cc-mirror update <name>
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Variant  â”‚  Read variant.json for existing config
â”‚ Metadata      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UPDATE STEPS                                       â”‚
â”‚                                                                           â”‚
â”‚   1. RebuildUpdateStep       Reset claude/tweakcc dirs (keep config)      â”‚
â”‚   2. InstallNativeUpdateStep Download + verify native CC (unless settingsOnly) â”‚
â”‚   3. ModelOverridesStep      Update model mappings                        â”‚
â”‚   4. TweakccUpdateStep       Re-apply theme                               â”‚
â”‚   5. WrapperUpdateStep       Regenerate wrapper script                    â”‚
â”‚   6. ConfigUpdateStep        Update settings.json                         â”‚
â”‚   7. ShellEnvUpdateStep      Update shell env integration                 â”‚
â”‚   8. SkillInstallUpdateStep  Update installed skills                      â”‚
â”‚   9. FinalizeUpdateStep      Update variant.json                          â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Variant Directory Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚  ~/.cc-mirror/<variant>/                                                    â”‚
â”‚                                                                             â”‚
â”‚  â”œâ”€â”€ native/                        Claude Code native installation         â”‚
â”‚  â”‚   â”œâ”€â”€ claude                      Claude Code binary                     â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”œâ”€â”€ config/                         CLAUDE_CONFIG_DIR                      â”‚
â”‚  â”‚   â”œâ”€â”€ settings.json              Env vars (API keys, base URLs)          â”‚
â”‚  â”‚   â”œâ”€â”€ .claude.json               MCP servers, approvals, onboarding      â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”œâ”€â”€ tweakcc/                        tweakcc configuration                  â”‚
â”‚  â”‚   â”œâ”€â”€ config.json                Theme and UI customization              â”‚
â”‚  â”‚   â”œâ”€â”€ cli.js.backup              tweakcc-managed backup                  â”‚
â”‚  â”‚   â””â”€â”€ system-prompts/            Prompt pack overlays                    â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â””â”€â”€ variant.json                    Variant metadata                       â”‚
â”‚                                                                             â”‚
â”‚  Wrapper: <bin-dir>/<variant>        Shell wrapper script                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Provider System

Providers define how cc-mirror connects to different APIs.

```typescript
interface ProviderTemplate {
  key: string; // e.g., 'zai', 'mirror'
  label: string; // Display name
  description: string; // Short description
  baseUrl: string; // API endpoint (empty for mirror)
  env: Record<string, string | number>; // Extra env vars

  // Auth handling
  apiKeyLabel?: string; // Prompt label for API key
  authMode?: 'apiKey' | 'authToken' | 'none';
  credentialOptional?: boolean;

  // Feature flags
  noPromptPack?: boolean; // Skip prompt pack overlays
}
```

### Provider Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               â”‚                         Provider Types                               â”‚
â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Feature     â”‚ API Key    â”‚ Auth Token  â”‚ Router     â”‚ Direct     â”‚ Description    â”‚
â”‚               â”‚ (zai,      â”‚ (openrouter,â”‚ (ccrouter) â”‚ (mirror)   â”‚                â”‚
â”‚               â”‚  minimax,  â”‚  vercel,    â”‚            â”‚            â”‚                â”‚
â”‚               â”‚  kimi)     â”‚  ollama,    â”‚            â”‚            â”‚                â”‚
â”‚               â”‚            â”‚  nanogpt,   â”‚            â”‚            â”‚                â”‚
â”‚               â”‚            â”‚  gatewayz)  â”‚            â”‚            â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BASE_URL      â”‚ âœ“ Set      â”‚ âœ“ Set       â”‚ âœ“ Set      â”‚ âœ— Not set  â”‚ API endpoint   â”‚
â”‚ Auth          â”‚ API_KEY    â”‚ AUTH_TOKEN   â”‚ Optional   â”‚ âœ— Not set  â”‚ Credential     â”‚
â”‚ Model mapping â”‚ Auto       â”‚ Auto/Req    â”‚ Handled    â”‚ âœ— Not set  â”‚ Sonnet/Opus    â”‚
â”‚ Prompt pack   â”‚ Optional   â”‚ âœ—           â”‚ âœ—          â”‚ âœ—          â”‚ System overlaysâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Shell Wrapper

The wrapper script makes variants accessible as commands:

```bash
#!/bin/bash
# <bin-dir>/zai

# Show splash art (if TTY and enabled)
if [ -t 1 ] && [ "${CC_MIRROR_SPLASH:-1}" != "0" ]; then
  # ASCII art here...
fi

# Set Claude Code config directory
export CLAUDE_CONFIG_DIR="$HOME/.cc-mirror/zai/config"

# Load environment from settings.json
# (API keys, base URLs, model mappings)

# Run Claude Code
exec "$HOME/.cc-mirror/zai/native/claude" "$@"
```

On Windows, the wrapper is `<bin-dir>\zai.cmd` with a sibling `<bin-dir>\zai.mjs` launcher script. Add `%USERPROFILE%\.cc-mirror\bin` to `PATH` to run wrappers without a full path.

---

## ğŸ”™ Related

- [Provider System](provider-system.md) - Adding new providers
- [Variant Lifecycle](variant-lifecycle.md) - Detailed create/update flows
- [Mirror Claude](../features/mirror-claude.md) - Pure Claude variant


## Links discovered
- [Provider System](https://github.com/numman-ali/cc-mirror/blob/main/docs/architecture/provider-system.md)
- [Variant Lifecycle](https://github.com/numman-ali/cc-mirror/blob/main/docs/architecture/variant-lifecycle.md)
- [Mirror Claude](https://github.com/numman-ali/cc-mirror/blob/main/docs/features/mirror-claude.md)

--- src/core/variant-builder/steps/InstallNativeStep.ts ---
/**
 * InstallNativeStep - Installs Claude Code via native binary download
 */

import { DEFAULT_CLAUDE_NATIVE_CACHE_DIR } from '../../constants.js';
import { installNativeClaudeAsync } from '../../install.js';
import type { BuildContext, BuildStep } from '../types.js';

export class InstallNativeStep implements BuildStep {
  name = 'InstallNative';

  execute(_ctx: BuildContext): void {
    // Native installs require async fetch streaming to avoid blocking the TUI.
    throw new Error('Native installs require async mode (use createVariantAsync).');
  }

  async executeAsync(ctx: BuildContext): Promise<void> {
    const { prefs, paths, state } = ctx;
    await ctx.report(`Installing Claude Code (native) ${prefs.resolvedClaudeVersion}...`);

    const install = await installNativeClaudeAsync({
      nativeDir: paths.nativeDir,
      version: prefs.resolvedClaudeVersion,
      cacheDir: DEFAULT_CLAUDE_NATIVE_CACHE_DIR,
      stdio: prefs.commandStdio,
    });

    state.binaryPath = install.binaryPath;
    state.nativePlatform = install.platform;
    state.nativeResolvedVersion = install.resolvedVersion;
    // Record the *resolved* version for provenance, even if the user pinned "stable"/"latest".
    state.claudeBinary = `native:${install.resolvedVersion}`;
    state.notes.push(`Claude Code native: ${install.resolvedVersion} (${install.platform})`);
  }
}


--- src/core/variant-builder/update-steps/InstallNativeUpdateStep.ts ---
/**
 * InstallNativeUpdateStep - Installs Claude Code via native binary download
 */

import { DEFAULT_CLAUDE_NATIVE_CACHE_DIR, DEFAULT_CLAUDE_VERSION } from '../../constants.js';
import { ensureDir } from '../../fs.js';
import { installNativeClaudeAsync } from '../../install.js';
import type { UpdateContext, UpdateStep } from '../types.js';

export class InstallNativeUpdateStep implements UpdateStep {
  name = 'InstallNative';

  execute(ctx: UpdateContext): void {
    if (ctx.opts.settingsOnly) return;
    throw new Error('Native installs require async mode (use updateVariantAsync).');
  }

  async executeAsync(ctx: UpdateContext): Promise<void> {
    if (ctx.opts.settingsOnly) return;

    const { meta, paths, prefs } = ctx;
    await ctx.report(`Installing Claude Code (native) ${prefs.resolvedClaudeVersion}...`);

    ensureDir(paths.nativeDir);

    const install = await installNativeClaudeAsync({
      nativeDir: paths.nativeDir,
      version: prefs.resolvedClaudeVersion,
      cacheDir: DEFAULT_CLAUDE_NATIVE_CACHE_DIR,
      stdio: prefs.commandStdio,
    });

    meta.binaryPath = install.binaryPath;
    meta.nativeDir = paths.nativeDir;
    meta.nativeVersion = prefs.resolvedClaudeVersion;
    const explicit = typeof ctx.opts.claudeVersion === 'string' && ctx.opts.claudeVersion.trim().length > 0;
    if (explicit) {
      meta.nativeVersionSource = meta.nativeVersion === DEFAULT_CLAUDE_VERSION ? 'default' : 'pinned';
    } else {
      meta.nativeVersionSource = meta.nativeVersionSource ?? 'default';
    }
    meta.nativePlatform = install.platform;
    meta.claudeOrig = `native:${install.resolvedVersion}`;
  }
}


--- src/core/variant-builder/steps/SkillInstallStep.ts ---
/**
 * SkillInstallStep - Installs the dev-browser skill
 */

import path from 'node:path';
import { ensureDevBrowserSkill, ensureDevBrowserSkillAsync } from '../../skills.js';
import type { BuildContext, BuildStep } from '../types.js';

export class SkillInstallStep implements BuildStep {
  name = 'SkillInstall';

  execute(ctx: BuildContext): void {
    const { paths, prefs, state } = ctx;

    if (!prefs.skillInstallEnabled) {
      return;
    }

    ctx.report('Installing dev-browser skill...');
    const skillResult = ensureDevBrowserSkill({
      install: true,
      update: prefs.skillUpdateEnabled,
      targetDir: path.join(paths.configDir, 'skills'),
    });

    if (skillResult.status === 'failed') {
      state.notes.push(`dev-browser skill install failed: ${skillResult.message || 'unknown error'}`);
    } else if (skillResult.status !== 'skipped') {
      state.notes.push(`dev-browser skill ${skillResult.status}`);
    }
  }

  async executeAsync(ctx: BuildContext): Promise<void> {
    const { paths, prefs, state } = ctx;

    if (!prefs.skillInstallEnabled) {
      return;
    }

    await ctx.report('Installing dev-browser skill...');
    const skillResult = await ensureDevBrowserSkillAsync({
      install: true,
      update: prefs.skillUpdateEnabled,
      targetDir: path.join(paths.configDir, 'skills'),
    });

    if (skillResult.status === 'failed') {
      state.notes.push(`dev-browser skill install failed: ${skillResult.message || 'unknown error'}`);
    } else if (skillResult.status !== 'skipped') {
      state.notes.push(`dev-browser skill ${skillResult.status}`);
    }
  }
}


--- src/core/variant-builder/update-steps/SkillInstallUpdateStep.ts ---
/**
 * SkillInstallUpdateStep - Installs dev-browser skill
 */

import path from 'node:path';
import { ensureDevBrowserSkill, ensureDevBrowserSkillAsync } from '../../skills.js';
import type { UpdateContext, UpdateStep } from '../types.js';

export class SkillInstallUpdateStep implements UpdateStep {
  name = 'SkillInstall';

  execute(ctx: UpdateContext): void {
    if (ctx.opts.settingsOnly) return;
    if (!ctx.prefs.skillInstallEnabled) return;
    ctx.report('Installing dev-browser skill...');
    this.install(ctx, false);
  }

  async executeAsync(ctx: UpdateContext): Promise<void> {
    if (ctx.opts.settingsOnly) return;
    if (!ctx.prefs.skillInstallEnabled) return;
    await ctx.report('Installing dev-browser skill...');
    await this.install(ctx, true);
  }

  private async install(ctx: UpdateContext, isAsync: boolean): Promise<void> {
    const { meta, prefs, state } = ctx;

    const skillOpts = {
      install: true,
      update: prefs.skillUpdateEnabled,
      targetDir: path.join(meta.configDir, 'skills'),
    };

    const skillResult = isAsync ? await ensureDevBrowserSkillAsync(skillOpts) : ensureDevBrowserSkill(skillOpts);

    if (skillResult.status === 'failed') {
      state.notes.push(`dev-browser skill install failed: ${skillResult.message || 'unknown error'}`);
    } else if (skillResult.status !== 'skipped') {
      state.notes.push(`dev-browser skill ${skillResult.status}`);
    }
  }
}


--- docs/TWEAKCC-GUIDE.md ---
# tweakcc Integration Guide (cc-mirror)

This document summarizes tweakcc capabilities and concrete implementation ideas for cc-mirror variants. It is intentionally practical: you can copy/paste snippets, adopt patterns, or expand into your own presets.

## What tweakcc can do (from upstream README)

- Edit Claude Code system prompts (core prompt, tool descriptions, agent prompts, utilities, etc.)
- Create custom themes (RGB/HSL picker), and switch themes in Claude Code
- Create and manage toolsets (and use them via Claude Codeâ€™s `/toolset`)
- Style user messages (custom label, borders, colors, padding)
- Customize thinking verbs and spinner animation (phases + speed)
- Remove the input box border
- Expand thinking blocks by default
- Enable session naming commands like `/title` and `/rename`
- Configure subagent models (Plan/Explore/etc.)
- Input pattern highlighters (highlight keywords while typing)
- Table format toggles (Unicode/ASCII/markdown styles)
- Session memory and â€œrememberâ€ features (optional)
- Suppress installer warnings (useful when you manage Claude installs manually)
- Misc UX patches (hide startup banner, hide clawd logo, hide â€œCtrl+G to edit promptâ€ hint, etc.)
- A large library of built-in patches, plus advanced `unpack`/`repack`/`adhoc-patch` workflows

tweakcc can patch either:

- **npm-based installs** (patches `cli.js` directly), or
- **native installs** (extracts the bundled JS from the `claude` binary, patches it, then repacks the binary).

## How cc-mirror uses tweakcc

- Per-variant config lives at:
  - `~/.cc-mirror/<variant>/tweakcc/config.json`
  - `~/.cc-mirror/<variant>/tweakcc/system-prompts/`
- Patch apply uses:
  - `TWEAKCC_CONFIG_DIR=~/.cc-mirror/<variant>/tweakcc`
  - `TWEAKCC_CC_INSTALLATION_PATH=...` (cc-mirror uses the native `~/.cc-mirror/<variant>/native/claude` binary)
- cc-mirror applies tweakcc after create/update, unless `--no-tweak`.
  - To re-apply patches without reinstalling Claude Code, run: `npx cc-mirror apply <variant>`
- cc-mirror pins the tweakcc CLI version it runs (see `src/core/constants.ts`), so updates are reproducible. (You can still manually run a different version via `npx tweakcc@latest` if you need a hotfix for a brand-new Claude Code release.)

### Tool restrictions (no toolsets)

cc-mirror intentionally does **not** manage tweakcc toolsets.

Instead, provider-specific tool restrictions (for example blocking `WebSearch` so the provider MCP can be used) are enforced via Claude Code's native `settings.json`:

- `~/.cc-mirror/<variant>/config/settings.json` â†’ `permissions.deny`

This keeps the UX stable and avoids relying on UI-level toolset patches inside the `claude` binary.

## Manual tweakcc for a single variant

Use this when you want to manually enable optional tweakcc features (for example swarm mode or session memory) on one variant without adding new cc-mirror UI settings.

### Fast path (recommended)

```bash
npx cc-mirror tweak <variant>
```

### Direct path (explicit target)

```bash
VARIANT=<variant>
TWEAKCC_CONFIG_DIR="$HOME/.cc-mirror/$VARIANT/tweakcc" \
TWEAKCC_CC_INSTALLATION_PATH="$HOME/.cc-mirror/$VARIANT/native/claude" \
npx tweakcc@4.0.1
```

### Apply specific optional patches

```bash
VARIANT=<variant>
TWEAKCC_CONFIG_DIR="$HOME/.cc-mirror/$VARIANT/tweakcc" \
TWEAKCC_CC_INSTALLATION_PATH="$HOME/.cc-mirror/$VARIANT/native/claude" \
npx tweakcc@4.0.1 --apply --patches "<patch-a>,<patch-b>"
```

Patch names depend on your tweakcc version. Run `npx tweakcc@4.0.1 --help` (or open the tweakcc UI patch list) to confirm available patch IDs.

## Recommended implementation patterns

### 1) Theme design (brand identity)

Goal: make each provider unmistakable while keeping readability.

Implementation suggestions:

- Choose a single signature accent color ("claude"/"bashBorder") and 1-2 supporting colors.
- Keep `background` and `text` high-contrast (use light backgrounds only if your terminal supports it).
- Use muted tinted backgrounds for:
  - `userMessageBackground`
  - `bashMessageBackgroundColor`
  - `memoryBackgroundColor`
- Keep `promptBorder` and `promptBorderShimmer` slightly darker than background, so focus rings show.

Example snippet (light theme with strong accents):

```
{
  "name": "MiniMax Pulse",
  "id": "minimax-pulse",
  "colors": {
    "claude": "rgb(255,77,77)",
    "claudeShimmer": "rgb(255,140,140)",
    "background": "rgb(245,245,245)",
    "text": "rgb(17,17,17)",
    "promptBorder": "rgb(229,209,255)",
    "userMessageBackground": "rgb(255,235,240)"
  }
}
```

### 2) User message display (chat banner)

Make the user label obvious and brand-consistent.

Suggested settings:

- `format`: ` [<username>] {}`
- `borderStyle`: `topBottomBold` or `topBottomDouble`
- `fitBoxToContent`: `true`

### 3) Thinking verbs + spinner

Make the "thinking" feel unique.

Ideas:

- Short, punchy verbs for fast models ("Routing", "Syncing")
- Longer verbs for more "deliberate" feel ("Calibrating", "Synthesizing")
- Spinner phases like `['Â·','â€¢','â—¦','â€¢']` for clean minimal rhythm

### 4) Input box + misc UX

Tweakcc can simplify the UI:

```
"inputBox": { "removeBorder": true },
  "misc": {
  "showPatchesApplied": true,
  "hideStartupBanner": false,
  "hideStartupClawd": false,
  "expandThinkingBlocks": true,
  "hideCtrlGToEdit": true
}
```

### 5) System prompts (advanced)

System prompt editing is powerful but risky. Suggested process:

- Start by editing only one prompt (core prompt) and validate behavior.
- Keep diffs small; avoid removing safety or tool instructions.
- When Claude Code updates, tweakcc will create HTML diffs for conflicts.

Suggested workflow:

1. Run tweakcc UI or open the system prompts folder.
2. Edit a single prompt file.
3. Run `tweakcc --apply` (cc-mirror does this on update).

### 6) Context limit overrides

Use `CLAUDE_CODE_CONTEXT_LIMIT` only for custom endpoints that support larger windows.

- Example: `CLAUDE_CODE_CONTEXT_LIMIT=400000`

### 7) Version compatibility and patch warnings

- tweakcc is sensitive to Claude Code versions. Patch failures are expected after CC updates.
- The `tweakcc` UI will still work even when one patch fails.

## Recommended cc-mirror UX flows

### Quick path (simple install)

- Prompt for API key
- Create variant (native install, pinned version)
- Apply brand preset + tweakcc patches
- Exit

### Advanced path

- Choose brand preset
- Optionally open tweakcc UI
- Optionally edit system prompts

## Checklist for creating a polished brand preset

- [ ] Unique theme palette with high contrast
- [ ] Distinct thinking verbs + spinner style
- [ ] User message banner formatting
- [ ] Input box border removed
- [ ] Startup banner visibility (hide or show)
- [ ] System prompt customized (optional)

## Startup ASCII art

tweakcc can **show or hide** Claude Codeâ€™s builtâ€‘in startup banner and clawd art. It does not currently support **custom** startup ASCII art. cc-mirror can optionally print a small wrapper splash when `CC_MIRROR_SPLASH=1`, and skips it for nonâ€‘TTY output or `--output-format` runs.

## Where to look in this repo

- Brand themes: `src/brands/*.ts`
- Tweakcc config writing: `src/core/tweakcc.ts`
- Variant creation: `src/core/index.ts`
- tweakcc upstream reference: `repos/tweakcc/README.md`

## Suggested roadmap (next steps)

1. **Theme polish pass**: iterate on one brand at a time, validate contrast, and tune borders/shimmers.
2. **System prompt v1**: edit only the main system prompt + 1 tool description, then validate behavior.
3. **MCP defaults**: seed provider MCP servers in `.claude.json`, then document how to manage scopes.
4. **Update flow**: add a â€œreapply after CC updateâ€ hint in CLI/TUI and detect patch failures early.
5. **UX polish**: add short â€œpreviewâ€ messages in the TUI showing what will change before applying.


--- docs/features/mirror-claude.md ---
# ğŸª Mirror Claude

Mirror Claude is a **pure Claude Code variant** with advanced features enabled. Unlike other providers that proxy through custom APIs, Mirror connects directly to Anthropic's API while providing isolation and enhanced capabilities.

---

## Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    PROXY PROVIDERS                                  â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   Z.ai â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ GLM API â”€â”€â”€â”€â”€â”€â”€â”€â–¶ GLM-5/4.7/4.5-Air            â”‚  â”‚
â”‚   â”‚   MiniMax â”€â”€â”€â”€â”€â”€â”€â”€â–¶ MiniMax API â”€â”€â”€â–¶ MiniMax-M2.5                  â”‚  â”‚
â”‚   â”‚   Kimi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Kimi API â”€â”€â”€â”€â”€â”€â–¶ kimi-for-coding (K2.5)       â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    GATEWAY PROVIDERS                                â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   OpenRouter â”€â”€â”€â”€â”€â–¶ 100+ models (pay-per-use)                      â”‚  â”‚
â”‚   â”‚   Vercel â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Vercel AI Gateway                              â”‚  â”‚
â”‚   â”‚   NanoGPT â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Claude Code endpoint                           â”‚  â”‚
â”‚   â”‚   GatewayZ â”€â”€â”€â”€â”€â”€â”€â–¶ Multi-provider gateway                         â”‚  â”‚
â”‚   â”‚   CC Router â”€â”€â”€â”€â”€â”€â–¶ Ollama / DeepSeek / local LLMs                 â”‚  â”‚
â”‚   â”‚   Ollama â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Local + cloud models                           â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    DIRECT PROVIDER                                  â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   Mirror â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Anthropic API (no proxy)       â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key difference**: Mirror Claude doesn't override `ANTHROPIC_BASE_URL`, `ANTHROPIC_API_KEY`, or any model settings. You authenticate exactly like vanilla Claude Code.

---

## âš¡ Quick Start

```bash
# Create a Mirror Claude variant
npx cc-mirror create --provider mirror --name mclaude

# Run it - authenticate via normal Claude flow
mclaude
```

No API key required at setup. When you run `mclaude`, authenticate via:

1. **OAuth** - Sign in through Anthropic Console (subscription)
2. **API Key** - Set `ANTHROPIC_API_KEY` environment variable

---

## ğŸ¯ What You Get

| Feature               | Description                                               |
| --------------------- | --------------------------------------------------------- |
| ğŸ¨ **Premium Theme**  | Silver/chrome aesthetic with electric blue accents        |
| ğŸ“ **Full Isolation** | Separate config and sessions                              |
| âœ¨ **Pure Claude**    | No prompt packs or model overrides - authentic experience |

---

## ğŸ“Š Provider Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                         â”‚
â”‚   Feature            â”‚ zai/minimax â”‚ kimi     â”‚ openrouter â”‚ ollama   â”‚ mirror          â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚   Model              â”‚ GLM / M2.5 â”‚ K2.5     â”‚ You choose â”‚ Local    â”‚ Claude (native) â”‚
â”‚   Auth Mode          â”‚ API Key    â”‚ API Key  â”‚ Auth Token â”‚ Auth Tok â”‚ OAuth or Key    â”‚
â”‚   ANTHROPIC_BASE_URL â”‚ âœ“ Set      â”‚ âœ“ Set    â”‚ âœ“ Set      â”‚ âœ“ Set    â”‚ âœ— Not set       â”‚
â”‚   Model Mappings     â”‚ âœ“ Auto     â”‚ âœ“ Auto   â”‚ âœ“ Required â”‚ Required â”‚ âœ— Not set       â”‚
â”‚   Prompt Pack        â”‚ âœ“ Minimal  â”‚ âœ—        â”‚ âœ—          â”‚ âœ—        â”‚ âœ— Pure          â”‚
â”‚   Config Isolation   â”‚ âœ“          â”‚ âœ“        â”‚ âœ“          â”‚ âœ“        â”‚ âœ“               â”‚
â”‚                                                                                         â”‚
â”‚   Also available: Vercel, NanoGPT, GatewayZ (auth token), CC Router (optional auth)    â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ When to Use Mirror Claude

### Perfect For

- **Power users** who want isolated Claude Code instances
- **Experimentation** - isolated config for testing hooks, skills, MCP servers
- **Multiple accounts** - keep work and personal Claude sessions separate

### Not For

- **Different models** - use OpenRouter or CCRouter for alternative LLMs
- **Cost savings** - Z.ai and MiniMax offer Coding Plan subscriptions
- **Offline use** - Mirror requires Anthropic API access

---

## ğŸ¨ Theme Preview

Mirror Claude features a distinctive silver/chrome theme:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                           â”‚
â”‚   Primary:    Silver    #C0C0C0           â”‚
â”‚   Accent:     Electric  #00D4FF           â”‚
â”‚   Secondary:  Purple    #6B5B95           â”‚
â”‚   Background: Near-black metallic         â”‚
â”‚                                           â”‚
â”‚   Thinking verbs:                         â”‚
â”‚   Reflecting, Refracting, Projecting,     â”‚
â”‚   Mirroring, Amplifying, Focusing,        â”‚
â”‚   Polishing, Crystallizing...             â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ Authentication

Mirror Claude uses standard Claude Code authentication:

### Option 1: OAuth (Anthropic Subscription)

```bash
mclaude
# Follow the OAuth prompt to sign in
```

### Option 2: API Key

```bash
export ANTHROPIC_API_KEY="sk-ant-..."
mclaude
```

### Option 3: Console API Key

```bash
# Get your key from https://console.anthropic.com/settings/keys
mclaude
# Enter key when prompted
```

---

## ğŸ“ Variant Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ~/.cc-mirror/mclaude/                                  â”‚
â”‚  â”œâ”€â”€ native/                 Claude Code installation   â”‚
â”‚  â”œâ”€â”€ config/                                            â”‚
â”‚  â”‚   â”œâ”€â”€ settings.json       Minimal env (splash only)  â”‚
â”‚  â”‚   â”œâ”€â”€ .claude.json        MCP servers, approvals     â”‚
â”‚  â”œâ”€â”€ tweakcc/                                           â”‚
â”‚  â”‚   â””â”€â”€ config.json         Mirror theme config        â”‚
â”‚  â””â”€â”€ variant.json            Variant metadata           â”‚
â”‚                                                         â”‚
â”‚  Wrapper: <bin-dir>/mclaude                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Default `<bin-dir>` is `~/.local/bin` on macOS/Linux and `~/.cc-mirror/bin` on Windows.

**Windows tip:** add `%USERPROFILE%\.cc-mirror\bin` to `PATH` (wrapper is `<variant>.cmd` with a sibling `<variant>.mjs` launcher).

### What Mirror Sets

```json
{
  "env": {
    "CC_MIRROR_SPLASH": "1",
    "CC_MIRROR_PROVIDER_LABEL": "Mirror Claude",
    "CC_MIRROR_SPLASH_STYLE": "mirror",
    "DISABLE_AUTOUPDATER": "1"
  }
}
```

### What Mirror Does NOT Set

- `ANTHROPIC_BASE_URL` - Uses Claude Code default
- `ANTHROPIC_API_KEY` - User authenticates normally
- `ANTHROPIC_DEFAULT_*_MODEL` - Uses Claude Code defaults

---

## ğŸ’¡ Tips

### Combine with Other Features

```bash
# Mirror with shell env integration (for Zsh/Bash profile)
npx cc-mirror create --provider mirror --name mclaude --shell-env
```

### Run Multiple Mirrors

```bash
# Work account
npx cc-mirror create --provider mirror --name work-claude

# Personal account
npx cc-mirror create --provider mirror --name personal-claude

# Run each with different API keys
ANTHROPIC_API_KEY="$WORK_KEY" work-claude
ANTHROPIC_API_KEY="$PERSONAL_KEY" personal-claude
```

---

## ğŸ”™ Related

- [Brand Themes](brand-themes.md) - Theme customization
- [Architecture Overview](../architecture/overview.md) - How cc-mirror works


## Links discovered
- [Brand Themes](https://github.com/numman-ali/cc-mirror/blob/main/docs/features/brand-themes.md)
- [Architecture Overview](https://github.com/numman-ali/cc-mirror/blob/main/docs/architecture/overview.md)

--- test/tui/ApiKeyScreen.test.ts ---
import test from 'node:test';
import assert from 'node:assert/strict';
import React from 'react';
import { render } from 'ink-testing-library';
import { ApiKeyScreen } from '../../src/tui/screens/ApiKeyScreen.js';
import { tick } from '../helpers/index.js';

test('ApiKeyScreen shows auth-token links for Vercel', async () => {
  const app = render(
    React.createElement(ApiKeyScreen, {
      providerLabel: 'Vercel AI Gateway',
      providerKey: 'vercel',
      envVarName: 'ANTHROPIC_AUTH_TOKEN',
      value: '',
      onChange: () => {},
      onSubmit: () => {},
    })
  );

  await tick();
  const output = app.lastFrame() ?? '';

  assert.ok(output.includes('Auth Token'), 'should show auth token title');
  assert.ok(output.includes('https://vercel.com/ai'), 'should show subscribe URL');
  assert.ok(output.includes('https://vercel.com/account/tokens'), 'should show credential URL');
  assert.ok(output.includes('https://vercel.com/docs/ai-gateway'), 'should show docs URL');

  app.unmount();
});

test('ApiKeyScreen falls back to generic guidance when provider links are missing', async () => {
  const app = render(
    React.createElement(ApiKeyScreen, {
      providerLabel: 'Unknown Provider',
      providerKey: 'unknown',
      envVarName: 'ANTHROPIC_API_KEY',
      value: '',
      onChange: () => {},
      onSubmit: () => {},
    })
  );

  await tick();
  const output = app.lastFrame() ?? '';

  assert.ok(output.includes("Get your API key from your provider's dashboard"), 'should show generic fallback help');

  app.unmount();
});


--- DESIGN.md ---
# cc-mirror Design

## Goals

- Create multiple isolated Claude Code variants, each with its own config + session store.
- Provide a **full-screen TUI** for discovery, creation, and management.
- Support unlimited providers with editable templates.
- Keep any global Claude Code install untouched.

## Architecture

```
  .-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-.
  |          ~/.cc-mirror/<variant>        |
  '-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-'
   |-- native/           # native Claude Code binary
   |   '-- claude        # (or claude.exe on Windows)
   |-- config/           # CLAUDE_CONFIG_DIR
   |   |-- settings.json # env overrides (API keys, model mappings, tool denies)
   |   '-- .claude.json  # API-key approvals + onboarding + MCP server seeds
   |-- tweakcc/          # tweakcc config/backup
   |   |-- config.json   # brand preset + theme config
   |   '-- system-prompts/ # prompt fragment overlays (prompt packs)
   '-- variant.json      # metadata

  wrapper -> <bin-dir>/<variant>
```

Wrappers are installed into `<bin-dir>/<variant>` (configurable).
Default `<bin-dir>` is `~/.local/bin` on macOS/Linux and `~/.cc-mirror/bin` on Windows.

## Core Components

- `src/providers/index.ts` â€” provider templates and env defaults
- `src/brands/` â€” tweakcc brand presets (optional UI skins)
- `src/core/` â€” file ops, tweakcc patching, variant CRUD (split by concern)
- `src/cli/index.ts` â€” CLI entrypoint, launches TUI when interactive
- `src/tui/` â€” Ink-based TUI wizard (components + app + entrypoint)
- `tweakcc` (dependency) â€” applies `cli.js` patches for each variant

## TUI Flow

- **Home**: create, manage, update-all, doctor
- **Quick setup**:
  - provider template
  - API key
  - model overrides (optional)
  - variant name (optional)
  - native install + tweakcc
- **Create wizard** (advanced):
  - provider template
  - brand preset (optional)
  - variant name
  - base URL
  - API key
  - model overrides
  - root + bin dirs
  - tweakcc toggle
  - provider prompt pack toggle
  - dev-browser skill install toggle
  - optional env overrides
  - summary + confirm
- **Manage**:
  - list variants
  - update / remove
- **Doctor**:
  - sanity report for binaries + wrappers

## Updating Binaries

- `cc-mirror update` rebuilds the `native/` + `tweakcc/` directories (preserving config, tasks, skills, approvals), then re-downloads the native binary and reapplies tweakcc for a clean upgrade.

## Maintenance Checklist

- Update all variants after Claude Code upgrades: `cc-mirror update`
- Update a single variant: `cc-mirror update <name>`
- Reapply or change brand preset: `cc-mirror update <name> --brand zai`
- Adjust API keys/base URL: edit `~/.cc-mirror/<variant>/config/settings.json`
- Launch tweakcc UI for a variant: `cc-mirror tweak <name>`
- Opt out of prompt packs: `--no-prompt-pack`
- Select prompt pack mode: `--prompt-pack-mode minimal`
- Opt out of skill install: `--no-skill-install`

## Provider Extensibility

Provider templates are plain TS objects; add new providers by extending `src/providers/index.ts`.

## Auth Handling

When an API key is supplied, cc-mirror writes `ANTHROPIC_API_KEY` into the variant config
so Claude Code recognizes API-key auth during onboarding.

Wrappers also load `settings.json` env vars at launch, ensuring onboarding sees API-key auth
before Claude Code applies config env internally.

For Z.ai variants, cc-mirror also sets `Z_AI_API_KEY` to the same value by default (used by `zai-cli`), unless the user overrides it via extra env. Quick/TUI flows can also write it into the shell profile (opt out with `--no-shell-env`).

cc-mirror also stores the **last 20 characters** of the API key in
`~/.cc-mirror/<variant>/config/.claude.json` under `customApiKeyResponses.approved` so Claude Code
skips the OAuth login screen in interactive mode.

Brand presets stamp the user label for the chat banner from `CLAUDE_CODE_USER_LABEL` (fallback: OS username).

Auth token providers (OpenRouter, Vercel, Ollama, NanoGPT, GatewayZ) use `ANTHROPIC_AUTH_TOKEN`. Some also set `ANTHROPIC_API_KEY` when the provider accepts either header.

MiniMax variants seed a default MCP server entry in `~/.cc-mirror/<variant>/config/.claude.json` so the coding-plan MCP is ready once you add your API key.

Z.ai and MiniMax variants add deny lists for known server-side MCP tools in `~/.cc-mirror/<variant>/config/settings.json` under `permissions.deny`, pushing the model toward provider-native tools (e.g., `zai-cli` for Z.ai, MiniMax MCP for MiniMax).

Prompt packs (provider overlays) are injected into tweakcc prompt fragments after tweakcc runs, then re-applied so the patched binary includes provider guidance.

dev-browser is installed into `~/.cc-mirror/<variant>/config/skills/dev-browser` by default for Z.ai and MiniMax variants (opt out with `--no-skill-install`).

## Brand Presets

Brand presets are optional tweakcc configurations written into `~/.cc-mirror/<variant>/tweakcc/config.json`.
Presets are provider-aware (e.g., `zai` auto-selects the Z.ai Carbon skin, `minimax` selects MiniMax Pulse) but can be overridden via `--brand`.

## Install (Native Binary)

cc-mirror downloads the native Claude Code binary into `~/.cc-mirror/<variant>/native/claude` (or `claude.exe` on Windows).
By default, variants track the `latest` channel. Use `--claude-version stable` to track stable, or pin a specific version with `--claude-version 2.1.37`.


--- CHANGELOG.md ---
# Changelog

This repository tracks changes primarily through Git history.

## v2.0.1

### Fixes

- **Windows tweakcc execution** â€” Invoke `tweakcc` via `cmd.exe` + `npx.cmd` so variant creation/update works reliably when `npx` isnâ€™t directly executable.
- **Windows PATH + tilde handling** â€” Better `~` expansion (supports `~\\`) and `list` now expands tilde before reading variants.
- **Docs** â€” Fixed Windows PATH examples (avoid double-escaped backslashes).

### CI / Dev

- **CI** â€” Added a Windows end-to-end smoke test on every PR (bundle + quick create + list/doctor + wrapper).
- **Tests** â€” Added regression coverage for Windows tweakcc execution and tilde expansion.
- **Lint** â€” Fixed a macOS CI failure caused by an unused variable in `scripts/preview-splash-grid.mjs`.

## v2.0.0

### Breaking Changes

- **Native-only installs** â€” Removed npm-based Claude Code installation entirely. All variants now use the native binary. Existing `npm/` directories are ignored; run `cc-mirror update` to migrate.
- **Team mode removed** â€” The team mode feature has been removed to reduce complexity.
- **Prompt pack mode** â€” Only `minimal` mode is supported. The `maximal` mode has been deprecated.

### New Providers

- **Kimi Code** â€” Moonshot AI's long-context coding assistant (kimi-for-coding / K2.5)
- **Ollama** â€” Local model runner with Anthropic-compatible API
- **GatewayZ** â€” Multi-provider AI gateway
- **Vercel AI Gateway** â€” Vercel's multi-provider gateway
- **NanoGPT** â€” Pay-per-token Claude Code endpoint
- **CC Router** â€” Route Claude Code to any LLM (Ollama, DeepSeek, etc.)

### Features

- **Unique brand themes for every provider** â€” Each provider has its own color palette, ASCII splash art, and custom thinking verbs
- **Adaptive diff palettes** â€” Diff colors now match each brand's color scheme for better readability
- **Model overrides in TUI** â€” Configure Sonnet/Opus/Haiku model mappings for all providers via the interactive wizard
- **`--claude-version` support** â€” Pin or update native Claude Code versions (`stable`, `latest`, or specific version)
- **Default to latest channel** â€” New variants track the `latest` Claude Code release by default
- **`--model` convenience flag** â€” Set all model tiers at once from CLI
- **Social media grid preview** â€” `scripts/preview-splash-grid.mjs` renders a 3x3 grid of all provider splash banners

### Improvements

- **OpenRouter Chrome theme** â€” Upgraded from navy to polished silver/chrome aesthetic
- **CC Router renamed** â€” "Claude Code Router" shortened to "CC Router" across UI
- **Mirror provider hidden** â€” Now marked as experimental (development reference only)
- **Tool denies via settings.json** â€” Provider tool restrictions moved from tweakcc toolsets to `settings.json` `permissions.deny` for reliability
- **Simplified splash art** â€” Cleaner, tighter ASCII art for OpenRouter, Vercel, CCRouter, and GatewayZ
- **Long API key paste fix** â€” TUI masked input now preserves full key across multiple paste chunks
- **Provider list viewport** â€” Constrained scrolling for cleaner TUI navigation

### Internal

- Legacy tweakcc toolset migration for existing variants
- Dark theme enforced as default for Rust native module compatibility
- Normalized variant metadata schema


--- CONTRIBUTING.md ---
# Contributing to cc-mirror

Thanks for your interest in contributing!

## Development Setup

```bash
# Clone the repo
git clone https://github.com/numman-ali/cc-mirror.git
cd cc-mirror

# Install dependencies
npm install

# Run in development mode
npm run dev -- --help
npm run tui

# Run tests
npm test

# Type check
npm run typecheck

# Bundle for distribution
npm run bundle
```

## Project Structure

```
src/
â”œâ”€â”€ cli/           # CLI entry point and argument parsing
â”œâ”€â”€ core/          # Core logic (create, update, remove variants)
â”œâ”€â”€ tui/           # Interactive TUI (ink/React)
â”‚   â”œâ”€â”€ screens/   # Screen components
â”‚   â””â”€â”€ components/# Reusable UI components
â”œâ”€â”€ brands/        # Provider theme presets
â””â”€â”€ providers/     # Provider templates (zai, minimax, etc.)

test/              # Tests (node:test)
scripts/           # Build scripts
```

## Adding a New Provider

1. Add the provider template in `src/providers/index.ts`
2. Add a brand preset in `src/brands/` (optional)
3. Update help text in `src/cli/help.ts`
4. Add tests in `test/`

## Code Style

- TypeScript with strict mode
- ESM modules
- Functional style preferred
- No emojis in code/output unless user requests

## Testing

```bash
# Run all tests
npm test

# Run specific test file
npm test -- test/core.test.ts
```

## Commits

Use conventional commits:

- `feat:` New feature
- `fix:` Bug fix
- `docs:` Documentation
- `refactor:` Code refactoring
- `test:` Tests
- `chore:` Maintenance

## Pull Requests

1. Fork and create a branch
2. Make your changes
3. Run tests and type check
4. Submit PR with clear description

## Questions?

Open an issue or reach out on Twitter [@nummanali](https://twitter.com/nummanali).


## Links discovered
- [@nummanali](https://twitter.com/nummanali)

--- AGENTS.md ---
# Repository Guidelines

## Project Structure

```
src/
â”œâ”€â”€ cli/                    # CLI entrypoint and commands
â”‚   â”œâ”€â”€ index.ts           # Main CLI entry
â”‚   â”œâ”€â”€ commands/          # create, update, remove, doctor, etc.
â”‚   â””â”€â”€ args.ts            # Argument parsing
â”œâ”€â”€ tui/                    # Ink-based TUI wizard
â”‚   â”œâ”€â”€ app.tsx            # Main TUI application
â”‚   â”œâ”€â”€ screens/           # Individual screen components
â”‚   â”œâ”€â”€ components/        # Reusable UI components
â”‚   â”œâ”€â”€ hooks/             # React hooks for business logic
â”‚   â”œâ”€â”€ state/             # State types and management
â”‚   â””â”€â”€ router/            # Screen navigation
â”œâ”€â”€ core/                   # Core variant management
â”‚   â”œâ”€â”€ index.ts           # Public API (createVariant, updateVariant, etc.)
â”‚   â”œâ”€â”€ variant-builder/   # Step-based variant creation
â”‚   â”‚   â”œâ”€â”€ VariantBuilder.ts
â”‚   â”‚   â”œâ”€â”€ VariantUpdater.ts
â”‚   â”‚   â”œâ”€â”€ steps/         # Build steps (PrepareDirectories, InstallNative, etc.)
â”‚   â”‚   â””â”€â”€ update-steps/  # Update steps
â”‚   â”œâ”€â”€ prompt-pack/       # System prompt overlays
â”‚   â”‚   â”œâ”€â”€ providers/     # Per-provider overlays (zai.ts, minimax.ts)
â”‚   â”‚   â”œâ”€â”€ overlays.ts    # Overlay resolution
â”‚   â”‚   â””â”€â”€ targets.ts     # Target file mapping
â”‚   â””â”€â”€ *.ts               # Utils (paths, fs, tweakcc, skills, etc.)
â”œâ”€â”€ providers/              # Provider templates
â”‚   â””â”€â”€ index.ts           # Provider definitions and defaults
â”œâ”€â”€ brands/                 # TweakCC brand presets
â”‚   â”œâ”€â”€ index.ts           # Brand resolution
â”‚   â”œâ”€â”€ types.ts           # TweakCC config types
â”‚   â”œâ”€â”€ zai.ts             # Z.ai theme + blocked tools
â”‚   â”œâ”€â”€ minimax.ts         # MiniMax theme + blocked tools
â”‚   â””â”€â”€ *.ts               # Other brand configs

test/                       # Node test runner tests
â”œâ”€â”€ e2e/                   # End-to-end tests
â”œâ”€â”€ tui/                   # TUI component tests
â”œâ”€â”€ unit/                  # Unit tests
â””â”€â”€ helpers/               # Test utilities

repos/                      # Upstream reference copies (vendor data, history)
â”œâ”€â”€ anthropic-claude-code-*/       # Claude Code versions for comparison/reference
â”œâ”€â”€ claude-code-system-prompts/    # System prompt changelog and sources
â””â”€â”€ tweakcc/                       # TweakCC repo (prompt patching tool)

notes/                      # Research notes and deep dive documentation
â”œâ”€â”€ CLI-VERSIONS.md               # Version comparison notes
â”œâ”€â”€ *-DEEP-DIVE.md                # Feature research and analysis
â””â”€â”€ RECONSTRUCTION-LEDGER.md      # Project state and decisions

docs/                       # User documentation
dist/                       # Build output (generated)
```

## Build, Test, and Development Commands

```bash
npm install          # Install dependencies
npm run dev          # Run CLI from TypeScript sources
npm run tui          # Launch TUI wizard
npm test             # Run all tests
npm run typecheck    # TypeScript check without emit
npm run bundle       # Build dist/cc-mirror.mjs
npm run render:tui-svg  # Regenerate docs/cc-mirror-tree.svg
```

## Coding Conventions

- **TypeScript + ESM**: Use `import`/`export`, avoid CommonJS
- **Formatting**: 2-space indent, single quotes, semicolons
- **Tests**: Name as `*.test.ts`, place in `test/` mirroring `src/` structure
- **New files**: Place in relevant `src/<area>/` folder

## Runtime Layout & Config Flow

### Variant Directory Structure

```
~/.cc-mirror/<variant>/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.json       # Env overrides (API keys, base URLs, model defaults)
â”‚   â”œâ”€â”€ .claude.json        # API-key approvals + onboarding/theme + MCP servers
â”œâ”€â”€ tweakcc/
â”‚   â”œâ”€â”€ config.json         # Brand preset + theme list + toolsets
â”‚   â””â”€â”€ system-prompts/     # Prompt-pack overlays (after tweakcc apply)
â”œâ”€â”€ native/
â”‚   â””â”€â”€ claude              # Native Claude Code binary (or claude.exe on Windows)
â””â”€â”€ variant.json            # Metadata
```

### Wrapper Script

Location: `<bin-dir>/<variant>` (macOS/Linux) or `<bin-dir>/<variant>.cmd` (Windows)

Default `<bin-dir>` is `~/.local/bin` on macOS/Linux and `~/.cc-mirror/bin` on Windows.

- Sets `CLAUDE_CONFIG_DIR` to variant config
- Loads `settings.json` into env at runtime
- Shows provider splash ASCII art when TTY and `CC_MIRROR_SPLASH != 0`
- Auto-update disable: `DISABLE_AUTOUPDATER=1` in settings.json env

### Provider Auth Modes

| Provider                              | Auth Mode  | Key Variable                                 |
| ------------------------------------- | ---------- | -------------------------------------------- |
| zai, minimax, kimi, custom            | API Key    | `ANTHROPIC_API_KEY`                          |
| openrouter, vercel, nanogpt, gatewayz | Auth Token | `ANTHROPIC_AUTH_TOKEN`                       |
| ollama                                | Auth Token | `ANTHROPIC_AUTH_TOKEN` + `ANTHROPIC_API_KEY` |
| ccrouter                              | Optional   | placeholder token                            |
| mirror                                | None       | user authenticates normally                  |

### Model Mapping (env vars)

- `ANTHROPIC_DEFAULT_SONNET_MODEL`
- `ANTHROPIC_DEFAULT_OPUS_MODEL`
- `ANTHROPIC_DEFAULT_HAIKU_MODEL`
- Optional: `ANTHROPIC_SMALL_FAST_MODEL`, `ANTHROPIC_MODEL`, `CLAUDE_CODE_SUBAGENT_MODEL`

## Provider Blocked Tools

Providers block tools via `settings.json` `permissions.deny` entries (written during variant creation/update). Tool lists are defined in `src/brands/*.ts`.

**zai blocked tools:**

```typescript
export const ZAI_BLOCKED_TOOLS = [
  'mcp__4_5v_mcp__analyze_image', // Server-injected
  'mcp__milk_tea_server__claim_milk_tea_coupon',
  'mcp__web_reader__webReader',
  'WebSearch', // Use zai-cli search
  'WebFetch', // Use zai-cli read
];
```

**minimax blocked tools:**

```typescript
export const MINIMAX_BLOCKED_TOOLS = [
  'WebSearch', // Use mcp__MiniMax__web_search
];
```

## Prompt Pack

- Only `minimal` mode supported (maximal deprecated)
- Per-provider overlays in `src/core/prompt-pack/providers/`
- Applied to `tweakcc/system-prompts/` via TweakCC
- Overlays are sanitized to strip backticks (tweakcc template literal issue)

## Common Development Tasks

| Task                        | Location                                                |
| --------------------------- | ------------------------------------------------------- |
| Add/update provider         | `src/providers/index.ts`                                |
| Add/update brand theme      | `src/brands/*.ts`                                       |
| Add blocked tools           | `src/brands/zai.ts` or `minimax.ts` â†’ `*_BLOCKED_TOOLS` |
| Modify prompt pack overlays | `src/core/prompt-pack/providers/*.ts`                   |
| Add build step              | `src/core/variant-builder/steps/`                       |
| Add TUI screen              | `src/tui/screens/` + `app.tsx` + `router/routes.ts`     |

## Debugging & Verification

### Config Inspection

```bash
# Variant config
cat ~/.cc-mirror/<variant>/config/settings.json
cat ~/.cc-mirror/<variant>/config/.claude.json
cat ~/.cc-mirror/<variant>/variant.json

# TweakCC config
cat ~/.cc-mirror/<variant>/tweakcc/config.json

# Wrapper script
cat <bin-dir>/<variant>
```

### Health Check

```bash
npx cc-mirror doctor
```

### Reference Files

- **Upstream CLI references**: `repos/anthropic-claude-code-*/cli.js` (multiple versions for comparison)
- **System prompt sources**: `repos/claude-code-system-prompts/` (includes CHANGELOG.md)
- **Research notes**: `notes/` (deep dives, version analysis, design decisions)
- **Applied prompts**: `~/.cc-mirror/<variant>/tweakcc/system-prompts/`
- **Debug logs**: `~/.cc-mirror/<variant>/config/debug/*.txt`

### CLI Feature Gates

```bash
# Native installs don't have cli.js on disk. Use tweakcc to unpack first:
npx tweakcc unpack /tmp/claude-code.js ~/.cc-mirror/<variant>/native/claude
rg "tengu_prompt_suggestion|promptSuggestionEnabled" /tmp/claude-code.js

# Check cached gates
cat ~/.cc-mirror/<variant>/config/.claude.json | jq '.statsig'
```

## ZAI CLI (for Z.ai variants)

```bash
# Available commands
npx zai-cli --help
npx zai-cli vision --help
npx zai-cli search --help
npx zai-cli read --help
npx zai-cli repo --help

# Examples
npx zai-cli search "React 19 new features" --count 5
npx zai-cli read https://docs.example.com/api
npx zai-cli vision analyze ./screenshot.png "What errors?"
npx zai-cli repo search facebook/react "server components"
```

Requires `Z_AI_API_KEY` in environment.

## Manual Debug Flow (Create Variant)

1. Run: `npm run dev -- create --provider zai --name test-zai --api-key <key>`
2. Verify `variant.json` exists
3. Verify `.claude.json` has `hasCompletedOnboarding` + `theme`
4. Run wrapper in TTY and confirm splash + no onboarding prompt
5. Use `npx cc-mirror update test-zai` to validate update flow

## Testing

```bash
npm test                                    # All tests
npm test -- --test-name-pattern="E2E"      # E2E tests only
npm test -- --test-name-pattern="TUI"      # TUI tests only
```

Key test files:

- `test/e2e/creation.test.ts` - Variant creation for all providers
- `test/e2e/blocked-tools.test.ts` - Provider blocked tools
- `test/tui/*.test.tsx` - TUI component tests

## Architecture Notes

- **Step-based builds**: Each step is isolated, can be sync or async
- **Build order**: PrepareDirectories â†’ InstallNative â†’ WriteConfig â†’ BrandTheme â†’ Tweakcc â†’ Wrapper â†’ ShellEnv â†’ SkillInstall â†’ Finalize

## Documentation

- `README.md` - User-facing documentation
- `DESIGN.md` - Architecture design document
- `docs/features/mirror-claude.md` - Mirror provider guide
- `docs/architecture/overview.md` - Architecture overview
- `docs/RECONSTRUCTION-LEDGER.md` - Current state + decisions

<skills_system priority="1">

## Available Skills

<!-- SKILLS_TABLE_START -->
<usage>
When users ask you to perform tasks, check if any of the available skills below can help complete the task more effectively. Skills provide specialized capabilities and domain knowledge.

How to use skills:

- Invoke: `npx openskills read <skill-name>` (run in your shell)
  - For multiple: `npx openskills read skill-one,skill-two`
- The skill content will load with detailed instructions on how to complete the task
- Base directory provided in output for resolving bundled resources (references/, scripts/, assets/)

Usage notes:

- Only use skills listed in <available_skills> below
- Do not invoke a skill that is already loaded in your context
- Each skill invocation is stateless
  </usage>

<available_skills>

<skill>
<name>open-source-maintainer</name>
<description>End-to-end GitHub repository maintenance for open-source projects. Use when asked to triage issues, review PRs, analyze contributor activity, generate maintenance reports, or maintain a repository. Triggers include "triage", "maintain", "review PRs", "analyze issues", "repo maintenance", "what needs attention", "open source maintenance", or any request to understand and act on GitHub issues/PRs. Supports human-in-the-loop workflows with persistent memory across sessions.</description>
<location>project</location>
</skill>

</available_skills>

<!-- SKILLS_TABLE_END -->

</skills_system>


--- CLAUDE.md ---
@AGENTS.md


--- README.md ---
# CC-MIRROR

<p align="center">
  <img src="./assets/cc-mirror-providers.png" alt="CC-MIRROR Provider Themes" width="800">
</p>

<p align="center">
  <a href="https://www.npmjs.com/package/cc-mirror"><img src="https://img.shields.io/npm/v/cc-mirror.svg" alt="npm version"></a>
  <a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="License: MIT"></a>
  <a href="https://twitter.com/nummanali"><img src="https://img.shields.io/twitter/follow/nummanali?style=social" alt="Twitter Follow"></a>
</p>

<h2 align="center">Claude Code, Unshackled</h2>

<p align="center">
  Pre-configured Claude Code variants with custom providers,<br>
  prompt packs, and battle-tested enhancements.<br><br>
  <strong>One command. Instant power-up.</strong>
</p>

---

## Quick Start

```bash
# Fastest path to a configured Claude Code variant
npx cc-mirror quick --provider mirror --name mclaude

# Run it
mclaude
```

That's it. You now have a Claude Code variant ready to run.

### Claude Code Version (Stable/Latest/Pin)

By default, CC-MIRROR installs the **latest** Claude Code native release. You can pin a channel or version:

```bash
# Track upstream stable channel
npx cc-mirror quick --provider mirror --name mclaude --claude-version stable

# Track upstream latest channel
npx cc-mirror update mclaude --claude-version latest

# Pin a specific version
npx cc-mirror update mclaude --claude-version 2.1.37
```

Notes:

- `stable` and `latest` are upstream channels. `stable` may lag behind `latest` (that is normal).
- cc-mirror resolves the channel to a concrete version during install/update and stores it in `variant.json`.

<p align="center">
  <img src="./assets/cc-mirror-home.png" alt="CC-MIRROR Home Screen" width="600">
</p>

### Or use the interactive wizard

```bash
npx cc-mirror
```

---

## What is CC-MIRROR?

CC-MIRROR is an **opinionated Claude Code distribution**. We did the hacking â€” you get the superpowers.

At its core, CC-MIRROR:

1. **Clones** Claude Code into isolated instances
2. **Configures** provider endpoints, model mapping, and env defaults
3. **Applies** prompt packs and tweakcc themes
4. **Installs** optional skills (dev-browser, opt-in)
5. **Packages** everything into a single command

Each variant is completely isolated â€” its own config, sessions, MCP servers, and credentials. Your main Claude Code installation stays untouched.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ~/.cc-mirror/                                                          â”‚
â”‚                                                                         â”‚
â”‚  â”œâ”€â”€ mclaude/                        â† Mirror Claude                     â”‚
â”‚  â”‚   â”œâ”€â”€ native/                     Claude Code installation           â”‚
â”‚  â”‚   â”œâ”€â”€ config/                     API keys, sessions, MCP servers    â”‚
â”‚  â”‚   â”œâ”€â”€ tweakcc/                    Theme customization                â”‚
â”‚  â”‚   â””â”€â”€ variant.json                Metadata                           â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â”œâ”€â”€ zai/                            â† Z.ai variant (GLM models)        â”‚
â”‚  â”œâ”€â”€ minimax/                        â† MiniMax variant (M2.5)           â”‚
â”‚  â””â”€â”€ kimi/                           â† Kimi Code variant (kimi-for-coding) â”‚
â”‚                                                                         â”‚
â”‚  Wrappers: <bin-dir>/mclaude, <bin-dir>/zai, ...                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Default `<bin-dir>` is `~/.local/bin` on macOS/Linux and `~/.cc-mirror/bin` on Windows.

**Windows tip:** add `%USERPROFILE%\.cc-mirror\bin` to your `PATH`, or run the `<variant>.cmd` wrapper directly. Each wrapper has a sibling `<variant>.mjs` launcher.

---

## Providers

### Mirror Claude (Recommended)

The purest path to vanilla Claude Code. No proxy, no model changes â€” just clean isolation.

```bash
npx cc-mirror quick --provider mirror --name mclaude
```

- **Direct Anthropic API** â€” No proxy, authenticate normally (OAuth or API key)
- **Isolated config** â€” Experiment without affecting your main setup
- **Provider presets** â€” Clean defaults without hidden patches

### Alternative Providers

Want to use different models? CC-MIRROR supports multiple providers:

| Provider       | Models                 | Auth       | Best For                        |
| -------------- | ---------------------- | ---------- | ------------------------------- |
| **Kimi**       | kimi-for-coding        | API Key    | Long-context coding (Kimi Code) |
| **MiniMax**    | MiniMax-M2.5           | API Key    | Unified model experience        |
| **Z.ai**       | GLM-5, 4.7, 4.5-Air    | API Key    | Heavy coding with GLM reasoning |
| **OpenRouter** | 100+ models            | Auth Token | Model flexibility, pay-per-use  |
| **Vercel**     | Multi-provider gateway | Auth Token | Vercel AI Gateway               |
| **Ollama**     | Local + cloud models   | Auth Token | Local-first + hybrid setups     |
| **NanoGPT**    | Claude Code endpoint   | Auth Token | Simple endpoint setup           |
| **CCRouter**   | Ollama, DeepSeek, etc. | Optional   | Local-first development         |
| **GatewayZ**   | Multi-provider gateway | Auth Token | Centralized routing             |

### Provider Setup Links

| Provider       | Subscribe                                                     | Get Key/Token                                                    | Docs                                                             |
| -------------- | ------------------------------------------------------------- | ---------------------------------------------------------------- | ---------------------------------------------------------------- |
| **Kimi**       | https://www.kimi.com/code                                     | https://www.kimi.com/code/console                                | https://www.kimi.com/code/docs/en/more/third-party-agents.html   |
| **MiniMax**    | https://platform.minimax.io/subscribe/coding-plan             | https://platform.minimax.io/user-center/payment/coding-plan      | https://platform.minimax.io/docs                                 |
| **Z.ai**       | https://z.ai/subscribe                                        | https://z.ai/manage-apikey/apikey-list                           | https://z.ai/docs                                                |
| **OpenRouter** | https://openrouter.ai/account                                 | https://openrouter.ai/keys                                       | https://openrouter.ai/docs                                       |
| **Vercel**     | https://vercel.com/ai                                         | https://vercel.com/account/tokens                                | https://vercel.com/docs/ai-gateway                               |
| **Ollama**     | https://ollama.com                                            | https://ollama.com                                               | https://docs.ollama.com/api/anthropic-compatibility              |
| **NanoGPT**    | https://nano-gpt.com                                          | https://nano-gpt.com                                             | https://docs.nano-gpt.com/docs/anthropic-compatibility           |
| **CCRouter**   | https://github.com/musistudio/claude-code-router#installation | https://github.com/musistudio/claude-code-router#2-configuration | https://github.com/musistudio/claude-code-router#2-configuration |
| **GatewayZ**   | https://gatewayz.ai                                           | https://gatewayz.ai                                              | https://docs.gatewayz.ai/docs/anthropic-compatibility            |

```bash
# Kimi Code (kimi-for-coding)
npx cc-mirror quick --provider kimi --api-key "$KIMI_API_KEY"

# MiniMax (MiniMax-M2.5)
npx cc-mirror quick --provider minimax --api-key "$MINIMAX_API_KEY"

# Z.ai (GLM-5/4.7/4.5-Air)
npx cc-mirror quick --provider zai --api-key "$Z_AI_API_KEY"

# OpenRouter (100+ models)
npx cc-mirror quick --provider openrouter --api-key "$OPENROUTER_API_KEY" \
  --model-sonnet "anthropic/claude-sonnet-4-20250514"

# Vercel AI Gateway
npx cc-mirror quick --provider vercel --api-key "$VERCEL_AI_GATEWAY_KEY" \
  --model-sonnet "anthropic/claude-3-5-sonnet-20241022"

# Ollama
npx cc-mirror quick --provider ollama --api-key "ollama" \
  --model-sonnet "qwen3-coder" --model-opus "qwen3-coder" --model-haiku "qwen3-coder"

# NanoGPT
npx cc-mirror quick --provider nanogpt --api-key "$NANOGPT_API_KEY"

# CC Router (local LLMs)
npx cc-mirror quick --provider ccrouter

# GatewayZ
npx cc-mirror quick --provider gatewayz --api-key "$GATEWAYZ_API_KEY" \
  --model-sonnet "claude-3-5-sonnet-20241022"
```

---

## All Commands

```bash
# Create & manage variants
npx cc-mirror                     # Interactive TUI
npx cc-mirror quick [options]     # Fast setup with defaults
npx cc-mirror create [options]    # Full configuration wizard
npx cc-mirror list                # List all variants
npx cc-mirror update [name]       # Update one or all variants
npx cc-mirror apply <name>        # Re-apply tweakcc patches (no reinstall)
npx cc-mirror remove <name>       # Delete a variant
npx cc-mirror doctor              # Health check all variants
npx cc-mirror tweak <name>        # Launch tweakcc customization

# Launch your variant
mclaude                           # Run Mirror Claude
zai                               # Run Z.ai variant
minimax                           # Run MiniMax variant
kimi                              # Run Kimi Code variant
```

---

## CLI Options

```
--provider <name>        kimi | minimax | zai | openrouter | vercel | ollama | nanogpt | ccrouter | mirror | gatewayz | custom
--name <name>            Variant name (becomes the CLI command)
--api-key <key>          Provider API key
--base-url <url>         Custom API endpoint
--model-sonnet <name>    Map to sonnet model
--model-opus <name>      Map to opus model
--model-haiku <name>     Map to haiku model
--brand <preset>         Theme: auto | kimi | minimax | zai | openrouter | vercel | ollama | nanogpt | ccrouter | mirror | gatewayz
--no-tweak               Skip tweakcc theme
--no-prompt-pack         Skip provider prompt pack
--verbose               Show full tweakcc output during update
```

---

## Brand Themes

Each provider includes a custom color theme via [tweakcc](https://github.com/Piebald-AI/tweakcc):

| Brand          | Style                            |
| -------------- | -------------------------------- |
| **kimi**       | Teal/cyan gradient               |
| **minimax**    | Coral/red/orange spectrum        |
| **zai**        | Dark carbon with gold accents    |
| **openrouter** | Silver/chrome with electric blue |
| **vercel**     | Monochrome with green accents    |
| **ollama**     | Warm sandstone with earthy tones |
| **nanogpt**    | Aurora green + cyan accents      |
| **ccrouter**   | Sky blue accents                 |
| **gatewayz**   | Violet gradients                 |

---

## Documentation

| Document                                        | Description                          |
| ----------------------------------------------- | ------------------------------------ |
| [Mirror Claude](docs/features/mirror-claude.md) | Pure Claude Code with clean defaults |
| [Architecture](docs/architecture/overview.md)   | How CC-MIRROR works under the hood   |
| [Full Documentation](docs/README.md)            | Complete documentation index         |

---

## Related Projects

- [tweakcc](https://github.com/Piebald-AI/tweakcc) â€” Theme and customize Claude Code
- [Claude Code Router](https://github.com/musistudio/claude-code-router) â€” Route Claude Code to any LLM
- [n-skills](https://github.com/numman-ali/n-skills) â€” Universal skills for AI agents

---

## Contributing

Contributions welcome! See [CONTRIBUTING.md](CONTRIBUTING.md) for development setup.

**Want to add a provider?** Check the [Provider Guide](docs/TWEAKCC-GUIDE.md).

---

## License

MIT â€” see [LICENSE](LICENSE)

---

<p align="center">
  <strong>Created by <a href="https://github.com/numman-ali">Numman Ali</a></strong><br>
  <a href="https://twitter.com/nummanali">@nummanali</a>
</p>


## Links discovered
- [tweakcc](https://github.com/Piebald-AI/tweakcc)
- [Mirror Claude](https://github.com/numman-ali/cc-mirror/blob/main/docs/features/mirror-claude.md)
- [Architecture](https://github.com/numman-ali/cc-mirror/blob/main/docs/architecture/overview.md)
- [Full Documentation](https://github.com/numman-ali/cc-mirror/blob/main/docs/README.md)
- [Claude Code Router](https://github.com/musistudio/claude-code-router)
- [n-skills](https://github.com/numman-ali/n-skills)
- [CONTRIBUTING.md](https://github.com/numman-ali/cc-mirror/blob/main/CONTRIBUTING.md)
- [Provider Guide](https://github.com/numman-ali/cc-mirror/blob/main/docs/TWEAKCC-GUIDE.md)
- [LICENSE](https://github.com/numman-ali/cc-mirror/blob/main/LICENSE.md)
- [<img src="https://img.shields.io/npm/v/cc-mirror.svg" alt="npm version">](https://www.npmjs.com/package/cc-mirror)
- [<img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="License: MIT">](https://opensource.org/licenses/MIT)
- [<img src="https://img.shields.io/twitter/follow/nummanali?style=social" alt="Twitter Follow">](https://twitter.com/nummanali)
- [Numman Ali](https://github.com/numman-ali)
- [@nummanali](https://twitter.com/nummanali)

--- eslint.config.js ---
import eslint from '@eslint/js';
import tseslint from 'typescript-eslint';
import reactPlugin from 'eslint-plugin-react';
import reactHooksPlugin from 'eslint-plugin-react-hooks';
import prettier from 'eslint-config-prettier';

export default tseslint.config(
  eslint.configs.recommended,
  ...tseslint.configs.recommended,
  {
    plugins: {
      react: reactPlugin,
      'react-hooks': reactHooksPlugin,
    },
    languageOptions: {
      parserOptions: {
        ecmaFeatures: {
          jsx: true,
        },
      },
    },
    settings: {
      react: {
        version: 'detect',
      },
    },
    rules: {
      // React rules
      'react/jsx-uses-react': 'off',
      'react/react-in-jsx-scope': 'off',
      'react-hooks/rules-of-hooks': 'error',
      'react-hooks/exhaustive-deps': 'warn',

      // TypeScript rules
      '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_', varsIgnorePattern: '^_' }],
      '@typescript-eslint/no-explicit-any': 'warn',
      '@typescript-eslint/explicit-function-return-type': 'off',
      '@typescript-eslint/no-non-null-assertion': 'warn',

      // General rules
      'no-console': 'off',
      'prefer-const': 'error',
      'no-var': 'error',
    },
  },
  {
    ignores: ['dist/**', 'node_modules/**', '*.js', '*.mjs', '!eslint.config.js'],
  },
  prettier
);


--- .github/PULL_REQUEST_TEMPLATE.md ---
## Description

Brief description of what this PR does.

## Type of Change

- [ ] Bug fix (non-breaking change that fixes an issue)
- [ ] New feature (non-breaking change that adds functionality)
- [ ] Breaking change (fix or feature that would cause existing functionality to not work as expected)
- [ ] Documentation update

## Related Issues

Fixes #(issue number)

## How Has This Been Tested?

- [ ] Ran `npm run check` (typecheck + lint + test)
- [ ] Tested the TUI flow manually
- [ ] Tested CLI commands

## Checklist

- [ ] My code follows the project's style guidelines
- [ ] I have performed a self-review of my code
- [ ] I have commented my code where necessary
- [ ] I have updated the documentation if needed
- [ ] My changes generate no new warnings
- [ ] I have added tests that prove my fix/feature works
- [ ] New and existing tests pass locally


--- .github/ISSUE_TEMPLATE/bug_report.md ---
---
name: Bug Report
about: Report something that isn't working correctly
title: '[Bug] '
labels: bug
assignees: ''
---

## Describe the Bug

A clear and concise description of what the bug is.

## To Reproduce

Steps to reproduce the behavior:

1. Run `npx cc-mirror ...`
2. Select '...'
3. See error

## Expected Behavior

A clear description of what you expected to happen.

## Screenshots

If applicable, add screenshots to help explain your problem.

## Environment

- **OS**: [e.g., macOS 14.0, Ubuntu 22.04, Windows 11]
- **Node.js version**: [e.g., 20.10.0]
- **cc-mirror version**: [e.g., 1.0.0]
- **Provider**: [e.g., zai, minimax, openrouter, ccrouter]

## Additional Context

Add any other context about the problem here.


--- .github/maintainer/context.md ---
# Project Context

## Vision

cc-mirror provides isolated Claude Code variants that connect to multiple AI providers. The goal is fast, reliable provider switching with consistent UX, clear configuration, and minimal breakage across upstream Claude Code updates.

## Current Priorities

1. Expand provider coverage with verified auth/base URLs and minimal UX friction.
2. Keep core flows stable across Claude Code updates (minimax/zai compatibility).
3. Improve documentation for config layout, wrapper usage, and MCP server setup.

## Success Metrics

- Adoption: increasing provider variants created per release.
- Quality: fewer crash/blocker bugs and reduced support churn.

## Areas

| Area        | Status     | Notes                                  |
| ----------- | ---------- | -------------------------------------- |
| `src/core/` | Stable     | High scrutiny for changes              |
| `src/cli/`  | Active     | Moderate churn okay                    |
| `src/tui/`  | Active     | UX changes welcome                     |
| `docs/`     | Needs work | Prioritize config + onboarding clarity |

## Contribution Guidelines

- External PRs are reference implementations; maintainer implements changes directly.
- Provide a test plan and verified provider documentation links for provider PRs.

## Tone

Friendly, direct, and technical. No vague promises.

## Out of Scope

- Team mode (removed in latest releases; only supported in 1.6.3).
- Merging external PRs directly.


--- .github/maintainer/contributors.md ---
# Contributor Notes

## Jan 2026 Snapshot (open items)

### PR Authors

- @MohMaya (PR:9) â€” Sync Variants feature proposal; good direction but currently deferred.
- @vdimarco (PR:4) â€” GatewayZ provider; likely superseded by PR:31 (credit when closing).
- @0xGingi (PR:5) â€” NanoGPT provider; likely superseded by PR:31 (credit when closing).
- @jerilynzheng (PR:21) â€” Vercel AI Gateway provider; likely superseded by PR:31 (credit when closing).
- @mikekelly (PR:22) â€” `--no-skills` flag request; decision is â€œno flag, default offâ€ (close with explanation).
- @am-will (PR:20) â€” ccstatusline integration idea; needs product decision and UX fit check.

### Issue Reporters / Feedback

- @Set27 (ISSUE:27) â€” minimax crash report with stack trace; needs repro details/version confirmation.
- @netman2048 (ISSUE:29) â€” /compact failure with good environment details; likely upstream behavior.
- @Jobierre (ISSUE:14) â€” IPv6 TLS issue with a working workaround; good troubleshooting write-up.
- @husseinkaraki (ISSUE:12, ISSUE:16) â€” Termux + MCP server UX feedback; strong doc improvement signal.
- @acomarcho (ISSUE:23) â€” cloud provider request (Azure Foundry example env vars); good potential provider template.
- @seramat (ISSUE:10) â€” Z.ai Chinese endpoint request with base URL suggestion.


--- .github/maintainer/decisions.md ---
# Decision Log

## 2026-01

### [ISSUE:42] Deferred - Version requirements

**Date:** 2026-01-15
**Decision:** Defer to post-1.0
**Reasoning:** Good feature but adds complexity. Want to stabilize core first.

### [PR:38] Closed - Implemented fix

**Date:** 2026-01-16
**Decision:** Closed after maintainer implementation
**Reasoning:** Fixes critical bug affecting all Windows users. Tests pass.

### [ISSUE:30] Closed - Stale

**Date:** 2026-01-16
**Decision:** Closed without action
**Reasoning:** No response to info request for 60 days.

### Team mode removal in current releases

**Date:** 2026-01-18
**Decision:** Team mode is out of scope for current releases (only supported in 1.6.3).
**Reasoning:** Maintenance cost outweighs value; focus on provider expansion and stability.

### [ISSUE:8] Deferred - Sync Variants

**Date:** 2026-01-18
**Decision:** Defer Sync Variants to a later milestone.
**Reasoning:** High complexity; prioritize provider expansion and core stability first.

### [PR:22] Declined - --no-skills flag

**Date:** 2026-01-18
**Decision:** Do not add a dedicated flag; dev-browser defaults to off with opt-in.
**Reasoning:** Team mode removed; simpler default and UI toggle avoids extra CLI surface area.

### Ollama provider intake

**Date:** 2026-01-18
**Decision:** Add Ollama provider (Anthropic compatibility; local + cloud).
**Reasoning:** Local-first demand and clear compatibility docs make this a high-leverage addition.

### Gateway provider PR consolidation (PR:31)

**Date:** 2026-01-23
**Decision:** Consolidate gateway provider work into PR:31; close PR:4 / PR:5 / PR:21 as duplicates after merge (with credit).
**Reasoning:** Multiple overlapping provider PRs increase drift risk. One canonical implementation keeps auth/env semantics consistent and centralizes tests + docs.


--- .github/ISSUE_TEMPLATE/feature_request.md ---
---
name: Feature Request
about: Suggest an idea for cc-mirror
title: '[Feature] '
labels: enhancement
assignees: ''
---

## Is your feature request related to a problem?

A clear and concise description of what the problem is. Ex. I'm always frustrated when [...]

## Describe the Solution You'd Like

A clear and concise description of what you want to happen.

## Describe Alternatives You've Considered

A clear and concise description of any alternative solutions or features you've considered.

## Additional Context

Add any other context or screenshots about the feature request here.

## Would You Like to Contribute?

- [ ] I'm interested in implementing this feature
- [ ] I'd like guidance on how to implement this


--- .github/maintainer/patterns.md ---
# Observed Patterns

## Recurring Issues

### Windows Path Handling

- **First seen:** 2025-12-15
- **Frequency:** 8 duplicate reports
- **Root cause:** Hardcoded `/` instead of `path.sep`
- **Resolution:** Fixed in v1.3.1
- **Prevention:** Added Windows CI

### Version Display Mismatch

- **First seen:** 2025-12-19
- **Cause:** Hardcoded version string not updated
- **Resolution:** Read from package.json dynamically

## Contributor Patterns

- Chinese-speaking user base is significant (consider i18n)
- Provider additions often arrive as multiple overlapping PRs; prefer a single â€œprovider intakeâ€ umbrella branch/PR to reduce drift (PR:31 vs PR:4/5/21).

## Codebase Patterns

- Most bugs cluster in `src/cli/` (needs refactoring)
- Test coverage gaps in error handling paths

## UX Patterns

- Users are confused about MCP server config location and variant vs project scope.
- The dev-browser skill default was frequently questioned; now default off with opt-in (keep docs/UI aligned).


--- .github/maintainer/runs.md ---
# Run Ledger

| Date | Report Path | Summary |
| ---- | ----------- | ------- |

- 2026-01-17T22:41:51.518Z | reports/2026-01-17T22-41-51 | issues:11 prs:10
- 2026-01-17T22:52:03.295Z | reports/2026-01-17T22-52-03 | issues:11 prs:10
- 2026-01-18T08:51:57.020Z | reports/2026-01-18T08-51-57 | issues:10 prs:6
- 2026-01-23T13:29:59.600Z | reports/2026-01-23T13-29-59 | issues:10 prs:7


--- .github/maintainer/standing-rules.md ---
# Standing Rules

## Stale Policy

| Condition                 | Days | Action                    |
| ------------------------- | ---- | ------------------------- |
| Issue waiting on reporter | 30   | Comment asking for update |
| Issue waiting on reporter | 60   | Close as stale            |
| PR waiting on author      | 30   | Close as stale            |

## Auto-Labels

| Condition                | Label                |
| ------------------------ | -------------------- |
| PR touches `src/core/`   | `core`               |
| Issue mentions "windows" | `platform:windows`   |
| First-time contributor   | `first-contribution` |

## External PR Handling

- Never merge external PRs
- Extract intent and implement fixes directly
- Close PRs with explanation and credit

## Scope Notes

- Team mode is removed in current releases (only supported in 1.6.3). Treat new team-mode issues as out of scope unless the reporter is on 1.6.3.
- Provider additions require verified base URL/auth docs and should avoid unverified marketing claims in README.


--- .github/maintainer/work/agent-briefs.md ---
# Agent Briefs

## Brief: Consolidate provider PRs into PR:31

**Goal:** Use PR:31 as the canonical implementation for gateway providers + dev-browser default off + Ollama. After merge, close duplicate provider PRs with credit and point to the merged commit.

**Items:** PR:31, PR:4, PR:5, PR:21, PR:22, ISSUE:23

**Acceptance:**

- PR:31 merged cleanly with CI green.
- PR:4/5/21 closed as duplicates with credit and link to merged PR.
- PR:22 closed as declined (decision already logged).
- ISSUE:23 updated to reflect gateway coverage (Foundry remains open as follow-up).

## Brief: Investigate minimax crash (`EJ.has is not a function`)

**Goal:** Reproduce ISSUE:27, identify whether the root cause is upstream Claude Code vs cc-mirror overlays/toolsets, and ship a fix or documented workaround.

**Acceptance:**

- Repro steps captured + minimal failing case.
- Fix/workaround validated on Linux (and ideally macOS).
- Regression test added if fix is in cc-mirror code.

## Brief: Add Z.ai CN endpoint support

**Goal:** Address ISSUE:10 by adding a supported path for the Chinese GLM Coding Plan endpoint (`https://open.bigmodel.cn/api/anthropic`).

**Acceptance:**

- Either: new provider key (e.g., `zai-cn`) with clear labeling, or: documented/validated base-url override flow.
- Docs mention any model mapping differences.

## Brief: Docs fixes for MCP servers + shell integration

**Goal:** Address user confusion in ISSUE:16 and ISSUE:12 with explicit docs and better â€œcreate finishedâ€ output.

**Acceptance:**

- Docs show exactly where `.claude.json` lives per variant and how to add MCP servers.
- Docs include Termux/no-rc troubleshooting.


--- scripts/bundle.ts ---
import { build } from 'esbuild';
import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();
const distDir = path.join(root, 'dist');

fs.mkdirSync(distDir, { recursive: true });

// Keep React ecosystem as external (npm will install them)
// This avoids bundling issues with dynamic imports and optional deps
const external = [
  // React ecosystem - let npm handle these
  'react',
  'react-dom',
  'ink',
  'ink-select-input',
  'ink-text-input',
  // Other dependencies
];

// Build CLI
await build({
  entryPoints: [path.join(root, 'src', 'cli', 'index.ts')],
  outfile: path.join(distDir, 'cc-mirror.mjs'),
  bundle: true,
  platform: 'node',
  format: 'esm',
  target: 'node18',
  external,
  banner: {
    js: '#!/usr/bin/env node',
  },
});

// Build TUI
await build({
  entryPoints: [path.join(root, 'src', 'tui', 'index.tsx')],
  outfile: path.join(distDir, 'tui.mjs'),
  bundle: true,
  platform: 'node',
  format: 'esm',
  target: 'node18',
  external,
});

fs.chmodSync(path.join(distDir, 'cc-mirror.mjs'), 0o755);

// Copy bundled skills to dist
const skillsSrcDir = path.join(root, 'src', 'skills');
const skillsDistDir = path.join(distDir, 'skills');
if (fs.existsSync(skillsSrcDir)) {
  fs.cpSync(skillsSrcDir, skillsDistDir, { recursive: true });
  console.log('Copied skills to dist/skills');
}

console.log('Bundled to dist/cc-mirror.mjs and dist/tui.mjs');


--- scripts/render-tui-svg.ts ---
import React from 'react';
import fs from 'node:fs';
import path from 'node:path';
import { render } from 'ink-testing-library';
import { App } from '../src/tui/app.js';

const stripAnsi = (input: string) =>
  input.replace(
    // eslint-disable-next-line no-control-regex
    /\u001b\[[0-9;]*m|\u001b\][0-9;]*\u0007|\u001b[=><]|\u001b\[?[0-9]*[A-Za-z]/g,
    ''
  );

const escapeXml = (value: string) =>
  value
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;');

const renderHomeScreen = async () => {
  const app = render(
    React.createElement(App, {
      initialRootDir: '~/.cc-mirror',
      initialBinDir: '~/.local/bin',
    })
  );
  await new Promise((resolve) => setTimeout(resolve, 30));
  const frame = app.lastFrame() || '';
  app.unmount();
  return stripAnsi(frame).split('\n');
};

const buildSvg = (lines: string[]) => {
  const padding = 24;
  const lineHeight = 18;
  const charWidth = 8;
  const maxLen = Math.max(...lines.map((line) => line.length), 0);
  const width = maxLen * charWidth + padding * 2;
  const height = lines.length * lineHeight + padding * 2;
  const bg = '#0b0c0f';
  const fg = '#e6e6e6';

  const text = lines
    .map((line, idx) => {
      const y = padding + (idx + 1) * lineHeight;
      return `<text x="${padding}" y="${y}" fill="${fg}">${escapeXml(line)}</text>`;
    })
    .join('\n');

  return `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" role="img" aria-label="cc-mirror TUI">
  <rect width="${width}" height="${height}" fill="${bg}" />
  <g font-family="SFMono-Regular, Menlo, Consolas, monospace" font-size="14">
${text}
  </g>
</svg>
`;
};

const main = async () => {
  const lines = await renderHomeScreen();
  const svg = buildSvg(lines);
  const target = path.join(process.cwd(), 'docs', 'cc-mirror-tree.svg');
  fs.writeFileSync(target, svg);
  console.log(`Wrote ${target}`);
};

main().catch((error) => {
  console.error(error);
  process.exit(1);
});


--- scripts/run-tests.ts ---
import { readdir } from 'node:fs/promises';
import { spawn } from 'node:child_process';
import path from 'node:path';
import process from 'node:process';

const ROOT = process.cwd();
const TEST_DIR = path.join(ROOT, 'test');

const collectTestFiles = async (dir: string, out: string[]): Promise<string[]> => {
  let entries;
  try {
    entries = await readdir(dir, { withFileTypes: true });
  } catch (error) {
    const err = error as NodeJS.ErrnoException;
    if (err && err.code === 'ENOENT') {
      return out;
    }
    throw error;
  }

  for (const entry of entries) {
    if (entry.name.startsWith('.')) {
      continue;
    }

    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      if (entry.name === 'node_modules') {
        continue;
      }
      await collectTestFiles(fullPath, out);
      continue;
    }

    if (entry.isFile() && entry.name.endsWith('.test.ts')) {
      out.push(fullPath);
    }
  }

  return out;
};

const testFiles: string[] = await collectTestFiles(TEST_DIR, []);
if (testFiles.length === 0) {
  console.error('No test files found under ./test.');
  process.exit(1);
}

testFiles.sort((a: string, b: string) => a.localeCompare(b));

const passThroughArgs: string[] = process.argv.slice(2);
const nodeArgs: string[] = ['--test', '--import', 'tsx'];
if (!passThroughArgs.some((arg) => arg === '--test-concurrency' || arg.startsWith('--test-concurrency='))) {
  nodeArgs.push('--test-concurrency=1');
}
nodeArgs.push(...passThroughArgs, ...testFiles);

const child = spawn(process.execPath, nodeArgs, { stdio: 'inherit' });
child.on('exit', (code, signal) => {
  if (signal) {
    process.exit(1);
  }
  process.exit(code ?? 1);
});


--- src/cli/args.ts ---
export interface ParsedArgs {
  _: string[];
  env: string[];
  yes?: boolean;
  noTweak?: boolean;
  tui?: boolean;
  noTui?: boolean;
  quick?: boolean;
  help?: boolean;
  ['no-prompt-pack']?: boolean;
  ['prompt-pack-mode']?: string;
  ['no-skill-install']?: boolean;
  ['skill-update']?: boolean;
  ['shell-env']?: boolean;
  ['no-shell-env']?: boolean;
  ['tweakcc-stdio']?: string;
  verbose?: boolean;
  [key: string]: string | boolean | string[] | undefined;
}

export const parseArgs = (argv: string[]): ParsedArgs => {
  const opts: ParsedArgs = { _: [], env: [] };
  const args = [...argv];
  while (args.length > 0) {
    const arg = args.shift() as string;
    if (!arg.startsWith('-')) {
      opts._.push(arg);
      continue;
    }
    if (arg === '--yes') {
      opts.yes = true;
      continue;
    }
    if (arg === '--no-tweak') {
      opts.noTweak = true;
      continue;
    }
    if (arg === '--tui') {
      opts.tui = true;
      continue;
    }
    if (arg === '--quick' || arg === '--simple') {
      opts.quick = true;
      continue;
    }
    if (arg === '--no-tui') {
      opts.noTui = true;
      continue;
    }
    if (arg.startsWith('--env=')) {
      opts.env.push(arg.slice('--env='.length));
      continue;
    }
    if (arg === '--env') {
      const value = args.shift();
      if (value) opts.env.push(value);
      continue;
    }
    const [key, inlineValue] = arg.startsWith('--') ? arg.slice(2).split('=') : [undefined, undefined];
    if (!key) continue;
    // If there's an inline value (--key=value), use it
    // Otherwise, peek at next arg - only consume if it doesn't start with -
    let value: string | undefined;
    if (inlineValue !== undefined) {
      value = inlineValue;
    } else {
      const next = args[0];
      if (next && !next.startsWith('-')) {
        value = args.shift();
      }
    }
    if (value !== undefined) {
      opts[key] = value;
    } else {
      opts[key] = true;
    }
  }
  return opts;
};


--- src/brands/ccrouter.ts ---
import type { TweakccConfig, Theme } from './types.js';
import { DEFAULT_THEMES } from './defaultThemes.js';
import { buildBrandMiscConfig } from './miscDefaults.js';
import { buildDiffPalette } from './diffPalette.js';
import { formatUserMessage, getUserLabel } from './userLabel.js';

type Rgb = { r: number; g: number; b: number };

const clamp = (value: number) => Math.max(0, Math.min(255, Math.round(value)));

const hexToRgb = (hex: string): Rgb => {
  const normalized = hex.replace('#', '').trim();
  if (normalized.length === 3) {
    const [r, g, b] = normalized.split('');
    return {
      r: clamp(parseInt(r + r, 16)),
      g: clamp(parseInt(g + g, 16)),
      b: clamp(parseInt(b + b, 16)),
    };
  }
  if (normalized.length !== 6) {
    throw new Error(`Unsupported hex color: ${hex}`);
  }
  return {
    r: clamp(parseInt(normalized.slice(0, 2), 16)),
    g: clamp(parseInt(normalized.slice(2, 4), 16)),
    b: clamp(parseInt(normalized.slice(4, 6), 16)),
  };
};

const rgb = (hex: string) => {
  const { r, g, b } = hexToRgb(hex);
  return `rgb(${r},${g},${b})`;
};

const mix = (hexA: string, hexB: string, weight: number) => {
  const a = hexToRgb(hexA);
  const b = hexToRgb(hexB);
  const w = Math.max(0, Math.min(1, weight));
  return `rgb(${clamp(a.r + (b.r - a.r) * w)},${clamp(a.g + (b.g - a.g) * w)},${clamp(a.b + (b.b - a.b) * w)})`;
};

const lighten = (hex: string, weight: number) => mix(hex, '#ffffff', weight);

const palette = {
  base: '#0c1320',
  surface: '#111a2a',
  panel: '#16233a',
  border: '#2a3f61',
  borderStrong: '#3f5f90',
  text: '#e7f1ff',
  textMuted: '#bfd0e8',
  textDim: '#8ca4c4',
  sky: '#4da3ff',
  skySoft: '#7bbcff',
  skyDeep: '#2a6fcb',
  cyan: '#64d5ff',
  green: '#2fb37f',
  red: '#e06b7a',
  orange: '#d9a04d',
  purple: '#7e8fe0',
};

const theme: Theme = {
  name: 'CCRouter Sky',
  id: 'dark',
  colors: {
    autoAccept: rgb(palette.green),
    bashBorder: rgb(palette.sky),
    claude: rgb(palette.skyDeep),
    claudeShimmer: lighten(palette.sky, 0.35),
    claudeBlue_FOR_SYSTEM_SPINNER: rgb(palette.sky),
    claudeBlueShimmer_FOR_SYSTEM_SPINNER: lighten(palette.skySoft, 0.2),
    permission: rgb(palette.cyan),
    permissionShimmer: lighten(palette.cyan, 0.25),
    planMode: rgb(palette.skyDeep),
    ide: rgb(palette.cyan),
    promptBorder: rgb(palette.border),
    promptBorderShimmer: rgb(palette.borderStrong),
    text: rgb(palette.text),
    inverseText: rgb(palette.base),
    inactive: rgb(palette.textDim),
    subtle: mix(palette.base, palette.skySoft, 0.15),
    suggestion: rgb(palette.skySoft),
    remember: rgb(palette.skyDeep),
    background: rgb(palette.base),
    success: rgb(palette.green),
    error: rgb(palette.red),
    warning: rgb(palette.orange),
    warningShimmer: lighten(palette.orange, 0.28),
    ...buildDiffPalette(),
    red_FOR_SUBAGENTS_ONLY: rgb(palette.red),
    blue_FOR_SUBAGENTS_ONLY: rgb(palette.skyDeep),
    green_FOR_SUBAGENTS_ONLY: rgb(palette.green),
    yellow_FOR_SUBAGENTS_ONLY: rgb(palette.orange),
    purple_FOR_SUBAGENTS_ONLY: rgb(palette.purple),
    orange_FOR_SUBAGENTS_ONLY: rgb(palette.orange),
    pink_FOR_SUBAGENTS_ONLY: lighten(palette.purple, 0.32),
    cyan_FOR_SUBAGENTS_ONLY: rgb(palette.cyan),
    professionalBlue: rgb(palette.sky),
    rainbow_red: rgb(palette.red),
    rainbow_orange: rgb(palette.orange),
    rainbow_yellow: lighten(palette.orange, 0.18),
    rainbow_green: rgb(palette.green),
    rainbow_blue: rgb(palette.skySoft),
    rainbow_indigo: rgb(palette.skyDeep),
    rainbow_violet: rgb(palette.purple),
    rainbow_red_shimmer: lighten(palette.red, 0.35),
    rainbow_orange_shimmer: lighten(palette.orange, 0.35),
    rainbow_yellow_shimmer: lighten(palette.orange, 0.3),
    rainbow_green_shimmer: lighten(palette.green, 0.35),
    rainbow_blue_shimmer: lighten(palette.skySoft, 0.35),
    rainbow_indigo_shimmer: lighten(palette.skyDeep, 0.35),
    rainbow_violet_shimmer: lighten(palette.purple, 0.35),
    clawd_body: rgb(palette.skyDeep),
    clawd_background: rgb(palette.base),
    userMessageBackground: mix('#383838', palette.sky, 0.12),
    bashMessageBackgroundColor: mix('#404040', palette.sky, 0.08),
    memoryBackgroundColor: mix('#383838', palette.cyan, 0.1),
    rate_limit_fill: rgb(palette.sky),
    rate_limit_empty: rgb(palette.borderStrong),
  },
};

export const buildCCRouterTweakccConfig = (): TweakccConfig => ({
  ccVersion: '',
  ccInstallationPath: null,
  lastModified: new Date().toISOString(),
  changesApplied: false,
  hidePiebaldAnnouncement: true,
  settings: {
    themes: [theme, ...DEFAULT_THEMES.filter((t) => t.id !== theme.id)],
    thinkingVerbs: {
      format: '{}... ',
      verbs: [
        'Routing',
        'Switching',
        'Proxying',
        'Forwarding',
        'Dispatching',
        'Negotiating',
        'Bridging',
        'Mapping',
        'Tunneling',
        'Resolving',
        'Balancing',
        'Indexing',
        'Synchronizing',
        'Finalizing',
      ],
    },
    thinkingStyle: {
      updateInterval: 115,
      phases: ['Â·', 'â€¢', 'â—¦', 'â€¢'],
      reverseMirror: false,
    },
    userMessageDisplay: {
      format: formatUserMessage(getUserLabel()),
      styling: ['bold'],
      foregroundColor: 'default',
      backgroundColor: 'default',
      borderStyle: 'topBottomDouble',
      borderColor: rgb(palette.sky),
      paddingX: 1,
      paddingY: 0,
      fitBoxToContent: true,
    },
    inputBox: {
      removeBorder: true,
    },
    misc: buildBrandMiscConfig(),
    claudeMdAltNames: null,
  },
});


--- src/core/claude-config.ts ---
import fs from 'node:fs';
import path from 'node:path';
import { readJson, writeJson } from './fs.js';

type ClaudeConfig = {
  customApiKeyResponses?: {
    approved?: string[];
    rejected?: string[];
  };
  mcpServers?: Record<string, McpServerConfig>;
  theme?: string;
  hasCompletedOnboarding?: boolean;
  lastOnboardingVersion?: string;
};

type SettingsFile = {
  env?: Record<string, string | number | undefined>;
  permissions?: {
    allow?: string[];
    ask?: string[];
    deny?: string[];
  };
};

type McpServerConfig = {
  command?: string;
  args?: string[];
  env?: Record<string, string>;
  url?: string;
  headers?: string[];
  transport?: string;
};

const SETTINGS_FILE = 'settings.json';
const CLAUDE_CONFIG_FILE = '.claude.json';
const PLACEHOLDER_KEY = '<API_KEY>';

const toStringOrNull = (value: unknown): string | null => {
  if (typeof value !== 'string') return null;
  const trimmed = value.trim();
  if (!trimmed || trimmed === PLACEHOLDER_KEY) return null;
  return trimmed;
};

const readSettingsApiKey = (configDir: string): string | null => {
  const settingsPath = path.join(configDir, SETTINGS_FILE);
  const settings = readJson<SettingsFile>(settingsPath);
  if (!settings?.env) return null;
  const env = settings.env;
  return toStringOrNull(env.ANTHROPIC_API_KEY);
};

export const ZAI_DENY_TOOLS = [
  // Z.ai injects these MCP tools; they can break expected cc-mirror behavior.
  'mcp__4_5v_mcp__analyze_image',
  'mcp__milk_tea_server__claim_milk_tea_coupon',
  'mcp__web_reader__webReader',
  // Built-in tools that should be routed via zai-cli instead.
  'WebSearch',
  'WebFetch',
];

export const MINIMAX_DENY_TOOLS = [
  // WebSearch should use mcp__MiniMax__web_search instead.
  'WebSearch',
];

export const ensureSettingsPermissionsDeny = (configDir: string, tools: string[]): boolean => {
  const settingsPath = path.join(configDir, SETTINGS_FILE);
  const existing = readJson<SettingsFile>(settingsPath) || {};
  const permissions = existing.permissions || {};
  const deny = Array.isArray(permissions.deny) ? [...permissions.deny] : [];

  let changed = false;
  for (const tool of tools) {
    if (!deny.includes(tool)) {
      deny.push(tool);
      changed = true;
    }
  }

  if (!changed) return false;

  const next: SettingsFile = {
    ...existing,
    permissions: {
      ...permissions,
      deny,
    },
  };

  writeJson(settingsPath, next);
  return true;
};

export const ensureSettingsEnvDefaults = (configDir: string, defaults: Record<string, string | number>): boolean => {
  const settingsPath = path.join(configDir, SETTINGS_FILE);
  const existing = readJson<SettingsFile>(settingsPath) || {};
  const env: Record<string, string | number | undefined> = { ...(existing.env ?? {}) };
  let changed = false;

  for (const [key, value] of Object.entries(defaults)) {
    if (!Object.hasOwn(env, key)) {
      env[key] = value;
      changed = true;
    }
  }

  if (!changed) return false;
  writeJson(settingsPath, { ...existing, env });
  return true;
};

export const ensureSettingsEnvOverrides = (
  configDir: string,
  overrides: Record<string, string | number | undefined>
): boolean => {
  const settingsPath = path.join(configDir, SETTINGS_FILE);
  const existing = readJson<SettingsFile>(settingsPath) || {};
  const env: Record<string, string | number | undefined> = { ...(existing.env ?? {}) };
  let changed = false;

  for (const [key, value] of Object.entries(overrides)) {
    if (value === undefined) continue;
    if (env[key] !== value) {
      env[key] = value;
      changed = true;
    }
  }

  if (!changed) return false;
  writeJson(settingsPath, { ...existing, env });
  return true;
};

export const ensureApiKeyApproval = (configDir: string, apiKey?: string | null): boolean => {
  const resolvedKey = toStringOrNull(apiKey) || readSettingsApiKey(configDir);
  if (!resolvedKey) return false;

  const approvedToken = resolvedKey.slice(-20);
  const configPath = path.join(configDir, CLAUDE_CONFIG_FILE);
  const exists = fs.existsSync(configPath);

  let config: ClaudeConfig | null = null;
  if (exists) {
    config = readJson<ClaudeConfig>(configPath);
    if (!config) return false;
  } else {
    config = {};
  }

  const approved = Array.isArray(config.customApiKeyResponses?.approved)
    ? [...config.customApiKeyResponses.approved]
    : [];
  const rejected = Array.isArray(config.customApiKeyResponses?.rejected)
    ? [...config.customApiKeyResponses.rejected]
    : [];

  if (approved.includes(approvedToken)) return false;

  approved.push(approvedToken);
  const next: ClaudeConfig = {
    ...config,
    customApiKeyResponses: {
      ...config.customApiKeyResponses,
      approved,
      rejected,
    },
  };

  writeJson(configPath, next);
  return true;
};

export type OnboardingStateResult = {
  updated: boolean;
  themeChanged: boolean;
  onboardingChanged: boolean;
};

export const ensureOnboardingState = (
  configDir: string,
  opts: { themeId?: string | null; forceTheme?: boolean; skipOnboardingFlag?: boolean } = {}
): OnboardingStateResult => {
  const configPath = path.join(configDir, CLAUDE_CONFIG_FILE);
  const exists = fs.existsSync(configPath);

  let config: ClaudeConfig | null = null;
  if (exists) {
    config = readJson<ClaudeConfig>(configPath);
    if (!config) {
      return { updated: false, themeChanged: false, onboardingChanged: false };
    }
  } else {
    config = {};
  }

  let changed = false;
  let themeChanged = false;
  let onboardingChanged = false;
  if (opts.themeId) {
    const shouldSetTheme = opts.forceTheme || !config.theme;
    if (shouldSetTheme && config.theme !== opts.themeId) {
      config.theme = opts.themeId;
      changed = true;
      themeChanged = true;
    }
  }

  // Skip setting hasCompletedOnboarding for providers that want users to see login screen
  if (!opts.skipOnboardingFlag && config.hasCompletedOnboarding !== true) {
    config.hasCompletedOnboarding = true;
    changed = true;
    onboardingChanged = true;
  }

  if (!changed) {
    return { updated: false, themeChanged: false, onboardingChanged: false };
  }
  writeJson(configPath, config);
  return { updated: true, themeChanged, onboardingChanged };
};

export const ensureMinimaxMcpServer = (configDir: string, apiKey?: string | null): boolean => {
  const resolvedKey = toStringOrNull(apiKey) || readSettingsApiKey(configDir);
  const configPath = path.join(configDir, CLAUDE_CONFIG_FILE);
  const exists = fs.existsSync(configPath);

  let config: ClaudeConfig | null = null;
  if (exists) {
    config = readJson<ClaudeConfig>(configPath);
    if (!config) return false;
  } else {
    config = {};
  }

  const existingServers = config.mcpServers ?? {};
  if (existingServers.MiniMax) return false;

  const mcpServer: McpServerConfig = {
    command: 'uvx',
    args: ['minimax-coding-plan-mcp', '-y'],
    env: {
      MINIMAX_API_KEY: resolvedKey ?? 'Enter your API key',
      MINIMAX_API_HOST: 'https://api.minimax.io',
    },
  };

  const next: ClaudeConfig = {
    ...config,
    mcpServers: {
      ...existingServers,
      MiniMax: mcpServer,
    },
  };

  writeJson(configPath, next);
  return true;
};


--- src/core/constants.ts ---
import os from 'node:os';
import path from 'node:path';

export const DEFAULT_ROOT = path.join(os.homedir(), '.cc-mirror');
export const DEFAULT_BIN_DIR =
  process.platform === 'win32' ? path.join(DEFAULT_ROOT, 'bin') : path.join(os.homedir(), '.local', 'bin');
export const TWEAKCC_VERSION = '4.0.1';
// Claude Code version/channel used for installs unless overridden.
// "stable" tracks the upstream stable channel; "latest" tracks newest releases.
export const DEFAULT_CLAUDE_VERSION = 'latest';
export const DEFAULT_CLAUDE_NATIVE_CACHE_DIR = path.join(DEFAULT_ROOT, '.cache', 'claude-native');


--- src/brands/defaultThemes.ts ---
import type { Theme } from './types.js';

export const DEFAULT_THEMES: Theme[] = [
  {
    name: 'Dark mode',
    id: 'dark',
    colors: {
      autoAccept: 'rgb(175,135,255)',
      bashBorder: 'rgb(253,93,177)',
      claude: 'rgb(215,119,87)',
      claudeShimmer: 'rgb(235,159,127)',
      claudeBlue_FOR_SYSTEM_SPINNER: 'rgb(147,165,255)',
      claudeBlueShimmer_FOR_SYSTEM_SPINNER: 'rgb(177,195,255)',
      permission: 'rgb(177,185,249)',
      permissionShimmer: 'rgb(207,215,255)',
      planMode: 'rgb(72,150,140)',
      ide: 'rgb(71,130,200)',
      promptBorder: 'rgb(136,136,136)',
      promptBorderShimmer: 'rgb(166,166,166)',
      text: 'rgb(255,255,255)',
      inverseText: 'rgb(0,0,0)',
      inactive: 'rgb(153,153,153)',
      subtle: 'rgb(80,80,80)',
      suggestion: 'rgb(177,185,249)',
      remember: 'rgb(177,185,249)',
      background: 'rgb(0,204,204)',
      success: 'rgb(78,186,101)',
      error: 'rgb(255,107,128)',
      warning: 'rgb(255,193,7)',
      warningShimmer: 'rgb(255,223,57)',
      diffAdded: 'rgb(34,92,43)',
      diffRemoved: 'rgb(122,41,54)',
      diffAddedDimmed: 'rgb(71,88,74)',
      diffRemovedDimmed: 'rgb(105,72,77)',
      diffAddedWord: 'rgb(56,166,96)',
      diffRemovedWord: 'rgb(179,89,107)',
      diffAddedWordDimmed: 'rgb(46,107,58)',
      diffRemovedWordDimmed: 'rgb(139,57,69)',
      red_FOR_SUBAGENTS_ONLY: 'rgb(220,38,38)',
      blue_FOR_SUBAGENTS_ONLY: 'rgb(37,99,235)',
      green_FOR_SUBAGENTS_ONLY: 'rgb(22,163,74)',
      yellow_FOR_SUBAGENTS_ONLY: 'rgb(202,138,4)',
      purple_FOR_SUBAGENTS_ONLY: 'rgb(147,51,234)',
      orange_FOR_SUBAGENTS_ONLY: 'rgb(234,88,12)',
      pink_FOR_SUBAGENTS_ONLY: 'rgb(219,39,119)',
      cyan_FOR_SUBAGENTS_ONLY: 'rgb(8,145,178)',
      professionalBlue: 'rgb(106,155,204)',
      rainbow_red: 'rgb(235,95,87)',
      rainbow_orange: 'rgb(245,139,87)',
      rainbow_yellow: 'rgb(250,195,95)',
      rainbow_green: 'rgb(145,200,130)',
      rainbow_blue: 'rgb(130,170,220)',
      rainbow_indigo: 'rgb(155,130,200)',
      rainbow_violet: 'rgb(200,130,180)',
      rainbow_red_shimmer: 'rgb(250,155,147)',
      rainbow_orange_shimmer: 'rgb(255,185,137)',
      rainbow_yellow_shimmer: 'rgb(255,225,155)',
      rainbow_green_shimmer: 'rgb(185,230,180)',
      rainbow_blue_shimmer: 'rgb(180,205,240)',
      rainbow_indigo_shimmer: 'rgb(195,180,230)',
      rainbow_violet_shimmer: 'rgb(230,180,210)',
      clawd_body: 'rgb(215,119,87)',
      clawd_background: 'rgb(0,0,0)',
      userMessageBackground: 'rgb(55, 55, 55)',
      bashMessageBackgroundColor: 'rgb(65, 60, 65)',
      memoryBackgroundColor: 'rgb(55, 65, 70)',
      rate_limit_fill: 'rgb(177,185,249)',
      rate_limit_empty: 'rgb(80,83,112)',
    },
  },
  {
    name: 'Light mode',
    id: 'light',
    colors: {
      autoAccept: 'rgb(135,0,255)',
      bashBorder: 'rgb(255,0,135)',
      claude: 'rgb(215,119,87)',
      claudeShimmer: 'rgb(245,149,117)',
      claudeBlue_FOR_SYSTEM_SPINNER: 'rgb(87,105,247)',
      claudeBlueShimmer_FOR_SYSTEM_SPINNER: 'rgb(117,135,255)',
      permission: 'rgb(87,105,247)',
      permissionShimmer: 'rgb(137,155,255)',
      planMode: 'rgb(0,102,102)',
      ide: 'rgb(71,130,200)',
      promptBorder: 'rgb(153,153,153)',
      promptBorderShimmer: 'rgb(183,183,183)',
      text: 'rgb(0,0,0)',
      inverseText: 'rgb(255,255,255)',
      inactive: 'rgb(102,102,102)',
      subtle: 'rgb(175,175,175)',
      suggestion: 'rgb(87,105,247)',
      remember: 'rgb(0,0,255)',
      background: 'rgb(0,153,153)',
      success: 'rgb(44,122,57)',
      error: 'rgb(171,43,63)',
      warning: 'rgb(150,108,30)',
      warningShimmer: 'rgb(200,158,80)',
      diffAdded: 'rgb(105,219,124)',
      diffRemoved: 'rgb(255,168,180)',
      diffAddedDimmed: 'rgb(199,225,203)',
      diffRemovedDimmed: 'rgb(253,210,216)',
      diffAddedWord: 'rgb(47,157,68)',
      diffRemovedWord: 'rgb(209,69,75)',
      diffAddedWordDimmed: 'rgb(144,194,156)',
      diffRemovedWordDimmed: 'rgb(232,165,173)',
      red_FOR_SUBAGENTS_ONLY: 'rgb(220,38,38)',
      blue_FOR_SUBAGENTS_ONLY: 'rgb(37,99,235)',
      green_FOR_SUBAGENTS_ONLY: 'rgb(22,163,74)',
      yellow_FOR_SUBAGENTS_ONLY: 'rgb(202,138,4)',
      purple_FOR_SUBAGENTS_ONLY: 'rgb(147,51,234)',
      orange_FOR_SUBAGENTS_ONLY: 'rgb(234,88,12)',
      pink_FOR_SUBAGENTS_ONLY: 'rgb(219,39,119)',
      cyan_FOR_SUBAGENTS_ONLY: 'rgb(8,145,178)',
      professionalBlue: 'rgb(106,155,204)',
      rainbow_red: 'rgb(235,95,87)',
      rainbow_orange: 'rgb(245,139,87)',
      rainbow_yellow: 'rgb(250,195,95)',
      rainbow_green: 'rgb(145,200,130)',
      rainbow_blue: 'rgb(130,170,220)',
      rainbow_indigo: 'rgb(155,130,200)',
      rainbow_violet: 'rgb(200,130,180)',
      rainbow_red_shimmer: 'rgb(250,155,147)',
      rainbow_orange_shimmer: 'rgb(255,185,137)',
      rainbow_yellow_shimmer: 'rgb(255,225,155)',
      rainbow_green_shimmer: 'rgb(185,230,180)',
      rainbow_blue_shimmer: 'rgb(180,205,240)',
      rainbow_indigo_shimmer: 'rgb(195,180,230)',
      rainbow_violet_shimmer: 'rgb(230,180,210)',
      clawd_body: 'rgb(215,119,87)',
      clawd_background: 'rgb(0,0,0)',
      userMessageBackground: 'rgb(240, 240, 240)',
      bashMessageBackgroundColor: 'rgb(250, 245, 250)',
      memoryBackgroundColor: 'rgb(230, 245, 250)',
      rate_limit_fill: 'rgb(87,105,247)',
      rate_limit_empty: 'rgb(39,47,111)',
    },
  },
  {
    name: 'Light mode (ANSI colors only)',
    id: 'light-ansi',
    colors: {
      autoAccept: 'ansi:magenta',
      bashBorder: 'ansi:magenta',
      claude: 'ansi:redBright',
      claudeShimmer: 'ansi:yellowBright',
      claudeBlue_FOR_SYSTEM_SPINNER: 'ansi:blue',
      claudeBlueShimmer_FOR_SYSTEM_SPINNER: 'ansi:blueBright',
      permission: 'ansi:blue',
      permissionShimmer: 'ansi:blueBright',
      planMode: 'ansi:cyan',
      ide: 'ansi:blueBright',
      promptBorder: 'ansi:white',
      promptBorderShimmer: 'ansi:whiteBright',
      text: 'ansi:black',
      inverseText: 'ansi:white',
      inactive: 'ansi:blackBright',
      subtle: 'ansi:blackBright',
      suggestion: 'ansi:blue',
      remember: 'ansi:blue',
      background: 'ansi:cyan',
      success: 'ansi:green',
      error: 'ansi:red',
      warning: 'ansi:yellow',
      warningShimmer: 'ansi:yellowBright',
      diffAdded: 'ansi:green',
      diffRemoved: 'ansi:red',
      diffAddedDimmed: 'ansi:green',
      diffRemovedDimmed: 'ansi:red',
      diffAddedWord: 'ansi:greenBright',
      diffRemovedWord: 'ansi:redBright',
      diffAddedWordDimmed: 'ansi:green',
      diffRemovedWordDimmed: 'ansi:red',
      red_FOR_SUBAGENTS_ONLY: 'ansi:red',
      blue_FOR_SUBAGENTS_ONLY: 'ansi:blue',
      green_FOR_SUBAGENTS_ONLY: 'ansi:green',
      yellow_FOR_SUBAGENTS_ONLY: 'ansi:yellow',
      purple_FOR_SUBAGENTS_ONLY: 'ansi:magenta',
      orange_FOR_SUBAGENTS_ONLY: 'ansi:redBright',
      pink_FOR_SUBAGENTS_ONLY: 'ansi:magentaBright',
      cyan_FOR_SUBAGENTS_ONLY: 'ansi:cyan',
      professionalBlue: 'ansi:blueBright',
      rainbow_red: 'ansi:red',
      rainbow_orange: 'ansi:redBright',
      rainbow_yellow: 'ansi:yellow',
      rainbow_green: 'ansi:green',
      rainbow_blue: 'ansi:cyan',
      rainbow_indigo: 'ansi:blue',
      rainbow_violet: 'ansi:magenta',
      rainbow_red_shimmer: 'ansi:redBright',
      rainbow_orange_shimmer: 'ansi:yellow',
      rainbow_yellow_shimmer: 'ansi:yellowBright',
      rainbow_green_shimmer: 'ansi:greenBright',
      rainbow_blue_shimmer: 'ansi:cyanBright',
      rainbow_indigo_shimmer: 'ansi:blueBright',
      rainbow_violet_shimmer: 'ansi:magentaBright',
      clawd_body: 'ansi:redBright',
      clawd_background: 'ansi:black',
      userMessageBackground: 'ansi:white',
      bashMessageBackgroundColor: 'ansi:whiteBright',
      memoryBackgroundColor: 'ansi:white',
      rate_limit_fill: 'ansi:yellow',
      rate_limit_empty: 'ansi:black',
    },
  },
  {
    name: 'Dark mode (ANSI colors only)',
    id: 'dark-ansi',
    colors: {
      autoAccept: 'ansi:magentaBright',
      bashBorder: 'ansi:magentaBright',
      claude: 'ansi:redBright',
      claudeShimmer: 'ansi:yellowBright',
      claudeBlue_FOR_SYSTEM_SPINNER: 'ansi:blueBright',
      claudeBlueShimmer_FOR_SYSTEM_SPINNER: 'ansi:blueBright',
      permission: 'ansi:blueBright',
      permissionShimmer: 'ansi:blueBright',
      planMode: 'ansi:cyanBright',
      ide: 'ansi:blue',
      promptBorder: 'ansi:white',
      promptBorderShimmer: 'ansi:whiteBright',
      text: 'ansi:whiteBright',
      inverseText: 'ansi:black',
      inactive: 'ansi:white',
      subtle: 'ansi:white',
      suggestion: 'ansi:blueBright',
      remember: 'ansi:blueBright',
      background: 'ansi:cyanBright',
      success: 'ansi:greenBright',
      error: 'ansi:redBright',
      warning: 'ansi:yellowBright',
      warningShimmer: 'ansi:yellowBright',
      diffAdded: 'ansi:green',
      diffRemoved: 'ansi:red',
      diffAddedDimmed: 'ansi:green',
      diffRemovedDimmed: 'ansi:red',
      diffAddedWord: 'ansi:greenBright',
      diffRemovedWord: 'ansi:redBright',
      diffAddedWordDimmed: 'ansi:green',
      diffRemovedWordDimmed: 'ansi:red',
      red_FOR_SUBAGENTS_ONLY: 'ansi:redBright',
      blue_FOR_SUBAGENTS_ONLY: 'ansi:blueBright',
      green_FOR_SUBAGENTS_ONLY: 'ansi:greenBright',
      yellow_FOR_SUBAGENTS_ONLY: 'ansi:yellowBright',
      purple_FOR_SUBAGENTS_ONLY: 'ansi:magentaBright',
      orange_FOR_SUBAGENTS_ONLY: 'ansi:redBright',
      pink_FOR_SUBAGENTS_ONLY: 'ansi:magentaBright',
      cyan_FOR_SUBAGENTS_ONLY: 'ansi:cyanBright',
      professionalBlue: 'rgb(106,155,204)',
      rainbow_red: 'ansi:red',
      rainbow_orange: 'ansi:redBright',
      rainbow_yellow: 'ansi:yellow',
      rainbow_green: 'ansi:green',
      rainbow_blue: 'ansi:cyan',
      rainbow_indigo: 'ansi:blue',
      rainbow_violet: 'ansi:magenta',
      rainbow_red_shimmer: 'ansi:redBright',
      rainbow_orange_shimmer: 'ansi:yellow',
      rainbow_yellow_shimmer: 'ansi:yellowBright',
      rainbow_green_shimmer: 'ansi:greenBright',
      rainbow_blue_shimmer: 'ansi:cyanBright',
      rainbow_indigo_shimmer: 'ansi:blueBright',
      rainbow_violet_shimmer: 'ansi:magentaBright',
      clawd_body: 'ansi:redBright',
      clawd_background: 'ansi:black',
      userMessageBackground: 'ansi:blackBright',
      bashMessageBackgroundColor: 'ansi:black',
      memoryBackgroundColor: 'ansi:blackBright',
      rate_limit_fill: 'ansi:yellow',
      rate_limit_empty: 'ansi:white',
    },
  },
  {
    name: 'Light mode (colorblind-friendly)',
    id: 'light-daltonized',
    colors: {
      autoAccept: 'rgb(135,0,255)',
      bashBorder: 'rgb(0,102,204)',
      claude: 'rgb(255,153,51)',
      claudeShimmer: 'rgb(255,183,101)',
      claudeBlue_FOR_SYSTEM_SPINNER: 'rgb(51,102,255)',
      claudeBlueShimmer_FOR_SYSTEM_SPINNER: 'rgb(101,152,255)',
      permission: 'rgb(51,102,255)',
      permissionShimmer: 'rgb(101,152,255)',
      planMode: 'rgb(51,102,102)',
      ide: 'rgb(71,130,200)',
      promptBorder: 'rgb(153,153,153)',
      promptBorderShimmer: 'rgb(183,183,183)',
      text: 'rgb(0,0,0)',
      inverseText: 'rgb(255,255,255)',
      inactive: 'rgb(102,102,102)',
      subtle: 'rgb(175,175,175)',
      suggestion: 'rgb(51,102,255)',
      remember: 'rgb(51,102,255)',
      background: 'rgb(0,153,153)',
      success: 'rgb(0,102,153)',
      error: 'rgb(204,0,0)',
      warning: 'rgb(255,153,0)',
      warningShimmer: 'rgb(255,183,50)',
      diffAdded: 'rgb(153,204,255)',
      diffRemoved: 'rgb(255,204,204)',
      diffAddedDimmed: 'rgb(209,231,253)',
      diffRemovedDimmed: 'rgb(255,233,233)',
      diffAddedWord: 'rgb(51,102,204)',
      diffRemovedWord: 'rgb(153,51,51)',
      diffAddedWordDimmed: 'rgb(102,153,204)',
      diffRemovedWordDimmed: 'rgb(204,153,153)',
      red_FOR_SUBAGENTS_ONLY: 'rgb(204,0,0)',
      blue_FOR_SUBAGENTS_ONLY: 'rgb(0,102,204)',
      green_FOR_SUBAGENTS_ONLY: 'rgb(0,204,0)',
      yellow_FOR_SUBAGENTS_ONLY: 'rgb(255,204,0)',
      purple_FOR_SUBAGENTS_ONLY: 'rgb(128,0,128)',
      orange_FOR_SUBAGENTS_ONLY: 'rgb(255,128,0)',
      pink_FOR_SUBAGENTS_ONLY: 'rgb(255,102,178)',
      cyan_FOR_SUBAGENTS_ONLY: 'rgb(0,178,178)',
      professionalBlue: 'rgb(106,155,204)',
      rainbow_red: 'rgb(235,95,87)',
      rainbow_orange: 'rgb(245,139,87)',
      rainbow_yellow: 'rgb(250,195,95)',
      rainbow_green: 'rgb(145,200,130)',
      rainbow_blue: 'rgb(130,170,220)',
      rainbow_indigo: 'rgb(155,130,200)',
      rainbow_violet: 'rgb(200,130,180)',
      rainbow_red_shimmer: 'rgb(250,155,147)',
      rainbow_orange_shimmer: 'rgb(255,185,137)',
      rainbow_yellow_shimmer: 'rgb(255,225,155)',
      rainbow_green_shimmer: 'rgb(185,230,180)',
      rainbow_blue_shimmer: 'rgb(180,205,240)',
      rainbow_indigo_shimmer: 'rgb(195,180,230)',
      rainbow_violet_shimmer: 'rgb(230,180,210)',
      clawd_body: 'rgb(215,119,87)',
      clawd_background: 'rgb(0,0,0)',
      userMessageBackground: 'rgb(220, 220, 220)',
      bashMessageBackgroundColor: 'rgb(250, 245, 250)',
      memoryBackgroundColor: 'rgb(230, 245, 250)',
      rate_limit_fill: 'rgb(51,102,255)',
      rate_limit_empty: 'rgb(23,46,114)',
    },
  },
  {
    name: 'Dark mode (colorblind-friendly)',
    id: 'dark-daltonized',
    colors: {
      autoAccept: 'rgb(175,135,255)',
      bashBorder: 'rgb(51,153,255)',
      claude: 'rgb(255,153,51)',
      claudeShimmer: 'rgb(255,183,101)',
      claudeBlue_FOR_SYSTEM_SPINNER: 'rgb(153,204,255)',
      claudeBlueShimmer_FOR_SYSTEM_SPINNER: 'rgb(183,224,255)',
      permission: 'rgb(153,204,255)',
      permissionShimmer: 'rgb(183,224,255)',
      planMode: 'rgb(102,153,153)',
      ide: 'rgb(71,130,200)',
      promptBorder: 'rgb(136,136,136)',
      promptBorderShimmer: 'rgb(166,166,166)',
      text: 'rgb(255,255,255)',
      inverseText: 'rgb(0,0,0)',
      inactive: 'rgb(153,153,153)',
      subtle: 'rgb(80,80,80)',
      suggestion: 'rgb(153,204,255)',
      remember: 'rgb(153,204,255)',
      background: 'rgb(0,204,204)',
      success: 'rgb(51,153,255)',
      error: 'rgb(255,102,102)',
      warning: 'rgb(255,204,0)',
      warningShimmer: 'rgb(255,234,50)',
      diffAdded: 'rgb(0,68,102)',
      diffRemoved: 'rgb(102,0,0)',
      diffAddedDimmed: 'rgb(62,81,91)',
      diffRemovedDimmed: 'rgb(62,44,44)',
      diffAddedWord: 'rgb(0,119,179)',
      diffRemovedWord: 'rgb(179,0,0)',
      diffAddedWordDimmed: 'rgb(26,99,128)',
      diffRemovedWordDimmed: 'rgb(128,21,21)',
      red_FOR_SUBAGENTS_ONLY: 'rgb(255,102,102)',
      blue_FOR_SUBAGENTS_ONLY: 'rgb(102,178,255)',
      green_FOR_SUBAGENTS_ONLY: 'rgb(102,255,102)',
      yellow_FOR_SUBAGENTS_ONLY: 'rgb(255,255,102)',
      purple_FOR_SUBAGENTS_ONLY: 'rgb(178,102,255)',
      orange_FOR_SUBAGENTS_ONLY: 'rgb(255,178,102)',
      pink_FOR_SUBAGENTS_ONLY: 'rgb(255,153,204)',
      cyan_FOR_SUBAGENTS_ONLY: 'rgb(102,204,204)',
      professionalBlue: 'rgb(106,155,204)',
      rainbow_red: 'rgb(235,95,87)',
      rainbow_orange: 'rgb(245,139,87)',
      rainbow_yellow: 'rgb(250,195,95)',
      rainbow_green: 'rgb(145,200,130)',
      rainbow_blue: 'rgb(130,170,220)',
      rainbow_indigo: 'rgb(155,130,200)',
      rainbow_violet: 'rgb(200,130,180)',
      rainbow_red_shimmer: 'rgb(250,155,147)',
      rainbow_orange_shimmer: 'rgb(255,185,137)',
      rainbow_yellow_shimmer: 'rgb(255,225,155)',
      rainbow_green_shimmer: 'rgb(185,230,180)',
      rainbow_blue_shimmer: 'rgb(180,205,240)',
      rainbow_indigo_shimmer: 'rgb(195,180,230)',
      rainbow_violet_shimmer: 'rgb(230,180,210)',
      clawd_body: 'rgb(215,119,87)',
      clawd_background: 'rgb(0,0,0)',
      userMessageBackground: 'rgb(55, 55, 55)',
      bashMessageBackgroundColor: 'rgb(65, 60, 65)',
      memoryBackgroundColor: 'rgb(55, 65, 70)',
      rate_limit_fill: 'rgb(153,204,255)',
      rate_limit_empty: 'rgb(69,92,115)',
    },
  },
  {
    name: 'Monochrome',
    id: 'monochrome',
    colors: {
      autoAccept: 'rgb(200,200,200)',
      bashBorder: 'rgb(180,180,180)',
      claude: 'rgb(255,255,255)',
      claudeShimmer: 'rgb(230,230,230)',
      claudeBlue_FOR_SYSTEM_SPINNER: 'rgb(200,200,200)',
      claudeBlueShimmer_FOR_SYSTEM_SPINNER: 'rgb(220,220,220)',
      permission: 'rgb(200,200,200)',
      permissionShimmer: 'rgb(220,220,220)',
      planMode: 'rgb(180,180,180)',
      ide: 'rgb(190,190,190)',
      promptBorder: 'rgb(160,160,160)',
      promptBorderShimmer: 'rgb(180,180,180)',
      text: 'rgb(255,255,255)',
      inverseText: 'rgb(40,40,40)',
      inactive: 'rgb(120,120,120)',
      subtle: 'rgb(100,100,100)',
      suggestion: 'rgb(200,200,200)',
      remember: 'rgb(200,200,200)',
      background: 'rgb(180,180,180)',
      success: 'rgb(220,220,220)',
      error: 'rgb(180,180,180)',
      warning: 'rgb(200,200,200)',
      warningShimmer: 'rgb(220,220,220)',
      diffAdded: 'rgb(90,90,90)',
      diffRemoved: 'rgb(60,60,60)',
      diffAddedDimmed: 'rgb(110,110,110)',
      diffRemovedDimmed: 'rgb(80,80,80)',
      diffAddedWord: 'rgb(200,200,200)',
      diffRemovedWord: 'rgb(80,80,80)',
      diffAddedWordDimmed: 'rgb(160,160,160)',
      diffRemovedWordDimmed: 'rgb(70,70,70)',
      red_FOR_SUBAGENTS_ONLY: 'rgb(200,200,200)',
      blue_FOR_SUBAGENTS_ONLY: 'rgb(180,180,180)',
      green_FOR_SUBAGENTS_ONLY: 'rgb(210,210,210)',
      yellow_FOR_SUBAGENTS_ONLY: 'rgb(190,190,190)',
      purple_FOR_SUBAGENTS_ONLY: 'rgb(170,170,170)',
      orange_FOR_SUBAGENTS_ONLY: 'rgb(195,195,195)',
      pink_FOR_SUBAGENTS_ONLY: 'rgb(205,205,205)',
      cyan_FOR_SUBAGENTS_ONLY: 'rgb(185,185,185)',
      professionalBlue: 'rgb(190,190,190)',
      rainbow_red: 'rgb(240,240,240)',
      rainbow_orange: 'rgb(230,230,230)',
      rainbow_yellow: 'rgb(220,220,220)',
      rainbow_green: 'rgb(210,210,210)',
      rainbow_blue: 'rgb(200,200,200)',
      rainbow_indigo: 'rgb(190,190,190)',
      rainbow_violet: 'rgb(180,180,180)',
      rainbow_red_shimmer: 'rgb(255,255,255)',
      rainbow_orange_shimmer: 'rgb(245,245,245)',
      rainbow_yellow_shimmer: 'rgb(235,235,235)',
      rainbow_green_shimmer: 'rgb(225,225,225)',
      rainbow_blue_shimmer: 'rgb(215,215,215)',
      rainbow_indigo_shimmer: 'rgb(205,205,205)',
      rainbow_violet_shimmer: 'rgb(195,195,195)',
      clawd_body: 'rgb(255,255,255)',
      clawd_background: 'rgb(40,40,40)',
      userMessageBackground: 'rgb(70,70,70)',
      bashMessageBackgroundColor: 'rgb(65,65,65)',
      memoryBackgroundColor: 'rgb(75,75,75)',
      rate_limit_fill: 'rgb(200,200,200)',
      rate_limit_empty: 'rgb(90,90,90)',
    },
  },
];


--- src/brands/diffPalette.ts ---
/**
 * Diff colors for brand themes.
 *
 * Returns the Claude Code default dark-mode diff palette â€” battle-tested by
 * Anthropic for readability across terminals. Brand identity comes from the
 * other ~55 theme properties; diffs should just be functional.
 */

export interface DiffPaletteInput {
  /** Kept for API compat â€” ignored. */
  base?: string;
  added?: string;
  removed?: string;
  tint?: string;
}

export interface DiffColors {
  diffAdded: string;
  diffRemoved: string;
  diffAddedDimmed: string;
  diffRemovedDimmed: string;
  diffAddedWord: string;
  diffRemovedWord: string;
  diffAddedWordDimmed: string;
  diffRemovedWordDimmed: string;
}

/** Claude Code default dark-mode diff colors. */
const DARK_DEFAULTS: DiffColors = {
  diffAdded: 'rgb(34,92,43)',
  diffRemoved: 'rgb(122,41,54)',
  diffAddedDimmed: 'rgb(71,88,74)',
  diffRemovedDimmed: 'rgb(105,72,77)',
  diffAddedWord: 'rgb(56,166,96)',
  diffRemovedWord: 'rgb(179,89,107)',
  diffAddedWordDimmed: 'rgb(46,107,58)',
  diffRemovedWordDimmed: 'rgb(139,57,69)',
};

export function buildDiffPalette(_input?: DiffPaletteInput): DiffColors {
  return DARK_DEFAULTS;
}


--- src/cli/doctor.ts ---
import type { DoctorReportItem } from '../core/types.js';

export const printDoctor = (report: DoctorReportItem[]) => {
  if (report.length === 0) {
    console.log('No variants found.');
    return;
  }
  for (const item of report) {
    console.log(`${item.ok ? 'âœ“' : 'âœ—'} ${item.name}`);
    if (!item.ok) {
      console.log(`  binary: ${item.binaryPath ?? 'missing'}`);
      console.log(`  wrapper: ${item.wrapperPath}`);
    }
  }
};


--- src/core/errors.ts ---
const extractErrorHint = (text: string) => {
  const normalized = text.toLowerCase();
  if (
    normalized.includes('could not extract js from native binary') ||
    normalized.includes('failed to extract claude.js from native installation') ||
    normalized.includes('failed to extract javascript from native installation')
  ) {
    return 'tweakcc could not extract JS from the native Claude Code binary. This usually means node-lief is unavailable on your system. Re-run with --no-tweak to skip theming, or follow tweakcc native-install docs to enable native patching.';
  }
  if (normalized.includes('node-lief')) {
    return 'tweakcc requires node-lief to patch native Claude Code binaries. If node-lief cannot be installed on your system, re-run with --no-tweak to skip theming.';
  }
  return null;
};

export const formatTweakccFailure = (output: string) => {
  const hint = extractErrorHint(output);
  if (hint) return hint;

  const lines = output
    .split(/\r?\n/)
    .map((line) => line.trim())
    .filter(Boolean);
  if (lines.length === 0) return 'tweakcc failed.';

  const errorLine = lines.find((line) => line.toLowerCase().startsWith('error:'));
  if (errorLine) return errorLine;

  const tail = lines.slice(-3).join(' | ');
  return tail.length > 0 ? tail : 'tweakcc failed.';
};


--- src/core/fs.ts ---
import fs from 'node:fs';

export const ensureDir = (dir: string) => {
  fs.mkdirSync(dir, { recursive: true });
};

export const writeJson = <T>(filePath: string, data: T) => {
  fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
};

export const readJson = <T>(filePath: string): T | null => {
  try {
    return JSON.parse(fs.readFileSync(filePath, 'utf8')) as T;
  } catch {
    return null;
  }
};


--- src/brands/gatewayz.ts ---
import type { TweakccConfig, Theme } from './types.js';
import { DEFAULT_THEMES } from './defaultThemes.js';
import { buildBrandMiscConfig } from './miscDefaults.js';
import { buildDiffPalette } from './diffPalette.js';
import { formatUserMessage, getUserLabel } from './userLabel.js';

type Rgb = { r: number; g: number; b: number };

const clamp = (value: number) => Math.max(0, Math.min(255, Math.round(value)));

const hexToRgb = (hex: string): Rgb => {
  const normalized = hex.replace('#', '').trim();
  if (normalized.length === 3) {
    const [r, g, b] = normalized.split('');
    return {
      r: clamp(parseInt(r + r, 16)),
      g: clamp(parseInt(g + g, 16)),
      b: clamp(parseInt(b + b, 16)),
    };
  }
  if (normalized.length !== 6) {
    throw new Error(`Unsupported hex color: ${hex}`);
  }
  return {
    r: clamp(parseInt(normalized.slice(0, 2), 16)),
    g: clamp(parseInt(normalized.slice(2, 4), 16)),
    b: clamp(parseInt(normalized.slice(4, 6), 16)),
  };
};

const rgb = (hex: string) => {
  const { r, g, b } = hexToRgb(hex);
  return `rgb(${r},${g},${b})`;
};

const mix = (hexA: string, hexB: string, weight: number) => {
  const a = hexToRgb(hexA);
  const b = hexToRgb(hexB);
  const w = Math.max(0, Math.min(1, weight));
  return `rgb(${clamp(a.r + (b.r - a.r) * w)},${clamp(a.g + (b.g - a.g) * w)},${clamp(a.b + (b.b - a.b) * w)})`;
};

const lighten = (hex: string, weight: number) => mix(hex, '#ffffff', weight);

const palette = {
  base: '#120d1d',
  surface: '#1a1328',
  panel: '#211736',
  border: '#35285a',
  borderStrong: '#4d3a80',
  text: '#efe8ff',
  textMuted: '#cfc0f2',
  textDim: '#9f8ec7',
  violet: '#9a6dff',
  violetBright: '#b38dff',
  violetDeep: '#6a3fd6',
  magenta: '#d36bff',
  green: '#2fb37f',
  red: '#e06b7a',
  orange: '#d9a04d',
  blue: '#6f8dff',
};

const theme: Theme = {
  name: 'GatewayZ Violet',
  id: 'dark',
  colors: {
    autoAccept: rgb(palette.green),
    bashBorder: rgb(palette.violet),
    claude: rgb(palette.violetDeep),
    claudeShimmer: lighten(palette.violet, 0.35),
    claudeBlue_FOR_SYSTEM_SPINNER: rgb(palette.violet),
    claudeBlueShimmer_FOR_SYSTEM_SPINNER: lighten(palette.violetBright, 0.2),
    permission: rgb(palette.magenta),
    permissionShimmer: lighten(palette.magenta, 0.25),
    planMode: rgb(palette.violetDeep),
    ide: rgb(palette.violetBright),
    promptBorder: rgb(palette.border),
    promptBorderShimmer: rgb(palette.borderStrong),
    text: rgb(palette.text),
    inverseText: rgb(palette.base),
    inactive: rgb(palette.textDim),
    subtle: mix(palette.base, palette.violetBright, 0.12),
    suggestion: rgb(palette.violetBright),
    remember: rgb(palette.violetDeep),
    background: rgb(palette.base),
    success: rgb(palette.green),
    error: rgb(palette.red),
    warning: rgb(palette.orange),
    warningShimmer: lighten(palette.orange, 0.28),
    ...buildDiffPalette(),
    red_FOR_SUBAGENTS_ONLY: rgb(palette.red),
    blue_FOR_SUBAGENTS_ONLY: rgb(palette.blue),
    green_FOR_SUBAGENTS_ONLY: rgb(palette.green),
    yellow_FOR_SUBAGENTS_ONLY: rgb(palette.orange),
    purple_FOR_SUBAGENTS_ONLY: rgb(palette.violet),
    orange_FOR_SUBAGENTS_ONLY: rgb(palette.orange),
    pink_FOR_SUBAGENTS_ONLY: lighten(palette.magenta, 0.32),
    cyan_FOR_SUBAGENTS_ONLY: rgb(palette.violetBright),
    professionalBlue: rgb(palette.violet),
    rainbow_red: rgb(palette.red),
    rainbow_orange: rgb(palette.orange),
    rainbow_yellow: lighten(palette.orange, 0.18),
    rainbow_green: rgb(palette.green),
    rainbow_blue: rgb(palette.violetBright),
    rainbow_indigo: rgb(palette.violetDeep),
    rainbow_violet: rgb(palette.violet),
    rainbow_red_shimmer: lighten(palette.red, 0.35),
    rainbow_orange_shimmer: lighten(palette.orange, 0.35),
    rainbow_yellow_shimmer: lighten(palette.orange, 0.3),
    rainbow_green_shimmer: lighten(palette.green, 0.35),
    rainbow_blue_shimmer: lighten(palette.violetBright, 0.35),
    rainbow_indigo_shimmer: lighten(palette.violetDeep, 0.35),
    rainbow_violet_shimmer: lighten(palette.violet, 0.35),
    clawd_body: rgb(palette.violetDeep),
    clawd_background: rgb(palette.base),
    userMessageBackground: mix('#383838', palette.violet, 0.12),
    bashMessageBackgroundColor: mix('#404040', palette.violet, 0.08),
    memoryBackgroundColor: mix('#383838', palette.blue, 0.1),
    rate_limit_fill: rgb(palette.violet),
    rate_limit_empty: rgb(palette.borderStrong),
  },
};

export const buildGatewayzTweakccConfig = (): TweakccConfig => ({
  ccVersion: '',
  ccInstallationPath: null,
  lastModified: new Date().toISOString(),
  changesApplied: false,
  hidePiebaldAnnouncement: true,
  settings: {
    themes: [theme, ...DEFAULT_THEMES.filter((t) => t.id !== theme.id)],
    thinkingVerbs: {
      format: '{}... ',
      verbs: [
        'Gatewaying',
        'Routing',
        'Bridging',
        'Relaying',
        'Switching',
        'Multiplexing',
        'Balancing',
        'Resolving',
        'Translating',
        'Stitching',
        'Sequencing',
        'Dispatching',
        'Orchestrating',
      ],
    },
    thinkingStyle: {
      updateInterval: 120,
      phases: ['Â·', 'â€¢', 'â—¦', 'â€¢'],
      reverseMirror: false,
    },
    userMessageDisplay: {
      format: formatUserMessage(getUserLabel()),
      styling: ['bold'],
      foregroundColor: 'default',
      backgroundColor: 'default',
      borderStyle: 'topBottomSingle',
      borderColor: rgb(palette.violet),
      paddingX: 1,
      paddingY: 0,
      fitBoxToContent: true,
    },
    inputBox: {
      removeBorder: true,
    },
    misc: buildBrandMiscConfig(),
    claudeMdAltNames: null,
  },
});


--- test/claude-config.test.ts ---
import test from 'node:test';
import assert from 'node:assert/strict';
import fs from 'node:fs';
import os from 'node:os';
import path from 'node:path';
import { ensureOnboardingState } from '../src/core/claude-config.js';

const makeTempDir = () => fs.mkdtempSync(path.join(os.tmpdir(), 'cc-mirror-claude-config-'));

test('ensureOnboardingState writes dark theme + onboarding flag', () => {
  const tempDir = makeTempDir();
  fs.mkdirSync(tempDir, { recursive: true });

  const result = ensureOnboardingState(tempDir, { themeId: 'dark' });
  assert.equal(result.updated, true);
  assert.equal(result.themeChanged, true);
  assert.equal(result.onboardingChanged, true);

  const configPath = path.join(tempDir, '.claude.json');
  const config = JSON.parse(fs.readFileSync(configPath, 'utf8')) as {
    theme?: string;
    hasCompletedOnboarding?: boolean;
  };
  assert.equal(config.theme, 'dark');
  assert.equal(config.hasCompletedOnboarding, true);

  const second = ensureOnboardingState(tempDir, { themeId: 'dark' });
  assert.equal(second.updated, false);
});


--- test/core.test.ts ---
import test from 'node:test';
import assert from 'node:assert/strict';
import fs from 'node:fs';
import path from 'node:path';
import * as core from '../src/core/index.js';
import { getWrapperPath } from '../src/core/paths.js';
import { makeTempDir, readFile, cleanup, resolveNativeClaudePath } from './helpers/index.js';

test('core create/update/remove/doctor flows', async () => {
  const rootDir = makeTempDir();
  const binDir = makeTempDir();

  const result = await core.createVariantAsync({
    name: 'alpha',
    providerKey: 'custom',
    baseUrl: 'http://localhost:4000/anthropic',
    apiKey: '',
    extraEnv: ['FOO=bar'],
    claudeVersion: 'stable',
    rootDir,
    binDir,
    noTweak: true,
    tweakccStdio: 'pipe',
  });

  const variantDir = path.join(rootDir, 'alpha');
  const nativeDir = path.join(variantDir, 'native');
  const binaryPath = resolveNativeClaudePath(nativeDir);
  const configPath = path.join(variantDir, 'config', 'settings.json');
  const wrapperPath = getWrapperPath(binDir, 'alpha');
  const variantMetaPath = path.join(variantDir, 'variant.json');

  assert.ok(fs.existsSync(binaryPath));
  assert.ok(fs.existsSync(configPath));
  assert.ok(fs.existsSync(wrapperPath));
  assert.ok(fs.existsSync(variantMetaPath));
  assert.equal(result.wrapperPath, wrapperPath);

  const configJson = JSON.parse(readFile(configPath)) as { env: Record<string, string> };
  assert.equal(configJson.env.ANTHROPIC_BASE_URL, 'http://localhost:4000/anthropic');
  assert.equal(configJson.env.FOO, 'bar');
  assert.equal(configJson.env.ANTHROPIC_API_KEY, '<API_KEY>');
  assert.equal(configJson.env.DISABLE_AUTOUPDATER, '1');
  assert.equal(configJson.env.DISABLE_AUTO_MIGRATE_TO_NATIVE, '1');
  assert.equal(configJson.env.DISABLE_INSTALLATION_CHECKS, '1');
  assert.equal(configJson.env.CLAUDE_CODE_ENABLE_PROMPT_SUGGESTION, '1');

  const metaBefore = JSON.parse(readFile(variantMetaPath)) as { updatedAt?: string };
  await new Promise((resolve) => setTimeout(resolve, 10));
  await core.updateVariantAsync(rootDir, 'alpha', { noTweak: true, tweakccStdio: 'pipe' });
  const metaAfter = JSON.parse(readFile(variantMetaPath)) as { updatedAt?: string };
  assert.ok(metaAfter.updatedAt, 'updatedAt should be set after update');
  assert.notEqual(metaAfter.updatedAt, metaBefore.updatedAt);

  const doctorReport = core.doctor(rootDir, binDir);
  assert.equal(doctorReport.length, 1);
  assert.equal(doctorReport[0].ok, true);

  core.removeVariant(rootDir, 'alpha');
  assert.equal(fs.existsSync(variantDir), false);

  cleanup(rootDir);
  cleanup(binDir);
});

test('zai brand preset writes tweakcc config', async () => {
  const rootDir = makeTempDir();
  const binDir = makeTempDir();

  try {
    await core.createVariantAsync({
      name: 'zai',
      providerKey: 'zai',
      apiKey: '',
      claudeVersion: 'stable',
      rootDir,
      binDir,
      brand: 'zai',
      promptPack: false,
      skillInstall: false,
      noTweak: true,
      tweakccStdio: 'pipe',
    });

    const tweakConfigPath = path.join(rootDir, 'zai', 'tweakcc', 'config.json');
    assert.ok(fs.existsSync(tweakConfigPath));
    const tweakConfig = JSON.parse(readFile(tweakConfigPath)) as { settings?: { themes?: { id?: string }[] } };
    assert.equal(tweakConfig.settings?.themes?.[0]?.id, 'dark');
  } finally {
    cleanup(rootDir);
    cleanup(binDir);
  }
});

test('minimax brand preset writes tweakcc config', async () => {
  const rootDir = makeTempDir();
  const binDir = makeTempDir();

  try {
    await core.createVariantAsync({
      name: 'minimax',
      providerKey: 'minimax',
      apiKey: '',
      claudeVersion: 'stable',
      rootDir,
      binDir,
      brand: 'minimax',
      promptPack: false,
      skillInstall: false,
      noTweak: true,
      tweakccStdio: 'pipe',
    });

    const tweakConfigPath = path.join(rootDir, 'minimax', 'tweakcc', 'config.json');
    assert.ok(fs.existsSync(tweakConfigPath));
    const tweakConfig = JSON.parse(readFile(tweakConfigPath)) as { settings?: { themes?: { id?: string }[] } };
    const themeIds = tweakConfig.settings?.themes?.map((theme) => theme?.id) ?? [];
    assert.equal(themeIds[0], 'dark');
    assert.equal(themeIds.includes('minimax-pulse'), false);
    assert.equal(themeIds.includes('minimax-glass'), false);
    assert.equal(themeIds.includes('minimax-blade'), false);
    assert.equal(themeIds.includes('minimax-ember'), false);

    const claudeConfigPath = path.join(rootDir, 'minimax', 'config', '.claude.json');
    assert.ok(fs.existsSync(claudeConfigPath));
    const claudeConfig = JSON.parse(readFile(claudeConfigPath)) as {
      mcpServers?: Record<string, { command?: string; args?: string[]; env?: Record<string, string> }>;
    };
    const minimaxServer = claudeConfig.mcpServers?.MiniMax;
    assert.ok(minimaxServer);
    assert.equal(minimaxServer?.command, 'uvx');
    assert.deepEqual(minimaxServer?.args, ['minimax-coding-plan-mcp', '-y']);
  } finally {
    cleanup(rootDir);
    cleanup(binDir);
  }
});

test('openrouter brand preset writes tweakcc config', async () => {
  const rootDir = makeTempDir();
  const binDir = makeTempDir();

  try {
    await core.createVariantAsync({
      name: 'openrouter',
      providerKey: 'openrouter',
      apiKey: 'or-key',
      claudeVersion: 'stable',
      rootDir,
      binDir,
      brand: 'openrouter',
      promptPack: false,
      skillInstall: false,
      noTweak: true,
      tweakccStdio: 'pipe',
    });

    const tweakConfigPath = path.join(rootDir, 'openrouter', 'tweakcc', 'config.json');
    assert.ok(fs.existsSync(tweakConfigPath));
    const tweakConfig = JSON.parse(readFile(tweakConfigPath)) as { settings?: { themes?: { id?: string }[] } };
    assert.equal(tweakConfig.settings?.themes?.[0]?.id, 'dark');
  } finally {
    cleanup(rootDir);
    cleanup(binDir);
  }
});

test('ccrouter brand preset writes tweakcc config', async () => {
  const rootDir = makeTempDir();
  const binDir = makeTempDir();

  try {
    await core.createVariantAsync({
      name: 'ccrouter',
      providerKey: 'ccrouter',
      apiKey: '',
      claudeVersion: 'stable',
      rootDir,
      binDir,
      brand: 'ccrouter',
      promptPack: false,
      skillInstall: false,
      noTweak: true,
      tweakccStdio: 'pipe',
    });

    const tweakConfigPath = path.join(rootDir, 'ccrouter', 'tweakcc', 'config.json');
    assert.ok(fs.existsSync(tweakConfigPath));
    const tweakConfig = JSON.parse(readFile(tweakConfigPath)) as { settings?: { themes?: { id?: string }[] } };
    assert.equal(tweakConfig.settings?.themes?.[0]?.id, 'dark');
  } finally {
    cleanup(rootDir);
    cleanup(binDir);
  }
});

test('mirror brand preset writes tweakcc config and disables prompt pack', async () => {
  const rootDir = makeTempDir();
  const binDir = makeTempDir();

  try {
    await core.createVariantAsync({
      name: 'mirror-test',
      providerKey: 'mirror',
      apiKey: '',
      claudeVersion: 'stable',
      rootDir,
      binDir,
      brand: 'mirror',
      noTweak: true,
      tweakccStdio: 'pipe',
    });

    // Verify tweakcc config with mirror theme
    const tweakConfigPath = path.join(rootDir, 'mirror-test', 'tweakcc', 'config.json');
    assert.ok(fs.existsSync(tweakConfigPath));
    const tweakConfig = JSON.parse(readFile(tweakConfigPath)) as { settings?: { themes?: { id?: string }[] } };
    assert.equal(tweakConfig.settings?.themes?.[0]?.id, 'dark');

    // Verify variant.json has prompt pack disabled
    const variantPath = path.join(rootDir, 'mirror-test', 'variant.json');
    const variant = JSON.parse(readFile(variantPath)) as { promptPack?: boolean };
    assert.equal(variant.promptPack, false, 'mirror provider should have promptPack disabled');

    // Verify settings.json has no auth overrides (pure Claude Code)
    const settingsPath = path.join(rootDir, 'mirror-test', 'config', 'settings.json');
    const settings = JSON.parse(readFile(settingsPath)) as { env?: Record<string, unknown> };
    assert.ok(!settings.env?.ANTHROPIC_BASE_URL, 'mirror should not set ANTHROPIC_BASE_URL');
    assert.ok(!settings.env?.ANTHROPIC_API_KEY, 'mirror should not set ANTHROPIC_API_KEY');
    assert.ok(settings.env?.CC_MIRROR_SPLASH, 'mirror should set splash env');
  } finally {
    cleanup(rootDir);
    cleanup(binDir);
  }
});

test('api key approvals are written to .claude.json', async () => {
  const rootDir = makeTempDir();
  const binDir = makeTempDir();

  const apiKey = 'sk-test-1234567890abcdefghijklmnopqrstuvwxyz';

  try {
    await core.createVariantAsync({
      name: 'beta',
      providerKey: 'custom',
      baseUrl: 'http://localhost:4000/anthropic',
      apiKey,
      claudeVersion: 'stable',
      rootDir,
      binDir,
      noTweak: true,
      tweakccStdio: 'pipe',
    });

    const claudeConfigPath = path.join(rootDir, 'beta', 'config', '.claude.json');
    assert.ok(fs.existsSync(claudeConfigPath));
    const config = JSON.parse(readFile(claudeConfigPath)) as {
      customApiKeyResponses?: { approved?: string[] };
    };
    const approved = config.customApiKeyResponses?.approved ?? [];
    assert.ok(approved.includes(apiKey.slice(-20)));
  } finally {
    cleanup(rootDir);
    cleanup(binDir);
  }
});

test('settingsOnly update preserves binary and only updates settings', () => {
  const rootDir = makeTempDir();
  const binDir = makeTempDir();

  return (async () => {
    await core.createVariantAsync({
      name: 'gamma',
      providerKey: 'openrouter',
      apiKey: 'or-key',
      claudeVersion: 'stable',
      rootDir,
      binDir,
      noTweak: true,
      tweakccStdio: 'pipe',
    });

    const variantDir = path.join(rootDir, 'gamma');
    const nativeDir = path.join(variantDir, 'native');
    const binaryPath = resolveNativeClaudePath(nativeDir);

    const marker = '\ncc-mirror-settings-only-test\n';
    fs.appendFileSync(binaryPath, marker);
    const beforeUpdate = readFile(binaryPath);

    // Update with settingsOnly - should NOT reinstall Claude Code binary
    await core.updateVariantAsync(rootDir, 'gamma', {
      settingsOnly: true,
      noTweak: true,
      tweakccStdio: 'pipe',
      modelOverrides: {
        sonnet: 'anthropic/claude-sonnet',
        haiku: 'anthropic/claude-haiku',
      },
    });

    const afterUpdate = readFile(binaryPath);
    assert.equal(afterUpdate, beforeUpdate, 'settingsOnly update should keep binary intact');
    assert.ok(afterUpdate.includes('cc-mirror-settings-only-test'), 'settingsOnly update should keep binary intact');

    // But settings should be updated with model overrides
    const configPath = path.join(variantDir, 'config', 'settings.json');
    const configJson = JSON.parse(readFile(configPath)) as {
      env: Record<string, string>;
    };
    assert.equal(configJson.env.ANTHROPIC_DEFAULT_SONNET_MODEL, 'anthropic/claude-sonnet');
    assert.equal(configJson.env.ANTHROPIC_DEFAULT_HAIKU_MODEL, 'anthropic/claude-haiku');
    assert.equal(
      configJson.env.ANTHROPIC_SMALL_FAST_MODEL,
      'anthropic/claude-haiku',
      'small-fast model should follow haiku alias when haiku is updated'
    );

    cleanup(rootDir);
    cleanup(binDir);
  })();
});


--- test/ink-testing-library.d.ts ---
declare module 'ink-testing-library';


--- test/prompt-pack.test.ts ---
import test from 'node:test';
import assert from 'node:assert/strict';
import fs from 'node:fs';
import os from 'node:os';
import path from 'node:path';
import { applyPromptPack } from '../src/core/prompt-pack.js';
import { resolveOverlays } from '../src/core/prompt-pack/overlays.js';
import { sanitizeOverlayMap, sanitizeOverlayText } from '../src/core/prompt-pack/sanitize.js';
import { OVERLAY_MARKERS, PROMPT_PACK_TARGETS } from '../src/core/prompt-pack/targets.js';

const makeTempDir = () => fs.mkdtempSync(path.join(os.tmpdir(), 'cc-mirror-prompt-pack-'));

const cleanup = (dir: string) => {
  fs.rmSync(dir, { recursive: true, force: true });
};

const writePromptFiles = (tweakDir: string) => {
  const systemPromptsDir = path.join(tweakDir, 'system-prompts');
  fs.mkdirSync(systemPromptsDir, { recursive: true });
  for (const target of PROMPT_PACK_TARGETS) {
    fs.writeFileSync(path.join(systemPromptsDir, target.filename), `# ${target.filename}\n`);
  }
  return systemPromptsDir;
};

test('sanitizeOverlayText removes backticks', () => {
  assert.equal(sanitizeOverlayText('Use `code` blocks.'), "Use 'code' blocks.");
  const sanitized = sanitizeOverlayMap({ main: 'Hello `world`', websearch: '   ' });
  assert.equal(sanitized.main, "Hello 'world'");
  assert.equal(Object.hasOwn(sanitized, 'websearch'), false);
});

test('resolveOverlays strips backticks for providers', () => {
  const providers = ['zai', 'minimax'] as const;
  for (const provider of providers) {
    const overlays = resolveOverlays(provider);
    for (const value of Object.values(overlays)) {
      if (!value) continue;
      assert.equal(value.includes('`'), false);
    }
  }
});

test('applyPromptPack writes overlays and is idempotent', () => {
  const tempDir = makeTempDir();
  const tweakDir = path.join(tempDir, 'tweakcc');
  const systemPromptsDir = writePromptFiles(tweakDir);

  const overlays = resolveOverlays('zai');
  const expectedUpdates = PROMPT_PACK_TARGETS.filter((target) => overlays[target.key]).length;

  const first = applyPromptPack(tweakDir, 'zai');
  assert.equal(first.changed, true);
  assert.equal(first.updated.length, expectedUpdates);

  const mainPath = path.join(systemPromptsDir, 'system-prompt-main-system-prompt.md');
  const content = fs.readFileSync(mainPath, 'utf8');
  assert.ok(content.includes(OVERLAY_MARKERS.start));
  assert.ok(content.includes(OVERLAY_MARKERS.end));
  assert.ok(content.includes('Provider: z.ai (GLM)'));
  const start = content.indexOf(OVERLAY_MARKERS.start);
  const end = content.indexOf(OVERLAY_MARKERS.end);
  assert.ok(start !== -1 && end !== -1);
  const overlayText = content.slice(start + OVERLAY_MARKERS.start.length, end);
  assert.equal(overlayText.includes('`'), false);

  const second = applyPromptPack(tweakDir, 'zai');
  assert.equal(second.changed, false);
  assert.equal(second.updated.length, 0);

  cleanup(tempDir);
});


--- test/provider-matrix.test.ts ---
/**
 * Provider Feature Matrix Tests
 *
 * Verify each provider has expected features and flags.
 * Ensures consistency between provider templates and documentation.
 */

import test from 'node:test';
import assert from 'node:assert/strict';
import { listProviders, getProvider, buildEnv, PROVIDER_DISPLAY_ORDER } from '../src/providers/index.js';

test('Provider Feature Matrix', async (t) => {
  const providers = listProviders(true); // Include experimental

  await t.test('all providers have required fields', () => {
    for (const provider of providers) {
      assert.ok(provider.key, `${provider.key} should have key`);
      assert.ok(provider.label, `${provider.key} should have label`);
      assert.ok(provider.description, `${provider.key} should have description`);
      assert.ok(typeof provider.baseUrl === 'string', `${provider.key} should have baseUrl (can be empty)`);
      assert.ok(provider.env, `${provider.key} should have env object`);
    }
  });

  await t.test('providers follow canonical display order', () => {
    assert.deepEqual(
      providers.map((provider) => provider.key),
      Array.from(PROVIDER_DISPLAY_ORDER),
      'providers should appear in canonical display order'
    );
  });

  await t.test('mirror provider has clean defaults', () => {
    const mirror = getProvider('mirror');
    assert.ok(mirror, 'mirror provider should exist');
    assert.ok(mirror.noPromptPack, 'mirror should have noPromptPack: true');
    assert.ok(mirror.credentialOptional, 'mirror should have credentialOptional: true');
    assert.equal(mirror.authMode, 'none', 'mirror should have authMode: none');
  });

  await t.test('ccrouter provider has correct auth mode', () => {
    const ccrouter = getProvider('ccrouter');
    assert.ok(ccrouter, 'ccrouter provider should exist');
    assert.equal(ccrouter.authMode, 'authToken', 'ccrouter should use authToken mode');
    assert.ok(ccrouter.credentialOptional, 'ccrouter should have credentialOptional: true');
  });

  await t.test('openrouter provider requires model mapping', () => {
    const openrouter = getProvider('openrouter');
    assert.ok(openrouter, 'openrouter provider should exist');
    assert.ok(openrouter.requiresModelMapping, 'openrouter should require model mapping');
    assert.equal(openrouter.authMode, 'authToken', 'openrouter should use authToken mode');
  });

  await t.test('ollama provider uses auth token + api key', () => {
    const ollama = getProvider('ollama');
    assert.ok(ollama, 'ollama provider should exist');
    assert.equal(ollama.authMode, 'authToken', 'ollama should use authToken mode');
    assert.ok(ollama.authTokenAlsoSetsApiKey, 'ollama should keep API key with auth token');
    assert.ok(ollama.requiresModelMapping, 'ollama should require model mapping');
    assert.ok(ollama.env.ANTHROPIC_AUTH_TOKEN, 'ollama should have default auth token');
    assert.ok(ollama.env.ANTHROPIC_API_KEY, 'ollama should have default api key');
  });

  await t.test('zai, minimax, and kimi providers have splash styles', () => {
    const zai = getProvider('zai');
    const minimax = getProvider('minimax');
    const kimi = getProvider('kimi');

    assert.ok(zai, 'zai provider should exist');
    assert.ok(minimax, 'minimax provider should exist');
    assert.ok(kimi, 'kimi provider should exist');

    assert.equal(zai.env.CC_MIRROR_SPLASH_STYLE, 'zai');
    assert.equal(minimax.env.CC_MIRROR_SPLASH_STYLE, 'minimax');
    assert.equal(kimi.env.CC_MIRROR_SPLASH_STYLE, 'kimi');
  });

  await t.test('experimental providers are hidden by default', () => {
    const visible = listProviders(false);
    const all = listProviders(true);

    assert.ok(all.length >= visible.length, 'Including experimental should have >= providers');

    const custom = getProvider('custom');
    assert.ok(custom, 'custom provider should exist');
    assert.ok(custom.experimental, 'custom should be experimental');

    const visibleKeys = visible.map((p) => p.key);
    assert.ok(!visibleKeys.includes('custom'), 'custom should not be in visible list');
  });

  await t.test('all non-experimental providers have CC_MIRROR env settings', () => {
    const visible = listProviders(false);
    for (const provider of visible) {
      assert.ok(provider.env.CC_MIRROR_SPLASH !== undefined, `${provider.key} should have CC_MIRROR_SPLASH`);
      assert.ok(provider.env.CC_MIRROR_PROVIDER_LABEL, `${provider.key} should have CC_MIRROR_PROVIDER_LABEL`);
      assert.ok(provider.env.CC_MIRROR_SPLASH_STYLE, `${provider.key} should have CC_MIRROR_SPLASH_STYLE`);
    }
  });

  await t.test('zai provider has default models', () => {
    const zai = getProvider('zai');
    assert.ok(zai, 'zai provider should exist');
    assert.equal(zai.env.ANTHROPIC_DEFAULT_HAIKU_MODEL, 'glm-4.5-air', 'zai should default haiku to glm-4.5-air');
    assert.equal(zai.env.ANTHROPIC_DEFAULT_SONNET_MODEL, 'glm-4.7', 'zai should default sonnet to glm-4.7');
    assert.equal(zai.env.ANTHROPIC_DEFAULT_OPUS_MODEL, 'glm-5', 'zai should default opus to glm-5');
  });

  await t.test('kimi provider has default models', () => {
    const kimi = getProvider('kimi');
    assert.ok(kimi, 'kimi provider should exist');
    assert.ok(kimi.env.ANTHROPIC_DEFAULT_HAIKU_MODEL, 'kimi should have haiku model');
    assert.ok(kimi.env.ANTHROPIC_DEFAULT_SONNET_MODEL, 'kimi should have sonnet model');
    assert.ok(kimi.env.ANTHROPIC_DEFAULT_OPUS_MODEL, 'kimi should have opus model');
  });

  await t.test('minimax provider has model settings', () => {
    const minimax = getProvider('minimax');
    assert.ok(minimax, 'minimax provider should exist');
    assert.ok(minimax.env.ANTHROPIC_MODEL, 'minimax should have ANTHROPIC_MODEL');
    assert.ok(minimax.env.ANTHROPIC_SMALL_FAST_MODEL, 'minimax should have ANTHROPIC_SMALL_FAST_MODEL');
  });

  await t.test('buildEnv derives startup/default models from alias mapping', () => {
    const zaiEnv = buildEnv({ providerKey: 'zai', apiKey: 'test-key' });
    assert.equal(
      zaiEnv.ANTHROPIC_MODEL,
      zaiEnv.ANTHROPIC_DEFAULT_OPUS_MODEL,
      'ANTHROPIC_MODEL should follow the Opus alias by default'
    );
    assert.equal(
      zaiEnv.ANTHROPIC_SMALL_FAST_MODEL,
      zaiEnv.ANTHROPIC_DEFAULT_HAIKU_MODEL,
      'ANTHROPIC_SMALL_FAST_MODEL should follow the Haiku alias by default'
    );
  });

  await t.test('buildEnv preserves explicit default/small-fast model overrides', () => {
    const env = buildEnv({
      providerKey: 'zai',
      apiKey: 'test-key',
      modelOverrides: {
        opus: 'glm-5',
        haiku: 'glm-4.5-air',
        defaultModel: 'glm-4.7',
        smallFast: 'glm-5-air',
      },
    });

    assert.equal(env.ANTHROPIC_MODEL, 'glm-4.7', 'explicit default model override should be preserved');
    assert.equal(env.ANTHROPIC_SMALL_FAST_MODEL, 'glm-5-air', 'explicit small-fast override should be preserved');
  });
});


--- test/shell-env.test.ts ---
import test from 'node:test';
import assert from 'node:assert/strict';
import fs from 'node:fs';
import os from 'node:os';
import path from 'node:path';
import { ensureZaiShellEnv } from '../src/core/shell-env.js';

delete process.env.Z_AI_API_KEY;

const makeTempDir = () => fs.mkdtempSync(path.join(os.tmpdir(), 'cc-mirror-shell-env-'));

const writeSettings = (configDir: string, apiKey: string) => {
  fs.mkdirSync(configDir, { recursive: true });
  const settingsPath = path.join(configDir, 'settings.json');
  fs.writeFileSync(settingsPath, JSON.stringify({ env: { ANTHROPIC_API_KEY: apiKey } }, null, 2));
};

test('ensureZaiShellEnv skips placeholder keys', () => {
  const tempDir = makeTempDir();
  const configDir = path.join(tempDir, 'config');
  const profilePath = path.join(tempDir, '.zshrc');
  writeSettings(configDir, '<API_KEY>');

  const result = ensureZaiShellEnv({ configDir, profilePath });
  assert.equal(result.status, 'skipped');
  assert.ok(result.message?.includes('missing API key'));
  assert.equal(fs.existsSync(profilePath), false);
});

test('ensureZaiShellEnv skips when profile already has a key', () => {
  const tempDir = makeTempDir();
  const configDir = path.join(tempDir, 'config');
  const profilePath = path.join(tempDir, '.zshrc');
  writeSettings(configDir, 'new-key');
  fs.writeFileSync(profilePath, 'export Z_AI_API_KEY="existing-key"\n');

  const result = ensureZaiShellEnv({ configDir, profilePath });
  assert.equal(result.status, 'skipped');
  assert.ok(result.message?.includes('already set in shell profile'));
  const content = fs.readFileSync(profilePath, 'utf8');
  assert.ok(content.includes('existing-key'));
});

test('ensureZaiShellEnv writes a cc-mirror block when missing', () => {
  const tempDir = makeTempDir();
  const configDir = path.join(tempDir, 'config');
  const profilePath = path.join(tempDir, '.zshrc');
  writeSettings(configDir, 'abc123');

  const result = ensureZaiShellEnv({ configDir, profilePath });
  assert.equal(result.status, 'updated');
  const content = fs.readFileSync(profilePath, 'utf8');
  assert.ok(content.includes('cc-mirror: Z.ai env start'));
  assert.ok(content.includes('export Z_AI_API_KEY="abc123"'));
});


--- test/tui.test.ts ---
import test from 'node:test';
import assert from 'node:assert/strict';
import React from 'react';
import { render } from 'ink-testing-library';
import { App } from '../src/tui/app.js';
import * as providers from '../src/providers/index.js';

delete process.env.Z_AI_API_KEY;
delete process.env.ANTHROPIC_API_KEY;

// Import test helpers
import { tick, send, waitFor, KEYS, makeCore } from './helpers/index.js';

const down = KEYS.down;
const enter = KEYS.enter;

const isSelectedProvider = (frame: string, label: string) =>
  frame.split('\n').some((line) => line.includes('â–¸') && line.toLowerCase().includes(label.toLowerCase()));

const moveToProvider = async (app: ReturnType<typeof render>, label: string) => {
  for (let i = 0; i < 20; i += 1) {
    const frame = app.lastFrame() || '';
    if (isSelectedProvider(frame, label)) return;
    await send(app.stdin, down);
    await tick();
  }
  throw new Error(`Provider not found in list: ${label}`);
};

test('TUI create flow applies tweakcc by default', async () => {
  const { core, calls } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();
  await send(app.stdin, down); // home -> create
  await send(app.stdin, enter);
  await moveToProvider(app, 'Zai');
  await send(app.stdin, enter); // select zai
  await send(app.stdin, enter); // intro screen -> continue
  await send(app.stdin, enter); // brand preset (auto)
  await send(app.stdin, enter); // name
  await send(app.stdin, enter); // base url
  await send(app.stdin, enter); // api key
  await send(app.stdin, enter); // prompt pack mode (maximal) - skipped yes/no for zai/minimax
  await send(app.stdin, enter); // install dev-browser? default No
  await send(app.stdin, enter); // write Z_AI_API_KEY? default Yes
  await send(app.stdin, down); // add env? select No
  await send(app.stdin, enter);

  const reachedSummary = await waitFor(() => {
    const frame = app.lastFrame() || '';
    return frame.includes('Review Configuration') || frame.includes('Extra environment variables');
  });
  assert.ok(reachedSummary);

  const frame = app.lastFrame() || '';
  if (frame.includes('Extra environment variables')) {
    await send(app.stdin, enter); // submit empty env line
    await waitFor(() => (app.lastFrame() || '').includes('Review Configuration'));
  }

  await send(app.stdin, enter); // summary -> create

  const created = await waitFor(() => calls.create.length > 0);
  assert.ok(created);
  assert.equal(calls.create.length, 1);
  assert.equal(calls.create[0].name, 'zai');
  assert.equal(calls.create[0].providerKey, 'zai');
  assert.equal(calls.create[0].noTweak, false); // tweakcc always applied now

  app.unmount();
});

test('TUI manage -> update flow', async () => {
  const { core, calls } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();
  await send(app.stdin, down); // create
  await send(app.stdin, down); // manage
  await send(app.stdin, enter);
  await send(app.stdin, enter); // pick alpha
  await tick();
  await send(app.stdin, enter); // update
  await waitFor(() => calls.update.length > 0);

  assert.equal(calls.update.length, 1);
  assert.equal(calls.update[0].name, 'alpha');

  app.unmount();
});

test('TUI manage -> remove flow', async () => {
  const { core, calls } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();
  await send(app.stdin, down); // create
  await send(app.stdin, down); // manage
  await send(app.stdin, enter);
  await send(app.stdin, enter); // pick alpha
  await tick();
  await send(app.stdin, down); // tweak
  await send(app.stdin, down); // remove
  await send(app.stdin, enter);
  const reachedRemoveConfirm = await waitFor(() => (app.lastFrame() || '').includes('Remove Variant'));
  assert.ok(reachedRemoveConfirm, 'Should reach remove confirmation screen');

  await send(app.stdin, enter); // confirm remove (default: Remove)
  const removed = await waitFor(() => calls.remove.length > 0);
  assert.ok(removed, 'Remove should be invoked');

  assert.equal(calls.remove.length, 1);
  assert.equal(calls.remove[0].name, 'alpha');

  app.unmount();
});

test('TUI update all flow', async () => {
  const { core, calls } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();
  await send(app.stdin, down); // create
  await send(app.stdin, down); // manage
  await send(app.stdin, down); // updateAll
  await send(app.stdin, enter);
  const updated = await waitFor(() => calls.update.length === 2);
  assert.ok(updated, 'Update all should trigger updates for all variants');
  assert.equal(calls.update[0].name, 'alpha');
  assert.equal(calls.update[1].name, 'beta');

  app.unmount();
});

test('TUI doctor flow', async () => {
  const { core, calls } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();
  await send(app.stdin, down); // create
  await send(app.stdin, down); // manage
  await send(app.stdin, down); // updateAll
  await send(app.stdin, down); // doctor
  await send(app.stdin, enter);
  await tick();

  const frame = app.lastFrame() || '';
  assert.ok(frame.includes('alpha'));
  assert.ok(calls.doctor.length >= 1);
  assert.equal(calls.doctor[0].root, '/tmp/root');
  assert.equal(calls.doctor[0].bin, '/tmp/bin');

  app.unmount();
});

// Settings flow test removed - Settings option was removed from TUI


--- test/tweakcc-error.test.ts ---
import test from 'node:test';
import assert from 'node:assert/strict';
import { formatTweakccFailure } from '../src/core/errors.js';

const assertNativeHint = (msg: string) => {
  assert.ok(msg.toLowerCase().includes('node-lief'));
  assert.ok(msg.toLowerCase().includes('--no-tweak'));
};

test('formatTweakccFailure maps classic native extraction errors', () => {
  const msg = formatTweakccFailure('Error: Could not extract JS from native binary: /tmp/claude');
  assertNativeHint(msg);
});

test('formatTweakccFailure maps tweakcc v4 native extraction errors', () => {
  const msg = formatTweakccFailure('Error: Failed to extract claude.js from native installation');
  assertNativeHint(msg);
});


--- test/tui/App.integration.test.ts ---
/**
 * App Integration Tests - Quick Setup Flow
 */

import test from 'node:test';
import assert from 'node:assert/strict';
import React from 'react';
import { render } from 'ink-testing-library';
import { App } from '../../src/tui/app.js';
import * as providers from '../../src/providers/index.js';
import { tick, send, waitFor, KEYS, makeCore } from '../helpers/index.js';

delete process.env.Z_AI_API_KEY;
delete process.env.ANTHROPIC_API_KEY;

const isSelectedProvider = (frame: string, label: string) =>
  frame.split('\n').some((line) => line.includes('â–¸') && line.toLowerCase().includes(label.toLowerCase()));

const moveToProvider = async (app: ReturnType<typeof render>, label: string) => {
  for (let i = 0; i < 20; i += 1) {
    const frame = app.lastFrame() || '';
    if (isSelectedProvider(frame, label)) return;
    await send(app.stdin, KEYS.down);
    await tick();
  }
  throw new Error(`Provider not found in list: ${label}`);
};

test('Quick setup flow completes successfully', async () => {
  const { core, calls } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();

  // Quick Setup
  await send(app.stdin, KEYS.enter);
  await tick();

  // Select provider - navigate down from mirror to zai
  await moveToProvider(app, 'Zai');
  await send(app.stdin, KEYS.enter);
  await tick();

  // Continue from intro screen
  await send(app.stdin, KEYS.enter);
  await tick();

  // Enter API key (just press enter for empty)
  await send(app.stdin, KEYS.enter);
  await tick();

  // Accept default models (prefilled)
  await send(app.stdin, KEYS.enter);
  await tick();

  // Enter variant name (just press enter for default)
  await send(app.stdin, KEYS.enter);

  // Wait for creation
  const created = await waitFor(() => calls.create.length > 0);

  assert.ok(created, 'Variant should be created');
  assert.equal(calls.create[0].providerKey, 'zai', 'Provider should be zai');

  app.unmount();
});


--- test/tui/App.navigation.test.ts ---
/**
 * App ESC Key Navigation Tests
 */

import test from 'node:test';
import assert from 'node:assert/strict';
import React from 'react';
import { render } from 'ink-testing-library';
import { App } from '../../src/tui/app.js';
import * as providers from '../../src/providers/index.js';
import { tick, send, KEYS, makeCore } from '../helpers/index.js';

delete process.env.Z_AI_API_KEY;
delete process.env.ANTHROPIC_API_KEY;

test('App ESC from home goes to exit', async () => {
  const { core } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();

  // Press ESC from home
  await send(app.stdin, KEYS.escape);

  const frame = app.lastFrame() || '';
  assert.ok(frame.includes('Goodbye'), 'Should show exit screen');

  app.unmount();
});

test('App ESC from quick-provider goes to home', async () => {
  const { core } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();

  // Go to quick setup (first item)
  await send(app.stdin, KEYS.enter);
  await tick();

  // Should be on provider select, press ESC
  await send(app.stdin, KEYS.escape);
  await tick();

  const frame = app.lastFrame() || '';
  assert.ok(frame.includes('Quick Setup'), 'Should be back at home screen');

  app.unmount();
});

test('App ESC from quick-api-key goes back to quick-provider', async () => {
  const { core } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();

  // Go to quick setup
  await send(app.stdin, KEYS.enter);
  await tick();

  // Select a provider
  await send(app.stdin, KEYS.enter);
  await tick();

  // Should be on API key screen, press ESC
  await send(app.stdin, KEYS.escape);
  await tick();

  const frame = app.lastFrame() || '';
  assert.ok(frame.includes('Select Provider'), 'Should be back at provider select');

  app.unmount();
});

test('App ESC from settings goes to home', async () => {
  const { core } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();

  // Navigate to Settings
  for (let i = 0; i < 5; i++) {
    await send(app.stdin, KEYS.down);
  }
  await send(app.stdin, KEYS.enter);
  await tick();

  // Should be on settings screen, press ESC
  await send(app.stdin, KEYS.escape);
  await tick();

  const frame = app.lastFrame() || '';
  assert.ok(frame.includes('Quick Setup'), 'Should be back at home screen');

  app.unmount();
});

test('App ESC from manage screen goes to home', async () => {
  const { core } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();

  // Navigate to Manage Variants
  await send(app.stdin, KEYS.down);
  await send(app.stdin, KEYS.down);
  await send(app.stdin, KEYS.enter);
  await tick();

  // Should be on manage screen, press ESC
  await send(app.stdin, KEYS.escape);
  await tick();

  const frame = app.lastFrame() || '';
  assert.ok(frame.includes('Quick Setup'), 'Should be back at home screen');

  app.unmount();
});

test('App ESC from doctor screen goes to home', async () => {
  const { core } = makeCore();
  const app = render(
    React.createElement(App, {
      core,
      providers,
      initialRootDir: '/tmp/root',
      initialBinDir: '/tmp/bin',
    })
  );

  await tick();

  // Navigate to Diagnostics
  for (let i = 0; i < 4; i++) {
    await send(app.stdin, KEYS.down);
  }
  await send(app.stdin, KEYS.enter);
  await tick();

  // Should be on diagnostics screen, press ESC
  await send(app.stdin, KEYS.escape);
  await tick();

  const frame = app.lastFrame() || '';
  assert.ok(frame.includes('Quick Setup'), 'Should be back at home screen');

  app.unmount();
});
